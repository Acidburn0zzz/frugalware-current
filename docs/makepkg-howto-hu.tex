\documentclass[a4paper,11pt,AnyOtherOptionalOptions]{article}
\usepackage{url}
\usepackage{verbatim}

\begin{document}
\title{Hogyan készítsünk csomagokat Frugalware alá?}
\author{Vajna Miklós}
\date{\today}
\maketitle

\section{Bevezetés}
A Frugalware ezernyi csomagból tevõdik össze. A disztribúcióban minden fájl egy csomag része. Könnyen lekérdezhetõ, hogy az adott fájl melyik csomag része. Például ha meg akarjuk tudni, hogy a /etc/frugalware-release fájlt melyik csomag tartalmazza, akkor hasznájuk ezt:
\begin{verbatim}
vmiklos@vmhome:~# grep -R etc/frugalware-release /var/lib/pacman/local/*
/var/lib/pacman/local/frugalware-0.0.92-1/files:etc/frugalware-release
\end{verbatim}
Ha a Frugalware Forrásfában böngészik, láthatja, hogy jelenleg 2 ág van. Nevük: frugalware és extra. A frugalware ág tartalmazza a csomagok nagy többségét. Az extra ág a 2. CD -n van: nyelvi és olyan csomagok, melyek nem férnek össze egy másik, a frugalware ágban levõ csomaggal. Például nem túl jó dolog 2 különbözõ levelezõszervert (MTA) telepíteni egy idõben: a frugalware ágban postfix van, az extrában pedig sendmail. Az exim csomag is az extra ágban lesz.

Mindegyik ágban van forrás és bináris könyvtár. A frugalware ágban a source/ és a frugalware/. Az extra ágban az extra/source/ és az extra/frugalware/. A bináris csomagok az adott ág bináris könyvtárában vannak. A csomagok forrásai egy picit komplikáltabbak. A csomagok egy kategóriákba tartoznak, mindegyik kategóriának és csomagnak megvan a saját könyvtára a forráskönyvtárban.

Lássunk egy példát. Vegyük a cabextract csomagot. Ekkor a bináris csomag neve frugalware/cabextract-version-release.fpm, a forrása pedig a source/apps/cabextract könyvtárban lesz.

A csomag saját könyvtárában tárolunk mindent, ami a csomagkészítéshez kell. Mondhatná az ember, hogy csak a patch -eket és egyéb dolgokat kellene tárolni, de véleményünk szerint nagyon bosszantó tud lenni akkor, amikor valamilyen okból újraforgatnánk egy csomagot, de az eredeti szerver lassú vagy épp elérhetetlen.

A forrásokon belül, minden csomag könyvtárában van egy FrugalBuild fájl. Ez egy sima shell szkript, amit a makepkg program használ fel. Magyarán a FrugalBuild szkriptekben minden olyan dolgot használhat, ami egy shell szkriptben használható.

Összefoglalva: a csomagolás a forrás beszerzésébõl, kiegészítõ fájlok (pl. inint szkriptek, konfig fájlok) hozzáadásából és a FrugalBuild szkript megírásából áll.

\section{Csomagok újrafordítása}

Mielõtt új csomagot csinálnánk, elõször egy meglevõ csomagot fordítunk újra ebben a leírásban. A példánkban az mplayer csomaggal fogunk foglalkozni. Feltételezem, hogy már le van töltve a forrásfa.

\begin {verbatim}
cd <Forrásfa>/source/xapps/mplayer
makepkg -c
movepkg
\end{verbatim}

Elõször is belépünk az mplayer könyvtárába, majd (mint a make és a Makefile) futtatjuk a makepkg programot, ami elkészíti a csomagot a FrugalBuild -ben leírt paraméterek alapján. Általában használni szoktuk a -c opciót sikeres fordítás után, hogy eltakarítsuk a kitömörített csomagot és a forrást. Ha le akarjuk cserélni a régi csomagot az újjal, akkor használjuk a movepkg parancsot. Ez törölni fogja a régi mplayer csomagot és bemásolja a most fordított csomagot a <Forrásfa>/frugalware könyvtárba.

A következõkben láthatunk egy egyszerû példát a FrugalBuild szkriptre.

\section{Egy egyszerû példa}
Lássunk egy egyszerû példát, a cabextract csomag FrugalBuild szkriptjét.
\begin{verbatim}
# Last Modified: Sun Mar 21 16:54:50 CET 2004
# Compiling Time: ~1 minute
# Maintainer: VMiklos <mamajom@axelero.hu>

pkgname=cabextract
pkgver=1.0
pkgrel=1
pkgdesc="a program to extract Microsoft Cabinet files"
url="http://www.kyz.uklinux.net/cabextract.php"
depends=('glibc')
up2date=`lynx -dump http://www.kyz.uklinux.net/cabextract.php |grep 'cabextract source code'|sed 's/.*t-\(.*\)\.t.*/\1/'`
source=(http://www.kyz.uklinux.net/downloads/$pkgname-$pkgver.tar.gz)
md5sums=('8fde8ad86f7144943b7e4e5a2da7eddb')

build() {
        cd $startdir/src/$pkgname-$pkgver
        ./configure --prefix=/usr
	
        make || return 1
	
        make DESTDIR=$startdir/pkg install
}

# vim: ft=sh
\end{verbatim}

És íme az egyes sorok magyarázatai:
\begin{verbatim}
# Last Modified: Sun Mar 21 16:54:50 CET 2004
\end{verbatim}

Ha módosítja a FrugalBuild szkriptet, akkor jó, ha átja ezt a mezõt. A dátum legyen angol formátumban (mint ahogy fent is látja). Ezt úgy érheti el, ha törli ideiglenesen az LC_ALL és a LANG környezeti változókat. Esetleg egy megoldás, ha nem szeretné bolygatni ezeket, hogy csinál rá egy aliast és berakja a .bash_login fájlba:
\begin{verbatim}
alias edate="LANG= LC_ALL= date"
\end{verbatim}
\begin{verbatim}
# Compiling Time: ~1 minute
\end{verbatim}

Jó, ha leírja, mennyi ideig tartott a csomag fordítása. Természetesen ez hardverfüggõ, mégis jobb tudni, mennyi idõ alatt fordul le az Ön hardverén, mintha egyáltalán nem tudnánk. A jövõben ezek talán át lesznek konvertálva SBU -ba (errõl bõvebben itt lehet olvasni:
\url{http://www.linuxfromscratch.org/lfs/view/stable/chapter04/aboutsbus.html}).

\begin{verbatim}
# Maintainer: VMiklos <mamajom@axelero.hu>
\end{verbatim}

Ha Ön lesz a csomag karbantartója, írja ide a nevét vagy a nickjét és az email címét. Ha úgy gondolja, többé nem tartja karban a csomagot, írjon Contributor-t a Maintainer helyett, a karbantartó késõbb majd hozzáírja magát.

\begin{verbatim}
pkgname=cabextract
\end{verbatim}

Ez lesz a csomag neve. Számokat, kötõjelet, stb. tartalmazhat, de maradjon kisbetûs.

\begin{verbatim}
pkgver=1.0
\end{verbatim}

A csomag verziója. A kötõjel nem megengedett, tehát az 1.0-6111 legyen inkább 1.0_6111.

\begin{verbatim}
pkgrel=1
\end{verbatim}

Ha újraforgatja a csomagot, növelnie kell ezt az értéket. Ha upgrade -eli újabb verzióra, ne felejtse el visszaírni ezt 1 -re. Ha új csomagot készít, természetesen legyen az érték 1.

\begin{verbatim}
pkgdesc="a program to extract Microsoft Cabinet files"
\end{verbatim}

A csomag rövid, egysoros leírása. Általában a program honlapjáról lehet átvenni.

\begin{verbatim}
url="http://www.kyz.uklinux.net/cabextract.php"
\end{verbatim}

A program eredeti weboldala.

\begin{verbatim}
depends=('glibc')
\end{verbatim}

A csomag függõségeinek listája, bash tömbben definiálva. Általában két kétszer kell a csomagot lefordítani: elõször üres függõségi listával ({\tt depends=()}), aztán futtatni a {\tt ldd /usr/bin/binaryname} parancsot minden binárisra. Ezután a listából kiderül, milyen más csomagokhoz kapcsolódik. Jó ötlet még a README vagy az INSTALL fájl elolvasása is, hogy megtaláljuk a függõségeket.

\begin{verbatim}
up2date=`lynx -dump http://www.kyz.uklinux.net/cabextract.php |grep 'cabextract source code'|sed 's/.*t-\(.*\)\.t.*/\1/'`
\end{verbatim}

Egy rövid parancs, hogy megtudjuk a csomag legújabb stabil verzióját. Ez segít a karbantartónak, hogy friss maradhasson a Forrásfa. Ez a sztring általában 3 részbõl tevõdik össze: egy {\tt lynx -dump urlcim}, egy {\tt grep valami} és egy {\tt sed} parancsból. A http protokolt használjuk, ha elérhetõ, azonban van olyan, hogy az ftp -t kell használnunk. Ilyenkor a {\tt lynx -dump} helyett a {\tt wget --passive-ftp -O - -q} parancs használatos. Természetesen használhatja a wget parancsot is minden esetben, de a lynx sokkal egyszerûbb. A sed parancs lecserélhetõ a {\tt tr} és a {\tt cut} parancsok kombinációira, ha ezeket jobban kedveli a sed -nél. A példa az alábbi lesz cut -ot és tr -t használva:

\begin{verbatim}
up2date=`lynx -dump http://www.kyz.uklinux.net/cabextract.php |grep 'cabextractsource code'|tr -s ' '|cut -d ' ' -f 6`
\end{verbatim}

\begin{verbatim}
source=(http://www.kyz.uklinux.net/downloads/$pkgname-$pkgver.tar.gz)
\end{verbatim}

It definiálja a csomag forrását, bash tömbben. Használhat sima fájlnevet patch -ekhez vagy kiegészítõ fáljokhoz, ha abba a könyvtárba rakja, ahol a FrugalBuild szkript van. Használhat URL -t, ha azt szeretné, hogy a {\tt makepkg} letöltse azt automatikusan. Fontos, hogy \textit{minden} forrást a csomag könyvtárába rakjon, beleérve a forrás fájlokat is, amiket letöltött.

\begin{verbatim}
md5sums=('8fde8ad86f7144943b7e4e5a2da7eddb')
\end{verbatim}

Egy másik bash tömb, hogy megakadályozza a rossz forrásból történõ fordítást. Természetesen ez elég haszontalan, ha letölti a forrást, majd egy {\tt md5sum foo.tar.gz} parancsot, ha lehetséges, próbáljuk az md5sumokat megszerezni a project weboldaláról. Jó ötlet egy megjegyzést hagyni az md5sum sor felett azzal kapcsolatban, hogy ezek az md5sumok hol érhetõk el. Például a codecs csomagnál:

\begin{verbatim}
# see http://www1.mplayerhq.hu/MPlayer/releases/codecs/MD5SUMS
md5sums=('9c51a70a6d14c064d9a80ac818c37584')
\end{verbatim}

\begin{verbatim}

build() {
        cd $startdir/src/$pkgname-$pkgver
        ./configure --prefix=/usr
	
        make || return 1
	
        make DESTDIR=$startdir/pkg install
}
\end{verbatim}

Végezetül, készítünk egy build függvényt, ami elkészíti a csomagot. Itt van egy {\tt \$startdir} változónk, minden forrás a {\tt \$startdir/src} könyvtárba lesz kicsomagolva, valamint a {\tt \$startdir/pkg} könyvtár lesz a csomag alapkönyvtára. Alapvetõen a build függvény négy feladatot végez el: belép a program forráskönyvtárába, lefuttatja a configure szkriptet, lefordítja a csomagot (és abbahagyja a csomagkészítési procedúrát, ha valami hiba történik) és telepíti a lefordított binárist. Legtöbb esetben a {\tt make DESTDIR=\$startdir/pkg install} vagy a {\tt make prefix=\$startdir/pkg/usr install} parancs használatos a binárisok telepítésére. Meg kell nézni a program által hozott Makefile -t, hogy lássuk melyik mûködik az adott csomagnál.

\begin{verbatim}
# vim: ft=sh
\end{verbatim}

A szkript aljára hozzáadhat editor-specifikus információt, például ez mondja meg a vim szövegszerkesztõnek, hogy a szkript formátuma shell szkript (mivel a #!/bin/bash nincs a fájl elején, a vim nem színezi ki õket).

\section{Teljes referencia}

És íme ittvan az összes lehetséges direktíva.

Elõször is nézzük az \textbf{install} direktívát. Itt hivatkozhat egy telepítõfájlra (általában \$pkgname.install), hogy ezt használja. A telepítõfájlban definiálhat akciókat, melyek az installálás után, upgrade útán, törlés elõtt és törlés után lesznek futtatva. Álljon itt egy példa, amivel világos lesz a dolog:

\begin{verbatim}
# $1:  the new package version
post_install()
{
        /bin/true
}

# $1:  the new package version
# $2:  the old package version
post_upgrade()
{
        /bin/true
}

# $1:  the old package version
pre_remove()
{
        /bin/true
}

# $1:  the old package version
post_remove()
{
        /bin/true
}

op=$1
shift
$op $*

# vim: ft=sh
\end{verbatim}

Ha pont ugyanazt szeretné tenni upgrade után, mint amit telepítés után, nyugodtan használja a {\tt post_install \$1} függvényt a {\tt post_upgrade()} függvényen belül.

Tehát mentse el ezt a fájlt valami.install néven és használja a {\tt install=\$pkgname.install} direktívát a FrugalBuild szkriptben.
Külön is megadhatja a telepítõ szkriptet a source tömbben, de nem szükséges.

A \textbf{pkgname}, \textbf{pkgver}, \textbf{pkgrel}, \textbf{url}, \textbf{source} and \textbf{md5sums} direktívákat megbeszéltük az elõzõ részben.

A \textbf{groups} direktíva is megadható, ha olyan csomagot készít, mely több tarballra van bontva. A KDE projekt jó példa ehhez. A KDE csomagokban az alábbi sort használjuk:
\begin{verbatim}
groups=('kde')
\end{verbatim}

A felhasználó így könnyebben tudja kezelni ezeket a csoportokat:
\begin{verbatim}
vmiklos@vmhome:~# pacman -Sg
kde
vmiklos@vmhome:~$ su -c 'pacman -S kde'
Password:
:: group kde:
    arts kdeaccessibility kdeaddons kdeadmin kdeartwork kdebase kdebindings
    kdeedu kdegames kdegraphics kdelibs kdemultimedia kdenetwork kdepim kdesdk
    kdetoys kdeutils kdevelop kdewebdev
    Install whole content? [Y/n]
\end{verbatim}

Amint látható, jelenleg csak a KDE -nél van ez használva.

A \textbf{backup} tömböt használjuk arra, hogy megjelöljük a konfigurációs fájlokat a csomagon belül. Ha lehetséges, nem módosítunk a beállításokon upgrade során. Bõvebb információért nézze meg a \textit{handling config files} részt a pacman manuáljában.

A \textbf{depends} tömb már meg lett tárgyalva. Egyvalamit nem említettem még, mégpedig azt, hogy az egyes elemek tartalmazhatnak verzió információkat. Mint például itt:
\begin{verbatim}
pkgname=kdewebdev
depends=('kdelibs=3.3.0')
\end{verbatim}

Itt az alábbi operátorok használhatóak: {\tt <>}, {\tt <=}, {\tt >=} or {\tt =}

A \textbf{makedepends} tömb definiálja a csomagkészítés alkalmával igényelt csomagokat. Például ha a forrás srpm formátumban van, akkor az alien programra szüksége lehet csomagkészítéskor.

A \textbf{conflicts} tömbben definiáljuk azokat a csomagokat, amiket nem telepíthetünk, ha ezt a csomagot akarjuk feltenni. Lássunk egy példát:

\begin{verbatim}
pkgname=blackbox
conflicts=('fluxbox')
\end{verbatim}

Erre itt azért van szükség, mert mindkét csomagban van {\tt bsetbg} parancs, de a két program különbözik. Ebben az esetben a fluxbox csomagnak is tartalmaznia kell ezt a sort ({\tt conflicts=('blackbox')}). Természetesen ha kettõ vagy több csomag nem fér össze, akkor csak az egyik csomagot lehet elhelyezni a frugalware ágban.

A \textbf{provides} tömböt virtuális függõségek létrehozására használjuk. Ez azt jelenti, hogy például a postfix is és a sendmail is mta -t biztosít, vagy egy mégjobb példa, hogy az xfree és az xorg is x -et biztosít, tehát a qt csomag az alábbiakat tartalmazza:
\begin{verbatim}
pkgname=qt
depends=('x' 'libpng' 'libjpeg')
\end{verbatim}

A felhasználónak lehetõsége van, hogy válasszon az xfree és az xorg között.

Az utolsó a sorban a \textbf{replaces} direktíva. A module-init-tools jó példa erre:
\begin{verbatim}
pkgname=module-init-tools
replaces=('modutils')
conflicts=('modutils')
\end{verbatim}

Amint látható, gyakran csinálunk olyan csomagokat, amik nem férnek össze egymássa. A replaces direktívát használva amikor a felhasználók legközelebb frissítik a csomaglistát ({\tt pacman -Su}), ha a modutils telepítve van (feltehetõleg :)), akkor a pacman törli a modutils csomagot és telepíti helyette a module-init-tools -t.

\section{Csomagok fordítása}

Ez végtelenül egyszerû. A csomag könyvtárban ugyanazokat a dolgokat kell megcsinálni, mint amik a \textit{Csomagok újrafordítása} részben vannak. Ha továbbítani akarja az elkészített csomagot a Frugalware projektnek, kérjük, hogy \textit{ne} indítsa a movepkg parancsot. Töltse fel a teljes könyvtárat (a bináris csomaggal együtt) ide: {\tt ftp://ftp.frugalware.org/incoming}, majd küldjön egy levelet a frugalware-devel listára.

További kellemes csomagkészítést :)

\end{document}

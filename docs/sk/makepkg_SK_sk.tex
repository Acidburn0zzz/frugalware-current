\chapter{Príloha: Ako urobi» balíèky pre Frugalware?}

\section{Úvod}
Frugalware obsahuje tisíce balíèkov. V¹etky súbory v distribúcií patria do balíèkov.
¥ahko mô¾ete prehladáva» do ktorého balíèka patrí ten a ten súbor.
Ak chceme vedie» do ktorého balíèka patrí /etc/frugalware-release tak pou¾ijeme
príkaz: 
\begin{verbatim}
vmiklos@vmhome:~# grep -R etc/frugalware-release /var/lib/pacman/local/*
/var/lib/pacman/local/frugalware-0.0.92-1/files:etc/frugalware-release
\end{verbatim}
Ak prehliadate FST (Frugalware Zdrojový Strom), tam sú momentálne dva archívy (v skratke repo).
Menujú sa frugalware a extra. Frugalware repo obsahuje najviac balíèkov. Extra repo je na 3-om CD:
lokalizaèné balíèky a balíèky ktorí sú v konflikte s balíèkami v frugalware repo. Napríklad nie je dobré
súèasne in¹talova» dva MTA: frugalware repos obsahuje postfix a extra obsahuje sendmail.
Exim balíèky budú v extra repo.

Ka¾dý repo má zdrojový a binárny adresár. Adresáre frugalwaru sú  source/ a frugalware/. 
Adresáre extra sú extra/source/ a extra/frugalware/.  Binárne balíèky sú v binárnych adresároch
repa. Zdrojové adresáre balíèkov sú viac komplexné. Ka¾dý balíèek má svoju kategóriu a ka¾dá kategória
a balíèek má svoje adresáre v zdrojovom adresári.

Pozrime si príklad. Vy hµadáte cabextract balíèek. Názov binárneho balíèka bude
frugalware/cabextract-version-release.fpm a zdrojový bude v adresári source/apps/cabextract

V adresári balíèku sa nachádza v¹etko èo je potrebné ku kompilácií balíèku. Mô¾ete poveda»
¾e by sme mohli uchováva» len patche a tak ïalej, ale podla na¹ej mienky je veµmi
zlé keï chcete re-kompilova» balíèek a pre nejaký dôvod pôvodný server je pomalý alebo
nefunguje.

Pritom, v ka¾dom zdrojovom adresári balíèka je FrugalBuild file.  Toto je jednoduchý shell skript ktorí bude pripojený
makepkgom. Tak¾e v skripte FrugalBuild mô¾ete pou¾i» v¹etko èo mô¾e by» pou¾itý v shell skripte.

Krákosti, zostavenie balíèka znamená zozbieranie zdrojov, pridávanie súborov (napr. príkladový init skripty alebo config súbory)
a napísanie FrugalBuild skriptu.


\section{prekompilácia balíèkov}

Pred vytvorením nových balíèkov, v tomto howto najprv uká¾eme ako re-kompilova» existujúci balíèek. Je to jednoduché.
V na¹om príklade prekompilujeme mplayer balíèek. Predpokladám ¾e máte stiahnutú FST.


\begin {verbatim}
cd <FST>/source/xapps/mplayer
makepkg -c
movepkg
\end{verbatim}

Najprv nastavíme sa na adresár mplayer (ako make a Makefile) spustíme makepkg ktorý zostaví balíèek podµa parametrov
opísaných v FrugalBuild. Zvyèajne pou¾ívame -c prepínaè aby sme vyèistili zdroje a nekomprimované súbory balíèkov po
úspe¹nom zostavovaní

V nasledujúcej sekcií budeme vidie» príklad na jednoduchý FrugalBuild skript.


\section{Príklad}
Pozrime si jednoduchý príklad FrugalBuild skriptu pre balíèek cabextract:
\begin{verbatim}
# Last Modified: Sun, 21 Mar 2004 16:54:50 +0100
# Compiling Time: ~1 minute
# Maintainer: VMiklos <mamajom@axelero.hu>

pkgname=cabextract
pkgver=1.0
pkgrel=1
pkgdesc="a program to extract Microsoft Cabinet files"
url="http://www.kyz.uklinux.net/cabextract.php"
depends=('glibc')
up2date=`elinks -dump http://www.kyz.uklinux.net/cabextract.php |grep 'cabextract source code'|sed 's/.*t-\(.*\)\.t.*/\1/'`
source=(http://www.kyz.uklinux.net/downloads/$pkgname-$pkgver.tar.gz)
md5sums=('8fde8ad86f7144943b7e4e5a2da7eddb')

build() {
        cd $startdir/src/$pkgname-$pkgver
        ./configure --prefix=/usr
	
        make || return 1
	
        make DESTDIR=$startdir/pkg install
}

# vim: ft=sh
\end{verbatim}

Sem ide opis pre ka¾dý riadok.
\begin{verbatim}
# Last Modified: Sun, 21 Mar 2004 16:54:50 +0100
\end{verbatim}

Ak zmeníte FrugalBuild skript tak by ste mali aktualizova» toto pole. Dátum malio by» anglické.
To mô¾eme urobi» vypnutím LC\_ALL a LANG premenných prostredia. Napr. ja pou¾ívam  LC\_ALL=hu\_HU, 
tak jednoducho urobil som alias dal som to do môjho .bash\_login:
\begin{verbatim}
alias edate="LANG= LC_ALL= date -R"
\end{verbatim}
\begin{verbatim}
# Compiling Time: ~1 minute
\end{verbatim}

Sem by ste mali napísa» koµko èasu Vám trvalo zostavenie balíèku. Preva¾ne to bude závisie» na 
hardvéri, je to lep¹ie vedie» èas na Va¹om poèítaèi ako nevedie». V budúcnosti mô¾no to prekonvertujeme 
tie èasy na SBU.(pozri. \url{http://www.linuxfromscratch.org/lfs/view/stable/chapter04/aboutsbus.html} pre viac info o SBU)


\begin{verbatim}
# Maintainer: VMiklos <mamajom@axelero.hu>
\end{verbatim}

Ak budete správcom balíka, napí¹te sem Va¹e meno alebo prezývku a email adresu.
Ak predpokladáte ¾e nebudete spravova» balíèek  napí¹te Contributor namiesto Maintainer a
Maintainer pridá svoj riadok.



\begin{verbatim}
pkgname=cabextract
\end{verbatim}

Toto bude meno balíèku. Je dovolené aby obsiahol: èísla, pomlèky atï. ale mali by» s malými písmenami.


\begin{verbatim}
pkgver=1.0
\end{verbatim}

Verzia balíèka. Pomlèky nie sú dovolené, ak pou¾ite napr 1.0-6111 tak to bude pravdepodobne konvertované na 1.0\_6111.



\begin{verbatim}
pkgrel=1
\end{verbatim}

Ak rekompilujete balíèek tak mali by ste zvý¹i» toto èíslo. Ak aktualizujete na novú verziu nezabudnite resetova» toto èíslo spä»
na 1. Ak urobíte nový balíèek tak máte to nastavi» na 1.


\begin{verbatim}
pkgdesc="a program to extract Microsoft Cabinet files"
\end{verbatim}

Krátky jedno riadkový opis balíèku. Získané zvyèajne z domovskej stránky projektu.


\begin{verbatim}
url="http://www.kyz.uklinux.net/cabextract.php"
\end{verbatim}

Domovská stránka projektu.


\begin{verbatim}
depends=('glibc')
\end{verbatim}

Zoznam závislostí balíèku je definované v bash poli. Zvyèajne mali by ste kompilova» jeden balíèek najmenej dva krát:
prvý krát s {\tt depends=()}  a potom mali by ste spusti» {\tt ldd /usr/bin/binaryname} pre v¹etky binárky. Potom
zo zoznamu mô¾ete vidie» ktorými ostatnými balíèkami je balíèek linkované. Èítanie README alebo INSTALL
súboru je taktie¾ dobrý nápad dozvedie» sa o závislostí.


\begin{verbatim}
up2date=`elinks -dump http://www.kyz.uklinux.net/cabextract.php |grep 'cabextract source code'|sed 's/.*t-\(.*\)\.t.*/\1/'`
\end{verbatim}

Krátky príkaz ktorý nám dá informáciu o poslednej stabilnej verzií balíèku. To pomáha maintainerom dr¾a» FST aktualizovanú.
Zvyèajne tento re»azec sa skladá z troch èastí: {\tt elinks -dump someurl}, {\tt grep foo} a {\tt sed} príkaz.
Pou¾ívame http protokol ak je mo¾né, ale niekedy musíme pou¾i» ftp. V tom prípade namiesto  {\tt elinks -dump} mali by ste pou¾íva»
{\tt wget -O - -q}. Pravda¾e mô¾ete pou¾i» wget v¾dy ale elinks je jednoduch¹í. Namiesto sed príkazu je mo¾né pou¾i» kombináciu 
{\tt tr} a {\tt cut} ak preferujete ich alebo nemáte rád sed. Hore pou¾itý príklad by vyzeral nasledujúc cut a tr:

\begin{verbatim}
up2date=`elinks -dump http://www.kyz.uklinux.net/cabextract.php |grep 'cabextractsource code'|tr -s ' '|cut -d ' ' -f 6`
\end{verbatim}

\begin{verbatim}
source=(http://www.kyz.uklinux.net/downloads/$pkgname-$pkgver.tar.gz)
\end{verbatim}

Tu mô¾ete definova» zdroje balíèku v bash poli. pou¾ite názvy súborov pre patche, alebo ïal¹ích súborov ak dáte ich
do toho istého adresára ako je FrugalBuild skript.


\begin{verbatim}
md5sums=('8fde8ad86f7144943b7e4e5a2da7eddb')
\end{verbatim}

E¹te jeden bash pole aby sa predchádzalo kompilovaniu zo zlých zdrojov. Pravda je to zbytoèné ak to stiahnete a spustíte {\tt md5sum foo.tar.gz}, ak je mo¾né skúste s»iahnu» md5sum z domovskej stránky projektu. Je to dobrý nápad necha» komentár nad týmto riadkom o tom kde je mo¾ne nájs» tie md5sumy. Napr. balíèek kodekov


\begin{verbatim}
# see http://www1.mplayerhq.hu/MPlayer/releases/codecs/MD5SUMS
md5sums=('9c51a70a6d14c064d9a80ac818c37584')
\end{verbatim}

\begin{verbatim}

build() {
        cd $startdir/src/$pkgname-$pkgver
        ./configure --prefix=/usr
	
        make || return 1
	
        make DESTDIR=$startdir/pkg install
}
\end{verbatim}


Na koniec definujeme zostavovaciu funkciu ktorá zostaví balíèek. Tu máme {\tt \$startdir} premennú, v¹etky zdroje budú rozbalené v
adresári {\tt \$startdir/src} a {\tt \$startdir/pkg} bude koreòový adresár balíèkov. Zostavovacia funkcia bude robi» tri veci: otvorí
zdrojový adresár programu, spustí konfiguraèný skript, kompiluje balíèky(a zastaví procedúru výroby balíèka ak to spadne) a in¹taluje
kompilované binárne súbory. Vo väè¹ine prípadov mali by ste pou¾i» {\tt make DESTDIR=\$startdir/pkg install} alebo {\tt make prefix=\$startdir/pkg/usr install} pre in¹taláciu kompilovaných bináriek. Pozrite sa do makefilu programu ktorý bude fungova» pre ¹pecifikovaný balíèek.


\begin{verbatim}
# vim: ft=sh
\end{verbatim}

Na konci mô¾ete da» editor-¹pecifické info, napr. toto povie vim ¾e formát tohto skript je v shell-skript. 



\section{Úplná referencia}

Tu je úplný zoznam dostupných direktív.

Najprv, zaèneme s  \textbf{in¹talaènou} direktívou. Tu mô¾ete pozrie» do in¹talaèného súboru (zvyèajne \$pkgname.install) a pou¾i».
V in¹talaènom súbore mô¾ete definova» akcie ktoré sa vykonajú po in¹talácií, po aktualizácií, pred odstránením a po odstránení.
Tu je príklad tak aby v¹etko bolo jasné:


\begin{verbatim}
# $1:  the new package version
post_install()
{
        /bin/true
}

# $1:  the new package version
# $2:  the old package version
post_upgrade()
{
        /bin/true
}

# $1:  the old package version
pre_remove()
{
        /bin/true
}

# $1:  the old package version
post_remove()
{
        /bin/true
}

op=$1
shift

$op $*

# vim: ft=sh
\end{verbatim}

Teraz, tie sú dostaèujúce ale mo¾no v budúcnosti budeme musie» vytvori» pre\_install a pre\_upgrade. 
Ak chcete urobi» to isté po aktualizácií ako po in¹talácií kµudne pou¾ite funkciu {\tt post\_install \$1} in the {\tt post\_upgrade()}.

Tak¾e, ulo¾ tento súbor ako foo.install a pou¾ite {\tt install=\$pkgname.install} direktívu v FrugalBuild skript.
mô¾ete menova» in¹talaèný skript v zdrojovom poli, ale to nie je nutné.

Direktívy \textbf{pkgname}, \textbf{pkgver}, \textbf{pkgrel}, \textbf{url}, \textbf{source} boli spomenuté v predchádzajúcej sekcií.

Skupinové

\textbf{Skupinové} direktívy je mo¾né ¹pecifikova» ak vytvárate balíèky pre projekt ktorý vydávajú svoje veci vo viac ako jednom
tarballe. Dobrým príkladom je projekt KDE. V KDE balíèkoch my pou¾ívame nasledujúci riadok: 

\begin{verbatim}
groups=('kde')
\end{verbatim}
Pou¾ívateµ mô¾e µahko nahliadnu» alebo in¹talova» tieto skupiny:
\begin{verbatim}
vmiklos@vmhome:~# pacman -Sg
kde
vmiklos@vmhome:~$ su -c 'pacman -S kde'
Password:
:: group kde:
    arts kdeaccessibility kdeaddons kdeadmin kdeartwork kdebase kdebindings
    kdeedu kdegames kdegraphics kdelibs kdemultimedia kdenetwork kdepim kdesdk
    kdetoys kdeutils kdevelop kdewebdev
    Install whole content? [Y/n]
\end{verbatim}

Ako mô¾ete vidie», momentálne pou¾ívame toto len pre KDE.

\textbf{backup}  pole je pou¾ité v balíèkoch na vytvorenie zo súborov, konfiguraèné súbory.
Ak je mo¾né, nezmeníme konfiguraèné súbory poèas aktualizácie.
Pre viac informácie o tomto pozrite \textit{handling config files} sekciu v pacman-vom manuálnej stránke.

\textbf{depends} pole u¾ bolo spomenuté, ale zabudol som spomenú» ¾e elementy mô¾u obsahova» informácie o 
verzie: napr.

\begin{verbatim}
pkgname=kdewebdev
depends=('kdelibs=3.3.0')
\end{verbatim}

Tu mô¾ete pou¾i» tieto operátory: {\tt <>}, {\tt <=}, {\tt >=} alebo {\tt =}. 

Pole \textbf{makedepends}  definuje balíèky ktoré sú potrebné poèas zostavovania.
Napríklad keï zdroj je SRPM formáte mô¾e by» cudzí ale je potrebné poèas zostavovania.

V \textbf{conflicts} pole mô¾ete definova» zoznam balíèkov ktoré nie je mo¾né in¹talova» ak chcete in¹talova» tento balíèek.
Pozrime si e¹te jeden príklad:

\begin{verbatim}
pkgname=blackbox
conflicts=('fluxbox')
\end{verbatim}


Toto je potrebné aby obe obsahovalii príkaz {\tt bsetbg} aj napriek tomu ¾e obe programy sú rôzne. V tomto prípade fluxbox balíèek taktie¾ musí obsahova» tento riadok ({\tt conflicts=('blackbox')}). To je zrejmé ak dva alebo viac balíèkov konfliktujú medzi sebou len jeden z nich je mo¾né da» do frugalware repo.

Pole \textbf{provides} je pou¾ité na vytvorenie virtuálnych závislosti. To znamená postfix and sendmail sú obe MTA alebo lep¹ím príkladom je, xfree a xorg sú obe x. Tak¾e qt bude obsahova» nasledujúci riadok:

\begin{verbatim}
pkgname=qt
depends=('x' 'libpng' 'libjpeg')
\end{verbatim}

Pou¾ívateµ má mo¾nos» vybra» medzi XFree a Xorg.

Posledná direktíva na zozname je \textbf{replaces}. Dobrým príkladom je balíèek module-init-tools:

\begin{verbatim}
pkgname=module-init-tools
replaces=('modutils')
conflicts=('modutils')
\end{verbatim}

Ako je evidentné, èasto vytvárame veµa nových balíèkov ktoré sú v konflikte medzi sebou. Pou¾itím replaces direktívy keï pou¾ívateµ pou¾ije {\tt pacman -Su} nabudúce ak modutils je nain¹talované (pravdepodobne)), budú vyzvané aby odstránili modutils a nain¹taloval module-init-tools.


\section{Kompilovanie balíèku}

Je to jednoduché. V adresári balíèku musíte urobi» to isté ako bolo popísané v sekcií \textit{Prekompilácia balíèkov}.
Ak chcete prispie» týmto balíèkom do Frugalware projektu, tak prosím \textit{ne} spustite movepkg. 
Uploadujte celý adresár balíèka (zahròujúce aj binárne balíèky) na {\tt ftp://ftp.frugalware.org/incoming} a po¹lite
mail na frugalware-devel mail list.

Prajem Vám skvelé balíèkovanie:)


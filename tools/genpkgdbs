#!/bin/bash

# (c) 2004-2007 Miklos Vajna <vmiklos@frugalware.org>,
#               CSÉCSY László <boobaa@frugalware.org>
# genpkgdbs for Frugalware
# distributed under GPL License

# this script is invoked by cron daily

. /usr/lib/frugalware/fwmakepkg

cd `dirname $0`/..

# Changelog
echo -n "generating ChangeLog.txt..."
darcs changes --from-tag "0.6$" | iconv -c -f iso8859-2 -t utf8 >ChangeLog.txt
echo " done"

# AUTHORS
echo -n "generating AUTHORS..."
genauthors docs/xml/authors.xml >AUTHORS
echo " done"

# Filelist.txt
echo -n "generating Filelist.txt..."
echo -e "Last Modified: `LANG= LC_ALL= date`\n\nFrugalware Source Tree">Filelist.txt
tree|grep -v ^\.$>>Filelist.txt
echo " done"

# fixing permsissions
echo -n "fixing permissions..."
cd tools
./fixperms
echo " done"

# setup

cd ../boot
rm *
for i in ${Farchs[@]}
do
	[ -e ../frugalware-$i/fwsetup-* ] || continue
	tar xvf ../frugalware-$i/fwsetup-* usr/share/setup
	mv usr/share/setup/* ./
	rm -rf usr
done

# documentation

cd ../docs
make clean
make all 2>&1 |tee build.log
make -i all-i18n 2>&1 |tee build-i18n.log

# update pots

make -C /home/ftp/pub/other/homepage-ng/frugalware/po pot
make -C /home/ftp/pub/other/setup/po pot
/home/ftp/pub/other/pacman-g2/pacman-g2/autogen.sh --gettext-only --pot-only
make -C /home/ftp/pub/other/frugalwareutils/frugalwareutils pot

# transfer them

ssh -p 2222 helicon sudo pootle-update /usr/lib/python2.5/site-packages/Pootle/po

# testsuite

cd ../t
./srcjunk --remove >/dev/null 2>&1
./fpmjunk-i686 --remove >/dev/null 2>&1
./fpmjunk-x86_64 --remove >/dev/null 2>&1
sh mailer.sh

# autotag

cd ..
LANG= LC_ALL= date |grep -q ^Fri && sh tools/tagger.sh .

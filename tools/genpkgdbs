#!/bin/bash

# (c) 2004 Vajna Miklos <mamajom@axelero.hu>
# genpkgdbs for FrugalWare
# distributed under GPL License

#if [ "$1" != "frugalware" -a "$1" != "extra" ]; then
#	echo "Hey, what repro? 'frugalware' or 'extra'?"
#	exit 1
#elif [ "$1" = "frugalware" ]; then
#	dir=..
#	name=current
#else # extra
#	dir=../extra
#	name=extra
#fi

# 0) Changelog
echo -n "generating ChangeLog.txt..."
(cd .. && darcs changes --from-tag 0.2 >ChangeLog.txt)
echo " done"

# 1) Packages.lst
echo -n "generating Packages.lst..."
( cd ..
  for i in `find source/* -name FrugalBuild|sed 's|.*/\(.*\)/\(.*\)/.*|\1/\2|'`
  do
  	grep -q ^nobuild= source/$i/FrugalBuild && continue
  	echo -n $i|sed 's|\(.*\)/.*|\1/|'
  	( cd frugalware/
  	  ls |grep "^`echo $i|sed 's|.*/\(.*\)|\1|'`-[[:digit:]]"|grep fpm |sed -n '1 p')
  done ) >../Packages.lst
echo " done"

# 2) Packages.lst for extra
echo -n "generating Packages.lst for extra..."
( cd ../extra
  for i in `find source/* -name FrugalBuild|sed 's|.*/\(.*\)/\(.*\)/.*|\1/\2|'`
  do
  	grep -q ^nobuild= source/$i/FrugalBuild && continue
  	echo -n $i|sed 's|\(.*\)/.*|\1/|'
  	( cd frugalware/;ls \
  	  |grep "^`echo $i|sed 's|.*/\(.*\)|\1|'`-[[:digit:]]"|grep fpm )
  done ) >../extra/Packages.lst
echo " done"

# 3) Filelist.txt
echo -n "generating Filelist.txt..."
( cd ..
  echo -e "Last Modified: `LANG= LC_ALL= date`\n\nFrugalware Source Tree">Filelist.txt
  tree|grep -v ^\.$>>Filelist.txt )
echo " done"

# 3) frugalware/frugalware-current.fdb
( cd ../
  arch=i686 gensync source/ frugalware-i686/frugalware-current.fdb
  arch=x86_64 gensync source/ frugalware-x86_64/frugalware-current.fdb )
( cd ../extra
  arch=i686 gensync source/ frugalware-i686/extra-current.fdb
  arch=x86_64 gensync source/ frugalware-x86_64/extra-current.fdb )

# 4) fixing permsissions
echo -n "fixing permissions..."
./fixperms
echo " done"

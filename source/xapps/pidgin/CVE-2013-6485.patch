
# HG changeset patch
# User Tomasz Wasilczyk <tomkiewicz@cpw.pidgin.im>
# Date 1377012974 -7200
# Node ID c9e5aba2dafdd7b94c2e9385f1be4b6461bc0707
# Parent  e111ec8dcb3f4b1b3af1f1bb9cb43ebbe2875a8d
Correct HTTP chunked transfers code (not fixed in rev ebe3fb4a3bc2)

Index: pidgin-2.10.7/libpurple/util.c
===================================================================
--- pidgin-2.10.7.orig/libpurple/util.c	2014-02-05 15:05:07.876165655 -0500
+++ pidgin-2.10.7/libpurple/util.c	2014-02-05 15:05:07.872165655 -0500
@@ -37,6 +37,8 @@
    specified a length) */
 #define DEFAULT_MAX_HTTP_DOWNLOAD (512 * 1024)
 
+#define MAX_HTTP_CHUNK_SIZE (10 * 1024 * 1024)
+
 struct _PurpleUtilFetchUrlData
 {
 	PurpleUtilFetchUrlCallback callback;
@@ -3780,11 +3782,12 @@
 			break;
 		s += 2;
 
-		if (s + sz > data + *len) {
+		if (sz > MAX_HTTP_CHUNK_SIZE || s + sz > data + *len) {
 			purple_debug_error("util", "Error processing chunked data: "
 					"Chunk size %" G_GSIZE_FORMAT " bytes was longer "
 					"than the data remaining in the buffer (%"
 					G_GSIZE_FORMAT " bytes)\n", sz, data + *len - s);
+			break;
 		}
 
 		/* Move all data overtop of the chunk length that we read in earlier */
@@ -3792,7 +3795,7 @@
 		p += sz;
 		s += sz;
 		newlen += sz;
-		if (*s != '\r' && *(s + 1) != '\n') {
+		if (*s == '\0' || (*s != '\r' && *(s + 1) != '\n')) {
 			purple_debug_error("util", "Error processing chunked data: "
 					"Expected \\r\\n, found: %s\n", s);
 			break;

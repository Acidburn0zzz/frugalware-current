
# HG changeset patch
# User Tomasz Wasilczyk <twasilczyk@pidgin.im>
# Date 1389300333 -3600
# Node ID 4c897372b5a485d8c82607fd2ac46161418c43e1
# Parent  ec15aa187aa0d51faea8d13f38220ddd35c6251a
Mxit: fix a possible segfault, refs VRT-2013-1002

Index: pidgin-2.10.7/libpurple/protocols/mxit/markup.c
===================================================================
--- pidgin-2.10.7.orig/libpurple/protocols/mxit/markup.c	2014-02-05 15:05:30.004166247 -0500
+++ pidgin-2.10.7/libpurple/protocols/mxit/markup.c	2014-02-05 15:05:29.996166247 -0500
@@ -204,7 +204,8 @@
  */
 static int asn_getUtf8( const char* data, char type, char** utf8 )
 {
-	int		len;
+	unsigned int len;
+	gchar *out_str;
 
 	/* validate the field type [1 byte] */
 	if ( data[0] != type ) {
@@ -213,10 +214,17 @@
 		return -1;
 	}
 
-	len = data[1];						/* length field [1 bytes] */
-	*utf8 = g_malloc( len + 1 );
-	memcpy( *utf8, &data[2], len );		/* data field */
-	(*utf8)[len] = '\0';
+	len = (uint8_t)data[1]; /* length field [1 byte] */
+	out_str = g_malloc(len + 1);
+	if (out_str == NULL) {
+		purple_debug_fatal(MXIT_PLUGIN_ID, "asn_getUtf8: out of memory");
+		return -1;
+	}
+
+	memcpy(out_str, &data[2], len); /* data field */
+	out_str[len] = '\0';
+
+	*utf8 = out_str;
 
 	return ( len + 2 );
 }

# Last modified: Wed, 21 Jun 2006 08:24:53 +0200
# Compiling time: 262.13 SBU
# Maintainer: Janny <janny@frugalware.org>
# Contributor: Laszlo Dvornik <dvornik@gnome.hu>

pkgname=openoffice.org
stablever=2.0.2
# this is the default, -stable
options=('scriptlet')
# uncomment this to get a -devel build
#options=('scriptlet' 'devel')
if [ "`check_option DEVEL`" ]; then
milestone=6
pkgver=$stablever.999.$milestone
snapshot=20060620
else
origver=14
pkgver=$stablever.$origver
ooover=`echo $pkgver|sed 's/\./_/g'|cut -c 1-5`
OOBVER=OOB680
fi
if [ "`check_option DEVEL`" ]; then
pkgrel=1
else
pkgrel=1
fi
pkgdesc="OpenOffice.org, a full office productivity suite (Version 2)"
url="http://www.openoffice.org/"
depends=('perl' 'gnome-vfs' 'libxml2' 'libart_lgpl' 'libsndfile' 'libgcj-awt' 'nas' \
	'startup-notification' 'fontconfig' 'libpng' 'imagemagick' 'flex' 'neon>=0.24.0' \
	'bison' 'zip' 'unzip' 'expat' 'cups' 'desktop-file-utils' 'perl-archive-zip' 'unixodbc' 'libxaw')
makedepends=('curl' 'intltool' 'tcsh' 'pam-headers' 'firefox' 'apache-ant' 'gcc-gcj' \
	'kdelibs' 'evolution-data-server-ldap' 'boost' 'icu' 'hunspell' 'imake' 'gccmakedep' \
	'xalan-j' 'patch>=2.5.9')
groups=('xapps')
archs=('i686')
if [ "`check_option DEVEL`" ]; then
archs=(${archs[@]} 'x86_64')
up2date="lynx -dump http://go-oo.org/packages/OOC680/|grep bz2$|sed -n 's/.*-m\(.*\)-.*/$stablever.999.\1/;$ p'"
source=(http://ftp.frugalware.org/pub/other/sources/ooo-build/ooo-build-$snapshot.tar.bz2 \
	http://go-oo.org/packages/OOC680/ooc680-m$milestone-core.tar.bz2 \
	http://go-oo.org/packages/OOC680/ooc680-m$milestone-system.tar.bz2 \
	http://go-oo.org/packages/OOC680/ooc680-m$milestone-lang.tar.bz2 \
	http://go-ooo.org/packages/SRC680/cli_types.dll \
	http://go-ooo.org/packages/SRC680/cli_types_bridgetest.dll \
	http://go-ooo.org/packages/SRC680/cairo-1.0.2.tar.gz \
	http://go-ooo.org/packages/SRC680/glitz-0.4.3.tar.gz \
	http://go-ooo.org/packages/SRC680/mdbtools-0.6pre1.tar.gz \
	http://go-ooo.org/packages/SRC680/extras-2.tar.bz2 \
	http://go-ooo.org/packages/xt/xt-20051206-src-only.zip \
	ooo-build-ooc680-m$milestone.diff)
_F_conf_configure="./autogen.sh"
else
up2date="lynx -dump 'http://go-oo.org/packages/OOB680/?C=M;O=A'|Flasttar"
source=(http://go-oo.org/packages/$OOBVER/ooo-build-$pkgver.tar.gz \
	http://go-ooo.org/packages/$OOBVER/OOO_$ooover-core.tar.bz2 \
	http://go-ooo.org/packages/$OOBVER/OOO_$ooover-system.tar.bz2 \
	http://go-ooo.org/packages/$OOBVER/OOO_$ooover-lang.tar.bz2 \
	http://go-ooo.org/packages/SRC680/ooo_crystal_images-1.tar.gz \
	http://go-ooo.org/packages/SRC680/ooo_custom_images-13.tar.bz2 \
	http://go-ooo.org/packages/SRC680/extras-2.tar.bz2 \
	http://go-ooo.org/packages/SRC680/cairo-1.0.2.tar.gz \
	http://go-ooo.org/packages/SRC680/glitz-0.4.3.tar.gz \
	http://go-ooo.org/packages/SRC680/mdbtools-0.6pre1.tar.gz \
	http://go-ooo.org/packages/libwpd/libwpd-0.8.3.tar.gz \
	http://go-ooo.org/packages/SRC680/cli_types.dll \
	http://go-ooo.org/packages/SRC680/cli_types_bridgetest.dll \
	http://go-ooo.org/packages/xt/xt-20051206-src-only.zip)
#	$pkgname-$pkgver-frugalware.diff)
sha1sums=('0d0d72a7c44d93c975f3a2af080c2292e8246992' \
	  'ed87feb8f160bb86d1922b73af6d4b409079798a' \
	  'c209592051095792dc8e8fe8db1f6ef4551db9e4' \
	  '802bdefe7de2667efed48693791ccd59bebfe0f8' \
	  '60c412c7d6e2f1247fadbe26ccf1e3e1f1ca87b8' \
	  '215cbf28c87a391e15ba9580e8201389ea8b92e4' \
	  '2c7fca93c106e23961f4aaa7cdfcaeb97064eed1' \
	  '3a425049499b0b067ed4dc60d94b4d0819c0841b' \
	  '6761c863b251660f0f329402a2d64f0db592f088' \
	  '37a50d623a444ec690d2677b12b59c2f11e497c0' \
	  '397b33bf77a6bfbab71ca3de7e42bc99ab80fdd6' \
	  'b91baf5d09c7dcb9702c824af04f91f048f46bf1' \
	  'f36c332cbe3a60e562ae42265fe0736d8102fea7' \
	  'edaba936383f5e1d6d245b4c826c6207825a8297')
fi
Finclude desktopdb
NOEXTRACT=1

ooosubpkgs=('de' 'es' 'fr' 'hu')
if [ ! "`check_option DEVEL`" ]; then
	ooosubpkgs=(${ooosubpkgs[@]} 'af' 'ar' 'be-BY' 'bg' 'bn' 'bn-BD' 'bn-IN' 'br' 'bs' 'ca' 'cy' 'cs' 'da' 'el' 'en-GB' 'en-ZA' 'eo' 'et' 'eu' 'fi' 'ga' 'gl' 'gu-IN' 'he' 'hi-IN' 'hr' 'it' 'ja' 'km' 'kn-IN' 'ko' 'lo' 'lt' 'lv' 'mk' 'ms' 'nb' 'ne' 'nl' 'nn' 'nr' 'ns' 'pa-IN' 'pl' 'pt' 'pt-BR' 'ru' 'rw' 'sh-YU' 'sk' 'sl' 'sr-CS' 'ss' 'st' 'sv' 'sw' 'sw-TZ' 'sx' 'ta-IN' 'th' 'tn' 'tr' 'ts' 've' 'vi' 'xh' 'zh-CN' 'zh-TW' 'zu' 'fa')
	if [ "`vercmp 2.0.2 $stablever`" -lt 0 ]; then
		ooosubpkgs=(${ooosubpkgs[@]} 'te-IN' 'ti-ER' 'ta-IN' 'tg')
	fi
fi

ooosubdescs=('German' 'Spanish' 'French' 'Hungarian')
if [ ! "`check_option DEVEL`" ]; then
	ooosubdescs=(${ooosubdescs[@]} 'Afrikaans' 'Arabic' 'Belarusian' 'Bulgarian' 'Bengali' 'Bengali (Bangladesh)' 'Bengali (India)' 'Breton' 'Bosnian' 'Catalan' 'Welsh' 'Czech' 'Danish' 'Greek' 'English (GB)' 'English (South Africa)' 'Esperanto' 'Estonian' 'Basque' 'Finnish' 'Irish' 'Galician' 'Gujarati' 'Hebrew' 'Hindi' 'Croatian' 'Italian' 'Japanese' 'Khmer (Cambodia)' 'Kannada' 'Korean' 'Lao' 'Lithuanian' 'Latvian' 'Macedonian' 'Malay' 'Norwegian Bokmal' 'Nepali' 'Dutch' 'Norwegian Nynorsk' 'Ndebele, South' 'NorthernSotho/Sepedi' 'Punjabi' 'Polish' 'Portuguese' 'Brazil (Port.)' 'Russian' 'Kinyarwanda' 'Serbian Latin' 'Slovak' 'Slovenian' 'Serbian Cyrillic' 'Swati' 'Sotho' 'Swedish' 'Swahili' 'Swahili ' 'South Georgian' 'Tamil' 'Thai' 'Tswana' 'Turkish' 'Tsonga' 'Venda' 'Vietnamese' 'Xhosa' 'Chinese (simplified)' 'Chinese (traditional)' 'Zulu' 'Persian')
	if [ "`vercmp 2.0.2 $stablever`" -lt 0 ]; then
		ooosubdescs=(${ooosubdescs[@]} 'Telugu' 'Tigrinya' 'Tamil' 'Tajik')
	fi
fi

if [ ${#ooosubpkgs[@]} -ne ${#ooosubdescs[@]} ]; then
	error '${#ooosubpkgs[@]} != ${#ooosubdescs[@]}'
	Fdie
fi

i=0
while [ $i -lt ${#ooosubpkgs[@]} ]
do
	if [ ! "`check_option DEVEL`" ]; then
		subpkgs=("${subpkgs[@]}" "openoffice.org-i18n-${ooosubpkgs[$i]}")
	else
		subpkgs=("${subpkgs[@]}" "openoffice.org-i18n-`echo ${ooosubpkgs[$i]}|tr [A-Z] [a-z]`")
	fi
	subdescs=("${subdescs[@]}" "${ooosubdescs[$i]} Localization for OpenOffice.org.")
	i=$(($i+1))
done

i=0
while [ $i -lt ${#ooosubpkgs[@]} ]
do
	subdepends=("${subdepends[@]}" "openoffice.org>=$pkgver")
	subgroups=("${subgroups[@]}" "locale-extra")
	# langpacks in -current goes to extra
	if [ "`check_option DEVEL`" ]; then
		subarchs=("${subarchs[@]}" "i686 x86_64")
	fi
	i=$(($i+1))
done

# You can find a few random notes about building OOo here:
# http://wiki.frugalware.org/OOo_building

build() {
	# Untar the ooo-build stuff
	if [ "`check_option DEVEL`" ]; then
	tar xjf ooo-build-$snapshot.tar.bz2 || return 1
	else
	tar -xvzf ooo-build-$pkgver.tar.gz || return 1
	fi

	# Move downloaded tarballs to the correct location. With this
	# ooo-build won't download the tarballs again.
	if [ "`check_option DEVEL`" ]; then
	mv ooc680-m$milestone-core.tar.bz2 ooo-build/src || return 1
	mv ooc680-m$milestone-system.tar.bz2 ooo-build/src || return 1
	mv ooc680-m$milestone-lang.tar.bz2 ooo-build/src || return 1
	mv cli_types.dll ooo-build/src || return 1
	mv cli_types_bridgetest.dll ooo-build/src || return 1
	mv cairo-1.0.2.tar.gz ooo-build/src || return 1
	mv glitz-0.4.3.tar.gz ooo-build/src || return 1
	mv mdbtools-0.6pre1.tar.gz ooo-build/src || return 1
	mv extras-2.tar.bz2 ooo-build/src || return 1
	mv xt-20051206-src-only.zip ooo-build/src || return 1

	Fcd ooo-build
	# Remove our patches so that incremental build will be possible.
	rm -f patches/src680/disable-regcomp_java.diff
	else
	mv OOO_$ooover-core.tar.bz2 ooo-build-$pkgver/src || return 1
	mv OOO_$ooover-system.tar.bz2 ooo-build-$pkgver/src || return 1
	mv OOO_$ooover-lang.tar.bz2 ooo-build-$pkgver/src || return 1
	mv ooo_crystal_images-1.tar.gz ooo-build-$pkgver/src || return 1
	mv ooo_custom_images-13.tar.bz2 ooo-build-$pkgver/src || return 1
	mv extras-2.tar.bz2 ooo-build-$pkgver/src || return 1
	mv cairo-1.0.2.tar.gz ooo-build-$pkgver/src || return 1
	mv glitz-0.4.3.tar.gz ooo-build-$pkgver/src || return 1
	mv mdbtools-0.6pre1.tar.gz ooo-build-$pkgver/src || return 1
	mv libwpd-0.8.3.tar.gz ooo-build-$pkgver/src || return 1
	mv cli_types.dll ooo-build-$pkgver/src || return 1
	mv cli_types_bridgetest.dll ooo-build-$pkgver/src || return 1
	mv xt-20051206-src-only.zip ooo-build-$pkgver/src || return 1

	Fcd ooo-build-$pkgver
	fi
	Fpatchall

	if [ ! "`check_option DEVEL`" ]; then
	# No binsuffix, thanks.
	Fsed 'openoffice@BINSUFFIX@' 'ooffice' desktop/openoffice.keys.in
	Fsed 'openoffice@BINSUFFIX@' 'ooffice' desktop/openoffice.applications.in
	fi

	# Defined $CARCH config
	if [ "$CARCH" == "x86_64" ]; then
		Fconfopts="$Fconfopts --with-distro=Frugalware64"
	else
		Fconfopts="$Fconfopts --with-distro=Frugalware"
	fi

	# SMP build
	if [ ! -z "$MAKEFLAGS" ]; then
		Fconfopts="$Fconfopts --with-num-cpus=${MAKEFLAGS/-j}"
		unset MAKEFLAGS
	fi

	# Set our version.
	Fsed "AC_PACKAGE_VERSION" "$pkgver-$pkgrel" configure.in
	if [ "`check_option DEVEL`" ]; then
		Fconf --with-lang="en-US de es fr hu" --without-binsuffix \
			--with-tag=ooc680-m$milestone --with-installed-ooo-dirname=$pkgname
	else
		Fconf --with-lang=ALL --without-binsuffix --with-installed-ooo-dirname=$pkgname
	fi

	./download || return 1

	make || return 1

	make DESTDIR=$Fdestdir install || return 1

	# Install some miscellaneous files into GNOME's prefix.
	if [ ! "`check_option DEVEL`" ]; then
	Ffilerel desktop/openoffice.keys.in /usr/share/mime-info/ooo.keys
	Ffilerel desktop/openoffice.applications.in /usr/share/application-registry/ooo.applications
	else
		cd desktop
		Ffilerel /usr/share/mime-info/openoffice.keys
		Ffilerel /usr/share/application-registry/openoffice.applications
		cd ..
	fi

	# Split out the i18n stuff
	for i in "${ooosubpkgs[@]}"
	do
		Fsplit openoffice.org-i18n-$i usr/lib/$pkgname/share/registry/res/$i/
		Fsplit openoffice.org-i18n-$i usr/lib/$pkgname/share/template/$i/
		if [ -d $Fdestdir/usr/lib/$pkgname/help/$i ]; then
			Fsplit openoffice.org-i18n-$i usr/lib/$pkgname/help/$i/
		fi
		Fsplit openoffice.org-i18n-$i usr/lib/$pkgname/program/resource/*680$i.res
	done
}
# optimization OK

# Compiling time: 262.13 SBU
# Maintainer: Janny <janny@frugalware.org>
# Contributor: Laszlo Dvornik <dvornik@gnome.hu>

pkgname=openoffice.org
pkgver=2.1.0
# this is the default, -stable
options=('scriptlet')
# uncomment this to get a -devel build
#options=('scriptlet' 'devel')
if [ ! "`check_option DEVEL`" ]; then
	pkgrel=3
	snapshot=20070109
else
	tree=ooe680
	milestone=6
	pkgver=$pkgver.999.$milestone
	pkgrel=1
	snapshot=20070105
fi
pkgdesc="OpenOffice.org, a full office productivity suite."
url="http://www.openoffice.org/"
depends=('libxml2' 'libart_lgpl' 'libsndfile' 'libgcj-awt=4.1.1-6' 'nas' 'fontconfig' 'libpng' 'imagemagick' \
	 'flex' 'neon>=0.26.1' 'bison' 'zip' 'unzip' 'expat' 'cups' 'desktop-file-utils' 'perl-archive-zip' \
	 'unixodbc' 'libxaw' 'libxslt')
makedepends=('curl' 'intltool' 'tcsh' 'pam-headers' 'firefox' 'apache-ant' 'gcc-gcj' 'kdelibs>=3.5.5' \
	     'evolution-data-server-ldap' 'boost' 'icu' 'hunspell' 'imake' 'gccmakedep' 'xalan-j' \
	     'patch>=2.5.9' 'openclipart' 'xorg-server' 'gstreamer' 'gst-plugins-base' 'gnome-vfs' \
	     'libbonobo' 'startup-notification' 'procps' 'openldap')
groups=('xapps')
archs=('i686' 'x86_64')
if [ ! "`check_option DEVEL`" ]; then
	up2date="lynx -source -dump http://www.openoffice.org/|grep download|sed -n 's|.*/\(.*\)/index.html.*|\1|;$ p'"
	source=(http://ftp.frugalware.org/pub/other/sources/ooo-build/ooo-build-${pkgver//./-}-$snapshot.tar.bz2)
#	$pkgname-$pkgver-frugalware.diff)
	signatures=($source.asc)
else
	up2date="lynx -dump http://svn.gnome.org/viewcvs/*checkout*/ooo-build/trunk/configure.in|grep ^DEFAULT_TAG|sed 's/.*_m\(.*\)/${pkgver%.*}.\1/'"
	source=(http://ftp.frugalware.org/pub/other/sources/ooo-build/ooo-build-$snapshot.tar.bz2)
#	ooo-build-$tree-m$milestone.diff)
	signatures=($source.asc)
fi
_F_gnome_desktop="y"
Finclude gnome-scriptlet
unset install

subpkgs=("$pkgname-kde" "$pkgname-gnome")
subdescs=("$pkgname kde integration" "$pkgname gnome integration")
# FIXME - depends - are still guessed   
subdepends=("$pkgname=$pkgver kdelibs>=3.5.5 startup-notification" "$pkgname=$pkgver gnome-vfs libbonobo evolution-data-server-ldap")
subarchs=('i686 x864_64' 'i686 x86_64')
subgroups=('kde-extra' 'gnome-extra')
subinstall=("" "$_F_gnome_scriptlet")

ooosubpkgs=('de' 'es' 'fr' 'hu')
ooosubdescs=('German' 'Spanish' 'French' 'Hungarian')
if [ ! "`check_option DEVEL`" ]; then
	ooosubpkgs=(${ooosubpkgs[@]} 'af' 'ar' 'be-BY' 'bg' 'bn' 'bn-BD' 'bn-IN' 'br' 'bs' 'ca' 'cy' 'cs' 'da' 'el' 'en-GB' 'en-ZA' 'eo' 'et' 'eu' 'fi' 'ga' 'gl' 'gu-IN' 'he' 'hi-IN' 'hr' 'it' 'ja' 'km' 'kn-IN' 'ko' 'lo' 'lt' 'lv' 'mk' 'ms' 'nb' 'ne' 'nl' 'nn' 'nr' 'ns' 'pa-IN' 'pl' 'pt' 'pt-BR' 'ru' 'rw' 'sh-YU' 'sk' 'sl' 'sr-CS' 'ss' 'st' 'sv' 'sw' 'sw-TZ' 'sx' 'ta-IN' 'th' 'tn' 'tr' 'ts' 've' 'vi' 'xh' 'zh-CN' 'zh-TW' 'zu' 'fa' 'ku' 'as-IN' 'ml-IN' 'mr-IN' 'or-IN' 'te-IN' 'tg' 'ti-ER' 'uk' 'ur-IN')
	ooosubdescs=(${ooosubdescs[@]} 'Afrikaans' 'Arabic' 'Belarusian' 'Bulgarian' 'Bengali' 'Bengali (Bangladesh)' 'Bengali (India)' 'Breton' 'Bosnian' 'Catalan' 'Welsh' 'Czech' 'Danish' 'Greek' 'English (GB)' 'English (South Africa)' 'Esperanto' 'Estonian' 'Basque' 'Finnish' 'Irish' 'Galician' 'Gujarati' 'Hebrew' 'Hindi' 'Croatian' 'Italian' 'Japanese' 'Khmer (Cambodia)' 'Kannada' 'Korean' 'Lao' 'Lithuanian' 'Latvian' 'Macedonian' 'Malay' 'Norwegian Bokmal' 'Nepali' 'Dutch' 'Norwegian Nynorsk' 'Ndebele, South' 'NorthernSotho/Sepedi' 'Punjabi' 'Polish' 'Portuguese' 'Brazil (Port.)' 'Russian' 'Kinyarwanda' 'Serbian Latin' 'Slovak' 'Slovenian' 'Serbian Cyrillic' 'Swati' 'Sotho' 'Swedish' 'Swahili' 'Swahili ' 'South Georgian' 'Tamil' 'Thai' 'Tswana' 'Turkish' 'Tsonga' 'Venda' 'Vietnamese' 'Xhosa' 'Chinese (simplified)' 'Chinese (traditional)' 'Zulu' 'Persian' 'Kurdish' 'Assamese' 'Malayalam' 'Marathi' 'Oriya' 'Telugu' 'Tajik' 'Tigrinya' 'Ukrainian' 'Urdu')
fi

if [ ${#ooosubpkgs[@]} -ne ${#ooosubdescs[@]} ]; then
	error '${#ooosubpkgs[@]} != ${#ooosubdescs[@]}'
	Fdie
fi

i=0
while [ $i -lt ${#ooosubpkgs[@]} ]
do
	subpkgs=("${subpkgs[@]}" "openoffice.org-i18n-`echo ${ooosubpkgs[$i]}|tr [A-Z] [a-z]`")
	subdescs=("${subdescs[@]}" "${ooosubdescs[$i]} Localization for OpenOffice.org.")
	i=$(($i+1))
done

i=0
while [ $i -lt ${#ooosubpkgs[@]} ]
do
	subinstall=("${subinstall[@]}" '')
	i=$(($i+1))
done

i=0
while [ $i -lt ${#ooosubpkgs[@]} ]
do
        subdepends=("${subdepends[@]}" "openoffice.org>=$pkgver")
        subgroups=("${subgroups[@]}" "locale-extra")
        subarchs=("${subarchs[@]}" "i686 x86_64")
        i=$(($i+1))
done

# You can find a few random notes about building OOo here:
# http://wiki.frugalware.org/OOo_building

build() {
	if [ ! "`check_option DEVEL`" ]; then
		Fcd ooo-build-$pkgver
	else
		Fcd ooo-build
	fi

	# Remove our patches so that incremental build will be possible.
	#rm -f patches/src680/disable-regcomp-python.diff
	Fpatchall

	# Defined $CARCH config
	if [ "$CARCH" == "x86_64" ]; then
		Fconfopts="$Fconfopts --with-distro=Frugalware64"
	else
		Fconfopts="$Fconfopts --with-distro=Frugalware"
	fi

	# SMP build
	if [ ! -z "$MAKEFLAGS" ]; then
		Fconfopts="$Fconfopts --with-num-cpus=${MAKEFLAGS/-j}"
		unset MAKEFLAGS
	fi

	# Other options.
	Fconfopts="$Fconfopts \
		--with-gcc-speedup=ccache \
		--with-openclipart=/usr/share/openclipart \
		--enable-gtk \
		--enable-hunspell \
		--with-binsuffix=no \
		--disable-dependency-tracking \
		--with-dejavu-fonts=2.13 \
		--with-fonts \
		--with-installed-ooo-dirname=openoffice.org"

	# Set our version.
	Fsed "AC_PACKAGE_VERSION" "$pkgver-$pkgrel" configure.in
	autoconf || return 1

	## Ffix env C{XX}FLAGS also Fkill 'mtune' ( don't _use_ -0[1-9] here ) O or Os nothing else... Fthx 
	## Fand Fwhy Fthey Fare Fdoing Fsomething Fcrappy Flike Fthis ? ;)
	#export ARCH_FLAGS="`echo $CFLAGS|sed 's/-O[0-9]/-Os/g'` -fno-strict-aliasing"
	export ARCH_FLAGS="$CFLAGS"

	if [ "`check_option DEVEL`" ]; then
		Fconf --with-lang="en-US de es fr hu" --with-tag=$tree-m$milestone
	else
		Fconf --with-lang=ALL
	fi

	./download || return 1

	make || return 1

	Fmakeinstall

	# Split out the i18n stuff
	for i in "${ooosubpkgs[@]}"
	do
		spkg=`echo $i|tr [A-Z] [a-z]`
		Fsplit openoffice.org-i18n-$spkg usr/lib/$pkgname/share/registry/res/$i/
		Fsplit openoffice.org-i18n-$spkg usr/lib/$pkgname/share/template/$i/
		if [ -d $Fdestdir/usr/lib/$pkgname/help/$i ]; then
			Fsplit openoffice.org-i18n-$spkg usr/lib/$pkgname/help/$i/
		fi
		Fsplit openoffice.org-i18n-$spkg usr/lib/$pkgname/program/resource/*680$i.res
	done

	## Split KDE stuff
	for kde in libfps_kde.so libvclplug_kde*.so libkab*.so kdebe*.so kdefilepicker; do
		Fsplit $pkgname-kde usr/lib/openoffice.org/program/$kde
	done
	## Split GNOME stuff 
	## FIXME "usr/lib/openoffice.org/share/xdg/" need be in gnome too ?!? 
	for gnome in gnome-open-ur* fps_gnome.uno.so gnome-set-default-* libvclplug_gtk*.so libeggtray* libqstart_gtk* ucpgvfs1.uno.so gconfbe* libevoab*.so; do
		Fsplit $pkgname-gnome usr/lib/openoffice.org/program/$gnome
	done 

	Fbuild_gnome_scriptlet

	# Check for missing language packs.
	misslangs="`find $Fdestdir |grep registry/res/.*/org|sed 's|.*registry/res/\(.*\)/org.*|\1|'|grep -v en-US |sort -u`"
	if [ -n "$misslangs" ]; then
		Fmessage "Unsplitted languages: $misslangs"
		return 1
	fi
}

# optimization OK

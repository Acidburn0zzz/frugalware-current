# Last modified: Sun, 25 Sep 2005 12:58:32 +0200
# Compiling time: ~36 hours on factory.frugalware.org
# Maintainer: Laszlo Dvornik <dvornik@gnome.hu>

pkgname=openoffice.org
pkgver=1.3.16
pkgrel=1
pkgdesc="OpenOffice.org, a full office productivity suite"
url="http://ooo.ximian.com/"
depends=('db>=4.3' 'perl' 'gtk+2' 'gnome-vfs' 'libxml2' 'libart_lgpl' \
	'startup-notification' 'fontconfig' 'libpng' 'imagemagick' 'flex' \
	'bison' 'zip' 'unzip' 'expat' 'cups' 'desktop-file-utils')
makedepends=('findutils' 'curl' 'intltool' 'tcsh' 'pam-headers' 'qt' \
	'kdelibs' 'evolution-data-server' 'util-linux')
backup=('usr/lib/ooo-1.1/share/dict/ooo/dictionary.lst')
groups=('xapps')
archs=('i686')
up2date="lynx -dump http://ooo.ximian.com/packages/OOO_1_1_5/|grep tar.gz$|sed -n 's/.*-\(.*\)\.t.*/\1/;$ p'"
source=(http://ooo.ximian.com/packages/OOO_1_1_5/ooo-build-$pkgver.tar.gz \
	http://ooo.ximian.com/packages/OOO_1_1_5/OOO_1_1_5.tar.bz2 \
	http://go-oo.org/packages/libwpd/libwpd-0.8.2.tar.gz \
	http://ooo.ximian.com/packages/ooo-icons-OOO_1_1-10.tar.gz \
	ooo-build-$pkgver-frugalware.patch \
	dictionary.lst \
	ooo.applications \
	ooo.keys \
	$pkgname-i18n.desc
	$pkgname.install \
	$pkgname-kde-menu.tar.bz2)
sha1sums=('1ea1558d2fffa12b8980afe8373e7eadf06398e6' \
	  'a6e36610fe4cd5242bf49bb6733a98b2ba9d6bc3' \
	  '8eb400f4e26db6333fb418051ae0cc98fe648797' \
	  '1e7b35e9adf8e51c90b43728f23af49685bf47c2' \
	  '29f916f1ea401389accb4f197e5703de6e9290ae' \
	  'e83814a2a3e1425892309167de6172189ff26268' \
	  'fdb8d5b9869e6363fe92d24cd4427f9e8e1cbcc2' \
	  'e31a1b937707007b90731e809ab8947429d645be' \
	  'f228032668b1466091eddaef20f23662fdf024a9' \
	  '458a718d106e852cb48c7f7a37f4b855f2bf8ed6' \
	  'b35713e1a7038b8c7d4de0a29712d1c343bc79bc')

build() {
	# Note: Requires a running X server for building.
	# Move downloaded tarballs to the correct location. With this
	# ooo-build won't download the tarballs again.
	mv $startdir/src/OOO_1_1_5.tar.bz2 $startdir/src/ooo-build-$pkgver/src
	mv $startdir/src/libwpd-0.8.2.tar.gz $startdir/src/ooo-build-$pkgver/src
	mv $startdir/src/ooo-icons-OOO_1_1-10.tar.gz $startdir/src/ooo-build-$pkgver/src

	# Remove the extracted directories, because ooo-build will extract
	# the tarballs.
	rm -rf libwpd-0.8.2
	rm -rf OOO_1_1_5
	rm -rf ooo-icons-OOO_1_1-10

	Fcd ooo-build-$pkgver
	Fpatch ooo-build-$pkgver-frugalware.patch
	./configure --prefix=/usr --sysconfdir=/etc --mandir=/usr/man \
		--with-docdir=/usr/share/doc/$pkgname-$pkgver \
		--with-lang=ALL --enable-libart --enable-libsn \
		--enable-crashdump=no --without-fonts --disable-rpath \
		--with-system-zlib --enable-fontconfig --with-system-freetype \
		--disable-mozilla --enable-kde --enable-gtk --disable-java \
		--with-icons=gnome --with-distro=Frugalware \
		--with-vendor=Frugalware --with-system-gcc=yes \
		--with-ccache-allowed --with-system-db-version=4.3 \
		--without-binsuffix
	./download || return 1

	make || return 1

	make DESTDIR=$startdir/pkg install

	# Install some miscellaneous files into GNOME's prefix.
	install -D -m644 -o root -g root $startdir/src/ooo.applications \
		$startdir/pkg/usr/share/application-registry/ooo.applications
	install -D -m644 -o root -g root $startdir/src/ooo.keys \
		$startdir/pkg/usr/share/mime-info/ooo.keys

	# Move GNOME menu entries to the correct location.
	mkdir -p $startdir/pkg/usr/share
	mv $startdir/pkg/usr/usr/ximian/applications \
		$startdir/pkg/usr/share

	# Remove empty directory.
	rm -rf $startdir/pkg/usr/share/gnome

	# Install KDE menu entries.
	# mv $startdir/src/opt/kde $startdir/pkg/opt

	# Remove all dictionary files except English.
	install -D -m644 -o root -g root $startdir/src/dictionary.lst \
		$startdir/pkg/usr/lib/ooo-1.1/share/dict/ooo/dictionary.lst
	rm -f $startdir/pkg/usr/lib/ooo-1.1/share/dict/ooo/*{da_,de,it,ru}*

	# Create i18n tarballs.
	mkdir $startdir/openoffice.org-i18n
	for code in `cat $startdir/src/openoffice.org-i18n.desc | grep -v '^#' | sed 's/^\([^\t]*\)\t.*/\1/'`
	do
		lang=`grep $code $startdir/src/openoffice.org-i18n.desc | sed 's/.*\t\(.*\)\t.*/\1/'`
		tar cvjf openoffice.org-i18n-$lang.tar.bz2 `find $startdir/pkg/usr/lib/ooo-1.1/program/resource/*645$code.res | xargs echo`
		mv openoffice.org-i18n-$lang.tar.bz2 \
			$startdir/openoffice.org-i18n/
		find $startdir/pkg/usr/lib/ooo-1.1/program/resource/*645$code.res \
			| xargs rm
	done
}

# vim: ft=sh

# optimalization OK

# Compiling time: 18.33 SBU
# Maintainer: Janny <janny@frugalware.org>
# Contributor: VMiklos <vmiklos@frugalware.org>

pkgname=firefox
pkgver=3.0
pathver=3.0 # version used in path names
pkgrel=1
pkgdesc="Mozilla Firefox web browser"
url="http://www.mozilla.org/products/firefox/"
depends=('gtk+2' 'libidl' 'desktop-file-utils' 'nss>=3.11.3-2' 'glibc>=2.6' 'dbus-glib' 'curl')
makedepends=('zip')
groups=('xapps')
archs=('i686' 'x86_64')
up2date="lynx -dump ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/latest/source | sed 's/-source//g' | Flasttarbz2"
source=(http://releases.mozilla.org/pub/mozilla.org/firefox/releases/$pkgver/source/firefox-$pkgver-source.tar.bz2 \
	# Disable the default application checks.
	01-$pkgname-1.5-default_applications.patch0 \
	# Set the default homepage
	02-$pkgname-2.0-homepage.patch \
	# Autodetect language.
	03-lang_detection.diff \
	config \
	ffremote \
	$pkgname.desktop)
signatures=("${source[0]}.asc" '' '' '' '' '' '')

build() {
	unset MAKEFLAGS
	Fcd mozilla
	sed "s/-march=i686 -O2 -pipe/$CFLAGS/" $startdir/src/config > .mozconfig
	# fix buggy dpi default value
	sed -i '/layout.css.dpi/s/-1/72/' modules/libpref/src/init/all.js || return 1
	export MOZ_PHOENIX=1
	Fpatchall
	
	Fsed "ac_cv_visibility_pragma=yes" "ac_cv_visibility_pragma=no" configure
	make -f client.mk build || Fdie
	make || Fdie

	Fmkdir /usr
	Fmakeinstall

	# Get rid of versions in path names.
	Fmv /usr/include/$pkgname-$pathver /usr/include/$pkgname
	Fmv /usr/lib/$pkgname-$pathver /usr/lib/$pkgname
	Fmv /usr/share/idl/$pkgname-$pathver /usr/share/idl/$pkgname
	Fln $pkgname /usr/include/$pkgname-$pathver
	Fln $pkgname /usr/lib/$pkgname-$pathver
	Fln $pkgname /usr/share/idl/$pkgname-$pathver

	# correction on broken ff symlink
	Frm /usr/bin/firefox
	Fln /usr/lib/firefox-3.0/firefox /usr/bin/firefox

	# remove ff-devel dir
	Frm /usr/lib/firefox-devel-3.0

	# create symlink nss headers to OOo
	Fln /usr/include/nss3 /usr/include/firefox/nss

	# Plugins.
	Fmv /usr/lib/$pkgname/plugins /usr/lib/$pkgname/plugins.orig
	Fln ../mozilla/plugins/ /usr/lib/$pkgname/plugins

	# /usr/share/aclocal/nspr.m4 conflicts with mozilla.
	Frm /usr/share/aclocal

	# Install ffremote.
	Fexe /usr/bin/ffremote

	# Install icon for the menu file.
	Fmkdir /usr/share/pixmaps/
	Fln /usr/lib/$pkgname/icons/mozicon50.xpm /usr/share/pixmaps/$pkgname.xpm

	# Install menu file.
	Ffile /usr/share/applications/$pkgname.desktop

	# Change the default icons
	Fln /usr/lib/$pkgname/icons /usr/lib/$pkgname/chrome/icons/default
	Fln /usr/lib/$pkgname/chrome/chromelist.txt /usr/lib/$pkgname/chrome/installed-chrome.txt
}

# optimization OK

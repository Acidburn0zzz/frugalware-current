# Compiling time: 0.58 SBU
# Maintainer: Christian Hamar alias krix <krics@linuxforum.hu>

pkgname=gdm
pkgver=2.28.0
pkgrel=2
pkgdesc="GNOME Display Manager"
url="http://www.gnome.org/"
backup=(etc/gdm/custom.conf etc/pam.d/gdm etc/pam.d/gdm-autologin)
depends=('zenity>=2.28.0' 'libgnomeui>=2.24.1-2' 'libxi' 'fontconfig' 'libxrandr>=1.2.2' \
	 'librsvg>=2.26.0' 'gnome-keyring' 'consolekit' 'libcanberra-gtk' \
	 'libxinerama' 'libxcursor' 'libxevie' 'xorg-server>=1.6.1' 'gnome-applets')
rodepends=('xsm' 'sessreg' 'gksu' 'xmessage')
makedepends=('intltool' 'gnome-doc-utils')
groups=('gnome' 'gnome-minimal')
archs=('i686' 'x86_64' 'ppc')
Finclude gnome
source=(${source[@]}
	libxklavier.diff \
	polkit-gnome-authentication-agent-1.desktop)
sha1sums=('e1975ccc92048de4b6e1e13a09b54a50d5fdb48a' \
          '010cef9dccd94a68e8b41c2c7fa910af20e8b496' \
          '93d1f9a7d068dd8e70c930abea9acf5b770a3485')

conflicts=('fast-user-switch-applet')
provides=('fast-user-switch-applet')
replaces=('fast-user-switch-applet')

build() {
	Fpatchall
	Fautoreconf
	Fmake --enable-authentication-scheme=pam \
		--enable-profiling \
		--enable-console-helper \
		--disable-scrollkeeper \
		--with-console-kit \
		--with-pam-dir=/lib/security \
		--with-pam-prefix=/etc
	Fmakeinstall

	chmod a+r $Fdestdir/var/gdm || Fdie
	chown root:root $Fdestdir/var/gdm || Fdie

	Fcp polkit-gnome-authentication-agent-1.desktop usr/share/gdm/autostart/LoginWindow/polkit-gnome-authentication-agent-1.desktop
	

	#delete PAM default rules
	Frm etc/pam.d/*

cat > $Fdestdir/etc/pam.d/gdm << "EOF"
#%PAM-1.0
auth        required    pam_unix.so
auth        requisite   pam_nologin.so
account     required    pam_unix.so
password    required    pam_unix.so
session     required    pam_unix.so
#Gnome Keyring's PAM Support
#auth    optional        pam_gnome_keyring.so
#session optional        pam_gnome_keyring.so  auto_start
EOF

cat > $Fdestdir/etc/pam.d/gdm-autologin << "EOF"
#%PAM-1.0
auth        required    pam_env.so
auth        requisite   pam_nologin.so
auth        required    pam_permit.so
account     required    pam_unix.so
password    required    pam_unix.so
session     required    pam_unix.so
EOF

}

# optimization OK

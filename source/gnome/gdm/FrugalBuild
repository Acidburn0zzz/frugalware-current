# Compiling time: 0.58 SBU
# Maintainer: bouleetbil <bouleetbil@frogdev.info>

pkgname=gdm
pkgver=3.1.92
pkgrel=4
pkgdesc="GNOME Display Manager"
url="http://www.gnome.org/"
backup=(etc/gdm/custom.conf etc/pam.d/gdm etc/pam.d/gdm-autologin \
	etc/pam.d/gdm-welcome etc/pam.d/gdm-smartcard etc/pam.d/gdm-fingerprint)
depends=('libxml2>=2.7.8' 'zenity>=3.0.0'  'libxi' 'fontconfig' 'libxrandr>=1.2.2' \
	 'librsvg>=2.26.0-2' 'gnome-keyring>=3.0.3' 'consolekit-x11>=0.4.5' 'libcanberra-gtk' \
	 'libxinerama' 'libxcursor' 'libxevie' 'xorg-server>=1.10.2' \
	'pam' 'accountsservice' 'upower' 'nss' 'hwdata' 'dbus-x11')
rodepends=('xsm' 'sessreg' 'xmessage' 'gnome-session')
makedepends=('intltool' 'gnome-doc-utils' 'gobject-introspection')
groups=('gnome')
archs=('i686' 'x86_64' 'ppc')
_F_gnome_git="n"
Finclude gnome
source=(${source[@]} \
	a11y.diff)
sha1sums=('204f49f507e4ded81e4680eabf40a7ba08f08937' \
          '3b31fb6239a3551e0f367d1ae24af3fdf624d171')
if [ "$_F_gnome_git" != "n" ]; then
	unset sha1sums
fi

conflicts=('fast-user-switch-applet')
provides=('fast-user-switch-applet' 'gdm-themes' 'somatic-gdm-themes' 'arc-colors-gdm-themes')
replaces=('fast-user-switch-applet' 'gdm-themes' 'somatic-gdm-themes' 'arc-colors-gdm-themes')

build() {
	if [ "$_F_gnome_git" != "n" ]; then
		Funpack_scm
		Fcd $pkgname
		sh ./autogen.sh
	else
		Fcd
		Fpatchall
		Fautoreconf
		# force regeneration
		#rm data/dconf-override-db || Fdie
	fi
	Fmake --enable-authentication-scheme=pam \
		--enable-console-helper \
		--disable-scrollkeeper \
		--with-console-kit \
		--with-pam-dir=/lib/security \
		--with-pam-prefix=/etc \
		--enable-split-authentication \
		--with-incomplete-locales=yes
	Fmakeinstall

	chmod a+r $Fdestdir/var/lib/gdm || Fdie
	chown root:root $Fdestdir/var/lib/gdm || Fdie
	Fmkdir var/spool/gdm

	#Fcp polkit-gnome-authentication-agent-1.desktop usr/share/gdm/autostart/LoginWindow/polkit-gnome-authentication-agent-1.desktop


	#delete PAM default rules
	Frm etc/pam.d/*

cat > $Fdestdir/etc/pam.d/gdm << "EOF"
#%PAM-1.0
auth            requisite       pam_nologin.so
auth            required        pam_env.so
auth            required        pam_unix.so
auth            optional        pam_gnome_keyring.so
account         required        pam_unix.so
session         required        pam_limits.so
session         required        pam_unix.so
session         optional        pam_gnome_keyring.so auto_start
password        required        pam_unix.so
EOF

cat > $Fdestdir/etc/pam.d/gdm-autologin << "EOF"
#%PAM-1.0
auth            requisite       pam_nologin.so
auth            required        pam_env.so
auth            requisite       pam_permit.so
auth            sufficient      pam_succeed_if.so uid >= 1000 quiet
auth            required        pam_deny.so
account         required        pam_unix.so
password        required        pam_deny.so
session         required        pam_loginuid.so
session		optional        pam_systemd.so
session         optional        pam_keyinit.so revoke
session         required        pam_limits.so
session         required        pam_unix.so
EOF

cat > $Fdestdir/etc/pam.d/gdm-welcome << "EOF"
#%PAM-1.0
auth            required        pam_env.so
auth            required        pam_permit.so
account         required        pam_nologin.so
account         required        pam_unix.so
password        required        pam_deny.so
session         required        pam_loginuid.so
session		optional        pam_systemd.so
session         optional        pam_keyinit.so force revoke
EOF

cat > $Fdestdir/etc/pam.d/gdm-pasword << "EOF"
#%PAM-1.0
auth            requisite       pam_nologin.so
auth            required        pam_env.so
auth            requisite       pam_unix.so nullok
auth            optional        pam_gnome_keyring.so
auth            sufficient      pam_succeed_if.so uid >= 1000 quiet
auth            required        pam_deny.so
account         required        pam_unix.so
password        required        pam_unix.so
session         required        pam_loginuid.so
session		optional        pam_systemd.so
session         optional        pam_keyinit.so revoke
session         required        pam_limits.so
session         required        pam_unix.so
session         optional        pam_gnome_keyring.so auto_start
EOF
cat > $Fdestdir/etc/pam.d/gdm-smartcard << "EOF"
#%PAM-1.0
auth            requisite       pam_nologin.so
auth            required        pam_env.so
auth            requisite       pam_pkcs11.so wait_for_card card_only
auth            sufficient      pam_succeed_if.so uid >= 1000 quiet
auth            required        pam_deny.so
account         required        pam_unix.so
password        required        pam_pkcs11.so
session         required        pam_loginuid.so
session		optional        pam_systemd.so
session         optional        pam_keyinit.so revoke
session         required        pam_limits.so
session         required        pam_unix.so
EOF
cat > $Fdestdir/etc/pam.d/gdm-smartcard << "EOF"
#%PAM-1.0
auth            requisite       pam_nologin.so
auth            required        pam_env.so
auth            requisite       pam_fprintd.so
auth            sufficient      pam_succeed_if.so uid >= 1000 quiet
auth            required        pam_deny.so
account         required        pam_unix.so
password        required        pam_deny.so
session         required        pam_loginuid.so
session		optional        pam_systemd.so
session         optional        pam_keyinit.so revoke
session         required        pam_limits.so
session         required        pam_unix.so
EOF
	#bash completion fix
	Fsed "#!/bin/sh" "#!/bin/bash" $Fdestdir/usr/sbin/gdm

	# systemd tmpfiles
	Frm var/run
	Fmkdir /etc/tmpfiles.d
        cat > $Fdestdir/etc/tmpfiles.d/gdm.conf << EOF
d $Flocalstatedir/run/gdm 0711 root gdm -
d $Flocalstatedir/run/gdm/greeter 0755 gdm gdm -
EOF

}

# optimization OK

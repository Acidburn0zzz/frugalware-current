# Compiling time: 0.58 SBU
# Maintainer: Baste <baste@frugalware.org>
# Contributor: bouleetbil <bouleetbil@frogdev.info>

pkgname=gdm
pkgver=3.19.90
pkgrel=1
pkgdesc="GNOME Display Manager"
url="http://www.gnome.org/"
backup=(etc/gdm/custom.conf etc/pam.d/gdm etc/pam.d/gdm-autologin \
	etc/pam.d/gdm-welcome etc/pam.d/gdm-password etc/pam.d/gdm-launch-environment)
depends=('dbus-glib>=0.104-2' 'accountsservice>=0.6.40-4' 'nss>=3.21-3' 'xorg-server>=1.18.0-1' 'libxrandr>=1.5.0-4' 'gtk+3>=3.19.9' \
	 'libcanberra-gtk>=0.30-12' 'pam>=1.1.8-3' 'upower>=0.99.3-3' 'libxklavier>=5.4-2' 'gnome-session>=3.19.4' 'systemd>=227-15' 'gnome-settings-daemon>=3.19.90')
makedepends=('intltool>=0.51.0-2' 'gobject-introspection>=1.46.0-2' 'dconf>=0.24.0-2' 'itstool>=2.0.2-3')
groups=('gnome' 'gnome-minimal')
archs=('i686' 'x86_64')
#nofakeroot for recreate glib schema (use dbus...)
#will see for don't use nofakeroot
options+=('nofakeroot' 'scriptlet' 'force')
_F_gnome_devel="y"
_F_gnome_ext=".tar.xz"
Finclude gnome
sha1sums=('32f9459ba334ab352cba6df0bdbf7b01f1d11588')

build() {
	Fmake --with-pam-prefix=/etc \
		--enable-gdm-xsession \
		--enable-split-authentication \
		--enable-console-helper \
		--with-lang-file=/etc/locale.conf \
		--enable-more-warnings \
		--enable-debug \
		--without-console-kit \
		--without-plymouth \
		--disable-fallback-greeter \
		--with-initial-vt=12

	Fmakeinstall
	chmod a+r $Fdestdir/var/lib/gdm || Fdie
	chmod 1770 $Fdestdir/var/log/gdm || Fdie
	# add logo to shell greeter
	#Fcp ../org.gnome.login-screen.gschema.override usr/share/glib-2.0/schemas/
	# gets rebuilt in posttrans
	Frm etc/dconf/db/gdm
	#delete PAM default rules
	Frm etc/pam.d/*

cat > $Fdestdir/etc/pam.d/gdm-autologin << "EOF"
#%PAM-1.0
auth		requisite	pam_nologin.so
auth		required	pam_env.so
auth		required	pam_permit.so
account		required	pam_unix.so
password	required	pam_unix.so
session		required	pam_limits.so
session		required	pam_unix.so
session         required        pam_systemd.so
EOF

cat > $Fdestdir/etc/pam.d/gdm-launch-environment << "EOF"
#%PAM-1.0
auth            required        pam_env.so
auth            required        pam_permit.so

account         required        pam_nologin.so
account         required        pam_unix.so

password        required        pam_deny.so

session         required        pam_loginuid.so
-session        optional        pam_systemd.so
session         optional        pam_keyinit.so force revoke
EOF

cat > $Fdestdir/etc/pam.d/gdm-password << "EOF"
#%PAM-1.0
auth            requisite       pam_nologin.so
auth            required        pam_env.so

auth            requisite       pam_unix.so nullok
auth            optional        pam_gnome_keyring.so

auth            sufficient      pam_succeed_if.so uid >= 1000 quiet
auth            required        pam_deny.so

account         required        pam_access.so
account         required        pam_time.so
account         required        pam_unix.so

password        required        pam_unix.so

session         required        pam_loginuid.so
-session        optional        pam_systemd.so
session         optional        pam_keyinit.so force revoke
session         required        pam_limits.so
session         required        pam_unix.so
session         optional        pam_gnome_keyring.so auto_start
EOF

}

# optimization OK

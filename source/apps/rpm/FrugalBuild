# Compiling Time: 3.42 SBU
# Contributor: VMiklos <vmiklos@frugalware.org>
# Maintainer: Christian Hamar alias krix <krics@linuxforum.hu>

pkgname=rpm
pkgver=4.4.6
pkgrel=7
pkgdesc="Red Hat Package Manager"
url="http://www.rpm.org/"
depends=('bzip2' 'libgcc' 'sqlite3' 'popt' 'neon>=0.26.1' 'db>=4.6.18' 'heimdal>=1.0')
groups=('apps')
archs=('i686' 'x86_64')
makedepends=('beecrypt')
up2date="4.4.6"
source=(ftp://jbj.org/pub/$pkgname-4.4.x/$pkgname-$pkgver.tar.gz \
	rpm-4.4.6-beecrypt.diff CVE-2006-5466.diff)
sha1sums=('33221f95189671d1a083b4f140bcf9a88ecd4374' \
	  'cd0efab5812eb82c0e0261340a194e2301913f75' \
	  'dc41417f4064eb9476de9ef51e616042e55e5f73')
[ "$CARCH" == "x86_64" ] && \
	source=(${source[@]} rpm_fix_lib64.patch) && \
	sha1sums=(${sha1sums[@]} 'ce35b5405edd9b2ea491ba933177f21f2b1bde75')

build()
{
	unset MAKEFLAGS
	Fpatchall
	touch config.rpath || Fdie
	Fautoreconf
	Fconf --without-selinux --without-python
	make staticLDFLAGS="" || return 1
	Fmakeinstall

	# conflicts with popt
	Frm /usr/include/popt.h  /usr/{lib,lib64}/libpopt.*
	Frm /usr/share/man/man3/popt.3
	Frm /usr/share/locale/*/LC_MESSAGES/popt.mo
	# x86_64 lib64 fixup
	if [ "$CARCH" == "x86_64" ] ; then
	    Fmv usr/lib64/* usr/lib/
	    Frm usr/lib64
	fi
	# Fixes symlink bug
	Fln /usr/lib/rpm/rpmpopt-$pkgver /usr/lib/rpm/rpmpopt
	# fixes bug "can't create transaction lock"
	Fmkdir /var/lock/rpm
}

# optimization OK

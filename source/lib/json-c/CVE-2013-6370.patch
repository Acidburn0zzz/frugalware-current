Description: fix denial of service via hash collision
Origin: backport, https://github.com/json-c/json-c/commit/64e36901a0614bf64a19bc3396469c66dcd0b015
Bug-Debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=744008
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/+source/json-c/+bug/1311397

Index: json-c-0.9/json_tokener.c
===================================================================
--- json-c-0.9.orig/json_tokener.c	2014-06-03 15:25:50.417628359 -0400
+++ json-c-0.9/json_tokener.c	2014-06-03 15:26:01.685628898 -0400
@@ -20,6 +20,7 @@
 #include <stddef.h>
 #include <ctype.h>
 #include <string.h>
+#include <inttypes.h>
 
 #include "bits.h"
 #include "debug.h"
@@ -56,6 +57,7 @@
   "object value separator ',' expected",
   "invalid string sequence",
   "expected comment",
+  "buffer size overflow"
 };
 
 
@@ -188,6 +190,16 @@
   tok->char_offset = 0;
   tok->err = json_tokener_success;
 
+  /* this interface is presently not 64-bit clean due to the int len argument
+     and the internal printbuf interface that takes 32-bit int len arguments
+     so the function limits the maximum string size to INT32_MAX (2GB).
+     If the function is called with len == -1 then strlen is called to check
+     the string length is less than INT32_MAX (2GB) */
+  if ((len < -1) || (len == -1 && strlen(str) > INT32_MAX)) {
+    tok->err = json_tokener_error_size;
+    return NULL;
+  }
+
   while (POP_CHAR(c, tok)) {
 
   redo_char:
Index: json-c-0.9/json_tokener.h
===================================================================
--- json-c-0.9.orig/json_tokener.h	2014-06-03 15:25:50.417628359 -0400
+++ json-c-0.9/json_tokener.h	2014-06-03 15:25:50.413628358 -0400
@@ -33,7 +33,8 @@
   json_tokener_error_parse_object_key_sep,
   json_tokener_error_parse_object_value_sep,
   json_tokener_error_parse_string,
-  json_tokener_error_parse_comment
+  json_tokener_error_parse_comment,
+  json_tokener_error_size
 };
 
 enum json_tokener_state {

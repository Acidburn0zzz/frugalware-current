Backport of:

From e99246246b4061f7e71463f8806b9dcad65affa0 Mon Sep 17 00:00:00 2001
From: Aris Adamantiadis <aris@0xbadc0de.be>
Date: Wed, 05 Feb 2014 20:24:12 +0000
Subject: security: fix for vulnerability CVE-2014-0017

When accepting a new connection, a forking server based on libssh forks
and the child process handles the request. The RAND_bytes() function of
openssl doesn't reset its state after the fork, but simply adds the
current process id (getpid) to the PRNG state, which is not guaranteed
to be unique.
This can cause several children to end up with same PRNG state which is
a security issue.
---
Index: libssh-0.5.4/include/libssh/wrapper.h
===================================================================
--- libssh-0.5.4.orig/include/libssh/wrapper.h	2014-03-10 09:50:49.105944378 -0400
+++ libssh-0.5.4/include/libssh/wrapper.h	2014-03-10 09:50:49.081944377 -0400
@@ -44,5 +44,6 @@
 struct ssh_crypto_struct *crypto_new(void);
 void crypto_free(struct ssh_crypto_struct *crypto);
 
+void ssh_reseed(void);
 
 #endif /* WRAPPER_H_ */
Index: libssh-0.5.4/src/bind.c
===================================================================
--- libssh-0.5.4.orig/src/bind.c	2014-03-10 09:50:49.105944378 -0400
+++ libssh-0.5.4/src/bind.c	2014-03-10 09:51:34.789946084 -0400
@@ -375,6 +375,8 @@
   session->dsa_key = dsa;
   session->rsa_key = rsa;
 
+  /* force PRNG to change state in case we fork after ssh_bind_accept */
+  ssh_reseed();
   return SSH_OK;
 }
 
Index: libssh-0.5.4/src/libcrypto.c
===================================================================
--- libssh-0.5.4.orig/src/libcrypto.c	2014-03-10 09:50:49.105944378 -0400
+++ libssh-0.5.4/src/libcrypto.c	2014-03-10 09:50:49.085944377 -0400
@@ -23,6 +23,7 @@
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
+#include <sys/time.h>
 
 #include "libssh/priv.h"
 #include "libssh/session.h"
@@ -38,6 +39,8 @@
 #include <openssl/rsa.h>
 #include <openssl/hmac.h>
 #include <openssl/opensslv.h>
+#include <openssl/rand.h>
+
 #ifdef HAVE_OPENSSL_AES_H
 #define HAS_AES
 #include <openssl/aes.h>
@@ -66,6 +69,12 @@
     return 0;
 }
 
+void ssh_reseed(void){
+    struct timeval tv;
+    gettimeofday(&tv, NULL);
+    RAND_add(&tv, sizeof(tv), 0.0);
+}
+
 SHACTX sha1_init(void) {
   SHACTX c = malloc(sizeof(*c));
   if (c == NULL) {
Index: libssh-0.5.4/src/libgcrypt.c
===================================================================
--- libssh-0.5.4.orig/src/libgcrypt.c	2014-03-10 09:50:49.105944378 -0400
+++ libssh-0.5.4/src/libgcrypt.c	2014-03-10 09:50:49.085944377 -0400
@@ -41,6 +41,9 @@
     return 0;
 }
 
+void ssh_reseed(void){
+	}
+
 SHACTX sha1_init(void) {
   SHACTX ctx = NULL;
   gcry_md_open(&ctx, GCRY_MD_SHA1, 0);

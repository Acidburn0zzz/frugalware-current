diff -Naur madwifi-0.9.2.1.orig/ath/if_ath_ahb.c madwifi-0.9.2.1/ath/if_ath_ahb.c
--- madwifi-0.9.2.1.orig/ath/if_ath_ahb.c	2006-05-22 06:39:55.000000000 +0200
+++ madwifi-0.9.2.1/ath/if_ath_ahb.c	2007-02-05 15:43:27.000000000 +0100
@@ -10,7 +10,6 @@
 #define	EXPORT_SYMTAB
 #endif
 
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -Naur madwifi-0.9.2.1.orig/ath/if_ath.c madwifi-0.9.2.1/ath/if_ath.c
--- madwifi-0.9.2.1.orig/ath/if_ath.c	2006-07-08 08:47:19.000000000 +0200
+++ madwifi-0.9.2.1/ath/if_ath.c	2007-02-05 15:43:27.000000000 +0100
@@ -44,7 +44,6 @@
  */
 #include "opt_ah.h"
 
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
@@ -116,7 +115,7 @@
 static void ath_rxorn_tasklet(TQUEUE_ARG);
 static void ath_bmiss_tasklet(TQUEUE_ARG);
 static void ath_bstuck_tasklet(TQUEUE_ARG);
-static void ath_radar_task(TQUEUE_ARG);
+static void ath_radar_task(struct ATH_WORK_THREAD *);
 static void ath_dfs_test_return(unsigned long);
 
 static int ath_stop_locked(struct net_device *);
@@ -412,7 +411,7 @@
 	ATH_INIT_TQUEUE(&sc->sc_bstucktq,ath_bstuck_tasklet,	dev);
 	ATH_INIT_TQUEUE(&sc->sc_rxorntq, ath_rxorn_tasklet,	dev);
 	ATH_INIT_TQUEUE(&sc->sc_fataltq, ath_fatal_tasklet,	dev);
-	ATH_INIT_SCHED_TASK(&sc->sc_radartask, ath_radar_task,	dev);
+	ATH_INIT_SCHED_TASK(&sc->sc_radartask, ath_radar_task);
 
 	/*
 	 * Attach the hal and verify ABI compatibility by checking
@@ -1581,7 +1580,7 @@
  * Interrupt handler.  Most of the actual processing is deferred.
  */
 irqreturn_t
-ath_intr(int irq, void *dev_id, struct pt_regs *regs)
+ath_intr(int irq, void *dev_id)
 {
 	struct net_device *dev = dev_id;
 	struct ath_softc *sc = dev->priv;
@@ -1700,11 +1699,9 @@
 	return IRQ_HANDLED;
 }
 
-static void
-ath_radar_task(TQUEUE_ARG data)
+static void ath_radar_task(struct ATH_WORK_THREAD *thr)
 {
-	struct net_device *dev = (struct net_device *)data;
-	struct ath_softc *sc = dev->priv;
+	struct ath_softc *sc = container_of(thr, struct ath_softc, sc_radartask);
 	struct ath_hal *ah = sc->sc_ah;
 	struct ieee80211com *ic = &sc->sc_ic;
 	struct ieee80211_channel ichan;
@@ -4672,7 +4669,7 @@
 	while (an->an_uapsd_qdepth) {
 		bf = STAILQ_FIRST(&an->an_uapsd_q);
 		STAILQ_REMOVE_HEAD(&an->an_uapsd_q, bf_list);
-		bf->bf_desc->ds_link = (u_int32_t)NULL;
+		bf->bf_desc->ds_link = 0;
 
 		dev_kfree_skb_any(bf->bf_skb);
 		bf->bf_skb = NULL;
@@ -4688,7 +4685,7 @@
 	while (an->an_uapsd_overflowqdepth) {
 		bf = STAILQ_FIRST(&an->an_uapsd_overflowq);
 		STAILQ_REMOVE_HEAD(&an->an_uapsd_overflowq, bf_list);
-		bf->bf_desc->ds_link = (u_int32_t)NULL;
+		bf->bf_desc->ds_link = 0;
 
 		dev_kfree_skb_any(bf->bf_skb);
 		bf->bf_skb = NULL;
@@ -6236,7 +6233,7 @@
 	while (an->an_uapsd_qdepth) {
 		bf = STAILQ_FIRST(&an->an_uapsd_q);
 		STAILQ_REMOVE_HEAD(&an->an_uapsd_q, bf_list);
-		bf->bf_desc->ds_link = (u_int32_t)NULL;
+		bf->bf_desc->ds_link = 0;
 		txq = sc->sc_ac2q[bf->bf_skb->priority & 0x3];
 		ath_tx_txqaddbuf(sc, ni, txq, bf, bf->bf_desc, bf->bf_skb->len);
 		an->an_uapsd_qdepth--;
@@ -6245,7 +6242,7 @@
 	while (an->an_uapsd_overflowqdepth) {
 		bf = STAILQ_FIRST(&an->an_uapsd_overflowq);
 		STAILQ_REMOVE_HEAD(&an->an_uapsd_overflowq, bf_list);
-		bf->bf_desc->ds_link = (u_int32_t)NULL;
+		bf->bf_desc->ds_link = 0;
 		txq = sc->sc_ac2q[bf->bf_skb->priority & 0x3];
 		ath_tx_txqaddbuf(sc, ni, txq, bf, bf->bf_desc, bf->bf_skb->len);
 		an->an_uapsd_overflowqdepth--;
diff -Naur madwifi-0.9.2.1.orig/ath/if_ath_pci.c madwifi-0.9.2.1/ath/if_ath_pci.c
--- madwifi-0.9.2.1.orig/ath/if_ath_pci.c	2006-07-21 10:00:32.000000000 +0200
+++ madwifi-0.9.2.1/ath/if_ath_pci.c	2007-02-05 15:43:27.000000000 +0100
@@ -42,7 +42,6 @@
 #define	EXPORT_SYMTAB
 #endif
 
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -Naur madwifi-0.9.2.1.orig/ath/if_athvar.h madwifi-0.9.2.1/ath/if_athvar.h
--- madwifi-0.9.2.1.orig/ath/if_athvar.h	2006-06-28 08:45:43.000000000 +0200
+++ madwifi-0.9.2.1/ath/if_athvar.h	2007-02-05 15:43:27.000000000 +0100
@@ -73,17 +73,17 @@
 #include <linux/tqueue.h>
 #define ATH_WORK_THREAD			tq_struct
 #define ATH_SCHEDULE_TASK(t)		schedule_task((t))
-#define ATH_INIT_SCHED_TASK(t, f, d) do { 	\
+#define ATH_INIT_SCHED_TASK(t, f) do { 	\
 	memset((t),0,sizeof(struct tq_struct)); 	\
 	(t)->routine = (void (*)(void*)) (f); 	\
-	(t)->data=(void *) (d); 		\
+	(t)->data=(void *) (t); 		\
 } while (0)
 #define ATH_FLUSH_TASKS			flush_scheduled_tasks
 #else
 #include <linux/workqueue.h>
 #define ATH_SCHEDULE_TASK(t)		schedule_work((t))
 
-#define ATH_INIT_SCHED_TASK(_t, _f, _d)	INIT_WORK((_t), (void (*)(void *))(_f), (void *)(_d));
+#define ATH_INIT_SCHED_TASK(_t, _f)	INIT_WORK((_t), (_f));
 
 #define ATH_WORK_THREAD			work_struct
 #define	ATH_FLUSH_TASKS			flush_scheduled_work
@@ -686,7 +686,7 @@
 void ath_resume(struct net_device *);
 void ath_suspend(struct net_device *);
 void ath_shutdown(struct net_device *);
-irqreturn_t ath_intr(int, void *, struct pt_regs *);
+irqreturn_t ath_intr(int, void *);
 int ath_ioctl_ethtool(struct ath_softc *, int, void __user *);
 void bus_read_cachesize(struct ath_softc *, u_int8_t *);
 #ifdef CONFIG_SYSCTL
diff -Naur madwifi-0.9.2.1.orig/ath_rate/amrr/amrr.c madwifi-0.9.2.1/ath_rate/amrr/amrr.c
--- madwifi-0.9.2.1.orig/ath_rate/amrr/amrr.c	2006-07-04 12:23:35.000000000 +0200
+++ madwifi-0.9.2.1/ath_rate/amrr/amrr.c	2007-02-05 15:43:27.000000000 +0100
@@ -43,7 +43,6 @@
  * "IEEE 802.11 Rate Adaptation: A Practical Approach" by
  *    Mathieu Lacage, Hossein Manshaei, Thierry Turletti
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -Naur madwifi-0.9.2.1.orig/ath_rate/onoe/onoe.c madwifi-0.9.2.1/ath_rate/onoe/onoe.c
--- madwifi-0.9.2.1.orig/ath_rate/onoe/onoe.c	2006-07-04 12:23:35.000000000 +0200
+++ madwifi-0.9.2.1/ath_rate/onoe/onoe.c	2007-02-05 15:43:27.000000000 +0100
@@ -39,7 +39,6 @@
 /*
  * Atsushi Onoe's rate control algorithm.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -Naur madwifi-0.9.2.1.orig/ath_rate/sample/sample.c madwifi-0.9.2.1/ath_rate/sample/sample.c
--- madwifi-0.9.2.1.orig/ath_rate/sample/sample.c	2006-07-04 12:23:35.000000000 +0200
+++ madwifi-0.9.2.1/ath_rate/sample/sample.c	2007-02-05 15:43:27.000000000 +0100
@@ -41,7 +41,6 @@
  * John Bicket's SampleRate control algorithm.
  */
 
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -Naur madwifi-0.9.2.1.orig/hal/linux/ah_osdep.c madwifi-0.9.2.1/hal/linux/ah_osdep.c
--- madwifi-0.9.2.1.orig/hal/linux/ah_osdep.c	2006-05-19 12:25:45.000000000 +0200
+++ madwifi-0.9.2.1/hal/linux/ah_osdep.c	2007-02-05 15:43:27.000000000 +0100
@@ -41,7 +41,6 @@
 #define	EXPORT_SYMTAB
 #endif
 
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
@@ -49,6 +48,7 @@
 #include <linux/kernel.h>
 #include <linux/slab.h>
 #include <linux/delay.h>
+#include <linux/jiffies.h>
 
 #include <linux/sysctl.h>
 #include <linux/proc_fs.h>
diff -Naur madwifi-0.9.2.1.orig/Makefile.inc madwifi-0.9.2.1/Makefile.inc
--- madwifi-0.9.2.1.orig/Makefile.inc	2006-07-14 07:15:56.000000000 +0200
+++ madwifi-0.9.2.1/Makefile.inc	2007-02-05 15:43:27.000000000 +0100
@@ -115,7 +115,7 @@
 
 # Determine target architecture of the kernel.
 ifeq (,$(ARCH_TARGET))
-ARCH_TARGET=$(shell $(DEPTH)/scripts/get_arch_target.sh $(KERNELCONF))
+ARCH_TARGET=$(shell $(obj)/$(DEPTH)/scripts/get_arch_target.sh $(KERNELCONF))
 ARCH ?= $(word 1,$(ARCH_TARGET))
 TARGET ?= $(word 2,$(ARCH_TARGET))
 endif
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_acl.c madwifi-0.9.2.1/net80211/ieee80211_acl.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_acl.c	2006-05-31 23:05:08.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_acl.c	2007-02-05 15:43:27.000000000 +0100
@@ -45,7 +45,6 @@
  * and if found the frame is either accepted (ACL_POLICY_ALLOW)
  * or rejected (ACL_POLICY_DENT).
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_beacon.c madwifi-0.9.2.1/net80211/ieee80211_beacon.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_beacon.c	2006-05-19 22:42:19.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_beacon.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
 /*
  * IEEE 802.11 beacon handling routines
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211.c madwifi-0.9.2.1/net80211/ieee80211.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211.c	2006-07-04 12:22:11.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
 /*
  * IEEE 802.11 generic handler
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_crypto.c madwifi-0.9.2.1/net80211/ieee80211_crypto.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_crypto.c	2006-02-01 21:07:11.000000000 +0100
+++ madwifi-0.9.2.1/net80211/ieee80211_crypto.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
 /*
  * IEEE 802.11 generic crypto support.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/kmod.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_crypto_ccmp.c madwifi-0.9.2.1/net80211/ieee80211_crypto_ccmp.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_crypto_ccmp.c	2006-06-13 16:09:51.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_crypto_ccmp.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
  * AP driver. The code is used with the consent of the author and
  * it's license is included below.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
@@ -297,17 +296,7 @@
 static void
 rijndael_encrypt(struct crypto_tfm *tfm, const void *src, void *dst)
 {
-	struct scatterlist sg_src;
-	struct scatterlist sg_dst;
-
-	sg_src.page = virt_to_page(src);
-	sg_src.offset = offset_in_page(src);
-	sg_src.length = AES_BLOCK_LEN;
-
-	sg_dst.page = virt_to_page(dst);
-	sg_dst.offset = offset_in_page(dst);
-	sg_dst.length = AES_BLOCK_LEN;
-	crypto_cipher_encrypt(tfm, &sg_dst, &sg_src, AES_BLOCK_LEN);
+	crypto_cipher_encrypt_one(tfm, dst, src);
 }
 
 /*
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_crypto_none.c madwifi-0.9.2.1/net80211/ieee80211_crypto_none.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_crypto_none.c	2006-02-01 21:07:11.000000000 +0100
+++ madwifi-0.9.2.1/net80211/ieee80211_crypto_none.c	2007-02-05 15:43:27.000000000 +0100
@@ -34,7 +34,6 @@
 /*
  * IEEE 802.11 NULL crypto support.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_crypto_tkip.c madwifi-0.9.2.1/net80211/ieee80211_crypto_tkip.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_crypto_tkip.c	2006-02-01 21:07:11.000000000 +0100
+++ madwifi-0.9.2.1/net80211/ieee80211_crypto_tkip.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
  * AP driver. The code is used with the consent of the author and
  * it's license is included below.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_crypto_wep.c madwifi-0.9.2.1/net80211/ieee80211_crypto_wep.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_crypto_wep.c	2006-02-06 21:20:57.000000000 +0100
+++ madwifi-0.9.2.1/net80211/ieee80211_crypto_wep.c	2007-02-05 15:43:27.000000000 +0100
@@ -34,7 +34,6 @@
 /*
  * IEEE 802.11 WEP crypto support.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_input.c madwifi-0.9.2.1/net80211/ieee80211_input.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_input.c	2006-07-06 05:23:08.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_input.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
 /*
  * IEEE 802.11 input handling.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_linux.c madwifi-0.9.2.1/net80211/ieee80211_linux.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_linux.c	2006-07-21 10:59:10.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_linux.c	2007-02-05 15:43:27.000000000 +0100
@@ -33,7 +33,6 @@
 /*
  * IEEE 802.11 support (Linux-specific code)
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/kmod.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_linux.h madwifi-0.9.2.1/net80211/ieee80211_linux.h
--- madwifi-0.9.2.1.orig/net80211/ieee80211_linux.h	2006-07-04 12:22:11.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_linux.h	2007-02-05 15:43:27.000000000 +0100
@@ -39,6 +39,7 @@
  * Deduce if tasklets are available.  If not then
  * fall back to using the immediate work queue.
  */
+#include <linux/fs.h>
 #include <linux/interrupt.h>
 #ifdef DECLARE_TASKLET			/* native tasklets */
 #define IEEE80211_TQ_STRUCT tasklet_struct
@@ -423,6 +424,7 @@
 #define CLONE_KERNEL	(CLONE_FS | CLONE_FILES | CLONE_SIGHAND)
 #endif
 
+#include <linux/mm.h>
 #ifndef offset_in_page
 #define	offset_in_page(p) ((unsigned long) (p) & ~PAGE_MASK)
 #endif
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_monitor.c madwifi-0.9.2.1/net80211/ieee80211_monitor.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_monitor.c	2006-04-21 18:57:59.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_monitor.c	2007-02-05 15:43:27.000000000 +0100
@@ -34,7 +34,6 @@
 /*
  * IEEE 802.11 monitor mode 
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/kmod.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_node.c madwifi-0.9.2.1/net80211/ieee80211_node.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_node.c	2006-06-13 10:50:37.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_node.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
 /*
  * IEEE 802.11 node handling support.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_output.c madwifi-0.9.2.1/net80211/ieee80211_output.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_output.c	2006-06-10 04:17:05.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_output.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
 /*
  * IEEE 802.11 output handling.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_power.c madwifi-0.9.2.1/net80211/ieee80211_power.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_power.c	2006-06-10 04:17:05.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_power.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
 /*
  * IEEE 802.11 power save support.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_proto.c madwifi-0.9.2.1/net80211/ieee80211_proto.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_proto.c	2006-06-09 22:41:19.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_proto.c	2007-02-05 15:43:27.000000000 +0100
@@ -38,7 +38,6 @@
 /*
  * IEEE 802.11 protocol support.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/kmod.h>
 #include <linux/module.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_scan_ap.c madwifi-0.9.2.1/net80211/ieee80211_scan_ap.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_scan_ap.c	2006-02-01 21:07:11.000000000 +0100
+++ madwifi-0.9.2.1/net80211/ieee80211_scan_ap.c	2007-02-05 15:43:27.000000000 +0100
@@ -37,7 +37,6 @@
 /*
  * IEEE 802.11 ap scanning support.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_scan.c madwifi-0.9.2.1/net80211/ieee80211_scan.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_scan.c	2006-04-21 18:57:59.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_scan.c	2007-02-05 15:43:27.000000000 +0100
@@ -37,7 +37,6 @@
 /*
  * IEEE 802.11 scanning support.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_scan_sta.c madwifi-0.9.2.1/net80211/ieee80211_scan_sta.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_scan_sta.c	2006-07-02 09:19:37.000000000 +0200
+++ madwifi-0.9.2.1/net80211/ieee80211_scan_sta.c	2007-02-05 15:43:27.000000000 +0100
@@ -37,7 +37,6 @@
 /*
  * IEEE 802.11 station scanning support.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/skbuff.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_wireless.c madwifi-0.9.2.1/net80211/ieee80211_wireless.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_wireless.c	2006-12-07 14:47:17.000000000 +0100
+++ madwifi-0.9.2.1/net80211/ieee80211_wireless.c	2007-02-05 15:43:27.000000000 +0100
@@ -39,7 +39,6 @@
 /*
  * Wireless extensions support for 802.11 common code.
  */
-#include <linux/config.h>
 
 #ifdef CONFIG_NET_WIRELESS
 #include <linux/version.h>
@@ -1555,10 +1554,10 @@
 	memcpy(p, leader, leader_len);
 	bufsize -= leader_len;
 	p += leader_len;
-	if (bufsize < ielen)
-		return 0;
-	for (i = 0; i < ielen && bufsize > 2; i++)
+	for (i = 0; i < ielen && bufsize > 2; i++) {
 		p += sprintf(p, "%02x", ie[i]);
+		bufsize -= 2;
+	}
 	return (i == ielen ? p - (u_int8_t *)buf : 0);
 }
 #endif /* WIRELESS_EXT > 14 */
diff -Naur madwifi-0.9.2.1.orig/net80211/ieee80211_xauth.c madwifi-0.9.2.1/net80211/ieee80211_xauth.c
--- madwifi-0.9.2.1.orig/net80211/ieee80211_xauth.c	2006-02-01 21:07:11.000000000 +0100
+++ madwifi-0.9.2.1/net80211/ieee80211_xauth.c	2007-02-05 15:43:27.000000000 +0100
@@ -46,7 +46,6 @@
  * of the available callbacks--the user mode authenticator process works
  * entirely from messages about stations joining and leaving.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -Naur madwifi-0.9.2.1.orig/net80211/if_media.c madwifi-0.9.2.1/net80211/if_media.c
--- madwifi-0.9.2.1.orig/net80211/if_media.c	2006-05-31 23:05:08.000000000 +0200
+++ madwifi-0.9.2.1/net80211/if_media.c	2007-02-05 15:43:27.000000000 +0100
@@ -49,7 +49,6 @@
 #define	EXPORT_SYMTAB
 #endif
 
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/kernel.h>
diff -Naur madwifi-0.9.2.1.orig/regression/ccmp/test_ccmp.c madwifi-0.9.2.1/regression/ccmp/test_ccmp.c
--- madwifi-0.9.2.1.orig/regression/ccmp/test_ccmp.c	2006-02-01 21:07:11.000000000 +0100
+++ madwifi-0.9.2.1/regression/ccmp/test_ccmp.c	2007-02-05 15:43:27.000000000 +0100
@@ -44,7 +44,6 @@
  * you want; e.g. insmod ccmp_test tests=7 will run only test mpdu's
  * 1, 2, and 3.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -Naur madwifi-0.9.2.1.orig/regression/tkip/test_tkip.c madwifi-0.9.2.1/regression/tkip/test_tkip.c
--- madwifi-0.9.2.1.orig/regression/tkip/test_tkip.c	2006-02-01 21:07:11.000000000 +0100
+++ madwifi-0.9.2.1/regression/tkip/test_tkip.c	2007-02-05 15:43:27.000000000 +0100
@@ -34,7 +34,6 @@
 /*
  * TKIP test module.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>
diff -Naur madwifi-0.9.2.1.orig/regression/wep/test_wep.c madwifi-0.9.2.1/regression/wep/test_wep.c
--- madwifi-0.9.2.1.orig/regression/wep/test_wep.c	2006-02-01 21:07:11.000000000 +0100
+++ madwifi-0.9.2.1/regression/wep/test_wep.c	2007-02-05 15:43:27.000000000 +0100
@@ -44,7 +44,6 @@
  * you want; e.g. insmod wep_test tests=7 will run only test mpdu's
  * 1, 2, and 3.
  */
-#include <linux/config.h>
 #include <linux/version.h>
 #include <linux/module.h>
 #include <linux/init.h>

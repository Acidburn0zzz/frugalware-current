# Last Modified: Tue, 26 Jul 2005 11:45:01 +0200
# Compiling Time: ~3 minutes
# Maintainer: Karoly CZOVEK  <slinky@rei.keni.hu>
# Contributor: VMiklos <vmiklos@frugalware.org>

pkgname=postfix
pkgver=2.2.5
pkgrel=2
vdaver=2.2.5
pkgdesc="A fast, easy to administer, and secure MTA"
url="http://www.postfix.org/"
depends=('db' 'pcre' 'cyrus-sasl' 'mysql')
provides=('mta')
groups=('network')
archs=('i686' 'x86_64')
backup=(etc/mail/{aliases,aliases.db} \
	etc/postfix/{main.cf,master.cf,virtual,canonical,generic,transport})
install="$pkgname.install"
mirror="http://www2.pcl.fr/mirrors/www.postfix.org/source"
up2date="lynx -dump $mirror/official/\?M=D|grep postfix-[0-9\.]*tar.gz$|sed -e 's|.*l/postfix-\(.*\)\.tar\.gz$|\1|'|sort -r |sed -e 'q'"
source=($mirror/official/$pkgname-$pkgver.tar.gz rc.$pkgname http://web.onda.com.br/nadal/postfix/VDA/postfix-$vdaver-vda.patch.gz)
#md5sums=('9c13d58494c64012bfd8ab0d6967305c' '469a3ba7df1e1e9e3f649a3d481657e6'\
#         '6fb8fdac842e561ca19cc1ed6cd9f810')
sha1sums=('5e86340e6ccff5a9141c259a6b65f72b7396483d' \
	  'd9965329e65d1722f06166bae79e473ef9a0ecc9' \
	  'fe0051d374d84f2a3607f2025a79766ff1a58b5e')

APPLY_PATCH_VDA=${APPLY_PATCH_VDA:1}
USE_FEATURE_SASL=${USE_FEATURE_SASL:1}
USE_BACKEND_MYSQL=${USE_BACKEND_MYSQL:1}


build()
{
	CCARGS="-DUSE_TLS -DHAS_MYSQL -I/usr/include/mysql -DUSE_SASL_AUTH -I/usr/include/sasl"
	AUXLIBS="-lz -lm -lpthread -L/usr/lib/mysql -lmysqlclient -L/usr/lib -lsasl2"
	
#	if [ $USE_BACKEND_MYSQL -eq 1 ]; then
#	    CCARGS="${CCARGS} -DUSE_MYSQL -I /usr/include/mysql "
#	    AUXLIBS="${AUXLIBS} -L/usr/lib/mysql -lmysqlclient "
#	fi
	
#	if [ $USE_FEATURE_SASL -eq 1 ];	then
#	    CCARGS="${CCARGS} -DUSE_SASL_AUTH -I /usr/include/sasl"
#	    AUXLIBS="${AUXLIBS} -L/usr/lib -lm -lz -lsasl2"
#	fi


	
#	if [ $APPLY_PATCH_VDA -eq 1 ]; then 
	    Fpatch postfix-$vdaver-vda.patch || return 1
#	fi

	Fcd	

#	make -f Makefile.init makefiles \
#	    CCARGS="${CCARGS}"  \
#	    AUXLIBS="${AUXLIBS}"

	make CCARGS="${CCARGS}" AUXLIBS="${AUXLIBS}" OPT="${CFLAGS}" makefiles
	
	make || return 1
	
	sh postfix-install -non-interactive \
		install_root="$Fdestdir" \
		daemon_directory="/usr/lib/$pkgname" \
		sample_directory="/etc/$pkgname/sample" \
		manpage_directory="/usr/man"
	
	# aliases
	Fsed '\(^#alias_maps = netinfo:/aliases$\)' '\1\nalias_maps = hash:/etc/postfix/aliases' $Fdestdir/etc/postfix/main.cf
	Fsed '\(^#alias_database = hash:/etc/aliases, hash:/opt/majordomo/aliases$\)' '\1\nalias_database = hash:/etc/postfix/aliases' $Fdestdir/etc/postfix/main.cf
	Frcd
}

# vim: ft=sh

# optimalization OK

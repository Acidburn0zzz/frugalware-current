# Last Modified: Sat, 17 Sep 2005 18:05:29 +0200
# Compiling Time: 2.66 SBU
# Maintainer: VMiklos <vmiklos@frugalware.org>

pkgname=samba
pkgver=3.0.20
pkgrel=2
pkgdesc="SMB file and print server"
url="http://www.samba.org"
backup=(etc/logrotate.d/samba)
depends=('heimdal' 'xfsprogs-attr' 'openldap' 'readline' 'popt')
makedepends=('cups')
groups=('network')
archs=('i686' 'x86_64')
install=$pkgname.install
up2date="lynx -dump 'http://hu.samba.org/samba/ftp/?M=D'|grep LATEST|sed -n -e 's/LATEST-IS-SAMBA-//' -e 's/-/\./g' -e '1 p'|tr -s ' '|cut -d ' ' -f 4|cut -d ] -f 2"
source=(http://ftp.samba.org/samba/ftp/stable/$pkgname-$pkgver.tar.gz samba.logrotate \
	rc.samba samba-3.0.20-hack-heimdal.patch)
sha1sums=('f67d0ba950ab6f0a2d3ece7687ab0b262645c022' \
	  '13fd371189bfe637f3f13c62d44d9e761268119e' \
	  '8c0676fcdf03d0264a4f7026c46b2cdf35f029a4' \
	  '5037b1f6412af9e14dc716d569cedabcfab42868')

build()
{
	unset MAKEFLAGS
	Fcd 
	### See bugzilla: https://bugzilla.samba.org/show_bug.cgi?id=2923
	Fpatch samba-3.0.20-hack-heimdal.patch 
	cd source
	Fmake --localstatedir=/var --bindir=/usr/bin \
        	--sbindir=/usr/sbin --with-lockdir=/var/cache/samba \
		--sysconfdir=/etc --with-configdir=/etc/samba \
		--with-privatedir=/etc/samba/private \
		--with-swatdir=/usr/share/swat \
	        --enable-cups --with-fhs --with-acl-support --with-automount \
		--with-smbmount --with-quotas --with-syslog --with-utmp \
		--with-libsmbclient --with-winbind || return 1
	
	gcc $CFLAGS $LDFLAGS client/mount.cifs.c -o bin/mount.cifs
	
	Fmkdir /var/spool /var/samba /var/log/samba /var/cache/samba
	Fmkdir /etc/samba/private
	chmod 700 $Fdestdir/etc/samba/private
	
	Fmakeinstall
	Fexe $pkgname-$pkgver/source/bin/mount.cifs /sbin/mount.cifs
	
	Fln samba/libsmbclient.so /usr/lib/libsmbclient.so
	Fln samba/libsmbclient.so /usr/lib/libsmbclient.so.0
	chmod 644 $Fdestdir/usr/include/*.h
	cat ../examples/smb.conf.default \
		| sed 's|log file = .*$|log file = /var/log/samba/log.%m|g' \
		>$Fdestdir/etc/samba/smb.conf.default
	Ffile samba.logrotate /etc/logrotate.d/samba
	Fln /usr/bin/smbmount /sbin/mount.smbfs
	
	Frcd
	
	# resolve conflicts with tdb
	Frm /usr/bin/tdbdump
}

# vim: ft=sh

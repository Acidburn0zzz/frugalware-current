# Compiling Time: 0.43 SBU
# Maintainer: voroskoi <voroskoi@frugalware.org>
# Contributor: Miklos Vajna <vmiklos@frugalware.org>

pkgname=samba
pkgver=4.3.1
pkgextraver=
pkgrel=1
pkgdesc="SMB file and print server."
url="http://www.samba.org"
backup=(etc/logrotate.d/$pkgname etc/sysconfig/$pkgname etc/$pkgname/smb.conf)
depends=('talloc' 'tdb' 'libldap' 'avahi' 'libcups' 'gamin')
makedepends=('docbook-xsl' 'docbook-xml' 'cups')
if [ "$CARCH" != "arm" ]; then
	makedepends=("${makedepends[@]}" "avahi")
fi
rodepends=("samba-client=$pkgver")
groups=('network')
archs=('i686' 'x86_64' 'arm')
up2date="Flasttar https://download.samba.org/pub/samba/stable"
source=(https://download.samba.org/pub/samba/stable/$pkgname-$pkgver$pkgextraver.tar.gz \
	samba.logrotate)
sha1sums=('6c29b17692e28995d3c2c89ce850894744640859' \
          '13fd371189bfe637f3f13c62d44d9e761268119e')
options=('scriptlet')

subpkgs=('libsmbclient' 'libwbclient' 'samba-client' 'nss-wins' 'nss-winbind')
subdescs=('SMB client library.' 'WinBind Client library.' 'SMB client tools.' 'WINS Lookup Support for NSS.' 'Winbind Lookup Support for NSS')
subdepends=('talloc' '' 'libarchive tdb libldap' '' '')
subrodepends=('' '' "libsmbclient=$pkgver libwbclient=$pkgver" "$pkgname=$pkgver" '')
subgroups=('lib' 'network' 'network' 'network' 'network')
subarchs=('i686 x86_64 arm' 'i686 x86_64 arm' 'i686 x86_64 arm' 'i686 x86_64 arm' 'i686 x86_64 arm')

_F_systemd_units=(nmb= smb= winbind=)
Finclude systemd

_samba4_idmap_modules=idmap_ad,idmap_rid,idmap_adex,idmap_hash,idmap_tdb2
_samba4_pdb_modules=pdb_tdbsam,pdb_ldap,pdb_ads,pdb_smbpasswd,pdb_wbc_sam,pdb_samba4
_samba4_auth_modules=auth_unix,auth_wbc,auth_server,auth_netlogond,auth_script,auth_samba4

Fconfopts="	--enable-fhs \
		--prefix=/usr \
		--libdir=/usr/lib \
		--enable-fhs \
		--with-sockets-dir=/var/run/samba \
		--with-piddir=/var/run \
		--localstatedir=/var \
                --bindir=/usr/bin \
                --sbindir=/usr/sbin \
                --with-lockdir=/var/cache/samba \
                --sysconfdir=/etc \
                --with-configdir=/etc/samba \
                --with-privatedir=/etc/samba/private \
                --enable-cups \
                --with-acl-support \
                --with-automount \
                --with-quotas \
                --with-syslog \
                --with-winbind \
                --with-utmp \
		--with-ldap \
                --with-winbind \
		--enable-gnutls \
		--with-pam \
		--with-pammodulesdir=/lib/security \
		--with-shared-modules=${_samba4_idmap_modules},${_samba4_pdb_modules},${_samba4_auth_modules}
		--disable-rpath-install \
		--with-systemd"

build()
{
	Fcd
	Fmake

	Fmakeinstall DESTDIR=$Fdestdir

	# Install manpages
	Fmanrel docs/manpages/*

	# Install systemd services
	Fmkdir /lib/systemd/system/
	for i in nmb samba smb winbind; do
		Ffile $pkgname-$pkgver/packaging/systemd/$i.service /lib/systemd/system/
	done

	# smb.conf
	Fsed 'log file = .*$' 'log file = /var/log/samba/log.%m' examples/smb.conf.default
	Ffilerel examples/smb.conf.default /etc/samba/smb.conf

	Ffile samba.logrotate /etc/logrotate.d/samba

	# Split
        Fsplit libsmbclient usr/include/samba-4.0/libsmbclient.h
        Fsplit libsmbclient usr/lib/libsmbclient*
        Fsplit libsmbclient usr/lib/pkgconfig/smbclient*

	Fsplit libwbclient usr/include/samba-4.0/wbclient.h
        Fsplit libwbclient usr/lib/libwbclient*
        Fsplit libwbclient usr/lib/pkgconfig/wbclient.pc

	for i in smbclient nmblookup; do
		Fsplit samba-client usr/bin/$i
		Fsplit samba-client usr/share/man/man1/$i.1
	done
	for i in net smbspool; do
		Fsplit samba-client usr/bin/$i
		Fsplit samba-client usr/share/man/man8/$i.8
	done

	Fsplit nss-wins usr/lib/libnss_wins.so
	Fsplit nss-winbind usr/lib/libnss_winbind.so

	Fgenscriptlet
}

# optimization OK

# Compiling Time: 6.88 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=openmpi
pkgver=2.1.1
pkgrel=1
pkgdesc="A high-performance message passing library"
url="http://www.open-mpi.org/"
depends=('libstdc++>=6.3.1-4' 'zlib>=1.2.11-2')
makedepends=('gcc-gfortran>=6.3.1-4')
groups=('lib-extra')
archs=('x86_64')
backup=("etc/$pkgname/{openmpi-mca-params.conf,openmpi-default-hostfile}")
up2date="Fwcat $url| grep -a -v "rc[0-9]" | grep -o -m 1 'Open MPI v\(.*\) released' | sed 's/.*v\(.*\) re.*/\1/'"
_F_archive_grepv="rc"
source=(http://www.open-mpi.org/software/ompi/v2.1/downloads/$pkgname-$pkgver.tar.bz2)
sha1sums=('3aaee35c17b6ef02f4cee274f2670d5b7b2c968a')

replaces=("$pkgname-fortran")
conflicts=("$pkgname-fortran")
provides=("$pkgname-fortran")
Fconfopts+=" --sysconfdir=/etc/$pkgname \
                --libdir=/usr/lib/$pkgname \
                --with-threads=posix \
                --enable-mpi-threads \
                --enable-progress-threads \
                --enable-smp-locks \
                --enable-pretty-print-stacktrace"

build()
{
	Fbuild

	# Add ld.so.conf.d entry
	Fmkdir "etc/ld.so.conf.d"
	echo /usr/lib/openmpi >"$Fdestdir/etc/ld.so.conf.d/openmpi.conf" || Fdie

	Fmkdir /usr/lib/pkgconfig
	for i in ompi-c.pc ompi-cxx.pc ompi-f77.pc ompi-f90.pc ompi.pc; do
		Fln /usr/lib/openmpi/pkgconfig/$i /usr/lib/pkgconfig/$i
	done
}

# optimization OK

# Compiling Time: 26.46 SBU
# Maintainer: DeX77 <dex77@frugalware.org>


pkgname=chromium-browser
pkgver=53.0.2785.143
pkgrel=2
pkgdesc='An open-source browser project that aims to build a safer, faster, and more stable way for all users to experience the web'
url='http://www.chromium.org/'
depends=('libevent>=2.0.22-3' 'nss>=3.26' 'libxscrnsaver>=1.2.2-2' 'libpulse>=9.0-2' 'snappy>=1.1.3-3' 'libcups>=2.2.0-2' \
	'speech-dispatcher>=0.8.5' 'gdk-pixbuf2>=2.32.3-2' 'libxtst>=1.2.2-2' 'libjpeg>=9a-2' 'libatomic>=6.2.1-5' 'pciutils>=3.5' \
	'opus>=1.1.3-2' 'ffmpeg>=3.1.3' 'libxslt' 'libwebp>=0.5.1-2' 'libgles>=12.0.3-3' 'libegl>=12.0.3-3' 'gtk+3>=3.22.0')
makedepends=('ninja' 'gtk+2' 'yasm' 'libexif' 'gperf' 'libpthread-stubs' 'x11-protos' 'krb5>=1.14.4' 'cups>=2.2.0-2' 'mesa>=12.0.3-3')

[ "$CARCH" == "x86_64" ] && makedepends+=('lib32-libstdc++>=6.2.1_5' 'lib32-zlib>=1.2.8_8')

license=('BSD')
groups=('xapps-extra')
archs=('i686' 'x86_64')
_F_gnome_iconcache="y"
Finclude gnome-scriptlet
_F_archive_name="chromium"
options+=('nostrip')
up2date="lynx -dump -useragent='Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_0) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.79 Safari/537.1' \
	'http://chromium.woolyss.com/#stable-chromium-version' | \
	egrep -o '([0123456789.]*)/DEPS' | \
	egrep -o '([0123456789.]*)'"
source=(https://commondatastorage.googleapis.com/chromium-browser-official/chromium-${pkgver}.tar.xz \
        $pkgname.desktop \
        $pkgname.sh \
	jpeg9.patch \
 	chromium-last-commit-position-r0.patch \
 	chromium-system-ffmpeg-r2.patch \
 	chromium-52.0.2743.82-widevinefix.patch \
 	chromium-46.0.2490.86-use_system_opus.patch \
 	chromium-52.0.2723.2-use_system_harfbuzz.patch \
	chromium-47.0.2526.80-nacl-ignore-broken-fd-counter.patch \
	chromium-52.0.2743.82-cups22.patch \
	chromium-52.0.2743.116-unset-madv_free.patch \
	gcc6-no-delete-null-pointer-checks.patch)

sha1sums=('9dfeeefde83b399f832e2485838977cbd2d4376e' \
          '264b8e7c4e3273263d504e041e5e4d152677922c' \
          '4c41d59b4d85a9f0443d6ca1dec456e50059dab5' \
          '95b850e2d22f3d42a25e33edfea549cf1bc5ab33' \
          '0db176bb4b6175b408f75b0644d38b5229bd113c' \
          '450cd81653499eb50f0f7df1b0d4d1c1620365a5' \
          '452ca515e91ff27957ee1b5dfd975f2daabc5b64' \
          'd6d09996ff5ff4d796cf26f239eb2b688e017d25' \
          '4ac2af324c6927507d214ba3b6512ad1a879a2ff' \
          'af663b4b7a7a9e6f0075c4f60f0b4310a77d2d89' \
          '281ef7c51b733765b741d69b78e7d74ec6cb328a' \
          '17ba326edbd5df0aba71958d9eea56ba9653c995' \
          '0fa01f6ac92d4616cdc74073952ada2259be1d70')

## -fno-delete-null-pointer-checks for gcc6 DO NOT REMOVE also not remove the gcc6-* patch
## add some -Wno-* gcc6 produces a lot noise and we don't care about deprectaed stuff
CXXFLAGS+=" -fpermissive -fno-delete-null-pointer-checks -Wno-deprecated -Wno-deprecated-declarations"

# Google API keys (see http://www.chromium.org/developers/how-tos/api-keys)
# Note: These are for Frugalware use ONLY. For your own distribution, please
# get your own set of keys. Feel free to contact dex77@frugalware.org for
# more information.
_google_api_key="AIzaSyDBY0Wxey1VCsW8fP6j7oJy_-ojnpYMh2o"
_google_default_client_id="63071405569.apps.googleusercontent.com"
_google_default_client_secret="2bNvMsN-57D44Q5ireW62LcZ"

build() {

	## out-of-mem workaround for genesis32 maybe
	if [ "$CARCH" == "i686" ]; then
		unset MAKEFLAGS
		export MAKEFLAGS="-j1"
                LDFLAGS+=" -Wl,--no-keep-memory -Wl,--reduce-memory-overheads"
        fi

	LDFLAGS+=" -Wl,-rpath,/usr/lib/chromium,-rpath,/usr/lib/chromium/lib"

        Fcd
	if [ $CARCH == x86_64 ]; then
		Fexec python build/download_nacl_toolchains.py \
			--packages nacl_x86_newlib,pnacl_newlib,pnacl_translator \
			--exclude nacl_arm_newlib --arch=x86-64 sync || Fdie

		## 2 steps , don't ask me
		Fexec python build/download_nacl_toolchains.py \
                        --packages nacl_x86_newlib,pnacl_newlib,pnacl_translator \
                        --exclude nacl_arm_newlib --arch=x86-64 extract || Fdie
	fi

	Fpatchall

	Fexec touch chrome/test/data/webui/i18n_process_css_test.html

	# Google API stuff
	myconf+="	-Dgoogle_api_key=$_google_api_key
			-Dgoogle_default_client_id=$_google_default_client_id
			-Dgoogle_default_client_secret=$_google_default_client_secret"

	# System libs
	myconf+="       -Duse_system_bzip2=1
			-Duse_system_flac=1
			-Duse_system_ffmpeg=1
			-Duse_system_harfbuzz=1
			-Duse_system_libevent=1
			-Duse_system_libjpeg=1
			-Duse_system_libpng=1
			-Duse_system_libxml=1
			-Duse_system_snappy=1
			-Duse_system_ssl=1
			-Duse_system_xdg_utils=1
			-Duse_system_yasm=1
			-Duse_system_zlib=1
			-Duse_system_libexif=1
			-Duse_system_protobuf=0
			-Duse_system_yasm=1
			-Duse_system_sqlite=0
			-Duse_system_fontconfig=1
			-Duse_system_expat=1
			-Duse_system_jsoncpp=1
			-Duse_system_libevent=1
			-Duse_system_libusb=1
			-Duse_system_libvpx=1
			-Duse_system_libwebp=1
			-Duse_system_libxnvctrl=0
			-Duse_system_libxslt=1
			-Duse_system_re2=0
			-Duse_system_v8=0
			-Duse_system_minizip=1
			-Duse_system_opus=1"

	# Linkage
	myconf+="	-Dlinux_link_gsettings=1
			-Dlinux_link_libpci=1
			-Dlinux_link_libspeechd=1
			-Dlinux_link_pulseaudio=1"
	# FFmpeg
	myconf+="	-Dffmpeg_branding=Chromium
			-Denable_widevine=1
			-Denable_pepper_cdms=1
			-Denable_webrtc=1
			-Dbuild_ffmpegsumo=1
			-Dffmpeg_component=shared_library
			-Dproprietary_codecs=1"

	# Like official
	myconf+="	-Dlogging_like_official_build=1
			-Dtracing_like_official_build=1
			-Dfieldtrial_testing_like_official_build=1"

	# Misc
	myconf+="	-Dwerror=
			-Dpython_ver=2.7
			-Dremove_webcore_debug_symbols=1
			-Dlinux_strip_binary=1
			-Dlinux_use_bundled_binutils=0
			-Dlinux_use_bundled_gold=0
			-Duse_gnome_keyring=0
			-Denable_webrtc=1
			-Duse_aura=1
			-Dcomponent=shared_library
			-Dno_strict_aliasing=1
			-Dv8_no_strict_aliasing=1
			-Dv8_no_delete_null_pointer_checks=1
			-Duse_gtk3=1
			-Denable_hidpi=1
			-Denable_hotwording=0
			-Dlinux_fpic=1
			-Denable_touch_ui=1
			-Duse_pulseaudio=1
			-Dusb_ids_path=/usr/share/hwdata/usb.ids
			-Duse_mojo=0
			-Duse_gconf=0
			-Duse_sysroot=0
			-Denable_hangout_services_extension=1
			-Ddisable_fatal_linker_warnings=1
			-Dlibspeechd_h_prefix=speech-dispatcher/
			-Dclang=0
			-Dgenerate_character_data=0
			-Ddisable_glibc=1"

	# Always disable NaCl for i686
	if [ $CARCH == i686 ]; then
		myconf+="	-Ddisable_nacl=1
				-Ddisable_pnacl=1"
	fi

	Fexec build/linux/unbundle/replace_gyp_files.py $myconf -Drelease_extra_cflags="$CFLAGS" || Fdie

	Fexec ./build/gyp_chromium --no-parallel --depth .  $myconf || Fdie
	Fexec ninja -v -C out/Release chrome chrome_sandbox || Fdie

	strip -s out/Release/chrome
	strip -s out/Release/chrome_sandbox
	strip -s out/Release/lib/*.so

	Fmkdir usr/lib/chromium
        Fexerel out/Release/chrome usr/lib/chromium/chromium
        Finstallrel 4755 out/Release/chrome_sandbox usr/lib/chromium/chrome-sandbox
	Ffileschown usr/lib/chromium/chrome-sandbox root root

	Fcprel out/Release/\*.pak usr/lib/chromium/
	Fcprel out/Release/locales usr/lib/chromium/
	Fcprel out/Release/resources usr/lib/chromium/
	Fcprel out/Release/libwidevinecdmadapter.so usr/lib/chromium/
	Fcprel out/Release/lib usr/lib/chromium/

	Frm usr/lib/chromium/lib/*.TOC #WTF!?
	Frm usr/lib/chromium/lib/*.tmp

	if [  $CARCH != i686 ]; then
	    	Fcprel out/Release/nacl_helper usr/lib/chromium/
		Fcprel out/Release/nacl_helper_bootstrap usr/lib/chromium/
		Fcprel out/Release/nacl_irt_*.nexe usr/lib/chromium/
	fi

	Fcprel out/Release/icudtl.dat usr/lib/chromium/

        find $Fdestdir/usr/lib/chromium/ -name '*.d' -type f -delete
        Finstallrel 644 out/Release/chrome.1 usr/share/man/man1/chromium.1

        Finstall 644 $pkgname.desktop usr/share/applications/$pkgname.desktop

	for size in 22 24 48 64 128 256; do
		Finstallrel 644 "chrome/app/theme/chromium/product_logo_$size.png" \
		"usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
               	done

	for size in 16 32; do
		Finstallrel 644 "chrome/app/theme/default_100_percent/chromium/product_logo_$size.png" \
		"usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
	done

	Finstallrel 644 out/Release/natives_blob.bin usr/lib/chromium
	Finstallrel 644 out/Release/snapshot_blob.bin usr/lib/chromium

	Fdirschmod usr/lib/chromium/locales 755

        Fexe $pkgname.sh usr/bin/$pkgname

        Fdocrel LICENSE
	Fbuild_gnome_scriptlet
}

# optimization OK

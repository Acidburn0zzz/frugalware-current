# Compiling Time: 0.08 SBU
# Maintainer: VMiklos <vmiklos@frugalware.org>
# Contributor: AlexExtreme <alex@alex-smith.me.uk>

pkgname=kvm
pkgver=56
pkgrel=1
pkgdesc="KVM is a kernel based virtual machine"
url="http://kvm.sourceforge.net"
groups=('xapps-extra')
archs=('i686')
Finclude sourceforge kernel-version
depends=("kernel>=$_F_kernelver_ver" 'sdl' 'zlib')
makedepends=("kernel-source>=$_F_kernelver_ver" 'gcc-3.3')
sha1sums=('25829c90a26003f1c2b62af5fdb9db913dd63f28')
Fconfopts="--prefix=$Fprefix"

# no changelog in the tarball, you can reach it here:
# http://kvm.qumranet.com/kvmwiki/ChangeLog

# i took this package as i maintain qemu, too but i don't have a kvm-able
# machine, so if you want to take this package, feel free to contact me

build() {
	Fsed 'datadir="$prefix/share/qemu"' 'datadir="$prefix/share/qemu-kvm"' \
		qemu/configure
	Fconf --with-patched-kernel --qemu-cc="/usr/bin/gcc-3.3"
	
	sed -i '/depmod -a/d' kernel/Makefile
	make || Fdie
	Fmakeinstall KERNELDIR=/usr/src/linux
	Frm /usr/include/linux
	
	# this hardwired x86_64 is so misleading..
	Fmv /usr/bin/qemu-system-x86_64 /usr/bin/qemu-kvm
	Fmv /usr/bin/qemu-img /usr/bin/qemu-img-kvm
}

# optimization OK

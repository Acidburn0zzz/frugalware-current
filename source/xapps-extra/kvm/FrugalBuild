# Compiling Time: 0.08 SBU
# Maintainer: AlexExtreme <alex@alex-smith.me.uk>

pkgname=kvm
pkgver=17
pkgrel=1
pkgdesc="KVM is a kernel based virtual machine"
url="http://kvm.sourceforge.net"
groups=('xapps-extra')
archs=('i686')
Finclude sourceforge kernel-version
depends=("kernel>=$_F_kernelver_ver" 'sdl' 'zlib')
makedepends=("kernel-source>=$_F_kernelver_ver" 'gcc-3.3')
up2date="lynx -dump http://kvm.qumranet.com/kvmwiki/Downloads | grep 'Linux $_F_kernelver_ver require' | sed 's/.*kvm-//' | sed 's/\..*//'"
sha1sums=('ac80a36b5eacafc4880f8f07c24d164906f5d5ce')
Fconfopts="--prefix=$Fprefix"

build() {
	Fconf --with-patched-kernel --qemu-cc="/usr/bin/gcc-3.3"
	
	sed -i 's/\/usr\/share\/qemu/\/usr\/share\/qemu-kvm/' qemu/config-host.h
	sed -i 's/\/usr\/share\/qemu/\/usr\/share\/qemu-kvm/' qemu/config-host.mak
	sed -i 's/\/usr\/share\/doc\/qemu/\/usr\/share\/doc\/qemu-kvm/' qemu/config-host.mak
	
	sed -i '/depmod -a/d' kernel/Makefile
	make || Fdie
	Fmakeinstall
	
	Fmv /usr/bin/qemu /usr/bin/qemu-kvm
	Fmv /usr/bin/qemu-img /usr/bin/qemu-img-kvm
}

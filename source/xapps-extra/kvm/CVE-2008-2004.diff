From: Chris Wright <chrisw@redhat.com>
Subject: [PATCH] add format= to drive options

A guest with a raw format disk can write any format header to that device.
A subsequent restart of the guest will cause qemu to interpret the format
header and could allow the guest read access to any host file.  Add a
format= drive option to allow host to specify, e.g. format=raw, to give
qemu a hint to choose a specific block format driver.  Originially noted
by Avi Kivity <avi@qumranet.com>.

Signed-off-by: Chris Wright <chrisw@redhat.com>
---
 qemu/qemu-doc.texi |    4 ++++
 qemu/vl.c          |   13 +++++++++++--
 2 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/qemu/qemu-doc.texi b/qemu/qemu-doc.texi
index b9ab492..783d977 100644
--- a/qemu/qemu-doc.texi
+++ b/qemu/qemu-doc.texi
@@ -260,6 +260,10 @@ These options have the same definition as they have in @option{-hdachs}.
 @var{snapshot} is "on" or "off" and allows to enable snapshot for given drive (see @option{-snapshot}).
 @item cache=@var{cache}
 @var{cache} is "on" or "off" and allows to disable host cache to access data.
+@item format=@var{format}
+Specify which disk @var{format} will be used rather than detecting
+the format.  Can be used to specifiy format=raw to avoid interpreting
+an untrusted format header.
 @end table
 
 Instead of @option{-cdrom} you can use:
diff --git a/qemu/vl.c b/qemu/vl.c
index b425ab5..10181e8 100644
--- a/qemu/vl.c
+++ b/qemu/vl.c
@@ -5079,6 +5079,7 @@ int drive_init(struct drive_opt *arg, int snapshot,
     int bus_id, unit_id;
     int cyls, heads, secs, translation;
     BlockDriverState *bdrv;
+    BlockDriver *drv = NULL;
     int max_devs;
     int index;
     int cache;
@@ -5087,7 +5088,7 @@ int drive_init(struct drive_opt *arg, int snapshot,
     char *str = arg->opt;
     char *params[] = { "bus", "unit", "if", "index", "cyls", "heads",
                        "secs", "trans", "media", "snapshot", "file",
-                       "cache", "boot", NULL };
+                       "cache", "boot", "format", NULL };
 
     if (check_params(buf, sizeof(buf), params, str) < 0) {
          fprintf(stderr, "qemu: unknown parameter '%s' in '%s'\n",
@@ -5271,6 +5272,14 @@ int drive_init(struct drive_opt *arg, int snapshot,
 	}
     }
 
+    if (get_param_value(buf, sizeof(buf), "format", str)) {
+	drv = bdrv_find_format(buf);
+	if (!drv) {
+	    fprintf(stderr, "qemu: '%s' invalid format\n", buf);
+	    return -1;
+	}
+    }
+
     if (arg->file == NULL)
         get_param_value(file, sizeof(file), "file", str);
     else
@@ -5376,7 +5385,7 @@ int drive_init(struct drive_opt *arg, int snapshot,
         bdrv_flags |= BDRV_O_SNAPSHOT;
     if (!cache)
         bdrv_flags |= BDRV_O_DIRECT;
-    if (bdrv_open(bdrv, file, bdrv_flags) < 0 || qemu_key_check(bdrv, file)) {
+    if (bdrv_open2(bdrv, file, bdrv_flags, drv) < 0 || qemu_key_check(bdrv, file)) {
         fprintf(stderr, "qemu: could not open disk image %s\n",
                         file);
         return -1;

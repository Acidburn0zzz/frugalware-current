Description: Fix stack-based buffer overflow
 CVE-2014-0978: Fix stack-based buffer overflow due to a boundary error
 in the "yyerror()" function.
Origin: upstream, https://github.com/ellson/graphviz/commit/7aaddf52cd98589fb0c3ab72a393f8411838438a
 https://github.com/ellson/graphviz/commit/d266bb2b4154d11c27252b56d86963aef4434750
Bug-Debian: http://bugs.debian.org/734745
Bug-Gentoo: https://bugs.gentoo.org/show_bug.cgi?id=497274
Bug-RedHat: https://bugzilla.redhat.com/show_bug.cgi?id=1049165
Forwarded: not-needed
Author: Salvatore Bonaccorso <carnil@debian.org>
Last-Update: 2014-01-11

--- a/lib/cgraph/scan.l
+++ b/lib/cgraph/scan.l
@@ -19,6 +19,7 @@
 %{
 #include <grammar.h>
 #include <cghdr.h>
+#include <agxbuf.h>
 #include <ctype.h>
 #define GRAPH_EOF_TOKEN		'@'		/* lex class must be defined below */
 	/* this is a workaround for linux flex */
@@ -193,13 +194,22 @@
 %%
 void yyerror(char *str)
 {
+	unsigned char	xbuf[BUFSIZ];
 	char	buf[BUFSIZ];
-	if (InputFile)
-		sprintf(buf,"%s:%d: %s in line %d near '%s'\n",InputFile, line_num,
-			str,line_num,yytext);
-	else
-		sprintf(buf," %s in line %d near '%s'\n", str,line_num,yytext);
-	agerr(AGWARN,buf);
+	agxbuf  xb;
+
+	agxbinit(&xb, BUFSIZ, xbuf);
+	if (InputFile) {
+		agxbput (&xb, InputFile);
+		agxbput (&xb, ": ");
+	}
+	agxbput (&xb, str);
+	sprintf(buf," in line %d near '", line_num);
+	agxbput (&xb, buf);
+	agxbput (&xb, yytext);
+	agxbput (&xb,"'\n");
+	agerr(AGWARN,agxbuse(&xb));
+	agxbfree(&xb);
 }
 /* must be here to see flex's macro defns */
 void aglexeof() { unput(GRAPH_EOF_TOKEN); }

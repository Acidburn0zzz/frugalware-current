# Compiling Time: 26.46 SBU
# Maintainer: Marius Cirsta <mcirsta@frugalware.org>

pkgname=chromium-dev
pkgver=54.0.2832.2
pkgrel=3
pkgdesc='Development version of Chromium browser'
url='http://www.chromium.org/'
depends=('libevent>=2.0.22-3' 'nss>=3.21-3' 'libxscrnsaver>=1.2.2-2' 'libpulse>=7.1-4' 'snappy>=1.1.3-2' 'libcups' \
	'speech-dispatcher>=0.7.1-4' 'libxtst>=1.2.2-2' 'libjpeg>=9a' 'freetype2' 'pango' 'ffmpeg' 'atk' 'libxkbcommon' \
	'libatomic' 'pciutils>=3.5' 'gtk+3' 'libxslt' 'libwebp')
makedepends=('ninja' 'clang>=3.7.0-3' 'yasm' 'libexif' 'gperf' 'libpthread-stubs' 'x11-protos' 'krb5' 'cups' \
             'python-ply' 'python-jinja' 'python-markupsafe' 'beautifulsoup4' 'html5lib-python' 'webencodings' 'protobuf-python')
license=('BSD')
groups=('xapps-extra')
archs=('i686' 'x86_64')
_F_gnome_iconcache="y"
Finclude gnome-scriptlet
_F_archive_name="chromium"
up2date="Flastarchive https://github.com/zcbenz/chromium-source-tarball/releases .tar.xz"
source=(https://commondatastorage.googleapis.com/chromium-browser-official/chromium-${pkgver}.tar.xz \
        $pkgname.desktop \
        $pkgname.sh \
        chromium-system-jinja-r13.patch \
        chromium-system-ffmpeg-r3.patch \
        jpeg9.patch \
        gtk2_disable_fix.patch \
        chromium-last-commit-position-r1.patch)
sha1sums=('b429111875a4a96217002375ad5e02878de9fe73' \
          'd05b07f1d37ba20cfa7811e117e5efc95c93e0ca' \
          '7b4b96c7150f3499cc02b8caeea73d28548dabd9' \
          'c121b8ab729efc99040a2908d763110428c62b72' \
          '4d615c06c61388d6d981702c2c8291544e098464' \
          '95b850e2d22f3d42a25e33edfea549cf1bc5ab33' \
          'f67ed24248c0ec152908d8c206c0efebe2a92997' \
          'd03e6465cd5a84580f9dad5d45f24ccd42bb71e6')

conflicts=('chromium-browser')

# Google API keys (see http://www.chromium.org/developers/how-tos/api-keys)
# Note: These are for Frugalware use ONLY. For your own distribution, please
# get your own set of keys. Feel free to contact dex77@frugalware.org for
# more information.
_google_api_key='AIzaSyDBY0Wxey1VCsW8fP6j7oJy_-ojnpYMh2o'
_google_default_client_id='63071405569.apps.googleusercontent.com'
_google_default_client_secret='2bNvMsN-57D44Q5ireW62LcZ'


build() {
    Fcd
	Fpatchall

	conditional_bundled_libraries+="
			base/third_party/libevent \
			third_party/adobe \
			third_party/speech-dispatcher \
			third_party/usb_ids \
			third_party/xdg-utils \
			third_party/yasm/run_yasm.py "

# Remove most bundled libraries. Some are still needed.
	Fexec build/linux/unbundle/remove_bundled_libraries.py \
		${conditional_bundled_libraries} \
		'base/third_party/dmg_fp' \
		'base/third_party/dynamic_annotations' \
        'base/third_party/icu' \
		'base/third_party/nspr' \
		'base/third_party/superfasthash' \
		'base/third_party/symbolize' \
		'base/third_party/valgrind' \
		'base/third_party/xdg_mime' \
		'base/third_party/xdg_user_dirs' \
		'breakpad/src/third_party/curl' \
		'chrome/third_party/mozilla_security_manager' \
		'courgette/third_party' \
		'net/third_party/mozilla_security_manager' \
		'net/third_party/nss' \
		'third_party/WebKit' \
		'third_party/analytics' \
		'third_party/angle' \
		'third_party/angle/src/common/third_party/numerics' \
		'third_party/angle/src/third_party/compiler' \
		'third_party/angle/src/third_party/libXNVCtrl' \
		'third_party/angle/src/third_party/murmurhash' \
		'third_party/angle/src/third_party/trace_event' \
		'third_party/boringssl' \
		'third_party/brotli' \
		'third_party/cacheinvalidation' \
		'third_party/catapult' \
		'third_party/catapult/third_party/polymer' \
		'third_party/catapult/third_party/py_vulcanize' \
		'third_party/catapult/third_party/py_vulcanize/third_party/rcssmin' \
		'third_party/catapult/third_party/py_vulcanize/third_party/rjsmin' \
		'third_party/catapult/tracing/third_party/d3' \
		'third_party/catapult/tracing/third_party/gl-matrix' \
		'third_party/catapult/tracing/third_party/jszip' \
		'third_party/catapult/tracing/third_party/mannwhitneyu' \
		'third_party/ced' \
		'third_party/cld_2' \
		'third_party/cld_3' \
		'third_party/cros_system_api' \
		'third_party/cython/python_flags.py' \
		'third_party/devscripts' \
		'third_party/dom_distiller_js' \
		'third_party/fips181' \
		'third_party/flatbuffers' \
		'third_party/flot' \
		'third_party/google_input_tools' \
		'third_party/google_input_tools/third_party/closure_library' \
		'third_party/google_input_tools/third_party/closure_library/third_party/closure' \
		'third_party/hunspell' \
		'third_party/iccjpeg' \
		'third_party/icu' \
		'third_party/jstemplate' \
		'third_party/khronos' \
		'third_party/leveldatabase' \
		'third_party/libXNVCtrl' \
		'third_party/libaddressinput' \
		'third_party/libjingle' \
		'third_party/libphonenumber' \
		'third_party/libsecret' \
		'third_party/libsrtp' \
		'third_party/libudev' \
		'third_party/libusb' \
		'third_party/libwebm' \
		'third_party/libxml/chromium' \
		'third_party/libyuv' \
		'third_party/lss' \
		'third_party/lzma_sdk' \
		'third_party/mesa' \
		'third_party/modp_b64' \
		'third_party/mt19937ar' \
		'third_party/openh264' \
		'third_party/openmax_dl' \
		'third_party/opus' \
		'third_party/ots' \
		'third_party/pdfium' \
		'third_party/pdfium/third_party/agg23' \
		'third_party/pdfium/third_party/base' \
		'third_party/pdfium/third_party/bigint' \
		'third_party/pdfium/third_party/freetype' \
		'third_party/pdfium/third_party/lcms2-2.6' \
		'third_party/pdfium/third_party/libjpeg' \
		'third_party/pdfium/third_party/libopenjpeg20' \
		'third_party/pdfium/third_party/libpng16' \
		'third_party/pdfium/third_party/libtiff' \
		'third_party/pdfium/third_party/zlib_v128' \
		'third_party/polymer' \
		'third_party/protobuf' \
		'third_party/protobuf/third_party/six' \
		'third_party/qcms' \
		'third_party/re2' \
		'third_party/sfntly' \
		'third_party/skia' \
		'third_party/smhasher' \
		'third_party/sqlite' \
		'third_party/tcmalloc' \
		'third_party/usrsctp' \
		'third_party/web-animations-js' \
		'third_party/webdriver' \
		'third_party/webrtc' \
		'third_party/widevine' \
		'third_party/woff2' \
		'third_party/x86inc' \
		'third_party/zlib/google' \
		'url/third_party/mozilla' \
		'v8/src/third_party/valgrind' \
		--do-remove


	gn_system_libraries="
		flac
		harfbuzz-ng
		libevent
		libpng
		libvpx
		libwebp
		libxml
		libxslt
		snappy
		yasm
		zlib
		ffmpeg"

	Fexec build/linux/unbundle/replace_gn_files.py --system-libraries ${gn_system_libraries}

	Fexec touch chrome/test/data/webui/i18n_process_css_test.html

	Fexec third_party/libaddressinput/chromium/tools/update-strings.py

	myconf_gn+=" is_debug=false"
#   myconf_gn+=" is_debug=true"
    myconf_gn+=" enable_iterator_debugging=false"
    myconf_gn+=" enable_nacl=false"
    myconf_gn+=" symbol_level=0 remove_webcore_debug_symbols=true"

	myconf_gn+=" enable_hangout_services_extension=false"
	myconf_gn+=" enable_widevine=false"
	myconf_gn+=" use_allocator=\"none\""
	myconf_gn+=" use_cups=true"
	myconf_gn+=" use_kerberos=true"
	myconf_gn+=" use_pulseaudio=true"
	myconf_gn+=" fieldtrial_testing_like_official_build=true"
    myconf_gn+=" is_clang=false"
	myconf_gn+=" use_gold=false use_sysroot=false"
	myconf_gn+=" proprietary_codecs=true "
	myconf_gn+=" use_atk=false "
	myconf_gn+=" use_gconf=false "
	myconf_gn+=" use_gio=false "
	myconf_gn+=" use_gnome_keyring=false"
#   myconf_gn+=" use_ozone=true "
#   myconf_gn+=" use_aura=true "
    myconf_gn+=" use_glib=true "
    myconf_gn+=" use_gtk3=true "
    myconf_gn+=" use_xkbcommon=true"
#remoting needs gtk2 so we disable it, test if it still needs gtk2 and if not enable
    myconf_gn+=" enable_remoting=false "
    myconf_gn+=" use_system_libjpeg=true "


#    myconf_gn+=" ffmpeg_branding=\"Chrome\""

	myconf_gn+=" google_api_key=\"${_google_api_key}\""
	myconf_gn+=" google_default_client_id=\"${_google_default_client_id}\""
	myconf_gn+=" google_default_client_secret=\"${_google_default_client_secret}\""

    myconf_gn+=" treat_warnings_as_errors=false"
	myconf_gn+=" fatal_linker_warnings=false"

	Fexec tools/gn/bootstrap/bootstrap.py -v --gn-gen-args "${myconf_gn}"

	Fexec out/Release/gn gen --args="${myconf_gn}" out/Release || Fdie

	Fexec ninja -C out/Release chrome chrome_sandbox chromedriver

	Fmkdir usr/lib/chromium-dev
        Fexerel out/Release/chrome usr/lib/chromium-dev/chromium
        Finstallrel 4755 out/Release/chrome_sandbox usr/lib/chromium-dev/chrome-sandbox
	Ffileschown usr/lib/chromium-dev/chrome-sandbox root root

	Fcprel out/Release/\*.pak usr/lib/chromium-dev/
	Fcprel out/Release/locales usr/lib/chromium-dev/
	Fcprel out/Release/resources usr/lib/chromium-dev/

	Fcprel out/Release/icudtl.dat usr/lib/chromium-dev/

        find $Fdestdir/usr/lib/chromium-dev/ -name '*.d' -type f -delete

        Finstall 644 $pkgname.desktop usr/share/applications/$pkgname.desktop

	for size in 22 24 48 64 128 256; do
		Finstallrel 644 "chrome/app/theme/chromium/product_logo_$size.png" \
		"usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
	done

	for size in 16 32; do
		Finstallrel 644 "chrome/app/theme/default_100_percent/chromium/product_logo_$size.png" \
		"usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
	done

	Finstallrel 644 out/Release/natives_blob.bin usr/lib/chromium-dev
	Finstallrel 644 out/Release/snapshot_blob.bin usr/lib/chromium-dev

	Fdirschmod usr/lib/chromium-dev/locales 755

        Fexe $pkgname.sh usr/bin/$pkgname

        Fdocrel LICENSE
	Fbuild_gnome_scriptlet
}

# optimization OK

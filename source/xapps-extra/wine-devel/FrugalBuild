# Compiling Time: 8 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=wine-devel
pkgver=2.22
_d3d9ver=2.20
pkgrel=1
Finclude wine ## don't include cross32 is included from wine.sh
source=("${source[@]}" \
	"https://github.com/sarnex/wine-d3d9-patches/archive/wine-d3d9-${_d3d9ver}.tar.gz" )
signatures=("${signatures[@]}" '' )

depends+=('mesa-nine' 'libegl')
depends+=('lib32-mesa-nine' 'lib32-libegl')

Fconfopts+=" --with-d3dadapter"

build()
{
	Fcd

        # Disable optimizations to workaround GCC issues
        CFLAGS="${CFLAGS//-O2/-O0}"
	Fexec patch -p1 < ../0001-programs-winhlp32-Use-noyywrap-for-macro.lex.l-and-p.patch || Fdie
	Fexec patch -p1 < ../wine-d3d9-patches-wine-d3d9-${_d3d9ver}/d3d9-helper.patch || Fdie
	Fexec patch -p1 <  ../wine-d3d9-patches-wine-d3d9-${_d3d9ver}/wine-d3d9.patch || Fdie

        Fsed 'lib64' 'lib' configure.ac
        Fautoreconf
        Fexec mkdir 64Bit_build || Fdie
        Fexec cd 64Bit_build || Fdie
        Fmake --enable-win64

        Fexec cd .. || Fdie
        Fexec mkdir 32Bit_build || Fdie
        Fexec cd 32Bit_build || Fdie
        Fcross32_prepare

        Fmake --libdir=/usr/lib32 --with-wine64="$Fsrcdir/${_F_cd_path}/64Bit_build"
        Fmakeinstall  libdir="$Fpkgdir/usr/lib32" dlldir="$Fpkgdir/usr/lib32/wine"

        Fexec cd ../64Bit_build || Fdie
        Fmakeinstall  libdir="$Fpkgdir/usr/lib" dlldir="$Fpkgdir/usr/lib/wine"

        Fexec cp $Fincdir/wine.conf $Fsrcdir
        Ffile /etc/binfmt.d/wine.conf

        Fln /usr/i686-frugalware-linux/bin/wine-preloader /usr/bin/wine-preloader
        Fln /usr/i686-frugalware-linux/bin/wine /usr/bin/wine

	## we cannot use reset_and_fix here since we don't split anything
	__cross32_unset_vars
	__cross32_export_orig_vars


}

# optimization OK

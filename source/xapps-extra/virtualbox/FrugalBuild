# Compiling Time: 6.23 SBU
# Maintainer: Marius Cirsta <mcirsta@frugalware.org>
# Contributor: AlexExtreme <alex@alex-smith.me.uk>

## we need nostrip while gcc6 bugs ( until upstream sort that )
## nostrip+release 58 MB fpm
## nostrip+debug = 60 MB fpm
## so we use full debug for now , maybe better anyway..

USE_VBOX_DEBUG=${USE_VBOX_DEBUG:-"n"}

pkgname=virtualbox
realname=VirtualBox
pkgver=5.1.22
pkgextra=
pkgrel=2
pkgdesc="Oracle VirtualBox is a family of powerful x86 virtualization products for enterprise as well as home use."
url="http://www.virtualbox.org"
depends=('xerces-c>=2.8.0' 'xalan-c>=1.10.0-2' 'iasl' 'dev86' 'libxslt' 'libxcursor' 'libidl' 'sdl' \
         'alsa-lib'  'curl' 'libxmu' 'libuuid' 'libcap' 'qt5-base>=5.7.1-2' 'qt5-x11extras>=5.7.1-2' \
         'libvpx>=1.6.0' 'lvm2' 'libgl' 'libxext' 'libx11' 'libpulse' 'libglu' 'libxrandr' 'libxcomposite' \
	 'libxinerama' 'libvncserver')
makedepends=('cdrtools' 'x11-protos' 'qt5-tools' 'mesa-libgl-headers')
rodepends=("virtualbox-modules=$pkgver")
groups=('xapps-extra')
archs=('x86_64')
up2date="lynx -dump http://download.virtualbox.org/virtualbox/LATEST.TXT | head -n 1"
source=(http://download.virtualbox.org/virtualbox/${pkgver}/${realname}-${pkgver}${pkgextra}.tar.bz2 \
	10-vboxdrv.rules \
	LocalConfig.kmk \
	60-vboxguest.rules \
	vboxservice.service \
	virtualbox-guest-utils.conf )

Finclude kernel-module

## WARNING:
## It seems something gets misscompiled *again* with gcc6 ..
## DO NOT REMOVE 'nostrip' , we strip mauanlly

## PDMLdr: pdmR3LoadR0U: pszName="VMMR0.r0" rc=VERR_INVALID_PARAMETER szErr="SUP_IOCTL_LDR_OPEN failed"
## SUP_IOCTL_LDR_OPEN: pReq->u.In.cbImageBits < pReq->u.In.cbImageWithTabs

options=('scriptlet' 'genscriptlet' 'nostrip') ## we strip manually in build()

_F_cd_path="${realname}-${pkgver}"
sha1sums=('57e6f73f62af7d5ddb670972ba0417b6fcb43950' \
          'aa931ae19edd8585150738f0efd8fedf5175a6d3' \
          '5e66ffd4607dafd9b55dc2b6e7591ef6892d4d49' \
          '08199d8e7906cb793277b798805d38ce386460d8' \
          '142f64efb9532f5ff4faa4df6b93f591be2ce564' \
          '80ba54b1e13f0e8f53a84ca3f25df617fb53ae4c')

subpkgs=("$pkgname-modules" "$pkgname-guest-additions")
subdescs=('Kernel modules for VirtualBox' 'VirtualBox guest Additions')
subarchs=('x86_64' 'x86_64')
subgroups=('apps-extra' 'xapps-extra')
subdepends=('' 'libxcomposite libxdamage libxrandr libxmu pam')

build() {

	Fcd
	Fpatchall

	## FIXME: figure these
	Fsed '/usr/X11R6/bin/xterm' '/usr/bin/xterm' \
		src/VBox/Runtime/VBox/RTAssertShouldPanic-vbox.cpp
	Fsed 'X11R6/' '' configure
	Fsed 'X11R6/' '' Config.kmk
	Fsed '-Werror$' '' Config.kmk
	Fsed '.*&& check_makeself' '' configure # we don't have makeself
	Fsed 'smc-napa' 'smcnapa' src/VBox/Devices/PC/vbox.dsl

        Fexec cp "$Fsrcdir/LocalConfig.kmk" . || Fdie

	Fsed 'DocPath=.*' '' src/VBox/Installer/common/virtualbox.desktop.in

	echo "VBOX_GCC_OPT=$CXXFLAGS" >> LocalConfig.kmk ## DO NOT REMOVE


	if Fuse $USE_VBOX_DEBUG; then
		VBoxBuildType="debug"
		VBox_Opts="-d"
	else
		VBoxBuildType="release"

	fi

	VboxSrcDir=${_F_cd_path}/out/linux.amd64/${VBoxBuildType}/bin

	# Configure and load our options
	Fexec ./configure \
		--disable-docs \
		--disable-kmods \
		--enable-vde \
		--enable-vnc \
		--enable-pulse ${VBox_Opts} || Fdie

	Fexec source ./env.sh || Fdie

	## we want to build verbose - DO NOT DISABLE THIS
	Fexec kmk KBUILD_VERBOSE=2  all || Fdie


	local i k j s

	Fmkdir usr/share/icons/hicolor/{16x16,20x20,32x32,40x40,48x48,64x64,128x128,scalable}/apps

	for k in 16 20 32 40 48 64 128; do
           Finstall 0644 ${_F_cd_path}/src/VBox/Artwork/OSE/virtualbox-${k}px.png  usr/share/icons/hicolor/${k}x${k}/apps/virtualbox.png
        done

        Finstall 0644 ${_F_cd_path}/src/VBox/Artwork/OSE/virtualbox.svg usr/share/icons/hicolor/scalable/apps/virtualbox.svg

	cd ${Fsrcdir}/${VboxSrcDir} || Fdie


	## FIXME: lot stuff missing
	#Binaries and Wrapper with Launchers
	Fexerel VBox.sh "usr/bin/VBox"

	for i in VBoxHeadless vboxheadless VBoxManage vboxmanage VBoxSDL vboxsdl VirtualBox virtualbox VBoxBalloonCtrl vboxballoonctrl; do
          Fln VBox "usr/bin/$i"
	done

	Fexerel VBoxTunctl "usr/bin/VBoxTunctl"

        Fexerel components/* "usr/lib/virtualbox/components"

        Fexerel *.so "usr/lib/virtualbox"

        Finstallrel 644 *.r0 "usr/lib/virtualbox/"

	## vmmraw stuff
	Finstallrel 644 *.rc "usr/lib/virtualbox/"

        Finstallrel 644 VBoxEFI*.fd "usr/lib/virtualbox/"

	Finstallrel 4755 VBoxSDL VirtualBox VBoxHeadless VBoxNetDHCP VBoxNetAdpCtl "usr/lib/virtualbox"

        Fexerel VBoxManage VBoxSVC VBoxExtPackHelperApp VBoxXPCOMIPCD VBoxTestOGL VBoxBalloonCtrl "usr/lib/virtualbox"

	Fexerel nls/*.qm "usr/share/virtualbox/nls"

	#useless scripts
	Fexerel VBoxCreateUSBNode.sh VBoxSysInfo.sh "usr/share/virtualbox"


	## icons
	pushd icons
	for j in ./*; do
	  #echo $j
	  Finstallrel 644 $j/* "usr/share/icons/hicolor/$j/mimetypes"
	done
	popd

	## this fixes -> warning: errors occurred while upgrading virtualbox
	## the folder is empty and the owner is hicolor-icon-theme
	Frm usr/share/icons/hicolor/scalable/mimetypes

	Finstallrel 0644 virtualbox.desktop "usr/share/applications/virtualbox.desktop"
	Finstallrel 0644 virtualbox.xml "usr/share/mime/packages/virtualbox.xml"

	#install configuration
	Fmkdir etc/vbox
        echo 'INSTALL_DIR=/usr/lib/virtualbox' > "$Fdestdir/etc/vbox/vbox.cfg"

	#udev and licence
	Finstall 0644 "VirtualBox-${pkgver}/COPYING" "usr/share/licenses/virtualbox/LICENSE"
	Finstall 0644 "10-vboxdrv.rules" "lib/udev/rules.d/10-vboxdrv.rules"

	Fmkdir etc/ld.so.conf.d
	echo /usr/lib/virtualbox  >> "$Fdestdir/etc/ld.so.conf.d/virtualbox.conf" || Fdie

	if ! Fuse $USE_VBOX_DEBUG; then
		Fmessage "Stripping symbols from $pkgname.."
		for s in `find  $Fdestdir/usr/lib/virtualbox -type f -not -name "*.rc" -not -name "*.r0" -not -name "*.fd" -not -name "*.xpt"`; do
			strip -s $s
		done
	fi

	# host kernel modules
	Fexec cd $Fsrcdir/${_F_cd_path}/out/linux.amd64/release/bin/src || Fdie
        Fmkdir ${_F_kernelmod_dir}/kernel/misc

        Fexec make KERN_DIR=${_F_kernelmod_dir}/build MODULE_DIR_TST=${Fdestdir}/${_F_kernelmod_dir} \
                MODULE_DIR=${Fdestdir}/${_F_kernelmod_dir}/kernel/misc || Fdie
        Fexec make KERN_DIR=${_F_kernelmod_dir}/build MODULE_DIR_TST=${Fdestdir}/${_F_kernelmod_dir} \
                MODULE_DIR=${Fdestdir}/${_F_kernelmod_dir}/kernel/misc INSTALL_MOD_PATH=${Fdestdir} install || Fdie

        #cleanup first
        rm -rf fw_tmp || Fdie
        mkdir fw_tmp || Fdie

        cd fw_tmp || Fdie

        Fbuild_kernelmod_scriptlet

        Fkernelver_compress_modules

	Fsplit virtualbox-modules ${_F_kernelmod_dir}/kernel/misc

        # guest additions
	Fexec cd $Fsrcdir/${_F_cd_path}/out/linux.amd64/release/bin/additions || Fdie
	Fexerel usr/bin/VBoxClient
	Fexerel usr/bin/VBoxControl
	Fexerel usr/bin/VBoxService
	Fexerel usr/bin/mount.vboxsf
	Fexe ${_F_cd_path}/src/VBox/Additions/x11/Installer/98vboxadd-xclient usr/bin/VBoxClient-all

	Fsplit virtualbox-guest-additions  usr/bin/{VBoxClient,VBoxControl,VBoxService,mount.vboxsf,VBoxClient-all}

	Fexe ${_F_cd_path}/src/VBox/Additions/x11/Installer/vboxclient.desktop etc/xdg/autostart/vboxclient.desktop
	Fsplit virtualbox-guest-additions  etc/xdg

	Finstallrel 755 usr/lib/VBoxOGL\*.so
	Fln /usr/lib/VBoxOGL.so usr/lib/xorg/modules/dri/vboxvideo_dri.so
	Fsplit virtualbox-guest-additions usr/lib/VBoxOGL*.so
	Fsplit virtualbox-guest-additions usr/lib/xorg/

	Finstallrel 755 lib/security/pam_vbox.so

	# TODO remove after systemd is gone
	Finstall 644 lib/udev/rules.d/60-vboxguest.rules
	Finstall 644 lib/systemd/system/vboxservice.service
	Finstall 644 usr/lib/sysusers.d/virtualbox-guest-utils.conf
	Fsplit virtualbox-guest-additions usr/lib/sysusers.d/

	# guest kernel modules
        Fexec cd $Fsrcdir/${_F_cd_path}/out/linux.amd64/release/bin/additions/src || Fdie
        Fmkdir ${_F_kernelmod_dir}/kernel/misc

        Fexec make KERN_DIR=${_F_kernelmod_dir}/build MODULE_DIR_TST=${Fdestdir}/${_F_kernelmod_dir} \
                MODULE_DIR=${Fdestdir}/${_F_kernelmod_dir}/kernel/misc || Fdie
        Fexec make KERN_DIR=${_F_kernelmod_dir}/build MODULE_DIR_TST=${Fdestdir}/${_F_kernelmod_dir} \
                MODULE_DIR=${Fdestdir}/${_F_kernelmod_dir}/kernel/misc INSTALL_MOD_PATH=${Fdestdir} install || Fdie

        #cleanup first
        rm -rf fw_tmp || Fdie
        mkdir fw_tmp || Fdie

        cd fw_tmp || Fdie

        Fbuild_kernelmod_scriptlet

        Fkernelver_compress_modules
	Fsplit virtualbox-guest-additions lib/modules/
	Fsplit virtualbox-guest-additions lib/security/
	Fsplit virtualbox-guest-additions lib/systemd/
	Fsplit virtualbox-guest-additions lib/udev/rules.d/60-vboxguest.rules
}

# optimization OK

diff -Nru  synaptics/eventcomm.h synaptics2/eventcomm.h
--- synaptics/eventcomm.h	2007-12-05 14:07:43.217910814 +0100
+++ synaptics2/eventcomm.h	2007-12-05 00:40:43.049129750 +0100
@@ -19,7 +19,8 @@
 #ifndef _EVENTCOMM_H_
 #define _EVENTCOMM_H_
 
-#include "linux_input.h"
+//#include "linux_input.h"
+#include <linux/input.h>
 
 /* for auto-dev: */
 #define DEV_INPUT_EVENT "/dev/input"

diff -Nru  synaptics/Makefile synaptics2/Makefile
--- synaptics/Makefile	2007-12-05 14:07:43.197910316 +0100
+++ synaptics2/Makefile	2007-12-05 00:41:11.665129870 +0100
@@ -9,10 +9,10 @@
 
 PREFIX ?= /usr/local
 BINDIR = $(DESTDIR)$(PREFIX)/bin
-MANDIR = $(DESTDIR)$(PREFIX)/man
+MANDIR = $(DESTDIR)$(PREFIX)/share/man
 
 ifeq ($(ARCH),)
-  ARCH = $(shell /bin/arch)
+  ARCH = $(shell /bin/uname -m)
 endif
 ifeq ($(ARCH),amd64)
   ARCH = x86_64
@@ -34,10 +34,7 @@
   LDCOMBINEFLAGS = -shared -lc
   PICFLAG = $(call check_gcc,-fPIC,)
   X_INCLUDES_ROOT = $(INSTALLED_X)
-  SDKDIR = $(shell pkg-config xorg-server --variable=sdkdir)
-  ALLINCLUDES = -I. -I$(INSTALLED_X)/include/X11 \
-		-I$(INSTALLED_X)/include/X11/extensions \
-		-I$(SDKDIR)
+  ALLINCLUDES = $(shell pkg-config --cflags xorg-server)
 else
   INSTALLED_X = /usr/X11R6
   INPUT_MODULE_DIR = $(DESTDIR)/$(INSTALLED_X)/$(LIBDIR)/modules/input
@@ -74,12 +71,12 @@
 MODULE_DEFINES = -DIN_MODULE -DXFree86Module
 PROTO_DEFINES = -DFUNCPROTO=15 -DNARROWPROTO
 
-STD_DEFINES = -Dlinux -D_POSIX_C_SOURCE=199309L -D_POSIX_SOURCE -D_XOPEN_SOURCE -D_BSD_SOURCE -D_SVID_SOURCE  -D_GNU_SOURCE  -DSHAPE -DXINPUT -DXKB -DLBX -DXAPPGROUP -DXCSECURITY -DTOGCUP   -DDPMSExtension  -DPIXPRIV -DPANORAMIX  -DRENDER -DGCCUSESGAS -DAVOID_GLYPHBLT -DPIXPRIV -DSINGLEDEPTH -DXFreeXDGA -DXvExtension -DXFree86LOADER  -DXFree86Server -DXF86VIDMODE  -DSMART_SCHEDULE -DBUILDDEBUG -DX_BYTE_ORDER=X_LITTLE_ENDIAN -DNDEBUG $(ARCH_DEFINES)
+STD_DEFINES = -Dlinux -D_POSIX_C_SOURCE=199309L -D_POSIX_SOURCE -D_XOPEN_SOURCE -D_BSD_SOURCE -D_SVID_SOURCE  -D_GNU_SOURCE $(ARCH_DEFINES)
 ALLDEFINES = $(ALLINCLUDES) $(STD_DEFINES) $(PROTO_DEFINES) $(MODULE_DEFINES)
 
 check_gcc = $(shell if $(CC) $(1) -S -o /dev/null -xc /dev/null > /dev/null 2>&1; then echo "$(1)"; else echo "$(2)"; fi ;)
 
-CCOPTIONS := -pedantic -Wall -Wpointer-arith
+CCOPTIONS := -pedantic -Wall -Wpointer-arith -fno-stack-protector
 CCOPTIONS += $(call check_gcc,-fno-merge-constants,)
 CDEBUGFLAGS = -O2
 CFLAGS = $(CDEBUGFLAGS) $(CCOPTIONS) $(PICFLAG) $(ALLDEFINES) -DVERSION="\"$(VERSION)\"" -DVERSION_ID="$(VERSION_ID)"
@@ -136,7 +133,7 @@
 
 synaptics.o : synaptics.h synproto.h Makefile
 ps2comm.o   : ps2comm.h synproto.h synaptics.h
-eventcomm.o : eventcomm.h linux_input.h synproto.h synaptics.h
+eventcomm.o : eventcomm.h synproto.h synaptics.h
 psmcomm.o   : freebsd_mouse.h psmcomm.h synproto.h synaptics.h ps2comm.h
 alpscomm.o  : alpscomm.h ps2comm.h synproto.h synaptics.h
 synclient.o : synaptics.h Makefile
diff -Nru  synaptics/ps2comm.h synaptics2/ps2comm.h
--- synaptics/ps2comm.h	2007-12-05 14:07:43.218910738 +0100
+++ synaptics2/ps2comm.h	2007-12-05 00:38:27.668130250 +0100
@@ -3,6 +3,7 @@
 
 #include <unistd.h>
 #include <sys/ioctl.h>
+#include "xorg-server.h"
 #include "xf86_OSproc.h"
 
 /* acknowledge for commands and parameter */
diff -Nru  synaptics/synaptics.c synaptics2/synaptics.c
--- synaptics/synaptics.c	2007-12-05 14:07:43.255910707 +0100
+++ synaptics2/synaptics.c	2007-12-18 17:24:50.229108603 +0100
@@ -65,12 +65,11 @@
  *	Standard Headers
  ****************************************************************************/
 
+#include "xorg-server.h"
 #include <unistd.h>
 #include <sys/ioctl.h>
 #include <misc.h>
 #include <xf86.h>
-#define NEED_XF86_TYPES
-#include <xf86_ansic.h>
 #include <xf86_OSproc.h>
 #include <xf86Xinput.h>
 #include "mipointer.h"
@@ -78,6 +77,11 @@
 #include <xf86Optrec.h>  		/* needed for Options */
 #endif
 
+#include <string.h>
+#include <sys/stat.h>
+#include <sys/ipc.h>
+#include <sys/shm.h>
+#include <errno.h>
 
 /*****************************************************************************
  *	Local Headers
@@ -158,7 +162,7 @@
     MODULEVENDORSTRING,
     MODINFOSTRING1,
     MODINFOSTRING2,
-    XF86_VERSION_CURRENT,
+    XORG_VERSION_CURRENT,
     1, 0, 0,
     ABI_CLASS_XINPUT,
     ABI_XINPUT_VERSION,
@@ -236,14 +240,14 @@
 	return TRUE;			    /* Already allocated */
 
     if (priv->shm_config) {
-	if ((shmid = xf86shmget(SHM_SYNAPTICS, 0, 0)) != -1)
-	    xf86shmctl(shmid, XF86IPC_RMID, NULL);
-	if ((shmid = xf86shmget(SHM_SYNAPTICS, sizeof(SynapticsSHM),
-				0777 | XF86IPC_CREAT)) == -1) {
+	if ((shmid = shmget(SHM_SYNAPTICS, 0, 0)) != -1)
+	    shmctl(shmid, IPC_RMID, NULL);
+	if ((shmid = shmget(SHM_SYNAPTICS, sizeof(SynapticsSHM),
+				0777 | IPC_CREAT)) == -1) {
 	    xf86Msg(X_ERROR, "%s error shmget\n", local->name);
 	    return FALSE;
 	}
-	if ((priv->synpara = (SynapticsSHM*)xf86shmat(shmid, NULL, 0)) == NULL) {
+	if ((priv->synpara = (SynapticsSHM*)shmat(shmid, NULL, 0)) == NULL) {
 	    xf86Msg(X_ERROR, "%s error shmat\n", local->name);
 	    return FALSE;
 	}
@@ -269,8 +273,8 @@
 	return;
 
     if (priv->shm_config) {
-	if ((shmid = xf86shmget(SHM_SYNAPTICS, 0, 0)) != -1)
-	    xf86shmctl(shmid, XF86IPC_RMID, NULL);
+	if ((shmid = shmget(SHM_SYNAPTICS, 0, 0)) != -1)
+	    shmctl(shmid, IPC_RMID, NULL);
     } else {
 	xfree(priv->synpara);
     }
@@ -284,7 +288,7 @@
     char *str_par;
     double value;
     str_par = xf86FindOptionValue(options, optname);
-    if ((!str_par) || (xf86sscanf(str_par, "%lf", &value) != 1))
+    if ((!str_par) || (sscanf(str_par, "%lf", &value) != 1))
 	return default_value;
     return value;
 }
@@ -491,8 +495,8 @@
     priv->fifofd = -1;
     if (repeater) {
 	/* create repeater fifo */
-	if ((xf86mknod(repeater, 666, XF86_S_IFIFO) != 0) &&
-	    (xf86errno != xf86_EEXIST)) {
+	if ((mknod(repeater, 666, S_IFIFO) != 0) &&
+	    (errno != EEXIST)) {
 	    xf86Msg(X_ERROR, "%s can't create repeater fifo\n", local->name);
 	} else {
 	    /* open the repeater fifo */
@@ -501,7 +505,7 @@
 		xf86Msg(X_ERROR, "%s repeater device open failed\n", local->name);
 	    }
 	}
-	xf86free(repeater);
+	free(repeater);
     }
 
     if (!QueryHardware(local)) {
@@ -694,7 +698,7 @@
 static int
 move_distance(int dx, int dy)
 {
-    return xf86sqrt(SQR(dx) + SQR(dy));
+    return sqrt(SQR(dx) + SQR(dy));
 }
 
 /*
@@ -729,14 +733,14 @@
     double xCenter = (priv->synpara->left_edge + priv->synpara->right_edge) / 2.0;
     double yCenter = (priv->synpara->top_edge + priv->synpara->bottom_edge) / 2.0;
 
-    return xf86atan2(-(y - yCenter), x - xCenter);
+    return atan2(-(y - yCenter), x - xCenter);
 }
 
 /* return angle difference */
 static double
 diffa(double a1, double a2)
 {
-    double da = xf86fmod(a2 - a1, 2 * M_PI);
+    double da = fmod(a2 - a1, 2 * M_PI);
     if (da < 0)
 	da += 2 * M_PI;
     if (da > M_PI)
@@ -844,7 +848,7 @@
 	int c;
 	while ((c = XisbRead(priv->comm.buffer)) >= 0) {
 	    unsigned char u = (unsigned char)c;
-	    xf86write(priv->fifofd, &u, 1);
+	    write(priv->fifofd, &u, 1);
 	    if (++count >= 3)
 		break;
 	}
@@ -1402,10 +1406,10 @@
 
 	    /* save the fraction, report the integer part */
 	    tmpf = dx * speed + x_edge_speed * dtime + priv->frac_x;
-	    priv->frac_x = xf86modf(tmpf, &integral);
+	    priv->frac_x = modf(tmpf, &integral);
 	    dx = integral;
 	    tmpf = dy * speed + y_edge_speed * dtime + priv->frac_y;
-	    priv->frac_y = xf86modf(tmpf, &integral);
+	    priv->frac_y = modf(tmpf, &integral);
 	    dy = integral;
 	}
 
diff -Nru  synaptics/synproto.h synaptics2/synproto.h
--- synaptics/synproto.h	2007-12-05 14:07:43.257911602 +0100
+++ synaptics2/synproto.h	2007-12-05 00:39:42.135130326 +0100
@@ -21,6 +21,7 @@
 
 #include <unistd.h>
 #include <sys/ioctl.h>
+#include "xorg-server.h"
 #include <xf86Xinput.h>
 #include <xisb.h>
 

# Last modified: Tue, 15 Aug 2006 14:10:26 +0200
# Compiling time: ~0.08 SBU
# Contributor: Shrift <shrift@frugalware.org>
# Maintainer: voroskoi <voroskoi@frugalware.org>

pkgname=fglrx
pkgver=8.27.10
pkgrel=3
pkgdesc="Hardware Accelerated ATi driver for xorg"
url="http://www.ati.com/"
# libstdc++5: no hardware acceleration without it
Finclude kernel-module
depends=('xorg-server' 'libstdc++5')
rodepends=("fglrx_module>=8.27.10-1")
conflicts=('libgl')
provides=('libgl')
groups=('x11-extra')
archs=('i686' 'x86_64')
install=$pkgname.install
up2date=$pkgver
[ "$CARCH" == "i686" ] && source=(https://a248.e.akamai.net/f/674/9206/0/www2.ati.com/drivers/linux/ati-driver-installer-$pkgver-x86.run)
[ "$CARCH" == "x86_64" ] && source=(https://a248.e.akamai.net/f/674/9206/0/www2.ati.com/drivers/linux/64bit/ati-driver-installer-$pkgver-x86_64.run)
source=(${source[@]} README.Frugalware)
options=(${options[@]} 'nodocs')
[ "$CARCH" == "i686" ] && sha1sums=('dc386ae275e7623d383a83b50b8685b53fe97f03')
[ "$CARCH" == "x86_64" ] && sha1sums=('9844ad5dc79a8d914d8707d2d17cf6be0de9e7d5')
sha1sums=(${sha1sums[@]} 'ff1bf5549896234bb7a17abbad8caa6578b19c4a')

subpkgs=('fglrx_module')
subdescs=('fglrx kernel module')
subdepends=("kernel=$kernelver")
subgroups=('x11-extra')
subarchs=('i686 x86_64')
subinstall=fglrx_module.install

Xversion=x710

build() {
	if [ "$CARCH" == "i686" ]; then
		chmod a+x ati-driver-installer-$pkgver-x86.run
		./ati-driver-installer-$pkgver-x86.run --extract ATi
		cp -r $Fsrcdir/ATi/arch/x86/* $Fsrcdir/ || Fdie
		cp -r $Fsrcdir/ATi/${Xversion}/* $Fsrcdir/ || Fdie
	fi
	if [ "$CARCH" == "x86_64" ]; then
		chmod a+x ati-driver-installer-$pkgver-x86_64.run
		./ati-driver-installer-$pkgver-x86_64.run --extract ATi
		cp -r $Fsrcdir/ATi/arch/x86_64/* $Fsrcdir/ || Fdie
		cp -r $Fsrcdir/ATi/${Xversion}_64a/* $Fsrcdir/ || Fdie
	fi

	cp -r $Fsrcdir/ATi/common/* $Fsrcdir/ || Fdie

	if [ "$CARCH" == "x86_64" ]; then
		Fcd /lib/modules/fglrx/build_mod
		#patch -p0 < $Fsrcdir/ati-drivers-8.22.5-intermodule.patch || Fdie
		#patch -p0 < $Fsrcdir/ati-drivers-8.23.7-noiommu.patch || Fdie
	fi

	# building kernel module
	Fcd /lib/modules/fglrx/build_mod
	cp 2.6.x/Makefile . || Fdie
	make -C /usr/src/linux-$kernelbasever-fw$kernelrel SUBDIRS="`pwd`" modules || Fdie
	Ffile lib/modules/fglrx/build_mod/fglrx.ko lib/modules/$kernelbasever-fw$kernelrel/video/fglrx.ko

	# moving the intresting part to the package
	mv $Fsrcdir/usr $Fdestdir || Fdie

	# Install into correct paths for Xorg7
	Fmkdir /usr/{include,lib/xorg,bin}
	mv $Fdestdir/usr/X11R6/include/* $Fdestdir/usr/include || Fdie
	if [ "$CARCH" == "i686" ]; then
		Fmessage "Using i686 libs"
		mv $Fdestdir/usr/X11R6/lib/* $Fdestdir/usr/lib || Fdie
	fi
	if [ "$CARCH" == "x86_64" ]; then
		Fmessage "Using x86_64 libs"
		mv $Fdestdir/usr/X11R6/lib64/* $Fdestdir/usr/lib || Fdie
	fi
	mv $Fdestdir/usr/X11R6/bin/* $Fdestdir/usr/bin || Fdie
	# FIXME
	[ "$CARCH" == "i686" ] && Fexe ATi/x690/usr/X11R6/bin/fireglcontrolpanel /usr/bin/fireglcontrolpanel
	[ "$CARCH" == "x86_64" ] && Fexe ATi/x690_64a/usr/X11R6/bin/fireglcontrolpanel /usr/bin/fireglcontrolpanel
	Frm /usr/X11R6

	# No hardware support without it
	Fmv /usr/lib/modules /usr/lib/xorg/modules
	Fln /usr/lib/xorg/modules /usr/lib/modules

	# Links
	Fln libfglrx_pp.so.1.0 /usr/lib/libfglrx_pp.1
	Fln libfglrx_gamma.so.1.0 /usr/lib/libfglrx_gamma.1
	Fln libfglrx_tvout.so.1.0 /usr/lib/libfglrx_tvout.1
	Fln libGL.so.1.2 /usr/lib/libGL.so
	Fln libGL.so.1.2 /usr/lib/libGL.so.1

	find $Fdestdir -type d |xargs chmod 755

	Fdoc README.Frugalware

	Fsplit fglrx_module /lib
}

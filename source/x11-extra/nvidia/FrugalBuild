# Compiling Time: 0.01 SBU
# Maintainer: AlexExtreme <alex@alex-smith.me.uk>

pkgname=nvidia
pkgver=100.14.09
pkgrel=3
pkgdesc="3D accelerated display driver for Nvidia cards"
url="http://www.nvidia.com/object/linux_display_archive.html"
conflicts=('libgl' 'libglx')
provides=('libgl' 'libglx')
groups=('x11-extra')
archs=('i686' 'x86_64')
up2date="lynx -dump http://www.nvidia.com/object/unix.html|grep -m1 'Latest Version:'|sed 's/.*]//;s/-/_/'"
[ "$CARCH" == "x86_64" ] && jarch=x86_64 && sha1=001bce9cba1c8ba31b0e942e85b429a5533ca72c && pkgnum=2
echo "$CARCH" | grep -q 'i.86' && jarch=x86 && sha1=b70794343d8f10d335564944130685b90a9c7f63 && pkgnum=1
source=(http://us.download.nvidia.com/XFree86/Linux-$jarch/$pkgver/NVIDIA-Linux-$jarch-$pkgver-pkg$pkgnum.run)
sha1sums=($sha1)
options=('nostrip' 'force')
Finclude kernel-module
depends=(${depends[@]} 'xorg-server>=1.1.0')
unset install
install=$pkgname.install

build() {  
	nvdir=NVIDIA-Linux-$jarch-$pkgver-pkg$pkgnum
	cd $Fsrcdir
	sh $nvdir.run --extract-only
	Fcd $nvdir/
	Fpatchall
	
	# Install the binaries
	Fexerel usr/bin/nvidia-* /usr/bin/
	
	# Xorg modules
	Fmkdir usr/lib/xorg/
	Fcpr $nvdir/usr/X11R6/lib/modules /usr/lib/xorg/modules
	
	# Libraries
	Fexerel usr/lib/*.so* /usr/lib/
	Fexerel usr/lib/libGL.la /usr/lib/libGL.la
	Fsed "__LIBGL_PATH__" "/usr/lib" $Fdestdir/usr/lib/libGL.la
	
	# Weird TLS stuff
	Fmkdir usr/lib/tls
	Fexerel usr/lib/tls/*.so* /usr/lib/tls/
	Fexerel usr/X11R6/lib/libXv* /usr/lib/
	
	# Data
	Fmkdir usr/share
	Fcpr $nvdir/usr/share/pixmaps /usr/share/
	Fcpr $nvdir/usr/share/applications /usr/share/
	Fcpr $nvdir/usr/share/man /usr/
	Frm usr/man/man1/nvidia-installer.1.gz
	Fsed "__UTILS_PATH__" "/usr/bin" $Fdestdir/usr/share/applications/nvidia-settings.desktop
	Fsed "__PIXMAP_PATH__" "/usr/share/pixmaps" $Fdestdir/usr/share/applications/nvidia-settings.desktop
	
	# Library links
	Fln "libGL.so.$pkgver" "/usr/lib/libGL.so"
	Fln "libGL.so.$pkgver" "/usr/lib/libGL.so.1"
	Fln "libGL.so.$pkgver" "/usr/lib/libGL.so.1.2"
	Fln "libGLcore.so.$pkgver" "/usr/lib/libGLcore.so.1"
	Fln "libnvidia-cfg.so.$pkgver" "/usr/lib/libnvidia-cfg.so.1"
	Fln "libnvidia-cfg.so.$pkgver" "/usr/lib/libnvidia-cfg.so"
	Fln "libnvidia-tls.so.$pkgver" "/usr/lib/libnvidia-tls.so.1"
	Fln "libnvidia-tls.so.$pkgver" "/usr/lib/tls/libnvidia-tls.so.1"
	Fln "libglx.so.$pkgver" "/usr/lib/xorg/modules/extensions/libglx.so"
	Fln "libXvMCNVIDIA.so.$pkgver" "/usr/lib/libXvMCNVIDIA.so"
	Fln "libXvMCNVIDIA.so.$pkgver" "/usr/lib/libXvMCNVIDIA.so.1"
	Fln "libXvMCNVIDIA.so.$pkgver" "/usr/lib/libXvMCNVIDIA_dynamic.so.1"
	Fln "libnvidia-wfb.so.$pkgver" "/usr/lib/xorg/modules/libnvidia-wfb.so"
	Fln "libnvidia-wfb.so.$pkgver" "/usr/lib/xorg/modules/libnvidia-wfb.so.1"
	Fln "libnvidia-wfb.so.$pkgver" "/usr/lib/xorg/modules/libwfb.so"
	
	cd usr/src/nv || Fdie
	ln -s Makefile.kbuild Makefile || Fdie
	make SYSSRC=$_F_kernelmod_dir/build module || Fdie
	cd ../../.. || Fdie
	Ffilerel usr/src/nv/nvidia.ko $_F_kernelmod_dir/kernel/drivers/video/nvidia.ko

	Fdoc $nvdir/LICENSE
	Fcpr $nvdir/usr/share/doc/* /usr/share/doc/$pkgname-$pkgver/
	Fln "$pkgname-$pkgver" "/usr/share/doc/$pkgname"
}

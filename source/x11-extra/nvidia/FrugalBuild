# Compiling Time: 0.01 SBU
# Maintainer: Michel Hermier <hermier@frugalware.org>

pkgname=nvidia
pkgver=387.34
pkgrel=6
archs=('x86_64')
_F_kernelmod_scriptlet=nvidia.install
Finclude kernel-module
groups=('x11-extra')
pkgdesc="3D accelerated display driver for Nvidia cards"
url="http://www.nvidia.com/object/unix.html"
up2date="Flastverdir http://download.nvidia.com/XFree86/Linux-x86/"
rodepends+=('libvdpau>=1.1.1-2' 'nvidia-settings>=361.16' 'nvidia-xconfig>=361.16' 'pkgconfig' 'xorg-server>=1.19.0')
conflicts+=('libgl' 'libgl-headers-mesa' 'libglx' 'libgles')
provides+=('libgl' 'libgl-headers-mesa' 'libglx' 'libgles')
options+=('nostrip')

_F_nvidia_name="NVIDIA-Linux-${CARCH}-${pkgver}-no-compat32"
source=("http://us.download.nvidia.com/XFree86/Linux-${CARCH}/${pkgver}/${_F_nvidia_name}.run" \
	modprobe-nvidia.conf \
	xorg-nvidia.conf \
	kernel-4.13.patch )

sha1sums=('96110da0cac27da4d8ffffd8c52d825277808085' \
          'a2bf63eb7dffdfc9268534654d3864e865af6834' \
          'd10124ab764340d514e76413e42d4bae2621a30a' \
          'dfb92fb757dd126ef842874811b1a4e29b1848ac')

build () {
	cd $Fsrcdir
	rm -rf ${_F_nvidia_name} || Fdie
	Fexec sh $_F_nvidia_name.run --extract-only || Fdie

	Fcd .

	cd $Fsrcdir/${_F_nvidia_name}
	Fpatchall

	# Build the kernel module
	Fexec cd $Fsrcdir/${_F_nvidia_name}/kernel || Fdie
	Fexec make SYSSRC=$_F_kernelmod_dir/build module || Fdie
	Ffilerel nvidia.ko $_F_kernelmod_dir/kernel/drivers/video/nvidia.ko
	Ffilerel nvidia-drm.ko $_F_kernelmod_dir/kernel/drivers/video/nvidia-drm.ko
	Ffilerel nvidia-modeset.ko $_F_kernelmod_dir/kernel/drivers/video/nvidia-modeset.ko
	Ffilerel nvidia-uvm.ko $_F_kernelmod_dir/kernel/drivers/video/nvidia-uvm.ko
	Fbuild_kernelmod_scriptlet

	Fexec cd $Fsrcdir/${_F_nvidia_name} || Fdie

	# FIXME: Cuda and OpenCL headers are missing on the package on purpose

	# X driver
	Fmkdir /usr/lib/xorg/modules/drivers/
	Fexerel /usr/lib/xorg/modules/drivers/nvidia_drv.so

	# GLX extension module for X
	Fmkdir /usr/lib/xorg/modules/nvidia/extensions/
	Fexerel /usr/lib/xorg/modules/nvidia/extensions/libglx.so.$pkgver
	Fln libglx.so.$pkgver /usr/lib/xorg/modules/nvidia/extensions/libglx.so
	Fln libglx.so.$pkgver /usr/lib/xorg/modules/nvidia/extensions/libglx.so.1
	Fexerel /usr/lib/libGLX_nvidia.so.$pkgver

	# OpenGL core library
	Fexerel /usr/lib/libnvidia-glcore.so.$pkgver
	Fexerel /usr/share/glvnd/egl_vendor.d/10_nvidia.json

	#EGL
	Fexerel /usr/lib/libEGL_nvidia.so.$pkgver
	Fexerel /usr/lib/libnvidia-eglcore.so.$pkgver

	#OpenGL ES
	Fexerel /usr/lib/libGLESv1_CM_nvidia.so.$pkgver
	Fexerel /usr/lib/libGLESv2_nvidia.so.$pkgver

	#GLSI
	Fexerel /usr/lib/libnvidia-glsi.so.$pkgver

	# CUDA
	Fexerel /usr/lib/libcuda.so.$pkgver
	Fexerel /usr/lib/libnvcuvid.so.$pkgver
	Fln libnvcuvid.so.$pkgver /usr/lib/libnvcuvid.so.1
	Fln libnvcuvid.so.$pkgver /usr/lib/libnvcuvid.so
	Fexerel /usr/lib/libnvidia-ml.so.$pkgver
	Fexerel /usr/lib/libnvidia-fatbinaryloader.so.$pkgver

	# nvidia-tls library
	Fexerel tls/libnvidia-tls.so.$pkgver /usr/lib/libnvidia-tls.so.$pkgver

	# OpenCL
	Fmkdir /etc/OpenCL/vendors/
	Ffilerel /etc/OpenCL/vendors/nvidia.icd
	Fexerel /usr/lib/libOpenCL.so.1.0.0
	Fln libOpenCL.so.1.0.0 /usr/lib/libOpenCL.so
	Fln libOpenCL.so.1.0.0 /usr/lib/libOpenCL.so.1
	Fexerel /usr/lib/libnvidia-cfg.so.$pkgver
	Fexerel /usr/lib/libnvidia-compiler.so.$pkgver
	Fexerel /usr/lib/libnvidia-opencl.so.$pkgver

	# Encode (no idea..)
	Fexerel /usr/lib/libnvidia-encode.so.$pkgver

	# Fbc (Frame buffer console?)
	Fexerel /usr/lib/libnvidia-fbc.so.$pkgver

	# GTK
	Fexerel /usr/lib/libnvidia-gtk2.so.$pkgver
	Fexerel /usr/lib/libnvidia-gtk3.so.$pkgver

	# IFR
	Fexerel /usr/lib/libnvidia-ifr.so.$pkgver

	# WFP
	Fexerel /usr/lib/libnvidia-wfb.so.$pkgver

	## VDAU
	Fexerel /usr/lib/vdpau/libvdpau_nvidia.so.${pkgver}

	## Wayland
	## to be replaced by this I guess : https://github.com/NVIDIA/egl-wayland
	Fexerel /usr/lib/libnvidia-egl-wayland.so.1.0.2
	Fln libnvidia-egl-wayland.so.1.0.2 /usr/lib/libnvidia-egl-wayland.so.1
	Fexerel /usr/share/egl/egl_external_platform.d/10_nvidia_wayland.json

	# nvidia-bug-report
	Fmkdir /usr/bin/
	Fexerel /usr/bin/nvidia-bug-report.sh
	# nvidia-smi
	Fexerel /usr/bin/nvidia-smi
	Fmkdir /usr/share/man/man1/
	Ffilerel /usr/share/man/man1/nvidia-smi.1.gz

	Fdocrel LICENSE README.txt html

	Ffile xorg-nvidia.conf /etc/X11/xorg.conf.d/15-nvidia.conf
	Ffile modprobe-nvidia.conf /etc/modprobe.d/nvidia.conf

	Fkernelver_compress_modules
}

# optimization OK

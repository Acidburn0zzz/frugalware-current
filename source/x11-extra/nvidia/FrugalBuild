# Last Modified: Thu, 07 Sep 2006 13:08:06 +0200
# Compiling Time: 0.01 SBU
# Maintainer: Janny <janny@frugalware.org>
# Contributor: VMiklos <vmiklos@frugalware.org>

pkgname=nvidia
pkgver=1.0_8774
nvver=`echo $pkgver|sed 's/_/-/'`
pkgrel=3
pkgdesc="3d accelerated display driver for Nvidia cards"
url="http://www.nvidia.com/object/linux_display_archive.html"
rodepends=('gcc' 'make' 'kernel-source')
depends=()
conflicts=('libgl' 'libglx')
provides=('libgl' 'libglx')
removes=(usr/bin/nvidia-{bug-report.sh,settings,xconfig}
	usr/lib/{libGLcore.so.1,libXvMCNVIDIA.a,libnvidia-cfg.so.1,libnvidia-tls.so.1}
	usr/lib/xorg/modules/drivers/nvidia_drv.{,s}o usr/share/applications/nvidia-settings.desktop)
groups=('x11-extra')
archs=('i686' 'x86_64')
up2date="lynx -dump http://www.nvidia.com/object/unix.html|grep -m1 'Latest Version:'|sed 's/.*]//;s/-/_/'"
[ "$CARCH" == "x86_64" ] && jarch=x86_64 && sha1=a1bf17935d31fafe5e51188ed226e0e6dac2508c
echo "$CARCH" | grep -q 'i.86' && jarch=x86 && sha1=0a2e063da4bf9ccee23a30033280d660129aebe3
pkgnum=0
source=(http://download.nvidia.com/XFree86/Linux-$jarch/$nvver/NVIDIA-Linux-$jarch-$nvver-pkg$pkgnum.run)
sha1sums=($sha1)
Finclude kernel-module
unset install
install=$pkgname.install

build() {  
nvdir=NVIDIA-Linux-$jarch-$nvver-pkg$pkgnum
linkver=`echo $pkgver|sed 's/_/\./'`
	cd $Fsrcdir
	sh $nvdir.run --extract-only
	Fcd $nvdir/
	Fexerel usr/bin/nvidia-* /usr/bin/
	Fmkdir /usr/lib/xorg/modules
	Fcpr $nvdir/usr/X11R6/lib/modules/* /usr/lib/xorg/modules
	Fexerel usr/lib/*.so* /usr/lib/
	Fexerel usr/X11R6/lib/libXv* /usr/lib/
	Fmkdir usr/{share/applications,share/pixmaps,man/man1,doc/html}
	Fcpr $nvdir/usr/share/* /usr/share/
	Fmv usr/share/man/man1/nvidia-xconfig.1.gz usr/man/man1
	Fmv usr/share/man/man1/nvidia-settings.1.gz usr/man/man1
	Frm usr/share/man
	Fsed "__UTILS_PATH__" "/usr/bin" $Fdestdir/usr/share/applications/nvidia-settings.desktop
	Fsed "__PIXMAP_PATH__" "/usr/share/pixmaps" $Fdestdir/usr/share/applications/nvidia-settings.desktop
	Fln "libGL.so.$linkver" "/usr/lib/libGL.so"
	Fln "libGL.so.$linkver" "/usr/lib/libGL.so.1"
	Fln "libGLcore.so.$linkver" "/usr/lib/libGLcore.so.1"
	Fln "libnvidia-cfg.so.$linkver" "/usr/lib/libnvidia-cfg.so.1"
	Fln "libnvidia-tls.so.$linkver" "/usr/lib/libnvidia-tls.so.1"
	Fln "libglx.so.$linkver" "/usr/lib/xorg/modules/extensions/libglx.so"

	cd usr/src/nv
	ln -s Makefile.kbuild Makefile
	make SYSSRC=/lib/modules/$kernelbasever-fw$kernelrel/build module
	cd ../../..
	Ffilerel usr/src/nv/nvidia.ko lib/modules/$kernelbasever-fw$kernelrel/kernel/drivers/video/nvidia.ko

	Fdoc $nvdir/LICENSE
	Fln "$pkgname-$pkgver" "/usr/share/doc/$pkgname"
}

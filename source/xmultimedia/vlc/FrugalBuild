# Compiling Time: 4.43 SBU
# Maintainer: DeX77 <dex77@frugalware.org>
# Contributor: kikadf <kikadf.01@gmail.com>
# Contributor: Devil505 <devil505linux@gmail.com>
# Contributor: Miklos Vajna <vmiklos@frugalware.org>

: ${USE_DEVEL="n"}

pkgname=vlc
pkgver=2.2.6
pkgextraver=
pkgrel=2
pkgdesc="The cross-platform media player and streaming server."
url="http://www.videolan.org/vlc/"
## TODO: split a lot more -- crazy --
depends=('e2fsprogs' 'libxpm>=3.5.8-1' 'libxdmcp' 'libshout' 'avahi' \
         'libdvbpsi>=1.3.0' 'libsmbclient' 'vcdimager>=0.7.24-4' 'alsa-lib>=1.1.0' \
         'libgcrypt>=1.6.1' 'lua' 'fribidi' 'freetype2' 'librsvg>=2.26.3' \
         'ffmpeg>=3.2.4' 'libgl' 'libxvmc' 'aalib' 'libmad' 'libdca' \
         'mpeg2dec' 'taglib' 'libmusicbrainz>=5.1.0' 'libid3tag' \
         'libmpcdec>=1.2.6-2' 'live>=2017.01.26' 'xcb-util>=0.3.8' 'gnutls>=3.4.2' \
         'libdvdread' 'libbluray' 'libass>=0.13.6' 'libva>=1.6.1-2' \
	 'x264>=20170105_224' 'ncurses>=6.0-3' 'libxpm' 'libxext' \
	 'libxinerama' 'qt5-base>=5.9.0-4' 'qt5-x11extras>=5.9.0' 'libvpx>=1.6.0')
makedepends+=('samba>=4.3.1-10' 'libxtst' 'x11-protos')
rodepends=("libvlc>=$pkgver" "mesa-vdpau-drivers" "libva-mesa-driver")
_F_gnome_iconcache="y"
_F_gnome_desktop="y"
_F_cd_path="$pkgname$Fpkgversep$pkgver"
options+=('scriptlet')

Fconfopts+=" --disable-rpath  \
		--enable-nls \
		--enable-lirc \
		--enable-ncurses \
		--enable-bluray \
		--enable-sout \
		--enable-lua \
		--enable-httpd \
		--enable-vlm \
		--disable-notify \
		--disable-dc1394 \
		--enable-dvdread \
		--enable-dvdnav \
		--enable-v4l2 \
		--enable-libcddb \
		--enable-vcdx \
		--enable-vcd \
		--enable-screen \
		--enable-ogg \
		--enable-mkv \
		--enable-mod \
		--enable-mpc \
		--enable-mad \
		--enable-avcodec \
		--enable-avformat \
		--enable-swscale \
		--enable-postproc \
		--enable-faad \
		--enable-twolame \
		--enable-realrtsp \
		--disable-libtar \
		--enable-a52 \
		--enable-dca \
		--enable-flac \
		--enable-libmpeg2 \
		--enable-vorbis \
		--enable-speex \
		--enable-theora \
		--enable-png \
		--enable-x264 \
		--enable-xvideo \
		--enable-sdl \
		--enable-sdl-image \
		--enable-freetype \
		--enable-libxml2 \
		--enable-svg \
		--enable-aa \
		--enable-alsa \
		--enable-skins2 \
		--enable-libgcrypt \
		--enable-vlc \
		--disable-optimizations \
		--with-gnu-ld \
		--enable-dvbpsi \
		--enable-upnp \
		--disable-debug \
		--enable-freerdp \
		--enable-live555"

Finclude gnome-scriptlet
groups=('xmultimedia')
archs=("x86_64")

up2date="Flastverdir http://download.videolan.org/pub/videolan/vlc"
#up2date="lynx -dump -source http://www.videolan.org/vlc/download-sources.html | grep .tar.xz | sed -ne 's/.*-\(.*\)\.t.*/\1/;1 p'"
if ! Fuse $USE_DEVEL; then
	source=(http://download.videolan.org/pub/videolan/vlc/$pkgver/$pkgname-$pkgver$pkgextraver.tar.xz \
		lua53-compat.patch \
		bug-14908.patch \
		vlc-2.1.0-TomWij-bisected-PA-broken-underflow.patch \
		vlc-9999-libva-1.2.1-compat.patch \
		vlc-2.2.4-relax_ffmpeg.patch \
		vlc-2.2.4-ffmpeg3.patch)
	sha1sums=('d299dce6a5c94af4292657b6cb99c44654024f70' \
	          '5d7dba23756ff577a90b8631b187fbeac1f94e17' \
	          'b1d20239bd0f7ee0666cec8d1f8118ab087f9893' \
	          '61ce442f390b3f744bbcd5771368c13e9236ea81' \
	          'b435ddbb4df0cbe7f983fba74e5b5747d6a62e9c' \
	          'e09103af98841ca149e26c0ef8051ecef588832b' \
	          'c572727ab1604aed3414ce5622bcc123d2accd7d')


else
	pkgver=3.0.0
	pkgextraver=-git
	pkgrel=0_1
	#source=(http://download.videolan.org/pub/videolan/testing/$pkgname-$pkgver$pkgextraver/$pkgname-$pkgver$pkgextraver.tar.xz)
	source=(http://nightlies.videolan.org/build/source/$pkgname-$pkgver-20160404-0537.tar.xz)
	sha1sums=('b1d8f517b29b2b0d62d7283edcb5669d8f2b51c5')
	_F_cd_path="$pkgname-$pkgver$pkgextraver"
	depends+=('libsecret')
	export BUILDCC=gcc
fi

subpkgs=('vlc-libdvdnav')
subdescs=('vlc plugin for libdvdnav')
subrodepends=("$pkgname>=$pkgver")
subdepends=("libdvdnav")
subgroups=('xmultimedia-extra vlc-codecs')
subarchs=("x86_64")

subpkgs+=('vlc-twolame')
subdescs+=('vlc plugin for twolame')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("twolame")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-sdlimage')
subdescs+=('vlc plugin for sdlimage')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("sdlimage")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-mkv')
subdescs+=('vlc plugin for mkv')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libmatroska>=1.2.0")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-modplug')
subdescs+=('vlc plugin for libmodplug')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libmodplug")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-upnp')
subdescs+=('vlc plugin for upnp')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libupnp>=1.6.13")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-caca')
subdescs+=('vlc plugin for libcaca')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libcaca")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-pulseaudio')
subdescs+=('vlc plugin for pulseaudio')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libpulse>=7.1 tcp_wrappers")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-opus')
subdescs+=('vlc plugin for opus')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("opus>=1.1.2")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-opencv')
subdescs+=('vlc plugin for opencv')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("opencv>=3.2.0")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-mtp')
subdescs+=('vlc plugin for mpt')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libmtp")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-dv1394')
subdescs+=('vlc plugin for dv1394')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libavc1394")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-sftp')
subdescs+=('vlc plugin for libssh2')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libssh2")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-vnc')
subdescs+=('vlc plugin for vnc')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libvncserver>=0.9.11")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('vlc-samplerate')
subdescs+=('vlc plugin for samplerate')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("libsamplerate")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

if ! Fuse $USE_DEVEL; then
	subpkgs+=('vlc-lirc')
	subdescs+=('vlc plugin for lirc')
	subrodepends+=("$pkgname>=$pkgver")
	subdepends+=("liblirc")
	subgroups+=('xmultimedia-extra vlc-codecs')
	subarchs+=('x86_64')
fi

subpkgs+=('vlc-freerdp')
subdescs+=('vlc plugin for freerdp')
subrodepends+=("$pkgname>=$pkgver")
subdepends+=("freerdp")
subgroups+=('xmultimedia-extra vlc-codecs')
subarchs+=('x86_64')

subpkgs+=('libvlc')
subdescs+=('VLC media player external control library')
subrodepends+=("")
subdepends+=("glibc>=2.24-4 libidn dbus>=1.10.6-5 libsystemd>=228 xz lz4 libgcrypt libgpg-error")
subgroups+=('lib')
subarchs+=('x86_64')

build()
{
	export CXXFLAGS+=" -std=c++11"

	Fpatchall
	Fsed 'truetype/freefont' 'X11/TTF' modules/text_renderer/freetype.c
	Fautoreconf
	Fmake
	Fmakeinstall

	Frm /usr/share/vlc/{,k,q,g,gnome-}vlc*.{png,xpm,ico}
	Fbuild_gnome_scriptlet

	Fsplit vlc-libdvdnav usr/lib/vlc/plugins/access/libdvdnav_plugin*
	Fsplit vlc-twolame usr/lib/vlc/plugins/codec/libtwolame_plugin*
	Fsplit vlc-sdlimage usr/lib/vlc/plugins/codec/libsdl_image_plugin*
	Fsplit vlc-mkv usr/lib/vlc/plugins/demux/libmkv_plugin*
	Fsplit vlc-modplug usr/lib/vlc/plugins/demux/libmod_plugin*
	Fsplit vlc-upnp usr/lib/vlc/plugins/services_discovery/libupnp_plugin*
	Fsplit vlc-caca usr/lib/vlc/plugins/video_output/libcaca_plugin*
	## pulse
	Fsplit vlc-pulseaudio usr/lib/vlc/plugins/audio_output/libpulse_plugin*
	Fsplit vlc-pulseaudio usr/lib/vlc/plugins/access/libpulsesrc_plugin*
	Fsplit vlc-pulseaudio usr/lib/vlc/plugins/services_discovery/libpulselist_plugin*
	Fsplit vlc-opus usr/lib/vlc/plugins/codec/libopus_*
	Fsplit vlc-opencv usr/lib/vlc/plugins/video_filter/libopencv_*
	Fsplit vlc-mtp usr/lib/vlc/plugins/services_discovery/libmtp_*
	Fsplit vlc-mtp usr/lib/vlc/plugins/access/libaccess_mtp*
	Fsplit vlc-dv1394 usr/lib/vlc/plugins/access/libdv1394_*
	Fsplit vlc-sftp usr/lib/vlc/plugins/access/libsftp_plugin*
	Fsplit vlc-vnc usr/lib/vlc/plugins/access/libvnc_*
	Fsplit vlc-samplerate usr/lib/vlc/plugins/audio_filter/libsamplerate*
	if ! Fuse $USE_DEVEL; then
		Fsplit vlc-lirc usr/lib/vlc/plugins/control/liblirc_*
	fi
	Fsplit vlc-freerdp usr/lib/vlc/plugins/access/librdp_*

	## the lib
	Fsplit libvlc usr/lib/libvlc.*
	Fsplit libvlc usr/lib/libvlccore.*
	Fsplit libvlc usr/include/vlc/{libvlc*,deprecated,vlc}.h
	Fsplit libvlc usr/lib/pkgconfig/libvlc.pc
}

# optimization OK

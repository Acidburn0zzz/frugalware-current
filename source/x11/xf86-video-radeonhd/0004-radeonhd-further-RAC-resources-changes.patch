From d389503eace03c0d8adf2028ade099b7a7f38a8a Mon Sep 17 00:00:00 2001
From: Dave Airlie <airlied@redhat.com>
Date: Tue, 28 Jul 2009 13:39:32 +1000
Subject: [PATCH] radeonhd: further RAC/resources changes

---
 src/rhd_driver.c |    4 ++++
 src/rhd_id.c     |    5 ++++-
 2 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/src/rhd_driver.c b/src/rhd_driver.c
index e7dca79..ad102d9 100644
--- a/src/rhd_driver.c
+++ b/src/rhd_driver.c
@@ -541,10 +541,12 @@ RHDPreInit(ScrnInfoPtr pScrn, int flags)
 	goto error0;
     }
 
+#ifndef XSERVER_LIBPCIACCESS
     if (rhdPtr->pEnt->resources) {
         xfree(rhdPtr->pEnt);
 	goto error0;
     }
+#endif
 
     pScrn->videoRam = rhdPtr->pEnt->device->videoRam;
     rhdPtr->entityIndex = rhdPtr->pEnt->index;
@@ -1277,7 +1279,9 @@ RHDScreenInit(int scrnIndex, ScreenPtr pScreen, int argc, char **argv)
                          CMAP_PALETTED_TRUECOLOR | CMAP_RELOAD_ON_MODE_SWITCH))
 	return FALSE;
 
+#ifndef XSERVER_LIBPCIACCESS
     pScrn->racIoFlags = pScrn->racMemFlags = racflag;
+#endif
 
     /* Function to unblank, so that we don't show an uninitialised FB */
     pScreen->SaveScreen = RHDSaveScreen;
diff --git a/src/rhd_id.c b/src/rhd_id.c
index a95e9e9..53cdf7a 100644
--- a/src/rhd_id.c
+++ b/src/rhd_id.c
@@ -29,7 +29,9 @@
 #include "git_version.h"
 
 #include "xf86.h"
+#ifndef XSERVER_LIBPCIACCESS
 #include "xf86Resources.h"
+#endif
 
 #include "rhd.h"
 #ifdef ATOM_BIOS
@@ -101,7 +103,6 @@ SymTabRec RHDChipsets[] = {
     { -1,      NULL }
 };
 
-resRange res_none[] = { _END };
 
 /*
  * This is what people would refer to as "Petite".
@@ -113,6 +114,8 @@ resRange res_none[] = { _END };
 # define PCI_ID_LIST struct pci_id_match RHDDeviceMatch[]
 # define LIST_END { 0, 0, (~0), (~0), 0, 0, 0 }
 #else
+resRange res_none[] = { _END };
+
 # define RHD_DEVICE_ENTRY(d, i, r) \
     { (i), (d), r }
 # define RHD_DEVICE_MATCH(d, i) \
-- 
1.6.4


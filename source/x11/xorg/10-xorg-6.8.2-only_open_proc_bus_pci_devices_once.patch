--- xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_pci.c.orig	2004-12-20 09:19:37.768077880 +0100
+++ xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_pci.c	2004-12-20 09:22:00.111438400 +0100
@@ -19,10 +19,11 @@
 #define PCIADDR_FMT		"%lx"
 #endif
 
+FILE *xf86OSLinuxPCIFile = NULL;
+
 Bool
 xf86GetPciSizeFromOS(PCITAG tag, int index, int* bits)
 {
-    FILE *file;
     char c[0x200];
     char *res;
     unsigned int bus, devfn, dev, fn;
@@ -33,10 +34,11 @@
     if (index > 7)
 	return FALSE;
     
-    if (!(file = fopen("/proc/bus/pci/devices","r")))
+    if (!xf86OSLinuxPCIFile && \
+        !(xf86OSLinuxPCIFile = fopen("/proc/bus/pci/devices","r")))
 	return FALSE;
     do {
-	res = fgets(c,0x1ff,file);
+	res = fgets(c,0x1ff,xf86OSLinuxPCIFile);
 	if (res) {
 	    num = sscanf(res,
 			 /*bus+dev vendorid deviceid irq */
@@ -60,7 +62,7 @@
 			 &bus,&devfn,&size[0],&size[1],&size[2],&size[3],
 			 &size[4],&size[5],&size[6]);
 	    if (num != 9) {  /* apparantly not 2.3 style */ 
-		fclose(file);
+		fseek(xf86OSLinuxPCIFile, 0L, SEEK_SET);
 		return FALSE;
 	    }
 	    dev = devfn >> 3;
@@ -74,12 +76,12 @@
 			(*bits)++;
 		    }
 		}
-		fclose(file);
+		fseek(xf86OSLinuxPCIFile, 0L, SEEK_SET);
 		return TRUE;
 	    }
 	}
     } while (res);
 
-    fclose(file);
+    fseek(xf86OSLinuxPCIFile, 0L, SEEK_SET);
     return FALSE;
 }

# Last Modified: Sat, 04 Jun 2005 12:44:52 +0000
# Compiling Time: ~2 hours
# Maintainer: zleho <zleho@index.hu>
# Contributor: VMiklos <mamajom@axelero.hu>

pkgname=xorg
pkgver=6.8.2
pkgrel=3
pkgdesc="A fork of the XFree86 Project with a GPL-compatible license"
url="http://www.x.org"
backup=(usr/X11R6/lib/X11/icons/default/index.theme etc/X11/xdm/Xsession \
	etc/sysconfig/desktop)
depends=('ncurses' 'fontconfig' 'gcc' 'libpng')
groups=('x11')
archs=('i686' 'x86_64')
conflicts=('xfree86')
provides=('x')
makedepends=('perl')
install=$pkgname.install
up2date="lynx -dump http://www.x.org/pub/|grep ]X11R|sed -n 's|.*R\(.*\)/.*|\1|;$ p'"
source=(ftp://ftp.gwdg.de/pub/x11/x.org/pub/X11R6.8.2/src-single/X11R6.8.2-src.tar.bz2 \
	Xsession desktop \
	rc.xprint libGL.la $pkgname-$pkgver-black-background.patch \
	$pkgname-$pkgver-can-2005-0605.diff xorg-6.8.2-fix_drm_compile_error.patch \
	00-xorg-6.8.2-mmx-gcc4.amd64.patch 01-xorg-8.6.2-vmware-amd64.patch)
md5sums=('8131cd7ea1e4566e6e05c438a93fcfe1' \
         '5e201b584b43de4e33da52a8c3085513' 'a386339431c93347f4ffe694d2f8dcd7' \
         '0a6f2850515182cfd28a061cc580f89d' '6b4052cf6d50cbd2854ebd3409f02695' \
         'aaf19c351c5340e0ef93ee25a6ccadb8' '1fec60b9007085c3b9286d8087015391' \
	 '8666bba1ae3abde2fc1a3d1dc58fb4dd' \
	 '4ee10bc6dc19e471de79001fae43870f' '7b2b143d3d6c1308b91ac550b895319b')

build() {	
	cd $startdir/src/xc
	patch -Np1 -i $startdir/src/$pkgname-$pkgver-black-background.patch || return 1
	patch -Np1 -i $startdir/src/$pkgname-$pkgver-can-2005-0605.diff || return 1
	[ "$CARCH" == "x86_64" ] && (patch -Np1 -i $startdir/src/$pkgname-$pkgver-fix_drm_compile_error.patch || return 1)
	[ "$CARCH" == "x86_64" ] && (patch -Np1 -i $startdir/src/00-$pkgname-$pkgver-mmx-gcc4.amd64.patch || return 1)
	[ "$CARCH" == "x86_64" ] && (patch -Np1 -i $startdir/src/01-xorg-8.6.2-vmware-amd64.patch || return 1)
	echo $'#define HasZlib YES\n' >config/cf/host.def
	echo $'#define HasNCurses YES\n' >>config/cf/host.def
	echo $'#define HasFontconfig YES\n' >>config/cf/host.def
	echo $'#define UseFreetype2 YES\n' >>config/cf/host.def
	echo $'#define HasFreetype2 YES\n' >>config/cf/host.def
	echo $'#define FreeType2IncDir /usr/include/freetype2\n' >>config/cf/host.def
	echo $'#define FreeType2IncDir /usr/include/freetype2\n' >>config/cf/host.def
	echo $'#define BuildFreeType2Library NO\n' >>config/cf/host.def
	echo $'#define HasExpat YES\n' >>config/cf/host.def
	echo $'#define HasMMXSupport YES\n' >>config/cf/host.def
[ "$CARCH" == "x86_64" ] && echo $'#define BootstrapCFlags -march=k8\n' >>config/cf/host.def
[ "$CARCH" == "x86_64" ] && echo $'#define HaveLib64 NO\n' >>config/cf/host.def
[ "$CARCH" == "x86_64" ] && echo $'#define HasSSESupport YES\n' >>config/cf/host.def
[ "$CARCH" == "x86_64" ] && echo $'#define Has3DNowSupport YES\n' >>config/cf/host.def
[ "$CARCH" == "x86_64" ] && echo $'#define DefaultGcc2x86_64Opt -march=k8 GccAliasingArgs\n' >>config/cf/host.def
[ "$CARCH" == "x86_64" ] && echo $'#define OptimizedCDebugFlags -march=k8 GccAliasingArgs\n' >>config/cf/host.def
[ "$CARCH" == "x86_64" ] && echo $'#define OptimizedCplusplusDebugFlags -march=k8 GccAliasingArgs\n' >>config/cf/host.def

	make World || return 1

	make DESTDIR=$startdir/pkg install
	make DESTDIR=$startdir/pkg install.man
  
	cp -f $startdir/src/Xsession $startdir/pkg/etc/X11/xdm/Xsession
	mv $startdir/pkg/etc/X11/xinit/xinitrc $startdir/pkg/etc/X11/xinit/xinitrc.twm
	chmod +x $startdir/pkg/etc/X11/xinit/xinitrc.twm
	install -D -m644 $startdir/src/desktop \
		$startdir/pkg/etc/sysconfig/desktop
	# xprint service, probably it would be easier writing an own script :)
	# mkdir $startdir/pkg/etc/rc.d
	# mv $startdir/pkg/etc/init.d/xprint $startdir/pkg/etc/rc.d/rc.xprint
	# sed -i 's|\(.*/usr/share/fonts.*\)|# \1|' $startdir/pkg/etc/rc.d/rc.xprint
	# sed -i 's/-name fonts.dir/-name fonts.dir ! -size 1w/' rc.xprint
	rm -rf $startdir/pkg/etc/init.d
	rm -rf $startdir/pkg/etc/rc.d/rc?.d
	mkdir -p $startdir/pkg/etc/rc.d/rc.messages
	install -m755 $startdir/rc.xprint $startdir/pkg/etc/rc.d/rc.xprint
	install -m644 $startdir/messages/xprint.* \
		$startdir/pkg/etc/rc.d/rc.messages/
	
	for i in $startdir/pkg/etc/profile.d/xprint.csh \
		$startdir/pkg/etc/profile.d/xprint.sh
	do
		sed -i 's|/etc/init.d/xprint|/etc/rc.d/rc.xprint|' $i
	done
	
	(cd $startdir/pkg/usr/include && ln -sf ../X11R6/include/X11 X11)
	(cd $startdir/pkg/usr/include && ln -sf ../X11R6/include/GL GL)
	install -D -m644 $startdir/src/libGL.la $startdir/pkg/usr/lib/libGL.la
	
	# Remove ugly TrueType Luxi fonts, we use the Type1 ones.
	# rm $startdir/pkg//usr/X11R6/lib/X11/fonts/TTF/luxi*
	# mkfontscale $startdir/pkg//usr/X11R6/lib/X11/fonts/TTF
	# mkfontdir $startdir/pkg//usr/X11R6/lib/X11/fonts/TTF

	# XDM: do not exec xconsole at startup
	sed -e 's/xconsole/#xconsole/g' -i $startdir/pkg/etc/X11/xdm/Xsetup_0
}

# vim: ft=sh

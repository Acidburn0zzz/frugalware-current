# Last modified: Tue, 16 Aug 2005 14:38:18 +0200
# Compiling time: ~8.93 SBU
# Maintainer: zleho <zleho@index.hu>
# Contributor: VMiklos <vmiklos@frugalware.org>

pkgname=xorg
pkgver=6.8.2
pkgrel=7
pkgdesc="A fork of the XFree86 Project with a GPL-compatible license"
url="http://www.x.org/"
backup=('usr/X11R6/lib/X11/icons/default/index.theme' \
	'etc/X11/xdm/Xsession' \
	'etc/sysconfig/desktop')
depends=('ncurses' 'fontconfig' 'libstdc++' 'libpng')
makedepends=('perl')
conflicts=('xfree86')
provides=('x')
groups=('x11')
archs=('i686' 'x86_64')
install=$pkgname.install
up2date="lynx -dump http://www.x.org/pub/|grep ]X11R|sed -n 's|.*R\(.*\)/.*|\1|;$ p'"
source=(ftp://ftp.gwdg.de/pub/x11/x.org/pub/X11R6.8.2/src-single/X11R6.8.2-src.tar.bz2 \
	00-$pkgname-$pkgver-fix_drm_compile_error.patch \
	01-$pkgname-$pkgver-mmx-gcc4.amd64.patch \
	02-$pkgname-$pkgver-vmware-amd64.patch \
	03-$pkgname-$pkgver-build-libs-with-pic.patch \
	04-$pkgname-$pkgver-x86_64-glx-nopic.patch \
	05-$pkgname-$pkgver-black-background.patch \
	06-$pkgname-$pkgver-can-2005-0605.patch \
	07-$pkgname-$pkgver-gcc4_1.patch \
	08-$pkgname-$pkgver-gcc4_2.patch \
	09-$pkgname-$pkgver-loader_speed_hack.patch \
	10-$pkgname-$pkgver-only_open_proc_bus_pci_devices_once.patch \
	11-$pkgname-$pkgver-CAN-2005-2495.patch0 \
	desktop \
	libGL.la \
	rc.xprint \
	$pkgname.install \
	Xsession)
sha1sums=('632e25a202bc41bb9b1c5dbc8bbb0d775c6593b0' \
	  'fb134bb5d3c1ac7ebe5e0d4b8c6c0070f37a0289' \
	  '06530daf7352506350cf4698a86223ecaebc35b4' \
	  '5e858a481dfdbdf6b453292e3a18aada786f3ce5' \
	  '18a4ae3666b40c2659a58cbdc26fa715d252a45d' \
	  '78186385688d32c7cdcf36b1a9c87c6f48fa83a5' \
	  '95dbe0513da7e84659ba8d52a1ee18daca56ff3b' \
	  'c1238e757e5ed3b1f83ba4f26594a9f46499edce' \
	  '2712aff9b43c4b0d26d4eed94c684fdfb7448dbb' \
	  '7573cec499728dee2b3efc3bc7316e36b2ef287a' \
	  '9adc6409f1c95dd0fc19843eeb5b78327ce4c179' \
	  'c582ea6e9c3b1fa4f48c7833a8ccb84740a8f6bd' \
	  'ed3bc27ec93b9d4ec719a2e10fe35d9ab1a311fa' \
	  '04fbe3125030273fca114463863e3a4f30ca636b' \
	  '8f822847c1fee77978495d8ad5bbaa2ccfa8670a' \
	  '4713d46b31eafbde58a1fafe8269642df6a12d77' \
	  '268d16bfeee7ee296294726437fbd0c611e26607' \
	  'e0dc8db0d88be2bcb6f1b746e5079ffbc0416693')

build()
{
	Fcd xc
	[ "$CARCH" == "x86_64" ] && Fpatch 00-$pkgname-$pkgver-fix_drm_compile_error.patch
	[ "$CARCH" == "x86_64" ] && Fpatch 01-$pkgname-$pkgver-mmx-gcc4.amd64.patch
	[ "$CARCH" == "x86_64" ] && Fpatch 02-$pkgname-$pkgver-vmware-amd64.patch
	[ "$CARCH" == "x86_64" ] && Fpatch 03-$pkgname-$pkgver-build-libs-with-pic.patch
	[ "$CARCH" == "x86_64" ] && Fpatch 04-$pkgname-$pkgver-x86_64-glx-nopic.patch
	Fpatch 05-$pkgname-$pkgver-black-background.patch
	Fpatch 06-$pkgname-$pkgver-can-2005-0605.patch
	[ "$CARCH" != "x86_64" ] && Fpatch 07-$pkgname-$pkgver-gcc4_1.patch
	Fpatch 08-$pkgname-$pkgver-gcc4_2.patch
#	Fpatch 09-$pkgname-$pkgver-loader_speed_hack.patch
#	Fpatch 10-$pkgname-$pkgver-only_open_proc_bus_pci_devices_once.patch
	Fpatch 11-$pkgname-$pkgver-CAN-2005-2495.patch0
	echo "#define HasZlib YES" > config/cf/host.def
	echo "#define HasNCurses YES" >> config/cf/host.def
	echo "#define HasFontconfig YES" >> config/cf/host.def
	echo "#define UseFreetype2 YES" >> config/cf/host.def
	echo "#define HasFreetype2 YES" >> config/cf/host.def
	echo "#define FreeType2IncDir /usr/include/freetype2" >> config/cf/host.def
	echo "#define FreeType2IncDir /usr/include/freetype2" >> config/cf/host.def
	echo "#define BuildFreeType2Library NO" >> config/cf/host.def
	echo "#define HasExpat YES" >> config/cf/host.def
	echo "#define HasMMXSupport YES" >> config/cf/host.def
	[ "$CARCH" == "x86_64" ] && echo "#define BootstrapCFlags -march=k8" >> config/cf/host.def
	[ "$CARCH" == "x86_64" ] && echo "#define HaveLib64 NO" >> config/cf/host.def
	[ "$CARCH" == "x86_64" ] && echo "#define HasSSESupport YES" >> config/cf/host.def
	[ "$CARCH" == "x86_64" ] && echo "#define Has3DNowSupport YES" >> config/cf/host.def
	[ "$CARCH" == "x86_64" ] && echo "#define DefaultGcc2x86_64Opt -march=k8 GccAliasingArgs" >> config/cf/host.def
	[ "$CARCH" == "x86_64" ] && echo "#define OptimizedCDebugFlags -march=k8 GccAliasingArgs" >> config/cf/host.def
	[ "$CARCH" == "x86_64" ] && echo "#define OptimizedCplusplusDebugFlags -march=k8 GccAliasingArgs" >> config/cf/host.def
	[ "$CARCH" == "x86_64" ] && echo "#define StaticNeedsPicForShared YES" >> config/cf/host.def

	make World || return 1

	make DESTDIR=$Fdestdir install
	make DESTDIR=$Fdestdir install.man

	Fexe /etc/X11/xdm/Xsession
	Fmv /etc/X11/xinit/xinitrc /etc/X11/xinit/xinitrc.twm
	chmod +x $Fdestdir/etc/X11/xinit/xinitrc.twm
	Ffile /etc/sysconfig/desktop
	# Removed xorg's xprint init script, we use own script.
	Frm /etc/init.d
	Frm /etc/rc.d/rc?.d
	Frcd xprint

	Fsed '/etc/init.d/xprint' '/etc/rc.d/rc.xprint' \
		$Fdestdir/etc/profile.d/xprint.csh
	Fsed '/etc/init.d/xprint' '/etc/rc.d/rc.xprint' \
		$Fdestdir/etc/profile.d/xprint.sh

	Fln ../X11R6/include/X11 /usr/include/X11
	Ffile /usr/lib/libGL.la

	# Remove ugly TrueType Luxi fonts, we use the Type1 ones.
	Frm /usr/X11R6/lib/X11/fonts/TTF/luxi*

	Frm /usr/X11R6/lib/X11/fonts/TTF/fonts.cache-2
	Frm /usr/X11R6/lib/X11/fonts/Type1/fonts.cache-2

	# Need for some binary driver and maybe for other stuffs (eg.: nvidia).
	[ "$CARCH" == "x86_64" ] && Fln /usr/X11R6/lib /usr/X11R6/lib64

	# XDM: Do not exec xconsole at startup.
	Fsed 'xconsole' '#xconsole' $Fdestdir/etc/X11/xdm/Xsetup_0
}

# vim: ft=sh

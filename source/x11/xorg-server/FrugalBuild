# Compiling Time: 6.34 SBU
# Maintainer: Christian Hamar alias krix <krics@linuxforum.hu>

pkgname=xorg-server
pkgver=1.2.0
pkgrel=2
mesaver=6.5.2
pkgdesc="Modular X.Org X Server"
groups=('x11' 'xorg-core')
archs=('i686' 'x86_64')
depends=('libxfont>=1.2.7-2' 'libx11>=1.1.1-2' 'xtrans>=1.0.3' 'libxau>=1.0.3' \
	'libxext>=1.0.2' 'libxkbfile>=1.0.4' 'libxdmcp' 'libxmu' 'libxrender>=0.9.2' \
	'libxi>=1.1.0' 'freetype2>=2.3.1' 'mesa>=6.5.2-1' 'font-cursor-misc' 'font-misc-misc' \
	'xbitmaps' 'xkeyboard-config' 'iceauth' 'rgb' 'xauth>=1.0.2' 'xinit>=1.0.3' 'libxaw' \
	'libxpm>=3.5.6' 'libxxf86misc' 'libxxf86vm' 'libxkbui' 'liblbxutil' \
	'xorg-cf-files' 'libxtst' 'font-alias' 'libxcb>=1.0')
makedepends=('randrproto' 'renderproto' 'fixesproto' 'damageproto' 'xextproto' 'xproto>=7.0.10' \
	'xf86dgaproto' 'xf86miscproto' 'xf86rushproto' 'xf86vidmodeproto' 'xf86bigfontproto' \
	'compositeproto' 'recordproto' 'resourceproto' 'videoproto' 'scrnsaverproto' 'evieext' \
	'trapproto' 'xineramaproto' 'fontsproto' 'kbproto' 'inputproto' 'bigreqsproto' 'xcmiscproto' \
	'glproto' 'xf86driproto' 'libdrm>=2.3.0' 'printproto' 'mkfontdir' 'mkfontscale>=1.0.3' \
	'fontcacheproto' 'xorg-sgml-doctools' 'util-macros>=1.1.5')
rodepends=('xf86-input-mouse' 'xf86-input-keyboard' 'xf86-video-vga' 'xf86-video-vesa' 'libglx')
provides=('xorg-compat')
replaces=('xorg-compat')
backup=('etc/sysconfig/desktop')
_F_xorg_nr=2
Finclude xorg
source=(${source[@]} http://dl.sourceforge.net/sourceforge/mesa3d/MesaLib-$mesaver.tar.bz2 \
	01-kernel-headers-fix.patch \
	02-access_c_skip_null_addresses.patch \
	03-black-background.patch \
	desktop \
	rc.xprint \
	change-default-dri-driver-dir-X7.1.patch \
	mesa-build-config.patch \
	F-xorg-x11-server-0.99.3-init-origins-fix.patch0 \
	F-xorg-x11-server-1.1.1-graphics-expose.patch \
	xprint-rc-files-fix.patch \
	i915tex.patch \
	bug-9045.patch \
	bug-9237.patch \
	no-aiglx.patch \
	bug-9367.patch \
	http://xorg.freedesktop.org/archive/X11R7.2/patches/xorg-xserver-1.2.0-xcmisc.diff)

subpkgs=('libglx')
subdescs=('Glx library for XOrg.')
subdepends=('glibc')
subgroups=('x11 xorg-core')
subarchs=('i686 x86_64')

build() {
	cd $Fsrcdir/Mesa-$mesaver || Fdie
	# Mesa specific patches from the mesa package
	Fpatch change-default-dri-driver-dir-X7.1.patch
	Fpatch mesa-build-config.patch
	Fpatch i915tex.patch
        Fpatch bug-9045.patch
        Fpatch bug-9237.patch

	cd $Fsrcdir/$_F_xorg_name-$_F_xorg_version$_F_xorg_nr-$pkgver || Fdie
	Fpatch 01-kernel-headers-fix.patch
	Fpatch 02-access_c_skip_null_addresses.patch
	Fpatch 03-black-background.patch
	# From fedora, misc fixes.
	Fpatch F-xorg-x11-server-0.99.3-init-origins-fix.patch0
	Fpatch F-xorg-x11-server-1.1.1-graphics-expose.patch
	# Hack for init scripts and wrong install stuff for xprint
	Fpatch xprint-rc-files-fix.patch
	## this disables AIGLX by default , comment it to enable 
	## Fpatch no-aiglx.patch
	## workaround ATI's closes source c***
	## see https://bugs.freedesktop.org/show_bug.cgi?id=9367
	Fpatch bug-9367.patch
	## SEC stuff , see BTS #1910
	Fpatch xorg-xserver-1.2.0-xcmisc.diff
	Fautoreconf

	Fmake \
		--disable-static \
		--enable-ipv6 \
		--enable-dri \
		--with-dri-driver-path=/usr/lib/dri \
		--disable-xprint \
		--enable-xcsecurity \
		--enable-xorg \
		--disable-dbus \
		--enable-xtrap \
		--enable-xevie \
		--enable-vfb \
		--sysconfdir=/etc/X11 \
		--localstatedir=/var \
		--enable-multibuffer \
		--with-mesa-source=$Fsrcdir/Mesa-$mesaver \
		--with-vendor-web="http://www.frugalware.org" \
		--with-os-name="Frugalware Linux" \
		--with-os-vendor="Frugalware.org Development Team" \
		--with-xkb-output=/var/lib/xkb \
		--with-xkb-path=/usr/lib/X11/xkb \
		--disable-xorgcfg
	Fmakeinstall

	Ffile /etc/sysconfig/desktop
#	Disabled for reasons :P
#	Frcd xprint

	# I dont think that simple user need this Xsession file on by-default :S
#	Fmkdir /etc/X11/Xsession.d.xprint
#	Fmv /etc/X11/Xsession.d/92* /etc/X11/Xsession.d.xprint/

	Fsplit libglx usr/lib/xorg/modules/extensions/libglx.*
}

sha1sums=('3c4e8ae90fafdddb4ec6e640b693c2beb295d106'\
          'ba860bb6ee57c02202342dfd5927464a068ea18f'\
          'f31702e0029b2d68018598e73ed55c4d6c58367b'\
          '859b98a4049400be152032fc09ceff2afe9e6dcf'\
          '863ad92892785c3785b122bf54d0def4d4d2732c'\
          '777194af057a8cfe02a4d5aacade37c6e4c4786f'\
          '4713d46b31eafbde58a1fafe8269642df6a12d77'\
          '426b0b08617ec19cba41ab20f3891cab82f205a2'\
          'b49bb4f22426fd0dab7551ef8907276214c9a3fa'\
          '2937d6a50155cc16f73ae44b1e5b6e26cabbb86a'\
          '31938c89a107ce89b06287b28c6d355ecaa13217'\
          '0eb64d46172b6f2f4462c02dad7964c6d7656076'\
          '067931e73ffd718f0715ddd69040c660821083d8'\
          'af385a1f28afb4368719c634b4fb5d3991e9e432'\
          '9d0d4102b26962cc453c4d66f5638f0cfb33c4fd'\
          'f53de93da5e110867db8b1655b5798d2049f43ae'\
          '22025bd7b96deec8cd31f24fe87a170f1c7898d1'\
          '3557cbe23be6912106ed7220d95301311fb93a26')
# optimization OK

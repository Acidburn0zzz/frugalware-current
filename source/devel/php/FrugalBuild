# Compiling Time: 5.10 SBU
# Maintainer: crazy <crazy@frugalware.org>
# Contributor: VMiklos <vmiklos@frugalware.org>

pkgname=php
pkgver=5.2.2
pkgrel=1
pkgdesc="A widely-used general-purpose scripting language"
url="http://www.php.net"
backup=(etc/{php.ini,httpd/conf/modules.d/$pkgname.conf})
depends=('openssl' 'libjpeg' 'freetype2>=2.3.1' 'libpng' 'gdbm' 'libxslt' 'curl>=7.16.1' 'libxml2' 'libmcrypt' \
	'libidn' 'libmysqlclient' 'libpq>=8.2.3' 'sqlite3')
provides=('php-pear-archive_tar' 'php-pear-console_getopt' 'php-pear-pear')
makedepends=('apache' 'imap>=2006e-2' 'bzip2' 'mta' 'tidy' 'freetds' 'mysql' 'postgresql>=8.2.3' 'openldap' 'libldap')
groups=('devel')
archs=('i686' 'x86_64')
up2date="lynx -dump http://www.php.net/downloads.php |grep 'Complete Source Code' -3|sed -n 's/.*P \(.*\)/\1/;2 p'"
source=(http://www.php.net/distributions/$pkgname-$pkgver.tar.gz \
	php.ini php.conf README.Frugalware \
	http://www.php.net/distributions/manual/php_manual_{en,ar,pt_BR,zh,hk,tw,cs,da,nl,fi,fr,de,el,hu,it,ja,kr,pl,ro,ru,sk,es,sv}.tar.gz)

subpkgs=("$pkgname-cgi")
suboptions=('nodocs') ## its depends on PHP and the same files are installed etc
subdescs=("CGI binary for php and its libs.")
subdepends=("$pkgname=$pkgver")
subgroups=('devel-extra')
subarchs=('i686 x86_64')

# lynx -dump http://www.php.net/download-docs.php|grep tar.gz/|sed 's/.*_\(.*\)\.t.*/\1/'|sed -e :a -e '$!N;s/\n/" "/;ta' -e 'P;D'
phpsubpkgs=("en" "ar" "pt_BR" "zh" "hk" "tw" "cs" "da" "nl" "fi" "fr" "de" "el" "hu" "it" "ja" "kr" "pl" "ro" "ru" "sk" "es" "sv")
# lynx -dump http://www.php.net/download-docs.php|grep 'html.gz '|sed 's/.* \([A-Z][^\[]*\) \[.*/\1/'|sed -e :a -e '$!N;s/\n/" "/;ta' -e 'P;D'
phpsubdescs=("English" "Arabic" "Portuguese" "Chinese (Simplified)" 
"Chinese (Hong Kong Cantonese)" "Chinese (Traditional)" "Czech" "Danish" "Dutch"
"Finnish" "French" "German" "Greek" "Hungarian" "Italian" "Japanese" "Korean"
"Polish" "Romanian" "Russian" "Slovak" "Spanish" "Swedish")

i=0
while [ $i -lt ${#phpsubpkgs[@]} ]
do
	subpkgs=("${subpkgs[@]}" "php-docs-`echo ${phpsubpkgs[$i]}|tr [A-Z] [a-z]`")
	subdescs=("${subdescs[@]}" "${phpsubdescs[$i]} Documentation for PHP.")
	subdepends=("${subdepends[@]}" "")
	suboptions=("${suboptions[@]}" "")
	subgroups=("${subgroups[@]}" "locale-extra")
	subarchs=("${subarchs[@]}" "i686 x86_64")
	i=$(($i+1))
done

build()
{
	## the php config
	phpconfig="--with-config-file-path=/etc \
		--enable-mailparse \
		--enable-bcmath=shared \
		--enable-calendar=shared \
		--enable-ftp=shared \
		--enable-gd-native-ttf \
		--enable-magic-quotes \
		--enable-posix=shared  \
		--enable-session \
		--enable-shared \
		--enable-shmop=shared \
		--enable-sysvsem=shared \
		--enable-sysvshm=shared \
		--enable-track-vars \
		--enable-trans-sid \
		--enable-safe-mode \
		--enable-sockets=shared \
		--enable-exif \
		--enable-sigchild \
                --enable-pcntl \
                --enable-memory-limit \
                --enable-sysvmsg \
                --enable-yp \
                --enable-dbx \
                --enable-mbstring \
		--without-db2 \
		--without-db3 \
                --with-ttf \
		--with-bz2=shared \
		--with-freetype-dir=/usr \
		--with-gd=shared \
		--with-gdbm=shared \
		--with-jpeg-dir=/usr \
		--with-mcrypt=shared,/usr \
		--with-mysql=shared,/usr \
		--with-mysql-sock=/tmp/mysql.sock \
		--with-openssl \
		--with-gettext \
		--with-pear=/usr/share/pear \
		--with-dom \
		--with-dom-xslt \
		--with-png-dir=/usr \
		--with-regex=php \
		--with-zlib \
		--with-xsl \
		--with-pgsql=shared \
		--with-pgsql-sock=/tmp/pgsql.sock \
		--with-mysqli \
		--with-curl=/usr/bin \
		--with-xmlrpc \
		--with-imap=shared \
		--with-imap-ssl=shared \
		--with-tidy \
		--with-tidy=shared \
		--with-ldap=shared \
		--with-mssql=shared \
		--with-mime-magic" \
		--with-sqlite=shared
	
	## this is true for both
	Fpatchall
	## PHP-CGI first
	Fmkdir usr/lib/php
        ./buildconf --force
        Fmake ${phpconfig} \
		--enable-fastcgi \
		--enable-cgi \
		--enable-discard-path \
		--enable-force-cgi-redirect
	
	make INSTALL_ROOT=$Fdestdir EXTENSION_DIR=/usr/lib/php PEAR_INSTALLDIR=/usr/share/pear install || Fdie
	## remove stuff is in php
	Fcd $Fdestdir
	Frm etc ./{.registry,.channels,.depdb*,.lock,.file*} usr/{include,share,lib,man}
	Frm usr/bin/{phpize,php-config,pecl,pear*}
	
	Fmv usr/bin/php usr/bin/php-cgi
	## yeah mv because Fdoc will not work
	## and if I don't move it it will be installed in PHP build as well =)
	Fmkdir usr/share/doc/$pkgname-cgi-$pkgver
	mv -f $Fsrcdir/README.Frugalware $Fdestdir/usr/share/doc/$pkgname-cgi-$pkgver/
	## split it
	Fsplit $pkgname-cgi /usr
	## PHP build
	# clean
	Fmessage "Prepare for PHP build. Running distclean..."
	make distclean
	./buildconf --force 
	Fmake ${phpconfig} --with-apxs2
	Fmkdir usr/lib/apache
	Fsed "-i -a -n php5" "-i -n php5" Makefile
	make INSTALL_ROOT=$Fdestdir EXTENSION_DIR=/usr/lib/php PEAR_INSTALLDIR=/usr/share/pear install || Fdie
	Fsed "$Fdestdir" "" $Fdestdir/usr/{bin/pear,share/pear/pearcmd.php}
	Ffile /etc/httpd/conf/modules.d/$pkgname.conf
	Ffile /etc/php.ini
	Fln /etc/php.ini /usr/lib/php.ini
	# manual
	Fmkdir /usr/share/doc/php-$pkgver/
	# package names are lowercase
	mv $Fsrcdir/php_manual_pt_BR.tar.gz $Fsrcdir/php_manual_pt_br.tar.gz
	cd $Fdestdir/usr/share/doc/php-$pkgver/
	for i in ${phpsubpkgs[@]}
	do
		i=`echo $i|tr [A-Z] [a-z]`
		# usually there is a html dir inside the tarball, but there are
		# some exceptions
		if [ "$i" != "hk" -a "$i" != "kr" -a "$i" != "ro" ]; then
			tar xf $Fsrcdir/php_manual_$i.tar.gz
			mv html $i
		else
			mkdir $i
			cd $i
			tar xf $Fsrcdir/php_manual_$i.tar.gz
			cd ..
		fi
		Fsplit php-docs-$i usr/share/doc/php-$pkgver/$i
	done
}

sha1sums=('9addca2ae7b6bf2bea78023484212d9f32fd08d7'\
          '9ba6e9430bdba5f6ab2bad15e7cc354d0ea3fd58'\
          '0850ef23512a02e8460dc36f08f453d148dcd9df'\
          '40ae88f0721e02a2c75de76be342c51c85bf734d'\
          'b98d1b83435d8dca25d29797846532f02dfffd6d'\
          '71da8dc871f27f93941ae06dbcd925c79b91f097'\
          '817eec918ed73ad3ca239a78f3c6272ff3ea4432'\
          'e20217326c05d679725710c373074910da8ce68c'\
          'cac03209cfe9f69b60beea36d368b079c8ecd070'\
          'e230385eb4299c60d9af95f0d55ee06ef35a241a'\
          'ee703c97c5056bcb222ae4ce021350afc6517004'\
          '794ef8d46894b41e05b9bd83d2474719921b6946'\
          'ec673df393cf93c7bcb22142a5e1f280cdfc6680'\
          'adbe3f142e2e3720ede53d278730ab4ba70e02c9'\
          'ceb99850e6cf07a14ac218103b258b9a746cca0d'\
          '9bc276fcbee9f9ba72303c464c2a6f841ff4775a'\
          '12f18ece62de40a5fa5ab5d2dcfeb68d218fb5fa'\
          '68f90ee674d60bd3af9497d5a37f057afb7be332'\
          '7b60f775ea189edbb8076e06b327cdec25176fc3'\
          'fce0c91c42a1d046cb1f73ce65d282e39c6536ae'\
          '07393df710aea0266ad35efe43772058dfdef3cd'\
          'f963f7de3c464a1b538bcef6409f010cdba11579'\
          'f1f5ba5502f01d5a15048276d245f5cd1077291c'\
          '5ab82c264b02f9f52b71613974eb526edf352e61'\
          'fe3906f5b4ae199b70f486a5a49ae4e6774c2ca5'\
          '9d3640586525a157669400d8d471e7696097ca00'\
          'f479e4943e14c3a442659c3af05e30d32156d1b1')
# optimization OK



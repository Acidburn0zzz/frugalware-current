From 5b295bf19161b14d6c81151fd89c2f17bd50525c Mon Sep 17 00:00:00 2001
From: Remi Collet <remi@php.net>
Date: Wed, 22 Oct 2014 15:37:04 +0200
Subject: [PATCH] Fix bug #68283: fileinfo: out-of-bounds read in elf note
 headers

Upstream commit
https://github.com/file/file/commit/39c7ac1106be844a5296d3eb5971946cc09ffda0

CVE -2014-3710

(cherry picked from commit 1803228597e82218a8c105e67975bc50e6f5bf0d)
---
 ext/fileinfo/libmagic/readelf.c | 7 +++++++
 1 file changed, 7 insertions(+)

Index: php5-5.3.10/ext/fileinfo/libmagic/readelf.c
===================================================================
--- php5-5.3.10.orig/ext/fileinfo/libmagic/readelf.c	2014-10-28 10:48:25.485177792 -0400
+++ php5-5.3.10/ext/fileinfo/libmagic/readelf.c	2014-10-28 10:48:25.485177792 -0400
@@ -375,6 +375,13 @@
 #endif
 	uint32_t namesz, descsz;
 
+	if (xnh_sizeof + offset > size) {
+		/*
+		 * We're out of note headers.
+		 */
+		return xnh_sizeof + offset;
+	}
+
 	(void)memcpy(xnh_addr, &nbuf[offset], xnh_sizeof);
 	offset += xnh_sizeof;
 

# Compiling time: 0.17 SBU
# Maintainer: Baste <baste@frugalware.org>

pkgname=mozjs
pkgver=38.2.1
pkgextra=".rc0"
pkgrel=1
pkgdesc="JavaScript interpreter and libraries"
url="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Releases/38"
depends=('nspr' 'readline' 'zlib' 'libstdc++>=6.3.1-4' 'icu4c')
makedepends=()
groups=('devel')
archs=("x86_64")
source=(https://people.mozilla.org/~sstangl/mozjs-38.2.1.rc0.tar.bz2 upstream.patch link.patch)
up2date="Flasttar $url | sed 's/$pkgextra//g'"
_F_cd_path="mozjs-38.0.0"
sha1sums=('e25d69718d846a73ee7897a82945a5f920b4be78' \
          '35f5e42e4caaff4a0e809bfdc8c7504bc37e1e43' \
          '432758063859715e4965601b9e5bef8c23525be1')
options+=('static')

build() {
	Fcd
	# Remove zlib directory (to be sure using system version)
	rm -rf modules/zlib
	Fpatchall
	cd js/src
	autoconf-2.13
	# Correct sed expression for new sed
	sed -i 's|\^\[:space:\]|^\[\[:space:\]\]|g' configure
	Fmake --with-system-nspr --enable-system-ffi \
		--with-system-zlib --with-system-icu --with-intl-api --enable-ctypes \
		--enable-threadsafe --enable-system-ffi --enable-shared-js \
		--enable-gcgenerational --disable-optimize --enable-pie
	Fmakeinstall
	Frm usr/lib/*.ajs
	Frm usr/bin/js38
}

# optimization OK

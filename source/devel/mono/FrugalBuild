# Compiling time: 3.45 SBU
# Maintainer: bouleetbil <bouleetbil@frogdev.info>

USE_DOC=${USE_DOC:-"y"}

pkgname=mono
pkgver=2.8
pkgrel=9
pkgdesc="Mono runtime and class libraries, a C# compiler/interpreter"
url="http://www.mono-project.com/"
depends=('zlib')
makedepends=('libgdiplus>=2.8' 'mono')
rodepends=('libxml2')
groups=('devel')
archs=('i686' 'x86_64' 'ppc')
Finclude mono
up2date="lynx -dump http://www.go-mono.com/sources-stable/|grep -m1 'mono-'|sed 's/.*-\(.*\).t.*/\1/'"
source=(http://www.go-mono.com/sources/$pkgname/$pkgname-$pkgver.tar.bz2 rc.mono rc.mono-hu.po ppc_thread.diff)
Fconfopts="$Fconfopts -with-ikvm-native=yes --with-jit=yes --with-xen_opt=n \
	--with-libgdiplus=installed
	--enable-static \
	--with-moonlight=yes \
	--disable-dtrace \
	--with-profile2=yes \
	--with-profile4=yes"
#--enable-static for mono debug works
#Don't enable --enable-big-arrays we should have >3Go of ram
replaces=('monodoc')

#ppc don't support sgen and profile4
if [ "$CARCH" == "ppc" ]; then
	Fconfopts="$Fconfopts --with-sgen=no --with-profile4=no"
fi

if ! Fuse $USE_DOC; then
	Fconfopts="$Fconfopts --with-mcs-docs=no"
fi

sha1sums=('a724de68dccb583b54d2e08c5a1e5760c18225ab' \
          '1a6826fb1bb13f906a1465be43bb592a2a9e0e10' \
          '6c19f98462d7bb1ecba79a3ad284ea02a1eac2ec' \
          '3dda8a39085fddec0b0e25e31743d49762575605')

build() {
	unset MAKEFLAGS
	#Remove this at your own peril. Mono will barf in unexpected ways.
	export CFLAGS="$CFLAGS -fno-strict-aliasing"
	Fcd
	# Remove prebuilt binaries
	#comment this line and remove mono from makedepends for ported mono to an other arch
	rm -rf mcs/class/lib/monolite/* || Fdie

	#fix undeclared Arg
	sed -i "61a #define ARG_MAX     _POSIX_ARG_MAX" mono/io-layer/wapi_glob.h || Fdie
	Fpatchall
	Fmonoexport
	Fautoreconf
	Fmake
	Fmakeinstall
	Fmonocleanup
	# for openoffice
	sed -i -e "s:#Requires:Requires:" ${Fdestdir}/usr/lib/pkgconfig/mono.pc || Fdie
}

# optimization OK

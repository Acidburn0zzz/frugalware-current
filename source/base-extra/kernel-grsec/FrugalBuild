# Compiling Time: 7.26 SBU
# Maintainer: crazy  <crazy@frugalware.org>
# Contributor: Zoltan Kiss <djsmiley@frugalware.org>

pkgver=2.1.9
upkver=2.6.19.1
fwkver=2.6.19.1
grtime=200612121859
cver=0.1.0
pkgrel=5
_F_kernel_dontsedarch=1
_F_kernel_manualamd64=1
_F_kernel_name="-grsec"
_F_kernel_ver=${fwkver%.*}
_F_kernel_stable=${fwkver##*.}
_F_kernel_patches=(http://www.grsecurity.net/grsecurity-$pkgver-$upkver-$grtime.patch.gz config.patch \
   http://ftp.frugalware.org/pub/frugalware/frugalware-current/source/base/kernel/fuse-2.6.1.patch.bz2 \
   http://ftp.frugalware.org/pub/frugalware/frugalware-current/source/base/kernel/linux-2.6.9-CVE-2006-6106-capi-size-check.patch)
[ "$CARCH" == "x86_64" ] && _F_kernel_patches=(${_F_kernel_patches[@]} config-x86_64.patch)
Finclude kernel
pkgdesc="The Linux Kernel and modules (Grsecurity version)"
url="http://www.grsecurity.net"
depends=('module-init-tools')
groups=('base-extra')
archs=('i686' 'x86_64')
backup=('etc/sysconfig/grsec')
provides=('kernel')
up2date="lynx -dump http://www.grsecurity.net/download.php|grep -1 Latest|sed -n 's/ //g;3 p'"
source=(${source[@]} http://ftp.frugalware.org/pub/other/grsecconf/grsecconf-$cver.tar.gz \
	grsec README.frugalware rc.grsec rc.grsec-{de,hu}.po \
	ftp://ftp.frugalware.org/pub/frugalware/frugalware-current/source/base/kernel/config)
signatures=("${signatures[@]}" '' '' '' '' '' '' '')
install=kernel-grsec.install

## TODO: - README need some sort mini howto
##	 - x86_64 config need an update
	
build()
{
	#build the mconf util
	Fcd grsecconf-$cver
	make || Fdie

	#install mconf
	Fmkdir usr/share/kernel-grsec var/lib/frugalware/system usr/sbin
	Fexerel /usr/sbin/grsecconf
	Ffilerel options /usr/share/kernel-grsec/mconf.opts
	Fexerel /var/lib/frugalware/system/mconf
	cd ..
	
	#build kernel
	Fbuildkernel
	Fdoc README.frugalware
	Fmkdir /etc/sysconfig
	Ffile /etc/sysconfig/grsec
	Fmkdir /etc/rc.d/rc.messages
	Frcd2 grsec
}

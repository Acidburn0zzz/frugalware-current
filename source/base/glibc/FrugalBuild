# Compiling time: 8.20 SBU
# Maintainer:  crazy <crazy@frugalware.org>
# Contributor: Miklos Vajna <vmiklos@frugalware.org>


## DO NOT BUMP THIS PACKAGE WITHOUT to aks the m8r!!
## IF you still want to BUMP rebuild the TOOLCHAIN!!

pkgname=glibc
pkgver=2.25
pkgrel=7
pkgdesc="GNU C Library"
url="http://www.gnu.org/software/libc/libc.html"
depends=()
makedepends=('libxml2>=2.9.2-2' 'binutils>=2.28-3' 'gcc>=6.3.1-3' 'grep>=2.5.3-4' \
	'zlib>=1.2.11-2' 'pacman-g2>=3.7.0-4')
rodepends=('tzdata>=2017a' 'frugalware')
groups=('base' 'chroot-core')
archs=('x86_64')
Fup2gnubz2
_dlurl="http://ftp.gnu.org/pub/gnu/glibc"
source=($_dlurl/glibc-$pkgver.tar.xz
	0001-Revert-Allow-IFUNC-relocation-against-unrelocated-sh.patch
	0002-Revert-Check-IFUNC-definition-in-unrelocated-shared-.patch
	0003-Revert-Clean-up-NPTL-longjmp-to-be-compat-only.patch
	0001-Fix-getting-tunable-values-on-big-endian-BZ-21109.patch
	0002-sunrpc-Avoid-use-after-free-read-access-in-clntudp_c.patch
	0003-sunrpc-Improvements-for-UDP-client-timeout-handling-.patch
	0004-Document-and-fix-enable-bind-now-BZ-21015.patch
	0005-hppa-Fix-setting-of-__libc_stack_end.patch
	0006-x86_64-fix-static-build-of-__mempcpy_chk-for-compile.patch
	0007-posix_spawn-fix-stack-setup-on-ia64-BZ-21275.patch
	0008-fts-Fix-symbol-redirect-for-fts_set-BZ-21289.patch
	0009-Call-the-right-helper-function-when-setting-mallopt-.patch
	0010-posix_spawn-use-a-larger-min-stack-for-fstack-check-.patch
	0011-x86-64-Improve-branch-predication-in-_dl_runtime_res.patch
	0012-posix-Add-cleanup-on-the-trap-list-for-globtest.sh.patch
	0013-x86-Set-Prefer_No_VZEROUPPER-if-AVX512ER-is-availabl.patch
	0014-x86-Use-AVX2-memcpy-memset-on-Skylake-server-BZ-2139.patch
	0015-Fix-i686-memchr-overflow-calculation-BZ-21182.patch
	0016-Fix-test-math-vector-sincos.h-aliasing.patch
	0017-fork-Remove-bogus-parent-PID-assertions-BZ-21386.patch
	0018-Correct-collation-rules-for-Malayalam.patch
	0019-CVE-2017-1000366-Ignore-LD_LIBRARY_PATH-for-AT_SECUR.patch
	0020-ld.so-Reject-overly-long-LD_PRELOAD-path-elements.patch
	0021-ld.so-Reject-overly-long-LD_AUDIT-path-elements.patch
	0022-Ignore-and-remove-LD_HWCAP_MASK-for-AT_SECURE-progra.patch
	0023-i686-Add-missing-IS_IN-libc-guards-to-vectorized-str.patch)
## see https://sourceware.org/bugzilla/show_bug.cgi?id=21041 for the 3 reverts
## there is  1 more canditate but I'll wait upstream to see how they fix..
sha1sums=('5fff5a94ef4470bf48fe1b79093185f19f5c827a' \
          'ff24a7227b5402133eed1e3c6e4104352d2d5afd' \
          '4995b808bba5cf50059ba3d46772b392033c9bbd' \
          '7fa7be35da7635bd7abc9e43a82c69dbcf55c80f' \
          '5e80bc200d7834cfd06283b566c4ebc46f99253b' \
          'a41340ac281fc7427a7243ccd3d4a0dde45cec75' \
          'b50b3b59a40e09638d5d6c368fe0e930f0bda211' \
          'a371a0e7b51b470e011cc86cf835ed0431bfc95c' \
          '6804e1e6689d53e3c49e17a9bea86a6e6aa77c6f' \
          '177c7536ab2b39cdb173ecfb5c262ce5e3ed5dcc' \
          'ac00b5991f2ab24b9e8b269547a8cb8a12bd3ad4' \
          '237916b0860e1cad22e482296ffc7dc1be98e6a1' \
          'e35b3ef7e134c0c56cce55ec19ed2b542c9d1a07' \
          '2cda34d072cedbfeb57238f9f401b16b064f5aeb' \
          'f4f4fd8bc9794ee0dbd9ee0033a1c9086df76c1a' \
          '097a70c6691826f735948cb568cdb009fd984ea9' \
          'aca3032c90bea8d3ab2d553f0ecf86d64c124638' \
          'f78138ec3890bb72c77b5051fbb73e4163d77266' \
          '978983d19364aae2d9a204f42fe23da7145284e2' \
          '8682bba89ec74a72def7c2b9508ded6a71aece86' \
          '37ea5fe39182665f3bd5ca80885608c4d1a813a6' \
          '521f00dc21009edacf4b24a1c7936ff4c5e6354e' \
          '870bf64e5ce74a0e08a359ec70fcfd0dda31b7fe' \
          'bd1816b625787836379c1447e6ff7f696e9f9b94' \
          'f22c7df952d29526965eb4a2fcfef7ae276fb02f' \
          'aeeade9d7e159b91d2c6deaa9c44e86b378b8c47' \
          '08d9834e6a91abaf91bd90eb9f7a6c4a5fa1a690')
options+=('scriptlet' 'noccache' 'static' 'nostrip')


subpkgs=("$pkgname-memusagestat")
subdescs=("glibc memusagestat utility")
subdepends=('gd>=2.1.1')
subgroups=('apps-extra')
subarchs=('x86_64')
suboptions=('nostrip')

conflicts=('lib32')
replaces=('lib32' 'lib32-glibc')
provides=('lib32' 'lib32-glibc')

_buildd() {

	make  || Fdie
	make  install_root=$Fdestdir install || Fdie
	make  install_root=$Fdestdir localedata/install-locales || Fdie
}

build() {


	## FIXME
	Fcd $pkgname-$pkgver
	Fpatchall
	Ffilerel nscd/nscd.conf /etc/nscd.conf
	Fexec cd ..
	Fexec cp -Ra  $pkgname-$pkgver lib32-$pkgname-$pkgver
	Fcd $pkgname-$pkgver
	## use Fdie here and kill the build
	## if we get any errors. -- crazy --
	rm -rf ../glibc-build || Fdie
	mkdir ../glibc-build || Fdie
	rm -rf ../glibc-build32 || Fdie
	mkdir ../glibc-build32 || Fdie


	## need for 32bit libs
	GLIBOPTS32="--libdir=/usr/lib32 --libexecdir=/usr/lib32 --build=i686-frugalware-linux"
	CFLAGS32="-march=i686 -mtune=generic -O2 -pipe"
	CXXFLAGS32="-march=i686 -mtune=generic -O2 -pipe"

	## untill there is some tc-32.sh we need such things
	HOSTCF="$CFLAGS"
	HOSTCXX="$CXXFLAGS"


	## 64bit options
	_GLIBOPTS="--libdir=/usr/lib --libexecdir=/usr/lib --build=$CARCH-frugalware-linux"

	## common options
	GLIBOPTS=" \
		--with-bugurl=https://bugs.frugalware.org/ \
		--prefix=/usr \
		--with-headers=/usr/include \
		--with-tls \
		--with-__thread \
		--enable-kernel=2.6.39 \
		--without-selinux \
		--enable-shared \
		--enable-static \
		--enable-bind-now \
		--enable-obsolete-rpc \
		--disable-werror \
		--enable-static-nss \
		--enable-add-ons \
		--disable-profile \
		--enable-stackguard-randomization \
		--enable-lock-elision=yes \
		--enable-multi-arch \
		--enable-stack-protector=strong" ## for buffer overflows detection

	#FW_CONFIG=" --with-pkgversion="Frugalware Linux - GNU glibc""

	## first 32bit so 64 bit apps ovverrides 32bit stuff and
	## we don't need to delete all over the place
	Fexec cd ../glibc-build32 || Fdie

	export CFLAGS="$CFLAGS32"
	export CXXFLAGS="$CXXFLAGS32"
	export CXX="g++ -m32"
	export CC="gcc -m32"
	export BUILD_ARCH=x86_64

	## put all in /usr/lib32 and symlink to /lib32
	echo "slibdir=/usr/lib32" >> configparms
	echo "rtlddir=/usr/lib32" >> configparms

	Fexec ../lib32-$pkgname-$pkgver/configure $GLIBOPTS $GLIBOPTS32 || Fdie

	_buildd

	## be sure to symlink the right one
	Fln /usr/lib32/ld-2.25.so /lib/ld-linux.so.2
	Fln /usr/lib32 /lib32
	Fmkdir etc/ld.so.conf.d
	echo /usr/lib32  >> "$Fdestdir/etc/ld.so.conf.d/glibc32.conf" || Fdie
	echo /lib32  >> "$Fdestdir/etc/ld.so.conf.d/glibc32.conf" || Fdie
	## 109MB .. remove and symlink later
	Frm usr/lib32/locale/locale-archive

	## 64bit
	Fexec cd ../glibc-build || Fdie

	export CFLAGS="$HOSTCF"
	export CXXFLAGS="$HOSTCXX"
	export CXX="g++"
	export CC="gcc"
	## put all in /lib we symlink to /lib64 , no need to move stuff around
	echo "slibdir=/lib" >> configparms
	echo "rtlddir=/lib" >> configparms
	Fexec ../$pkgname-$pkgver/configure $GLIBOPTS $_GLIBOPTS || Fdie

	_buildd

	Fsplit $pkgname-memusagestat usr/bin/memusagestat
	Frm /etc/ld.so.cache

	## symlink locale-archive for 32bit
	Fln /usr/lib/locale/locale-archive /usr/lib32/locale/locale-archive

	Frm /usr/share/info/dir
	cd - >/dev/null
}

# optimization ok

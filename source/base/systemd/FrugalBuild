# Compiling Time: 0.08 SBU
# Maintainer: bouleetbil <bouleetbil@frogdev.info>

USE_CRYPTSETUP=${USE_CRYPTSETUP:-"n"}
USE_SYSV_COMPAT=${USE_SYSV_COMPAT:-"y"}
USE_TCP=${USE_TCP:-"n"}
USE_GUI=${USE_GUI:-"n"}
USE_SYSV_REPLACE=${USE_SYSV_REPLACE:-"y"}

pkgname=systemd
pkgver=15
pkgrel=21
pkgdesc="A System and Service Manager"
url="http://www.freedesktop.org/wiki/Software/systemd"
source=(http://www.freedesktop.org/software/$pkgname/$pkgname-$pkgver.tar.bz2 \
	Frugalware.diff sysv_translate_name.patch \
	console.conf)
up2date="Flasttar http://www.freedesktop.org/software/$pkgname"
depends=('dbus' 'udev' 'pam' 'coreutils' 'libcap' 'sysvinit-initscripts' 'sysvinit-tools')
makedepends=('vala')


if Fuse $USE_CRYPTSETUP; then
       	depends=("${depends[@]}"  'cryptsetup-luks')
fi
if Fuse $USE_TCP; then
        depends=("${depends[@]}"  'tcp_wrappers')
fi

groups=('base')
archs=('i686' 'x86_64' 'ppc')

#TODO : Remove backup, source rc for SysVinit when all rc scripts used systemd
backup=(etc/{vconsole.conf,systemd/system.conf})

if Fuse $USE_SYSV_REPLACE; then
	replaces=('sysvinit')
	provides=('sysvinit')
	conflicts=('sysvinit')
fi

if Fuse $USE_GUI; then
	subpkgs=('systemd-gtk')
	subdescs=('Graphical frontend for systemd')
	subrodepends=("$pkgname=$pkgver")
	subdepends=('dbus-glib gtk+2 polkit libnotify')
	subgroups=('xapps-extra')
	subarchs=('i686 x86_64 ppc')
else
	replaces=("${replaces[@]}"  'systemd-gtk')
fi

Fconfopts="$Fconfopts --disable-selinux --with-distro=frugalware --with-pamlibdir=/lib/security \
	--with-rootdir= --with-dbussystemservicedir=/usr/share/dbus-1/system-services \
	--with-dbusinterfacedir=/usr/share/dbus-1/interfaces"
if ! Fuse $USE_SYSV_COMPAT; then
	Fconfopts="$Fconfopts --with-sysvinit-path= --with-sysvrcd-path="
fi

build()
{
	#create dbus dir
	Fmkdir usr/share/dbus-1/services

	#build systemd
	Fcd
	Fsed 'agetty' 'frugalwaregetty' units/getty@.service.m4
	# we want some output from systemd before the login prompt, even
	# if we use 'quiet'
	Fsed '"quiet"' '"nosystemd"' src/main.c
	# we don't have auditd
	Fsed 'auditd.service ' '' units/systemd-update-utmp-{runlevel,shutdown}.service.in
	Fpatchall
	Fautoreconf
	Fmake
	Fmakeinstall
	#auto mount
	Fsed "#MountAuto=yes" "MountAuto=yes" $Fdestdir/etc/systemd/system.conf
	Fsed "#SwapAuto=yes" "SwapAuto=yes" $Fdestdir/etc/systemd/system.conf
	#http://0pointer.de/public/systemd-man/tmpfiles.d.html
	Fcp console.conf etc/tmpfiles.d/console.conf

	if Fuse $USE_SYSV_REPLACE; then
		#Create Sysvinit symlink
		Fmkdir sbin
		Fln /bin/systemd /sbin/init
		Fln /bin/systemctl /sbin/reboot
		Fln /bin/systemctl /sbin/halt
		Fln /bin/systemctl /sbin/poweroff
		Fln /bin/systemctl /sbin/shutdown
		Fln /bin/systemctl /sbin/telinit
		Fln /bin/systemctl /sbin/runlevel
	else
		#remove some conflicts
		Frm /usr/share/man/man8/halt.*
		Frm /usr/share/man/man8/poweroff.*
		Frm /usr/share/man/man8/reboot.*
		Frm /usr/share/man/man8/runlevel.*
		Frm /usr/share/man/man8/shutdown.*
		Frm /usr/share/man/man8/telinit.*
	fi

	Frm etc/systemd/system/*.target.wants

	#don't have tmpfs on /var/run and /var/lock
	Frm lib/systemd/system/local-fs.target.wants/var-run.mount
	Frm lib/systemd/system/local-fs.target.wants/var-lock.mount

	# support for this is disabled in the kernel
	Frm /lib/systemd/system/dev-hugepages.automount
	Frm /lib/systemd/system/dev-hugepages.mount
	Frm /lib/systemd/system/sysinit.target.wants/dev-hugepages.automount

	# we do not patch our syslog to have socket activation
	Frm /lib/systemd/system/sockets.target.wants/syslog.socket
	Frm /lib/systemd/system/syslog.socket
	Fsed 'syslog.socket' 'syslog.service' $Fdestdir/lib/systemd/system/systemd-{logger,kmsg-syslogd}.service

	# Make sure these directories are properly owned
	Fmkdir lib/systemd/system/basic.target.wants
	Fmkdir lib/systemd/system/default.target.wants
	Fmkdir lib/systemd/system/dbus.target.wants
	Fmkdir lib/systemd/system/syslog.target.wants

	if Fuse $USE_GUI; then
		#split gtk fronted
		# TODO : Added .desktop for start fronted
		Fsplit systemd-gtk usr/bin/systemadm
		Fsplit systemd-gtk usr/bin/systemd-gnome-ask-password-agent
		Fsplit systemd-gtk usr/share/polkit-1/actions/org.freedesktop.systemd1.policy
		Fsplit systemd-gtk usr/share/man/man1/systemadm.*
	fi
}

sha1sums=('b383d35b409a99d6929e7d1f2e508e3b97fef601' \
          '6bb289f43930f7b9dfca980936c91ac414821733' \
          'b521d50f26b3e66e47ac405b112d2f17f09cb549' \
          'abaa5c83d5adf2c5be188ce0de488bfa2b5a4505')


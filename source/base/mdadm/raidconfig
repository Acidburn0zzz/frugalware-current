#!/bin/sh

# (c) 2005-2006 Miklos Vajna <vmiklos@frugalware.org>
# raidconfig for Frugalware
# distributed under GPL License

. /var/lib/frugalware/messages/rc.messages

### constants
logdev=/dev/tty4

### strings
raidbacktitle="$mkraid - Frugalware `cat /etc/frugalware-release |cut -d ' ' -f 2` $setup"

### functions
suggest_devname()
{
	## check for existing raids
	#prev=`ls /dev/md* 2>/dev/null |sed -n '$ p'`
	#if [ -z "$prev" ]; then
		echo /dev/md0
	#else
	#	echo /dev/md$((`echo $prev |sed 's/.*\([0-9]\)$/\1/'`+1))
	#fi
}

ask_devname()
{
	devnamef=`mktemp /tmp/tmp.XXXXXX`
	dialog --backtitle "$raidbacktitle" --title "$devnamet" \
		--aspect 20 --inputbox "$devnamed" 0 0 \
		`suggest_devname` 2>$devnamef || return 1
	devname=`cat $devnamef`
	rm $devnamef
}

mknod_md()
{
	mknod $1 b 9 `echo $1 |sed 's/.*\([0-9]\)$/\1/'` >$logdev 2>$logdev
}

lst_levels()
{
	echo -n "0 \"raid0/stripe\" "
	echo -n "1 \"raid1/miror\" "
	echo -n "4 \"raid4\" "
	echo -n "5 \"raid5\" "
	echo -n "6 \"raid6\" "
	echo -n "10 \"raid10\" "
}

ask_level()
{
	levelf=`mktemp /tmp/tmp.XXXXXX`
	dialog --backtitle "$raidbacktitle" --title "$levelt" \
		--aspect 20 --menu "$leveld" 0 0 0 \
		`lst_levels` 2>$levelf || return 1
	level=`cat $levelf`
	rm $levelf
}

lst_parts()
{
	for i in `/sbin/fdisk -l 2>/dev/null|grep -E 'Linux raid autodetect' |cut -d ' ' -f 1`
	do
		echo "\"$i\" \"Linux raid autodetect `/sbin/fdisk -s $i`K\" \\"
	done
}

add_devices()
{
	while true
	do
		if [ -z "$devices" ]; then
			devlist=$devlistempty
		else
			devlist="$devices"
		fi
		seldevm=`mktemp /tmp/tmp.XXXXXX`
		chmod +x $seldevm
		seldevf=`mktemp /tmp/tmp.XXXXXX`
		echo "dialog --clear --backtitle \"$raidbacktitle\" --title \"$adddevicest\" \\" >$seldevm
		echo "--aspect 20 --ok-label \"$add\" --cancel-label \"$finish\" --menu \"$adddevicesd$devlist\" 0 0 0 \\">>$seldevm
		lst_parts >>$seldevm
		echo "2>$seldevf">>$seldevm
		$seldevm || break
		rm $seldevm
		devices="$devices`cat $seldevf` "
		rm $seldevf
	done
}

create_md()
{
	devnum=$((`echo "$devices" |tr ' '  '\n' |wc -l`-1))
	mdadm --create --verbose $devname --level=$level \
		--raid-devices=$devnum $devices >$logdev 2>$logdev
}

### main
ask_devname
ask_level
mknod_md $devname
add_devices
create_md

# Compiling Time: 0.01 SBU
# Maintainer: Miklos Vajna <vmiklos@frugalware.org>

pkgname=kmod
pkgver=3
pkgrel=1
pkgdesc="Utilities for inserting and removing modules from the Linux kernel"
url="http://git.profusion.mobi/cgit.cgi/kmod.git"
depends=('glibc>=2.8-3' 'zlib' 'xz')
makedepends=('docbook-utils' 'docbook-sgml-dtd-4.1' 'perl-sgmlspm')
groups=('base')
archs=('i686' 'x86_64' 'ppc' 'arm')
backup=('etc/rc.d/rc.modules' 'etc/sysconfig/modules')
_F_archive_grepv="pre\|rc"
up2date="Flasttar $url"
source=($url/snapshot/$pkgname-$pkgver.tar.bz2
	modules)
sha1sums=('c5ed8e4760c715982a6521c006d377573bc87257' \
          '07c76e65af673c8aad478ad78ef2d750b8ea407e')
replaces=('module-init-tools')
conflicts=('module-init-tools')
provides=('module-init-tools')
options=('scriptlet')

build()
{
	Fsed '2>&1' '' Makefile*
	Fpatchall
	Fautoreconf
	Fmake --exec-prefix=/ --with-zlib --with-xz
	Fmakeinstall
	if [ "$CARCH" == "ppc" ]; then
		# we do not want to load any kernel module by default on ppc
		sed -i '/\(^[^#]\)/d' $Fsrcdir/modules
	fi
	Ffile /etc/sysconfig/modules
	# systemd
	Fmkdir /etc/modules-load.d
	Fln ../sysconfig/modules /etc/modules-load.d/sysconfig.conf
	# Compatibility symlinks
	for i in depmod insmod lsmod modinfo modprobe rmmod; do
		Fln kmod /bin/$i
	done
	Fmv /bin /sbin
}

# optimization ok

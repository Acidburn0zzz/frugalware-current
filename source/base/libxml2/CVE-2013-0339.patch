From 4629ee02ac649c27f9c0cf98ba017c6b5526070f Mon Sep 17 00:00:00 2001
From: Daniel Veillard <veillard@redhat.com>
Date: Mon, 23 Jul 2012 06:15:40 +0000
Subject: Do not fetch external parsed entities

Unless explicietely asked for when validating or replacing entities
with their value. Problem pointed out by Tom Lane <tgl@redhat.com>

* parser.c: do not load external parsed entities unless needed
* test/errors/extparsedent.xml result/errors/extparsedent.xml*:
  add a regression test to avoid change of the behaviour in the future
---
Index: libxml2-2.8.0+dfsg1/parser.c
===================================================================
--- libxml2-2.8.0+dfsg1.orig/parser.c	2013-07-11 14:29:47.656521477 -0400
+++ libxml2-2.8.0+dfsg1/parser.c	2013-07-11 14:29:47.652521477 -0400
@@ -6943,8 +6943,15 @@
      * The first reference to the entity trigger a parsing phase
      * where the ent->children is filled with the result from
      * the parsing.
+     * Note: external parsed entities will not be loaded, it is not
+     * required for a non-validating parser, unless the parsing option
+     * of validating, or substituting entities were given. Doing so is
+     * far more secure as the parser will only process data coming from
+     * the document entity by default.
      */
-    if (ent->checked == 0) {
+    if ((ent->checked == 0) &&
+        ((ent->etype != XML_EXTERNAL_GENERAL_PARSED_ENTITY) ||
+         (ctxt->options & (XML_PARSE_NOENT | XML_PARSE_DTDVALID)))) {
 	unsigned long oldnbent = ctxt->nbentities;
 
 	/*
Index: libxml2-2.8.0+dfsg1/result/errors/extparsedent.xml
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ libxml2-2.8.0+dfsg1/result/errors/extparsedent.xml	2013-07-11 14:29:47.652521477 -0400
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<!DOCTYPE foo [
+<!ENTITY c PUBLIC "bar" "/etc/doesnotexist">
+]>
+<root>&c;</root>
Index: libxml2-2.8.0+dfsg1/test/errors/extparsedent.xml
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ libxml2-2.8.0+dfsg1/test/errors/extparsedent.xml	2013-07-11 14:29:47.652521477 -0400
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<!DOCTYPE foo [
+<!ENTITY c PUBLIC "bar" "/etc/doesnotexist">
+]>
+<root>&c;</root>

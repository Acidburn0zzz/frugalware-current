# Compiling Time: 0 SBU
# Maintainer: James Buren <ryuo@frugalware.org>

Finclude kernel-version

pkgname=kernel-initrd
pkgver=$_F_kernelver_ver
pkgrel=5
pkgdesc="The initrd for the Frugalware Linux Kernel."
url="http://www.frugalware.org"
depends=("kernel=$_F_kernelver_ver-$_F_kernelver_rel")
makedepends=('dracut-plymouth>=015' 'linux-firmware>=20120203' 'xz' 'eject' 'sysvinit-tools' \
	'less' 'xfsprogs' 'jfsutils' 'reiserfsprogs' 'mdadm' 'lvm2' 'udev>=181' \
	'systemd>=43' 'kmod>=5')
groups=('base')
archs=('i686' 'x86_64')
up2date="$_F_kernelver_ver"
options=('scriptlet')

_add_include()
{
	includes=("${includes[@]}" "--include" "$1" "$1")
}

_add_include /sbin/mdadm
_add_include /sbin/mdmon
_add_include /lib/udev/rules.d/64-md-raid.rules

build()
{
	_UNAME="$_F_kernelver_ver-fw$_F_kernelver_rel"
	_INITRD="initrd-$_UNAME"
	Fmkdir /boot
	Fexec /usr/bin/dracut --xz --force -a dmsquash-live ${includes[@]} \
		$_INITRD $_UNAME || Fdie
	if ! xz -d < $_INITRD | cpio -t | grep -q '\.ko\.xz$'; then
		error "No kernel modules in initrd."
		Fdie
	fi
	Ffile /boot/$_INITRD
	Fln $_INITRD /boot/initrd
	# compatibility with GRUB1 default config. remove after 1.7
	Fln $_INITRD /boot/initrd.img.xz
}

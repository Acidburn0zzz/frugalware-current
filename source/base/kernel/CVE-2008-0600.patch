Path: news.gmane.org!not-for-mail
From: "Niki Denev" <ndenev@gmail.com>
Newsgroups: gmane.linux.kernel
Subject: Re: [PATCH] kernel 2.6.24.1 still vulnerable to the vmsplice local root exploit
Date: Sun, 10 Feb 2008 04:40:53 -0500
Lines: 74
Approved: news@gmane.org
Message-ID: <2e77fc10802100140q5c8adfb4k7db88d48cbd5f8b2@mail.gmail.com>
References: <2e77fc10802092204t7764ff12s65304f70500e2090@mail.gmail.com>
	 <20080210063247.GQ8953@1wt.eu>
	 <2e77fc10802092238k13efb111ifcd298daaf7b4aba@mail.gmail.com>
NNTP-Posting-Host: lo.gmane.org
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit
X-Trace: ger.gmane.org 1202636511 24477 80.91.229.12 (10 Feb 2008 09:41:51 GMT)
X-Complaints-To: usenet@ger.gmane.org
NNTP-Posting-Date: Sun, 10 Feb 2008 09:41:51 +0000 (UTC)
Cc: linux-kernel@vger.kernel.org, jens.axboe@oracle.com
To: "Willy Tarreau" <w@1wt.eu>
Original-X-From: linux-kernel-owner+glk-linux-kernel-3=40m.gmane.org-S1757947AbYBJJlL@vger.kernel.org Sun Feb 10 10:42:14 2008
Return-path: <linux-kernel-owner+glk-linux-kernel-3=40m.gmane.org-S1757947AbYBJJlL@vger.kernel.org>
Envelope-to: glk-linux-kernel-3@gmane.org
Original-Received: from vger.kernel.org ([209.132.176.167])
	by lo.gmane.org with esmtp (Exim 4.50)
	id 1JO8hR-0003SF-6d
	for glk-linux-kernel-3@gmane.org; Sun, 10 Feb 2008 10:42:13 +0100
Original-Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1757947AbYBJJlL (ORCPT <rfc822;glk-linux-kernel-3@m.gmane.org>);
	Sun, 10 Feb 2008 04:41:11 -0500
Original-Received: (majordomo@vger.kernel.org) by vger.kernel.org id S1751093AbYBJJk4
	(ORCPT <rfc822;linux-kernel-outgoing>);
	Sun, 10 Feb 2008 04:40:56 -0500
Original-Received: from rv-out-0910.google.com ([209.85.198.185]:25834 "EHLO
	rv-out-0910.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1750843AbYBJJky (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Sun, 10 Feb 2008 04:40:54 -0500
Original-Received: by rv-out-0910.google.com with SMTP id k20so3033173rvb.1
        for <linux-kernel@vger.kernel.org>; Sun, 10 Feb 2008 01:40:53 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:received:received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;
        bh=DkjJ/2kNLB4IO6y6cznNaBB8kgNglb7o5UDzetTgTL4=;
        b=a7u8M5mOkruAjsxekKf81OUJoGPETfqx8WZ/xdNC+iatNultx2g4ynVpbr7ZAWlpJ8jetqKwcxc302pCcVECjFDAJD1ZNu8wzMIEsukBnTKa8BMdCA8mjJyf3nhurYC75aDiI69dYYM5nNzKe691upJJ4KPwd/givpPLHRzKJOQ=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;
        b=u78nCFwVc70bxKuAHIQbwII2kk9BvovN0VLEqpF3YN48ZjOf4GkfFS3HCiR3OwybgmJ0Iq+6e0M6+9VsrAn0eMiRF+wYAi/kZaPVhw0Pr/Xht2dW15AAtYkLWMBqW5+418O2vUyZQcPF4fJQyaSMlmdUZd3ApQRylYvkD+BYal0=
Original-Received: by 10.141.69.1 with SMTP id w1mr9789132rvk.147.1202636453478;
        Sun, 10 Feb 2008 01:40:53 -0800 (PST)
Original-Received: by 10.141.170.18 with HTTP; Sun, 10 Feb 2008 01:40:53 -0800 (PST)
In-Reply-To: <2e77fc10802092238k13efb111ifcd298daaf7b4aba@mail.gmail.com>
Content-Disposition: inline
Original-Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
Xref: news.gmane.org gmane.linux.kernel:637412
Archived-At: <http://permalink.gmane.org/gmane.linux.kernel/637412>

On Feb 10, 2008 1:38 AM, Niki Denev <ndenev@gmail.com> wrote:
>
> On Feb 10, 2008 8:32 AM, Willy Tarreau <w@1wt.eu> wrote:
> > On Sun, Feb 10, 2008 at 08:04:35AM +0200, Niki Denev wrote:
> > > Hi,
> > >
> > > As the subject says the 2.6.24.1 is still vulnerable to the vmsplice
> > > local root exploit.
> >
> > Yes indeed, that's quite bad. 2.6.24-git is still vulnerable too, and
> > also contains the fix :-(
> >
> > CC'd Jens as he worked on the fix.
> >
> > Willy
> >
> >
>
> I was unable to gain root on 2.6.24-git20
> but after several segfaults when executing the exploit continously
> the machine crashes.
>
> --Niki
>

this fixed the problem for me (kernel 2.6.24.1) :
It appears that the initial patch checked the input to vmsplice_to_user,
but the exploit used vmsplice_to_pipe which remained open to the attack.

--- fs/splice.c.orig	2008-02-08 21:55:30.000000000 +0200
+++ fs/splice.c	2008-02-10 11:32:50.000000000 +0200
@@ -1443,6 +1443,10 @@
 	struct pipe_inode_info *pipe;
 	struct page *pages[PIPE_BUFFERS];
 	struct partial_page partial[PIPE_BUFFERS];
+	int error;
+	long ret;
+	void __user *base;
+	size_t len;
 	struct splice_pipe_desc spd = {
 		.pages = pages,
 		.partial = partial,
@@ -1450,6 +1454,31 @@
 		.ops = &user_page_pipe_buf_ops,
 	};

+	error = ret = 0;
+
+	/*
+	 * Get user address base and length for this iovec.
+	 */
+	error = get_user(base, &iov->iov_base);
+	if (unlikely(error))
+		return error;
+	error = get_user(len, &iov->iov_len);
+	if (unlikely(error))
+		return error;
+
+	/*
+	 * Sanity check this iovec. 0 read succeeds.
+	 */
+	if (unlikely(!len))
+		return 0;
+	if (unlikely(!base)) {
+		return -EFAULT;	
+	}
+
+	if (unlikely(!access_ok(VERIFY_WRITE, base, len))) {
+		return -EFAULT;
+	}
+
 	pipe = pipe_info(file->f_path.dentry->d_inode);
 	if (!pipe)
 		return -EBADF;

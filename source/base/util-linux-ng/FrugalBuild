# Compiling time: 0.19 SBU
# Maintainer: Miklos Vajna <vmiklos@frugalware.org>

USE_DEVEL=${USE_DEVEL:-"n"}

pkgname=util-linux-ng
pkgver=2.18
pkgrel=4
pkgdesc="Miscellaneous system utilities for Linux"
url="http://www.kernel.org/pub/linux/utils/util-linux-ng"
backup=('etc/sysconfig/console' 'etc/sysconfig/numlock')
removes=('etc/mtab')
depends=('bash' 'ncurses>=5.6-4' 'zlib>=1.2.3-6' 'texinfo>=4.11-3')
makedepends=('cvs')
replaces=('util-linux' 'linux32')
conflicts=('util-linux' 'linux32')
provides=('util-linux' 'linux32')
groups=('base' 'chroot-core')
archs=('i686' 'x86_64' 'ppc')
up2date="lynx -dump 'http://git.kernel.org/?p=utils/util-linux-ng/util-linux-ng.git' |grep 'release v'|sed 's/.* .*v\(.*\) .*release .*/\1/'|grep -m1 -v 'rc'"
# see bzr for more description on ${pkgver%%.?}
if ! Fuse $USE_DEVEL; then
	source=("$url/v${pkgver%%.?}/util-linux-ng-$pkgver.tar.bz2"
		util-linux-ng-2.18-agetty-baudrate.patch util-linux-ng-2.18-fsck-wholedisk.patch)
	signatures=("${source[0]}.sign" '' '')
else
	_F_scm_type="git"
	pkgver="$pkgver.184.ga4f4cc7"
	pkgrel=1
	_F_scm_url="git://git.kernel.org/pub/scm/utils/util-linux-ng/util-linux-ng.git"
	Finclude scm
fi
source=("${source[@]}" \
	frugalwaregetty numlock rc.rmount \
	rc.rmount-{de,hu}.po README.Frugalware)
signatures=("${signatures[@]}" '' '' '' '' '' '')

subpkgs=("${subpkgs[@]}" "libblkid")
subdescs=("${subdescs[@]}" 'Block device id library')
subdepends=("${subdepends[@]}" "glibc")
subrodepends=("${subrodepends[@]}" "libuuid=$pkgver")
subgroups=("${subgroups[@]}" 'base chroot-core')
subarchs=("${subarchs[@]}" 'i686 x86_64 ppc')

subpkgs=("${subpkgs[@]}" "libuuid")
subdescs=("${subdescs[@]}" 'Universally unique id library')
subdepends=("${subdepends[@]}" "glibc")
subrodepends=("${subrodepends[@]}" "")
subgroups=("${subgroups[@]}" 'base chroot-core')
subarchs=("${subarchs[@]}" 'i686 x86_64 ppc')

rodepends=("${rodepends[@]}" "${subpkgs[@]}")

build() {
	export CFLAGS="$CFLAGS -fPIC"

	if Fuse $USE_DEVEL; then
		Funpack_scm
	fi

	Fpatchall
	Fautoreconf
	Fmake --enable-arch --enable-raw --enable-elvtune --enable-partx
	Fmakeinstall
	# Remove conflicting files.
	Frm /bin/kill /usr/bin/wall
	Frm /usr/share/man/man1/{kill,wall}.1
	Frm /usr/bin/write
	Frm /usr/share/man/man1/write.*
	Frm /usr/share/man/man5/nfs.5
	Frm /usr/bin/setfdprm
	# This one will be created by ldconfig
	Frm /lib/libblkid.so.1

	# Runtime file
	Fln /proc/mounts /etc/mtab

	# Move stuff to the right location (where util-linux had them, maybe
	# remove later).
	Fmv /sbin/raw /usr/bin/raw

	# Init scripts.
	Frcd2 rmount

	# Our getty.
	Fexe /sbin/frugalwaregetty
	Ffile /etc/sysconfig/numlock

	# Console config.
	echo "idle=15" > $Fdestdir/etc/sysconfig/console

	# Documentation.
	Fdoc README.Frugalware
	Fdocrel docs/*

	## libblkid
	Fsplit libblkid usr/lib/libblkid.*
	Fsplit libblkid lib/libblkid.so.*
	Fsplit libblkid usr/lib/pkgconfig/blkid.pc
	Fsplit libblkid usr/include/blkid

	## libuuid
	Fsplit libuuid usr/lib/libuuid.*
	Fsplit libuuid lib/libuuid.so.*
	Fsplit libuuid usr/lib/pkgconfig/uuid.pc
	Fsplit libuuid usr/include/uuid
}

# optimization OK

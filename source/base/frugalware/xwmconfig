#!/bin/sh

# (c) 2005 Szabo Peter <pete [at] teamlupus.hu>
# (c) 2005 Vajna Miklos <vmiklos@frugalware.org>
# Window manager chooser for Frugalware
# distributed under GPL License
# Script layout was taken from timeconfig.

TEXTDOMAIN=xwmconfig ; TEXTDOMAINDIR=/var/lib/frugalware/messages

### strings
fwver="`cat /etc/frugalware-release|cut -d ' ' -f 2`"
version=0.8
menutitle=$"Window manager configuration - Frugalware $fwver Setup"

### wm descriptions
wm_blackbox=$"A fast, light window manager without library dependencies";
wm_enlightenment=$"A fast, flexible, and very extensible Window Manager";
wm_fvwm=$"An ICCCM-compliant multiple virtual desktop window manager";
wm_gnome=$"GNU Network Object Modelling Environment"
wm_icewm=$"A window manager, whose goal is speed and simplicity";
wm_kde=$"K Desktop Environment";
wm_twm=$"Tab window manager for the X window system"
wm_windowmaker=$"A small NeXtStep-like window manager"
wm_wmi=$"Window Manager Improved is a lightweight window manager";
wm_xfce4=$"A window manager compatable with Gnome, Gnome2, KDE2, KDE3 and Xfce4"
wm_openbox=$"A standards compliant, fast, light-weight, extensible window manager"
wm_ratpoison=$"Simple window manager with no fat library dependencies"
wm_unknown=$"--- No description, please report ---"

### functions
showlist()
{
	howf=`mktemp`
	dialogfile=`mktemp`
	chmod +x $dialogfile

	wmlist=`ls -1 /etc/X11/xinit/ | cut -d "." -f 2`
	wmlist_mnu=""

	for itemname in $wmlist ;
	do
	    if [ $itemname != "d" ] && [ $itemname != "xinitrc" ];
	    then
		varname="wm_$itemname"
		desc=${!varname}
		if [ -z "$desc" ];
		then
		    desc="$wm_unknown"
		fi
		wmlist_mnu="$wmlist_mnu $itemname \"$desc\""
	    fi
	done
	echo -n 'dialog --backtitle "'>$dialogfile;
	echo -n $menutitle>>$dialogfile;
	echo -n '" --title "'>>$dialogfile;
	echo -n $"Window managers">>$dialogfile;
	echo -n '" --aspect 20 --menu "'>>$dialogfile;
	echo -n $"Choose one from the window managers listed below. Window managers are responsible for the desktop layout.">>$dialogfile;
	echo -n '" 0 0 0  '>>$dialogfile;
	echo -n $wmlist_mnu>>$dialogfile;
	echo -n ' 2> '>>$dialogfile;
	echo -n $howf>>$dialogfile;
	echo -n ' || exit 0'>>$dialogfile;

	$dialogfile || exit 0;
	selected_wm=`cat $howf`

	rm $howf
	rm $dialogfile
}

doselect()
{
    link="/etc/X11/xinit/xinitrc";
    if [ "$selected_wm" != "" ]; then
        if [ -h $link ]; then
    	    rm "$link";
        fi
	ln -s "/etc/X11/xinit/xinitrc.$selected_wm" "/etc/X11/xinit/xinitrc";
    fi
}


function usage()
{
	cat <<EOF
xwmconfig $version (C) 2005 Szabo Peter <pete [at] teamlupus.hu>

Usage: xwmconfig [options]

Options:
--force		Run this tool even GDM or KDM installed.
--help		This help.
--silent	Do not print any warning if GDM or KDM installed.
EOF
}

### main

if [ "$1" == "--help" ]; then
	usage
	exit 0
fi

if [ "$1" == "--silent" ]; then
	silent=1
	shift
fi

if [ "$1" == "--force" ]; then
	force=1
	shift
fi

if [ "$force" != 1 ]; then
	if pacman -Q kdebase &>/dev/null; then
		[ "$silent" == 1 ] || echo $"KDM is installed, you can choose a window manager from the login menu."
		exit 0;
	fi

	if pacman -Q gdm &>/dev/null; then
		[ "$silent" == 1 ] || echo $"GDM is installed, you can choose a window manager from the login menu."
		exit 0;
	fi
fi

if [ -e /etc/sysconfig/desktop ]; then
    showlist
    doselect
    exit 0;
fi
    echo $"The X server is not installed, please issue a 'pacman -S xorg' command as root."

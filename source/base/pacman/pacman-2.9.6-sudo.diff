Date: 2005-07-20
Initial Package Version: 2.9.6
Upstream Status: http://bugs.archlinux.org/index.php?do=details&id=2981
Origin: Miklos Vajna <vmiklos@frugalware.org>
Description: Adds dependency auto-resolution support using sudo to makepkg.
diff -Naur pacman-2.9.6.orig/doc/makepkg.8.in pacman-2.9.6/doc/makepkg.8.in
--- pacman-2.9.6.orig/doc/makepkg.8.in	2005-07-20 00:27:58.000000000 +0200
+++ pacman-2.9.6/doc/makepkg.8.in	2005-07-20 00:33:37.000000000 +0200
@@ -420,6 +420,11 @@
 pacman will download the missing packages from a package repository and
 install them for you.
+.TP
+.B "\-S, \-\-sudosync"
+Install missing dependencies using pacman and sudo. This is the same as \fB-s\fP
+except that makepkg will call pacman with sudo. This means you don't have to
+build as root to use dependency auto-resolution.
 .TP
 .B "\-u, \-\-noup2date"
 Do not check for newer version before starting build. Normally makepkg will
 prevent you from building obsolete source by mistake. If you know what you are
diff -Naur pacman-2.9.6.orig/scripts/makepkg pacman-2.9.6/scripts/makepkg
--- pacman-2.9.6.orig/scripts/makepkg	2005-07-20 00:27:58.000000000 +0200
+++ pacman-2.9.6/scripts/makepkg	2005-07-20 00:29:22.000000000 +0200
@@ -111,7 +111,7 @@
 	local missingdeps=0
 	local deplist="$*"
 	local haveperm=0
-	if [ "`id -u`" = "0" -a "$INFAKEROOT" != "1" ]; then
+	if [ \( "`id -u`" = "0" -a "$INFAKEROOT" != "1" \) -o "$DEP_SUDO" = 1 ]; then
 		haveperm=1
 	fi
 
@@ -125,6 +125,15 @@
 				exit 1
 			fi
 			# TODO: check deps again to make sure they were resolved
+		elif [ "$DEP_SUDO" = "1" ]; then
+			# install missing deps from binary packages (using pacman -S and sudo)
+			msg "Installing missing dependenciessss..."
+			sudo pacman -D $deplist
+			if [ "$?" = "127" ]; then
+				error "Failed to install missing dependencies."
+				exit 1
+			fi
+			# TODO: check deps again to make sure they were resolved
 		elif [ "$DEP_SRC" = "1" ]; then
 			# install missing deps by building them from source.
 			# we look for each package name in $ABSROOT and build it.
@@ -166,8 +175,8 @@
 		fi
 	elif [ "$deplist" != "" -a $haveperm -eq 0 ]; then
 		if [ "$DEP_SRC" = "1" -o "$DEP_BIN" = "1" ]; then
-			warning "Cannot auto-install missing dependencies as a normal user!"
-			plain "Run makepkg as root to resolve dependencies automatically."
+			warning "Cannot auto-install missing dependencies as a normal user without sudo!"
+			plain "Run makepkg as root or with -S to resolve dependencies automatically."
 		fi
 		missingdeps=1
 	fi
@@ -197,6 +206,7 @@
 	echo "  -p <buildscript> Use an alternate build script (instead of FrugalBuild)"
 	echo "  -r, --rmdeps     Remove installed dependencies after a successful build"
 	echo "  -s, --syncdeps   Install missing dependencies with pacman"
+	echo "  -S, --sudosync   Install missing dependencies with pacman and sudo"
 	echo "  -u, --noup2date  Do not check for newer version"
 	echo "  -w <destdir>     Write package to <destdir> instead of the working dir"
 	echo
@@ -213,6 +223,7 @@
 DOWNLOAD=""
 GENMD5=0
 DEP_BIN=0
+DEP_SUDO=0
 DEP_SRC=0
 NODEPS=0
 FORCE=0
@@ -232,6 +243,7 @@
 		--clean)      CLEANUP=1 ;;
 		--cleancache) CLEANCACHE=1 ;;
 		--syncdeps)   DEP_BIN=1 ;;
+		--sudosync)   DEP_SUDO=1 ;;
 		--builddeps)  DEP_SRC=1 ;;
 		--nodeps)     NODEPS=1 ;;
 		--noextract)  NOEXTRACT=1 ;;
@@ -253,7 +265,7 @@
 			exit 1
 			;;
 		-*)
-			while getopts "acCsbdehifgj:l:Lkmnorp:uw:-" opt; do
+			while getopts "acCsSbdehifgj:l:Lkmnorp:uw:-" opt; do
 				case $opt in
 					a) SEARCHDEPS=1 ;;
 					c) CLEANUP=1 ;;
@@ -277,6 +289,7 @@
 					p) BUILDSCRIPT=$OPTARG ;;
 					r) RMDEPS=1 ;;
 					s) DEP_BIN=1 ;;
+					S) DEP_SUDO=1 ;;
 					u) NOUP2DATE=1 ;;
 					w) PKGDEST=$OPTARG ;;
 					-)
@@ -833,6 +846,10 @@
 if [ "$RMDEPS" = "1" -a "`id -u`" = "0" -a "$INFAKEROOT" != "1" ]; then
 	msg "Removing installed dependencies..."
 	pacman -R $makedeplist $deplist
+
+elif [ "$RMDEPS" = "1" -a "$DEP_SUDO" = "1" ]; then
+	msg "Removing installed dependencies..."
+	sudo pacman -R $makedeplist $deplist
 fi
 
 # check optimalization and write it to $BUILDSCRIPT

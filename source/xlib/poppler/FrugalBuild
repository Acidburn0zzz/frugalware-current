# Compiling time: 0.89 SBU
# Maintainer: crazy <crazy@frugalware.org>

if [[ "$CARCH" != "arm" ]]; then
	USE_GLIB=${USE_GLIB:-"y"}
	USE_QT4=${USE_QT4:-"y"}
	USE_QT5=${USE_QT5:-"y"}
else
	USE_GLIB=${USE_GLIB:-"y"}
	USE_QT4=${USE_QT4:-"n"}
	USE_QT5=${USE_QT5:-"n"}
fi

## TODO: figure curl
##       switch to cmake

pkgname=poppler
pkgver=0.41.0
pkgrel=1
pkgdesc="A PDF rendering library"
url="http://poppler.freedesktop.org/"
depends=('fontconfig>=2.11.94-3' 'cairo>=1.14.6-2' 'libjpeg>=9a' 'libpng>=1.6.20'  'openjpeg>=1.5.2' 'libstdc++>=5.3.0-2')
makedepends=('x11-protos' 'gobject-introspection')
rodepends=('poppler-data')
groups=('xlib')
archs=('i686' 'x86_64' 'arm')
up2date="Flasttar $url/releases.html"
source=(http://poppler.freedesktop.org/$pkgname-$pkgver.tar.xz \
	01-poppler.conf)
sha1sums=('af3a941866095312cf5b51086cff3a2a48bcc816' \
          'a048348d9a8c6d545714350d3ab66dc7028e4b7f')
options+=('scriptlet' 'force')
conflicts=('poppler-qt')
provides=('poppler-qt')
replaces=('poppler-qt')

if Fuse $USE_GLIB; then
	## builds gtk-test and demo app we don't even install it
	## than need gtk+3
	Fconfopts+=" --disable-gtk-test"
	subpkgs=("${subpkgs[@]}" 'poppler-glib')
	subdescs=("${subdescs[@]}" 'Poppler glib bindings')
	subgroups=("${subgroups[@]}" 'xlib')
	subdepends=("${subdepends[@]}" 'cairo>=1.14.6-2 libffi>=3.2.1 libpng>=1.6.20 libstdc++>=5.3.0-2')
	subrodepends=("${subrodepends[@]}" "poppler>=$pkgver")
	subarchs=("${subarchs[@]}" 'i686 x86_64 arm')
	subreplaces=("${subreplaces[@]}" '')
	subprovides=("${subprovides[@]}" '')
fi

subpkgs=("${subpkgs[@]}" 'poppler-pdftools')
subdescs=("${subdescs[@]}" 'Poppler xpdf tools')
subgroups=("${subgroups[@]}" 'xapps')
subdepends=("${subdepends[@]}" 'lcms2>=2.7-3 cairo>=1.14.6-2 libffi>=3.2.1 libpng>=1.6.20 libstdc++>=5.3.0-2')
subrodepends=("${subrodepends[@]}" 'poppler')
subarchs=("${subarchs[@]}" 'i686 x86_64 arm')
subreplaces=("${subreplaces[@]}" 'xpdf')
subprovides=("${subprovides[@]}" 'xpdf')

if Fuse $USE_QT4; then
	subpkgs=("${subpkgs[@]}" 'poppler-qt4')
	subdescs=("${subdescs[@]}" 'Poppler QT4 bindings')
	subgroups=("${subgroups[@]}" 'xlib')
	subdepends=("${subdepends[@]}" 'libqtgui libqtxml libqttest')
	subrodepends=("${subrodepends[@]}" 'poppler')
	subarchs=("${subarchs[@]}" 'i686 x86_64 arm')
	subreplaces=("${subreplaces[@]}" '')
	subprovides=("${subprovides[@]}" '')
fi

if Fuse $USE_QT5; then
	subpkgs=("${subpkgs[@]}" 'poppler-qt5')
	subdescs=("${subdescs[@]}" 'Poppler QT5 bindings')
	subgroups=("${subgroups[@]}" 'xlib-extra')
	subdepends=("${subdepends[@]}" 'qt5-base>=5.5.1-11')
	subrodepends=("${subrodepends[@]}" 'poppler')
	subarchs=("${subarchs[@]}" 'i686 x86_64 arm')
	subreplaces=("${subreplaces[@]}" '')
	subprovides=("${subprovides[@]}" '')
fi

build() {
	Fbuild \
		--disable-gtk-doc \
		--enable-xpdf-headers \
		--enable-zlib \
		--enable-build-type=release

	Ffile 01-poppler.conf /etc/fonts/conf.avail/01-poppler.conf
	Fln /etc/fonts/conf.avail/01-poppler.conf /etc/fonts/conf.d/01-poppler.conf

	Fsplit poppler-pdftools usr/bin/*
	Fsplit poppler-pdftools usr/share/man/man1/*

	if Fuse $USE_GLIB; then
		Fsplit poppler-glib usr/include/poppler/glib/
		Fsplit poppler-glib usr/lib/libpoppler-glib*
		Fsplit poppler-glib usr/lib/pkgconfig/poppler-glib.*
	fi

	if Fuse $USE_QT4; then
		Fsplit poppler-qt4 usr/include/poppler/qt4/
		Fsplit poppler-qt4 usr/lib/libpoppler-qt4.*
		Fsplit poppler-qt4 usr/lib/pkgconfig/poppler-qt4.*
	fi

	if Fuse $USE_QT5; then
		Fsplit poppler-qt5 usr/include/poppler/qt5/
		Fsplit poppler-qt5 usr/lib/libpoppler-qt5.*
		Fsplit poppler-qt5 usr/lib/pkgconfig/poppler-qt5.*
	fi

	Frm usr/bin
	Frm usr/share/man
}

# optimization OK

# Compiling Time: 5.65 SBU
# Maintainer: crazy <crazy@frugalware.org>
# Contributor: AlexExtreme <alex@alex-smith.me.uk>

pkgname=xulrunner
pkgver=1.9.2
pkgrel=1
pkgdesc="XULRunner is a Mozilla runtime package that can be used to bootstrap XUL+XPCOM applications that are as rich as Firefox and Thunderbird."
url="http://developer.mozilla.org/en/docs/XULRunner"
depends=('alsa-lib' 'bzip2' 'cairo>=1.8.10-2' 'curl' 'dbus-glib' 'gtk+2>=2.20.0-2' 'libidl' 'libnotify>=0.4.5-3' 'libpng>=1.4.1' 'libstdc++' 'nss' 'nspr' 'sqlite3' 'wireless_tools')
makedepends=('zip' 'pkgconfig')
groups=('xlib')
archs=('i686' 'x86_64' 'ppc')
up2date="Flastarchive ftp://releases.mozilla.org/pub/mozilla.org/$pkgname/releases/"
up2date=("echo $pkgver")
source=(ftp://ftp.mozilla.org/pub/$pkgname/releases/$pkgver/source/$pkgname-$pkgver.source.tar.bz2 \
	mozilla-gcc44.patch \
	mozilla-locale.patch)
signatures=("${source[0]}.asc" '' '')

build() {
	unset MAKEFLAGS

	Fcd mozilla-1.9.2

	Fsed 'png_voidp_NULL' 'NULL' modules/libpr0n/encoders/png/nsPNGEncoder.cpp

	# Fix buggy default DPI setting
#	sed -i '/layout.css.dpi/s/-1/72/' modules/libpref/src/init/all.js || Fdie

	# Let jars get compressed.
	Fsed '\-0' '\-9' config/make-jars.pl

	# Let xullrunner have autocomplete xfce componant (for thunderbird)
#	Fsed '$(MOZ_THUNDERBIRD)' 1 xpfe/components/Makefile.in
#	Fsed 'EXTRA_DSO_LDOPTS +=' 'EXTRA_DSO_LDOPTS = $(LIBS_DIR)' xpfe/components/autocomplete/src/Makefile.in

	export MOZILLA_OFFICIAL=1
	export BUILD_OFFICIAL=1

	Fpatchall

#		--disable-jsd \
#		--disable-logging \
#		--disable-profilesharing \
#		--with-default-mozilla-five-home=/usr \

	# Build it
	ac_cv_visibility_pragma=no Fmake \
		--disable-activex \
		--disable-activex-scripting \
		--disable-debug \
		--disable-installer \
		--disable-javaxpcom \
		--disable-pedantic \
		--disable-tests \
		--disable-toolkit-gtk \
		--disable-toolkit-qt \
		--disable-toolkit-xlib \
		--disable-xprint \
		--enable-application=xulrunner \
		--enable-canvas \
		--enable-crypto \
		--enable-default-toolkit=cairo-gtk2 \
		--enable-extensions=cookie,default,permissions \
		--enable-image-decoders=all \
		--enable-image-encoders=all \
		--enable-ipv6 \
		--enable-ldap \
		--enable-mathml \
		--enable-necko-protocols=all \
		--enable-optimize="${CFLAGS}" \
		--enable-pango \
		--enable-safe-browsing \
		--enable-single-profile \
		--enable-strip \
		--enable-svg \
		--enable-toolkit-cairo-gtk2 \
		--enable-xft \
		--enable-xinerama \
		--enable-xpfe-components \
		--enable-xsl \
		--enable-xterm-updates \
		--with-distribution-id=Frugalware \
		--with-pthreads \
		--with-system-bz2 \
		--with-system-cairo \
		--with-system-jpeg \
		--with-system-lcms \
		--with-system-mng \
		--with-system-nspr \
		--with-system-nss \
		--with-system-png \
		--with-system-sqlite \
		--with-system-zlib

	# Does not use Fmakeinstall here because DESDIR is not found in root Makefile
	Fexec make DESTDIR="$Fdestdir" install

	# Get rid of versions in path names.
	Fmv /usr/include/$pkgname-$pkgver /usr/include/$pkgname
	Fmv /usr/lib/$pkgname-$pkgver /usr/lib/$pkgname
	Fmv /usr/lib/$pkgname-devel-$pkgver /usr/lib/$pkgname-devel
	Fmv /usr/share/idl/$pkgname-$pkgver /usr/share/idl/$pkgname
	Fln $pkgname /usr/include/$pkgname-$pkgver
	Fln $pkgname /usr/lib/$pkgname-$pkgver
	Fln $pkgname-devel /usr/lib/$pkgname-devel-$pkgver
	Fln $pkgname /usr/share/idl/$pkgname-$pkgver

	# and in pkgconfig .pc files
	Fsed "$pkgname-$pkgver" "$pkgname" $Fdestdir/usr/lib/pkgconfig/*.pc
	Fsed "$pkgname-devel-$pkgver" "$pkgname-devel" $Fdestdir/usr/lib/pkgconfig/*.pc

	# create symlink nss headers to OOo
#	Fln /usr/include/nss3 /usr/include/$pkgname/nss

	# Install icon for the menu file.
#	Fmkdir /usr/share/pixmaps/
#	Fln /usr/lib/$pkgname/icons/mozicon128.png /usr/share/pixmaps/$pkgname.png

	# Install menu file.
#	Ffile /usr/share/applications/$pkgname.desktop

	# Change the default icons
#	Fln /usr/lib/$pkgname/icons /usr/lib/$pkgname/chrome/icons/default
}

# optimization OK

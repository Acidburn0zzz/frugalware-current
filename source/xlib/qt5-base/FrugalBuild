# Compiling Time: 64.56 SBU
# Maintainer: Marius Cirsta <mcirsta@frugalware.org>

pkgname=qt5-base
pkgver=5.7.0
pkgrel=3
Finclude qt5
pkgdesc="The Qt5 GUI toolkit."
depends=('libxkbcommon>=0.6.1-2' 'xcb-util-image>=0.4.0-3' 'xcb-util-wm>=0.4.1-3' \
	'dbus>=1.10.10-3' 'harfbuzz>=1.3.1-2' 'libcups>=2.2.0-2' 'libpng>=1.6.25' \
	'libjpeg>=9a-2' 'libinput>=1.4.0-2' 'sqlite3>=3.14.2-3' 'libsystemd>=231-6' \
	'glib2>=2.50.0' 'libevdev>=1.5.4-2' 'libxcursor>=1.1.14-3' 'libxcb>=1.12-4' \
	'libxi>=1.7.6-2' 'pcre>=8.39-3' 'libxrender>=0.9.9-5' 'mtdev>=1.1.5-4' \
	'libgl>=>=12.0.3-3' 'libproxy>=0.4.13-2' 'libsm>=1.2.2-3')
makedepends+=('cups>=2.2.0-2' 'x11-protos' 'mysql>=5.5.50-2' 'postgresql>=9.5.4'  \
	'gst1-plugins-base>=1.9.2-2' 'alsa-lib>=1.1.2-2' 'pulseaudio>=9.0-2' 'gperf')

## old qt5
replaces=('libqt5concurrent' 'libqt5core' 'libqt5dbus' 'libqt5gui' 'libqt5network' 'libqt5opengl' 'libqt5openglextensions' \
	  'libqt5platformsupport' 'libqt5printsupport' 'libqt5sql' 'libqt5test' 'libqt5widgets' 'libqt5xml'
	  'qt5-plugin-odbc' 'qt5-plugin-sqlite3' 'qt5')
conflicts=("${replaces[@]}")
provides=("${replaces[@]}")
## old qt5 end

source+=(no-o3-02-use-HOST-flags.patch qtbase-multilib_optflags.patch)
sha1sums=('ba835ff158932eebbf1ed9f678414923dfd7cce4' \
          '6e7d286dd921acdc489e57a7d40e76996d5f2906' \
          '6ec3dddda2105b43648e321887c3879267c1a512')

Fconfopts+=" -prefix /usr \
		-bindir /usr/lib/qt5/bin \
		-headerdir /usr/include/qt5 \
		-archdatadir /usr/share/qt5 \
		-plugindir /usr/lib/qt5/plugins \
		-datadir /usr/share/qt5 \
		-docdir /usr/share/doc/qt5 \
		-examplesdir /usr/share/qt5/examples \
		-testsdir /usr/share/qt5/tests \
		-sysconfdir /etc/qt5 \
		-no-rpath \
		-release \
		-opensource \
		-confirm-license \
		-verbose \
		-openssl-linked \
		-optimized-qmake \
		-dbus-linked \
		-nomake examples \
		-reduce-relocations \
		-cups \
		-nis \
		-pch \
		-opengl \
		-system-libpng \
		-system-libjpeg \
		-system-zlib \
		-system-pcre \
		-system-harfbuzz \
		-system-proxies \
		-system-sqlite \
		-libproxy \
		-libinput \
		-gstreamer 1.0 \
		-journald"

## no sse2 for 32bit
[[ "${CARCH}" = "i686" ]] && Fconfopts+=" -no-sse2"

subpkgs=("$pkgname-mysql")
subdescs=('Mysql support for qt5')
subdepends=("libmysqlclient>=5.5.50-2")
subrodepends=("$pkgname>=$pkgver")
subgroups=('xlib-extra')
subarchs=('i686 x86_64')
subreplaces=('qt5-plugin-mysql')
subprovides=('qt5-plugin-mysql')
subconflicts=('qt5-plugin-mysql')

subpkgs+=("$pkgname-postgresql")
subdescs+=('Postgresql support for qt5')
subdepends+=("libpq>=9.5.4")
subrodepends+=("$pkgname>=$pkgver")
subgroups+=('xlib-extra')
subarchs+=('i686 x86_64')
subreplaces+=('qt5-plugin-psql')
subprovides+=('qt5-plugin-psql')
subconflicts+=('qt5-plugin-psql')


build()
{
	Fpatchall
	## let qt5 own his config dir ;)
	Fmkdir /etc/qt5
	Fmessage "Fixing up CXX/LD flags.."
	Fexec sed -i -e "s|-O2|$CXXFLAGS|g" mkspecs/*/qmake.conf || Fdie
	Fexec sed -i -e "s|^\(QMAKE_LFLAGS_RELEASE.*\)|\1 $LDFLAGS|" mkspecs/common/g++-unix.conf || Fdie
	Fmake
	make  INSTALL_ROOT=$Fdestdir install || Fdie
	for i in ${Fdestdir}/usr/lib/qt5/bin/*; do
		q5=`basename ${i}`
		Fln /usr/lib/qt5/bin/${q5} /usr/bin/${q5}-qt5
        done

	Fsplit $pkgname-mysql usr/include/qt5/QtSql/${pkgver}/QtSql/private/qsql_mysql_p.h
	Fsplit $pkgname-mysql usr/lib/qt5/plugins/sqldrivers/libqsqlmysql.so
	Fsplit $pkgname-mysql usr/lib/cmake/Qt5Sql/Qt5Sql_QMYSQLDriverPlugin.cmake

	Fsplit $pkgname-postgresql usr/include/qt5/QtSql/${pkgver}/QtSql/private/qsql_psql_p.h
	Fsplit $pkgname-postgresql usr/lib/qt5/plugins/sqldrivers/libqsqlpsql.so
	Fsplit $pkgname-postgresql usr/lib/cmake/Qt5Sql/Qt5Sql_QPSQLDriverPlugin.cmake
}

# optimization OK


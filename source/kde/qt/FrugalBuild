# Last modified: Wed, 22 Feb 2006 20:06:42 +0100
# Compiling Time: 0.49 SBU 
# Maintainer: Kapolnasi Tamas <ktamas@tdc.hu>
# Contributor: crazy <crazy@pimpmylinux.org>
 
pkgname=qt
pkgver=3.3.5
pkgrel=5
pkgmore=x11-free
pkgdesc="The QT GUI toolkit."
url="http://www.trolltech.com/products/qt"
install=qt.install
depends=('libxrandr' 'mesa' 'libxft' 'libmng' 'libjpeg' 'libxcursor' 'libxinerama' 'libsm' 'imake' 'libpng' 'libxtst')
makedepends=('mysql>=5.0.15' 'postgresql' 'sqlite3' 'cups' 'bison')
groups=('kde' 'kde-lib')
archs=('i686' 'x86_64')
options=('nodocs')
removes=('usr/share/doc/qt-3.3.5/README*' 'usr/share/doc/qt-3.3.5/FAQ' 'usr/share/doc/qt-3.3.5/MANIFEST' \
           'usr/share/doc/qt-3.3.5/INSTALL' 'usr/lib/qt/mkspecs/default')
up2date=$pkgver
source=(ftp://ftp.trolltech.com/qt/source/$pkgname-$pkgmore-$pkgver.tar.bz2 qt.sh apply_patches \
         http://ftp.frugalware.org/pub/other/qt/patches-510500.tar.bz2 \
         $pkgname-$pkgmore-$pkgver-gcc4.patch \
         $pkgname-$pkgmore-$pkgver-uic.patch \
         $pkgname-$pkgmore-$pkgver-visibility.patch \
         $pkgname-$pkgmore-$pkgver-rpath+FW.patch \
	 $pkgname-$pkgmore-$pkgver-from-3.3.6_fix.patch)

sha1sums=('8d7c7ba0b39848ef60b3cd93fc1d33e9527694ec' \
          '0464d40d9bd518fe8d139b1306136089349a4cdf' \
          '7562323175ec47483dcb45c2857519f6276e0a51' \
          'e63e84bff3958416083c24c055aa993f77a340bf' \
          '54d37e3988c4b195ae960ef2c59e678151115211' \
          'dba54b91b2b00c1d052ac512d824b29d31aefb89' \
          '0e88e4f3a184b0f0544bd0cbd8302e55aaf14871' \
          '0d5fcbe569723792700bad3c82abe34d5e5163c4' \
          'd50158d27b11bf68b646671f2e6bfddf0db1b2a8')

export QTDIR=$startdir/src/$pkgname-$pkgmore-$pkgver
export PATH=${QTDIR}/bin:${PATH}
export LD_LIBRARY_PATH=${QTDIR}/lib:${LD_LIBRARY_PATH}
export YACC='yacc -d'

build()
{
	unset MAKEFLAGS
	Fcd $pkgname-$pkgmore-$pkgver 
	Fpatchall
        rm -rf doc/html examples tutorial
        Fsed "DUMMY" "${CFLAGS}" mkspecs/linux-g++/qmake.conf
        mv $Fsrcdir/{patches,apply_patches} $Fsrcdir/$pkgname-$pkgmore-$pkgver
        echo "0005" >> patches/DISABLED
        chmod +x apply_patches
        ./apply_patches || return 1
        ./configure -v -platform linux-g++ -prefix /usr/lib/qt  -release -shared \
              -qt-gif -system-libpng -system-libjpeg -system-libmng -system-zlib \
              -plugin-imgfmt-png -plugin-imgfmt-jpeg -plugin-imgfmt-mng -largefile \
              -plugin-sql-mysql -plugin-sql-psql -plugin-sql-sqlite \
              -thread  -stl -no-g++-exceptions \
              -enable-{dialogs,iconview,workspace,network,tools,kernel,widgets,opengl,stl,canvas,table,xml,sql,input} \
              -nis -pch -sm -tablet -xft -xinerama -xrender -xkb -ipv6 || return 1
        Fmkdir /usr/lib/qt/mkspecs
        cp -r mkspecs/linux-g++ $Fdestdir/usr/lib/qt/mkspecs/linux-g++
        ##Fixme need patch##
        cd $Fsrcdir/$pkgname-$pkgmore-$pkgver/plugins/src/sqldrivers/mysql
        qmake -o Makefile "INCLUDEPATH+=/usr/include/mysql" "LIBS+=-L/usr/lib/mysql -lmysqlclient" mysql.pro
  
        cd $Fsrcdir/$pkgname-$pkgmore-$pkgver/plugins/src/sqldrivers/psql
        qmake -o Makefile "INCLUDEPATH+=/usr/include/postgresql/server /usr/include" "LIBS+=-L/usr/lib -lpq" psql.pro
        
        cd $Fsrcdir/$pkgname-$pkgmore-$pkgver
        make || return 1
        make INSTALL_ROOT=$Fdestdir install
        rm -rf $Fdestdir/usr/lib/$pkgname/{phrasebooks,templates}
        Fmkdir /usr/lib/$pkgname/man
        cp -r $Fsrcdir/$pkgname-$pkgmore-$pkgver/doc/man/{man1,man3} $Fdestdir/usr/lib/$pkgname/man 
        Fsed "-L$startdir/src/$pkgname-$pkgmore-$pkgver/lib" "" $Fdestdir/usr/lib/$pkgname/lib/*.prl
        Fexe /etc/profile.d/qt.sh
        (cd $Fdestdir/usr/lib/qt/mkspecs; ln -sf linux-g++ default)
        Fmkdir /usr/lib/pkgconfig
        Fcp /usr/lib/qt/lib/pkgconfig/* /usr/lib/pkgconfig
        (cd $Fdestdir/usr/lib/pkgconfig; ln -sf qt-mt.pc qt.pc)
}

# vim: ft=sh

# optimalization OK

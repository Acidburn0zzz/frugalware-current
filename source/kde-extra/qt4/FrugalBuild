# Last Modified: Sun, 20 Aug 2006 20:54:17 +0200
# Compiling Time: 17.07 SBU
# Maintainer: crazy <crazy@frugalware.org>

pkgname=qt4
origname=qt
pkgver=4.1.4
pkgrel=3
pkgmore=x11-opensource-src
pkgdesc="The QT4 GUI toolkit."
url="http://www.trolltech.com/products/qt"
depends=('libxrandr' 'mesa' 'libxft' 'libmng' 'libjpeg' 'libxcursor' 'libxinerama' 'freetype2' 'libsm' 'libpng' 'libxtst' 'fontconfig')
makedepends=('mysql>=5.0.15' 'postgresql' 'cups' 'bison' 'flex' 'unixodbc' 'imake')
groups=('kde-extra')
archs=('i686' 'x86_64')
options=('nodocs' 'scriptlet')
up2date="lynx -dump ftp://ftp.trolltech.com/qt/source/|grep 'qt-x11-opensource-src'|sort -n -r|head -n 1|sed 's/.*-\(.*\).t.*/\1/'"
source=(ftp://ftp.trolltech.com/qt/source/$origname-$pkgmore-$pkgver.tar.gz \
	assistant4.desktop designer4.desktop linguist4.desktop \
	qt4config.desktop dummy.patch qt4.sh.off)
sha1sums=('59ef791e2a0deafcd76429187162ac893c547b29' \
          '991ed0d2f047e0ead54efc050c652595b7bed00b' \
          '19281b54674d4071a3814200fd8a64e097ece2e8' \
          '410b18b9a496cf551f7ff6cb282c719c874bc883' \
          'dfa7acb2259f65aeb23968241983110e509fa90c' \
          '50181a7f20c625a7b710d9f832921a64f0e21d14' \
          'ec754c532cd2e479119f3e144f1b2d6ca970a5a2')

export QTDIR=$startdir/src/$origname-$pkgmore-$pkgver
export PATH=${QTDIR}/bin:${PATH}
export LD_LIBRARY_PATH=${QTDIR}/lib:${LD_LIBRARY_PATH}
export YACC='yacc -d'

subpkgs=("$pkgname-docs" "$pkgname-debug")
suboptions=('' 'nostrip')
subdescs=('QT4 Documentation.' 'The QT4 GUI toolkit (DEBUG).')
subdepends=("$pkgname=$pkgver" "$pkgname=$pkgver")
subgroups=('kde-extra kde-docs' 'kde-extra')
subarchs=('i686 x86_64' 'i686 x86_64')
build()
{
	unset MAKEFLAGS
	Fcd $origname-$pkgmore-$pkgver
	Fpatch dummy.patch
	Fsed "DUMMY" "${CFLAGS} -fno-strict-aliasing -Wno-deprecated" mkspecs/linux-g++/qmake.conf
	./configure -v -confirm-license -prefix /usr -L /usr/lib \
		-libdir /usr/lib \
		-docdir /usr/share/doc/$pkgname-$pkgver \
		-datadir /usr/share/$pkgname \
		-sysconfdir /etc/$pkgname \
		-translationdir /usr/share/$pkgname/translations \
		-demosdir /usr/share/doc/$pkgname-$pkgver/demos \
		-examplesdir /usr/share/doc/$pkgname-$pkgver/examples \
		-plugindir /usr/lib/$pkgname/plugins \
		-debug-and-release -shared -nis -qt-gif -stl -pch -sm \
		-system-libpng -system-libjpeg -system-libmng -system-zlib \
                -accessibility -fontconfig -no-nas-sound -no-rpath \
                -tablet -xinerama -xrender -xkb -xshape -xrandr -cups -no-exceptions \
		-plugin-sql-mysql -I/usr/include/mysql/ \
		-plugin-sql-psql -I/usr/include -I/usr/include/pgsql/ -I/usr/include/pgsql/server \
		-plugin-sql-sqlite -plugin-sql-odbc \
		 || return 1
	Fsed "-L$startdir/src/$origname-$pkgmore-$pkgver/lib" "" lib/*
	## for some reason without the extra -I/*'s we have some weird compile errors so
	## lets hope this is fixed in .3 or later
	## some missing folder :)
        Fmkdir usr/share/applications usr/share/pixmaps usr/lib/pkgconfig
        Ffile ../*.desktop /usr/share/applications/
	Fmessage "Moving needed icons to $Fdestdir/usr/share/pixmaps..."
        cp -a tools/assistant/images/{linguist,designer,assistant}.png $Fdestdir/usr/share/pixmaps/
	Fmessage "Starting make.."
	make || return 1
	Fmessage "Installing.."
	make INSTALL_ROOT=$Fdestdir install || return 1
	## now let us fix some stuff this *piep* qmake installed THAT fine :-D gota love it
	## fix *.pc file location
	Fmv /usr/lib/*.pc usr/lib/pkgconfig/
	Fmessage "Removing junk from all prl,pc,la files..."
	find $Fdestdir/usr/lib -type f -name '*prl' -print -exec sed -i -e "/^QMAKE_PRL_BUILD_DIR/d" {} \;
	Fsed "-L$startdir/src/$origname-$pkgmore-$pkgver/lib" "" $Fdestdir/usr/lib/pkgconfig/*.pc
	Fsed "-L$startdir/src/$origname-$pkgmore-$pkgver/lib" "" $Fdestdir/usr/lib/*.la
	Fsed "-L$startdir/src/$origname-$pkgmore-$pkgver/lib" "" $Fdestdir/usr/lib/*.prl
	## docs , demos etc
	Fsplit $pkgname-docs usr/share/doc/$pkgname-$pkgver
	Fsplit $pkgname-docs usr/bin/{assistant,qtdemo}
	Fsplit $pkgname-docs usr/share/applications/assistant4.desktop
	Fsplit $pkgname-docs usr/share/pixmaps/assistant.png
	## debug package because .. ->
	## 73M     /usr/lib/libQtGui_debug.so.4.1.4 :-D with nostrip
	Fsplit $pkgname-debug usr/lib/*_debug.*
	Fsplit $pkgname-debug usr/include/Qt/qdebug.h
	Fsplit $pkgname-debug usr/include/QtCore/qdebug.h
	Fsplit $pkgname-debug usr/lib/pkgconfig/*_debug.pc
	Fsplit $pkgname-debug usr/lib/$pkgname/plugins/accessible/*_debug.*
	Fsplit $pkgname-debug usr/lib/$pkgname/plugins/designer/*_debug.*
	Fsplit $pkgname-debug usr/lib/$pkgname/plugins/imageformats/*_debug.*
	Fsplit $pkgname-debug usr/lib/$pkgname/plugins/sqldrivers/*_debug.*
	Fsplit $pkgname-debug usr/share/$pkgname/mkspecs/features/debug.prf
	Fexe /etc/profile.d/qt4.sh.off
	## some more fixes
	cd $Fdestdir/usr/share/$pkgname/mkspecs
	rm -rf default ## blah symlink to build dir
	for i in `ls|grep -v linux-g|grep -v features|grep -v qconfig.pri`
	do
		rm -rf $i
	done
	ln -sf linux-g++ default
}

# optimization OK

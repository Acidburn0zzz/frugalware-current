# Compiling Time: 12.73 SBU
# Maintainer: crazy <crazy@frugalware.org>

pkgname=qt4
origname=qt
pkgver=4.3.1
pkgrel=3
pkgmore=x11-opensource-src
pkgdesc="The QT4 GUI toolkit."
url="http://www.trolltech.com/products/qt"
depends=('libxrandr' 'mesa>=6.5.3' 'libxft' 'libmng' 'libjpeg' 'libxcursor' 'libxinerama' 'freetype2' \
	'libsm' 'libpng' 'libxtst' 'fontconfig' 'dbus>=0.93')
makedepends=('mysql>=5.0.15' 'postgresql>=8.2' 'cups' 'bison' 'flex' 'unixodbc' 'imake' 'sqlite3' 'sqlite2')
rodepends=('dejavu-ttf')
groups=('kde-extra')
archs=('i686' 'x86_64')
options=('nodocs' 'scriptlet')
up2date="lynx -dump ftp://ftp.trolltech.com/qt/source/|grep 'qt-x11-opensource-src'|grep -v rc[1-9]|grep -v beta|sort -n -r|head -n 1|sed 's/.*-\(.*\).t.*/\1/'"
source=(ftp://ftp.trolltech.com/qt/source/$origname-$pkgmore-$pkgver.tar.gz \
	http://ftp.frugalware.org/pub/other/sources/kde/qt4/patches-r716585.tar.bz2 \
	CVE-2007-4137.patch \
	assistant4.desktop designer4.desktop linguist4.desktop qt4config.desktop \
	dummy.patch qt4.sh.off Trolltech.conf apply_patches)


export QTDIR=$startdir/src/$origname-$pkgmore-$pkgver
export PATH=${QTDIR}/bin:${PATH}
export LD_LIBRARY_PATH=${QTDIR}/lib:${LD_LIBRARY_PATH}
export YACC='yacc -d'

subpkgs=("$pkgname-docs")
subdescs=('QT4 Documentation.')
subdepends=("$pkgname=$pkgver")
subgroups=('kde-extra kde-docs')
subarchs=('i686 x86_64')
build()
{

	Fcd $origname-$pkgmore-$pkgver
	Fpatchall
	Fsed "DUMMY" "${CFLAGS} -fno-strict-aliasing -Wno-deprecated" mkspecs/common/g++.conf
	mv $Fsrcdir/{patches-r716585,apply_patches} $Fsrcdir/$origname-$pkgmore-$pkgver || Fdie
	mv patches-r716585 patches || Fdie
	#echo "0118" >> patches/DISABLED || Fdie
        #echo "0176" >> patches/DISABLED || Fdie
	#echo "0177" >> patches/DISABLED || Fdie
	chmod +x apply_patches || Fdie
	./apply_patches || Fdie
	./configure \
		-v -confirm-license \
		-prefix /usr -L /usr/lib \
		-libdir /usr/lib \
		-docdir /usr/share/doc/$pkgname-$pkgver \
		-datadir /usr/share/$pkgname \
		-sysconfdir /etc/$pkgname \
		-translationdir /usr/share/$pkgname/translations \
		-demosdir /usr/share/doc/$pkgname-$pkgver/demos \
		-examplesdir /usr/share/doc/$pkgname-$pkgver/examples \
		-plugindir /usr/lib/$pkgname/plugins \
		-shared \
		-nis \
		-qt-gif \
		-stl \
		-pch \
		-sm \
		-system-libpng \
		-system-libjpeg \
		-system-libmng \
		-system-zlib \
		-system-sqlite \
                -accessibility \
		-fontconfig \
		-no-nas-sound \
		-no-rpath \
		-qt3support \
                -tablet \
		-xinerama \
		-xrender \
		-xkb \
		-xshape \
		-xrandr \
		-cups \
		-no-exceptions \
		-plugin-sql-mysql -I/usr/include/mysql/ \
		-plugin-sql-psql -I/usr/include -I/usr/include/pgsql/ -I/usr/include/pgsql/server \
		-plugin-sql-sqlite \
		-plugin-sql-sqlite2 \
		-plugin-sql-odbc \
		-qdbus \
		-no-glib \
		-no-separate-debug-info \
		-optimized-qmake \
		-fast || return 1
        Fmkdir usr/share/applications usr/share/pixmaps usr/lib/pkgconfig
        Ffile ../*.desktop /usr/share/applications/
	Fmessage "Moving needed icons to $Fdestdir/usr/share/pixmaps..."
        cp -a tools/assistant/images/{linguist,designer,assistant}.png \
		$Fdestdir/usr/share/pixmaps/ || Fdie
	Fmessage "Starting make.."
	make || Fdie
	Fmessage "Installing.."
	make INSTALL_ROOT=$Fdestdir install || Fdie
	## now let us fix some stuff this *piep* qmake installed THAT fine :-D gota love it
	Fmessage "Removing junk from all prl,pc,la files..."
	find $Fdestdir/usr/lib -type f -name '*prl' -print -exec sed -i -e "/^QMAKE_PRL_BUILD_DIR/d" {} \;
	Fsed "-L$startdir/src/$origname-$pkgmore-$pkgver/lib" "" $Fdestdir/usr/lib/pkgconfig/*.pc
	Fsed "-L$startdir/src/$origname-$pkgmore-$pkgver/lib" "" $Fdestdir/usr/lib/*.la
	Fsed "-L$startdir/src/$origname-$pkgmore-$pkgver/lib" "" $Fdestdir/usr/lib/*.prl
	Fsed "$startdir/src/$origname-$pkgmore-$pkgver/bin/moc" "/usr/bin/moc" $Fdestdir/usr/lib/pkgconfig/*.pc
	Fsed "$startdir/src/$origname-$pkgmore-$pkgver/bin/uic" "/usr/bin/uic" $Fdestdir/usr/lib/pkgconfig/*.pc
	## docs , demos etc
	Fsplit $pkgname-docs usr/share/doc/$pkgname-$pkgver
	Fsplit $pkgname-docs usr/bin/{assistant,qtdemo}
	Fsplit $pkgname-docs usr/share/applications/assistant4.desktop
	Fsplit $pkgname-docs usr/share/pixmaps/assistant.png
	Fexe /etc/profile.d/qt4.sh.off
	Fexe /etc/$pkgname/Trolltech.conf
	## some more fixes
	cd $Fdestdir/usr/share/$pkgname/mkspecs || Fdie
	rm -rf default || Fdie ## blah symlink to build dir
	ln -sf linux-g++ default || Fdie
}

sha1sums=('ca59cfdcfc390cf16c6e6b503546e8bb2cc8e1e2' \
          'fdffe57818a2a7c7252f9a295a3f8744cd7d9895' \
          'bc00ca6a74edde2a8536988b47e75cc68cb0cb25' \
          '991ed0d2f047e0ead54efc050c652595b7bed00b' \
          '19281b54674d4071a3814200fd8a64e097ece2e8' \
          '410b18b9a496cf551f7ff6cb282c719c874bc883' \
          'dfa7acb2259f65aeb23968241983110e509fa90c' \
          '6868adc53c2037a83b0601c92ea39dd3394a8fdf' \
          '6d2cd19e53c155dec758fda3d49b065ce2fae0b7' \
          '2468fea7b127253832148115d5aa9e85b2e0aea6' \
          '5a2341286f6d766ab943294aec90a8ad25d0ee1d')
# optimization OK

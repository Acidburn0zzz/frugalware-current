# Compiling Time: 1.14 SBU
# Maintainer: Christian Hamar alias krix <krics@linuxforum.hu>

pkgname=mesa-cvs
origname=Mesa-cvs
pkgver=20060624
pkgrel=1
pkgdesc="Mesa is a 3D graphics library (CVS Version)"
url="http://mesa3d.sourceforge.net/"
depends=('libx11' 'libxext' 'libxxf86vm' 'libxi' 'libxmu' 'libice' 'libdrm')
makedepends=('makedepend' 'glproto' 'xf86vidmodeproto')
archs=('x86_64' 'i686')
groups=('xlib-extra')
up2date=$pkgver
source=(http://ftp.frugalware.org/pub/other/sources/mesa-cvs/$origname-$pkgver.tar.bz2 \
	r200-copy-pixels-1.patch)
sha1sums=('178b9c34315c5e01311385074de4d872d83cdf2d' \
	  '1396202a472a59266e884cfef5654af4e4cd451c')

# NOTE: If you bump version (major or minor) you need to review the symlinking at the end of this
#       file !!!! On minor bump last number will be changed.

build()
{
	Fcd $origname-$pkgver

	[ "$CARCH" == "i686" ] && CONFIG=linux-dri-x86
	[ "$CARCH" == "x86_64" ] && CONFIG=linux-dri-x86-64 && dripath=64
	[ "$CARCH" == "ppc" ] && CONFIG=linux-dri-ppc
	Fpatchall

	HOSTCONF="configs/${CONFIG}"

	Fsed "MKDEP = /usr/X11R6/bin/makedepend" "MKDEP = /usr/bin/makedepend" configs/linux-dri
	Fsed "X11_INCLUDES = -I/usr/X11R6/include" "X11_INCLUDES = -I/usr/include" configs/linux-dri
	Fsed "EXTRA_LIB_PATH=-L/usr/X11R6/lib" "EXTRA_LIB_PATH=-L/usr/lib" configs/linux-dri
	Fsed '#define DEFAULT_DRIVER_DIR "/usr/X11R6/lib/modules/dri"' '#define DEFAULT_DRIVER_DIR "/usr/lib/xorg/modules/dri"' src/glx/x11/dri_glx.c

	echo "DEFINES += -DDEFAULT_DRIVER_DIR='\"/usr/lib/mesa-cvs/lib/xorg/modules/dri\"'" >> ${HOSTCONF}
	echo "EXTRA_LIB_PATH =" >> ${HOSTCONF}
	echo "OPT_FLAGS = ${CFLAGS}" >> ${HOSTCONF}
	echo "SRC_DIRS = glx/x11 mesa" >> ${HOSTCONF}
	rm -f include/GL/glut*h
	echo "USING_EGL = 0" >> ${HOSTCONF}
	echo "PROGRAM_DIRS =" >> ${HOSTCONF}
#	echo "DRI_DIRS =" >> ${HOSTCONF}
	
	echo "INSTALL_DIR = $Fdestdir/usr/lib/mesa-cvs" >> ${HOSTCONF}
	echo "DRI_DRIVER_INSTALL_DIR = $Fdestdir/usr/lib/mesa-cvs/lib/xorg/modules/dri" >> ${HOSTCONF}
	
	make ${CONFIG} || Fdie

	Fmkdir /usr/lib/mesa-cvs
	
	[ "$CARCH" == "x86_64" ] && mv $Fsrcdir/Mesa-cvs-20060624/lib64 $Fsrcdir/Mesa-cvs-20060624/lib
	
	make install || Fdie

	Fmkdir /usr/share/doc/$origname-$pkgver
	cp -r docs/{README.*,*.html,RELNOTES-6.4.2,RELNOTES-6.5,COPYING,VERSIONS} \
		$Fdestdir/usr/share/doc/$origname-$pkgver/ || Fdie
	
	Fmkdir /usr/lib/mesa-cvs/lib/xorg/modules/dri
	cp -ar $Fsrcdir/$origname-$pkgver/lib$dripath/*_dri.so $Fdestdir/usr/lib/mesa-cvs/lib/xorg/modules/dri/ || Fdie
}

# optimization OK

# Compiling Time: ~0.22 SBU
# Maintainer: voroskoi <voroskoi@frugalware.org>

USE_DEVEL=${USE_DEVEL:-"y"}

pkgname=bitlbee
pkgver=3.0.2
Fuse $USE_DEVEL && pkgver=3.0.2.771
pkgrel=1
pkgdesc="An IRC to other chat networks gateway."
url="http://www.bitlbee.org/main.php/news.html"
# inetd: othervise it can't serve on port 6667
# tcp_wrappers: provides /usr/sbin/tcpd
rodepends=('inetd' 'tcp_wrappers')
depends=('glib2' 'gnutls>=2.8' 'systemd')
Fuse $USE_DEVEL && makedepends=('docbook-xsl>=1.73.0-2' 'docbook-xml' 'xmlto')
backup=(etc/biltbee/{bitlbee.conf,motd.txt})
groups=('network-extra')
archs=('i686' 'x86_64' 'ppc')
up2date="lynx -dump http://www.bitlbee.org/ |grep Stable |sed 's/.*: \(.*\)/\1/'"
source=(http://get.bitlbee.org/src/$pkgname-$pkgver.tar.gz \
	bitlbee-systemd.patch)
sha1sums=('59113b1dc440ebd775e6cf324d1cfb698fb20cfc' \
          'dad60158fa774d5f91e3f3c39ffd55c50fbb895b')
options=('scriptlet')

subpkgs=('bitlbee-otr')
subdescs=('OTR support for BitlBee.')
subdepends=("libotr")
subrodepends=("$pkgname=$pkgver")
subgroups=('network-extra')
subarchs=('i686 x86_64 ppc')

if Fuse $USE_DEVEL; then
	unset source sha1sums
	_F_scm_type="bzr"
	_F_scm_url="http://code.bitlbee.org/bitlbee/"
	Finclude scm
fi

build() {
	Fuse $USE_DEVEL && Funpack_scm
	Fpatchall
	Fmake --etcdir=/etc --otr=plugin
	Fmkdir /var/lib/bitlbee
	# fakeroot does not set $USER, check for uid instead
	Fsed 'ifeq ($(USER),root)' 'ifeq ($(shell id -u),0)' Makefile
	make DESTDIR=$Fdestdir install-etc install-dev || Fdie
	Fmakeinstall
	chown 503:503 $Fdestdir/var/lib/bitlbee || return 1
	Fdocrel doc/{AUTHORS,CHANGES,FAQ,README}
	Ffilerel doc/user-guide/* /usr/share/doc/$pkgname-$pkgver/user-guide/
	Fsplit bitlbee-otr usr/lib/bitlbee/otr.so
}

# optimization OK

--- smtp-tls.c-orig	2005-12-15 19:59:49.000000000 +0100
+++ smtp-tls.c	2010-03-09 21:37:16.769301648 +0100
@@ -439,16 +439,24 @@
 match_component (const char *dom, const char *edom,
                  const char *ref, const char *eref)
 {
+  int wildcard = 0;
+
   while (dom < edom && ref < eref)
     {
       /* Accept a final '*' in the reference as a wildcard */
       if (*ref == '*' && ref + 1 == eref)
-        break;
+       {
+         wildcard = 1;
+         break;
+       }
       /* compare the domain name case insensitive */
       if (!(*dom == *ref || tolower (*dom) == tolower (*ref)))
         return 0;
       ref++, dom++;
     }
+  if (!wildcard && (dom < edom || ref < eref))
+    return 0;
+
   return 1;
 }
 
@@ -589,9 +597,10 @@
       if (!ok)
 	{
 	  /* Matching by subjectAltName failed, try commonName */
-	  X509_NAME_get_text_by_NID (X509_get_subject_name (cert),
-				     NID_commonName, buf, sizeof buf);
-	  if (!match_domain (session->host, buf) != 0)
+	  int l = X509_NAME_get_text_by_NID (X509_get_subject_name (cert),
+                                             NID_commonName, buf, sizeof buf);
+	  if (l != strlen(buf) ||
+              !match_domain (session->host, buf) != 0)
 	    {
 	      if (session->event_cb != NULL)
 		(*session->event_cb) (session, SMTP_EV_WRONG_PEER_CERTIFICATE,

# Compiling Time: 0.01 SBU
# Contributor: Daniel Exner <dex@dragonslave.de>
# Maintainer: James Buren <ryuo@frugalware.org>

pkgname=r8168
pkgver=8.042.00
pkgrel=17
Finclude kernel-module
pkgdesc="Realtek driver for RTL8111/RTL8168 cards."
groups=('network-extra')
archs=('i686' 'x86_64')
url='http://www.realtek.com.tw/downloads/downloadsView.aspx?Langid=1&PNid=13&PFid=5&Level=5&Conn=4&DownTypeID=3&GetDown=false'
up2date="Fwcat '$url' | sed -n -r 's/.*$pkgname-([0-9.]+)[.]tar[.]bz2.*/\1/p'"
# Needs updating for each upgrade.
source=(http://12244.wpc.azureedge.net/8012244/drivers/rtdrivers/cn/nic/0005-r8168-8.042.00.tar.bz2 \
	$pkgname.conf \
	linux-4.5.patch \
	makefile.patch)
sha1sums=('7e0ce5f34a2d3a0ad21f96e3ba4eb79c396f7edf' \
          '385fab20e1ad896dc6c1ee5c4aff9a6bd9496ee0' \
          '5a42deba9165d352389422bd8d7084d43142ae3b' \
          'a674df4fe4b78b54d8b65957ae42f0e35403065e')

build() {
	unset MAKEFLAGS
	#Fcheckkernel
	Fcd
	Fexec sed -i \
			-e '/gso_min_segs/d' \
			-e 's/dev->trans_start = jiffies/netif_trans_update(dev)/g' \
			src/r8168_n.c || Fdie

	Fbuild_kernelmod_scriptlet
	Fsed '$(shell uname -r)' "${_F_kernelmod_uname}" src/Makefile
	Fpatchall
	Fmake
	Ffilerel src/r8168.ko $_F_kernelmod_dir/kernel/drivers/net/r8168.ko
	Ffile /etc/modprobe.d/$pkgname.conf
	Fkernelver_compress_modules
}

# optimization OK

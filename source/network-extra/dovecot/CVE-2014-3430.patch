
# HG changeset patch
# User Timo Sirainen <tss@iki.fi>
# Date 1399472781 -10800
# Node ID b7ac23b4d3390367a06d3de498747d3dedd2475b
# Parent  b20b4071a282bc64bcc665b67ab5a8449bde36f4
*-login: SSL connections didn't get closed when the client got destroyed.

Index: dovecot-2.1.7/src/login-common/client-common.c
===================================================================
--- dovecot-2.1.7.orig/src/login-common/client-common.c	2014-05-14 13:17:08.902158922 -0400
+++ dovecot-2.1.7/src/login-common/client-common.c	2014-05-14 13:17:08.898158922 -0400
@@ -141,6 +141,8 @@
 		last_client = client->prev;
 	DLLIST_REMOVE(&clients, client);
 
+	if (!client->login_success && client->ssl_proxy != NULL)
+		ssl_proxy_destroy(client->ssl_proxy);
 	if (client->input != NULL)
 		i_stream_close(client->input);
 	if (client->output != NULL)
Index: dovecot-2.1.7/src/login-common/ssl-proxy-openssl.c
===================================================================
--- dovecot-2.1.7.orig/src/login-common/ssl-proxy-openssl.c	2014-05-14 13:17:08.902158922 -0400
+++ dovecot-2.1.7/src/login-common/ssl-proxy-openssl.c	2014-05-14 13:17:08.898158922 -0400
@@ -108,7 +108,6 @@
 static void ssl_read(struct ssl_proxy *proxy);
 static void ssl_write(struct ssl_proxy *proxy);
 static void ssl_step(struct ssl_proxy *proxy);
-static void ssl_proxy_destroy(struct ssl_proxy *proxy);
 static void ssl_proxy_unref(struct ssl_proxy *proxy);
 
 static struct ssl_server_context *
@@ -782,7 +781,7 @@
 	i_free(proxy);
 }
 
-static void ssl_proxy_destroy(struct ssl_proxy *proxy)
+void ssl_proxy_destroy(struct ssl_proxy *proxy)
 {
 	if (proxy->destroyed)
 		return;
Index: dovecot-2.1.7/src/login-common/ssl-proxy.h
===================================================================
--- dovecot-2.1.7.orig/src/login-common/ssl-proxy.h	2014-05-14 13:17:08.902158922 -0400
+++ dovecot-2.1.7/src/login-common/ssl-proxy.h	2014-05-14 13:17:08.898158922 -0400
@@ -31,6 +31,7 @@
 const char *ssl_proxy_get_security_string(struct ssl_proxy *proxy);
 const char *ssl_proxy_get_compression(struct ssl_proxy *proxy);
 const char *ssl_proxy_get_cert_error(struct ssl_proxy *proxy);
+void ssl_proxy_destroy(struct ssl_proxy *proxy);
 void ssl_proxy_free(struct ssl_proxy **proxy);
 
 /* Return number of active SSL proxies */

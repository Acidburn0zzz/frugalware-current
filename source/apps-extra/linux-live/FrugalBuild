# Last Modified: Tue, 17 Oct 2006 20:59:07 +0200
# Compiling Time: 0.01 SBU
# Maintainer: CSÉCSY László <boobaa@frugalware.org>
# Contributor: VMiklos <vmiklos@frugalware.org>

pkgname=linux-live
pkgver=5.5.0
splashver=0.1
pkgrel=1
pkgdesc="A set of shell scripts which allows you to create own LiveCD."
url="http://www.linux-live.org/"
depends=('cdrtools')
makedepends=('squashfs' 'busybox' 'unionfs' 'eject')
groups=('devel-extra')
archs=('i686')
up2date="lynx -dump $url |Flasttar"
source=(http://www.linux-live.org/dl/linux-live-$pkgver.tar.gz \
	http://ftp.frugalware.org/pub/other/sources/fwlive/splash-$splashver.{bmp,lss} \
	linux-live-5.5.0-fwlive.diff)

# when the interal package versions are outdated, we need extra hacks
# the version of glibc we have
glibcver=2.5
# the version of the internal glibc
liveglibcver=2.3.6

build()
{
	Fpatchall
	# a special version of make clean ;)
	unset bins
	for i in `find . -perm -u+x ! -type d ! -type l`
	do
		if [[ "`file $i`" =~ "ELF" ]]; then
			bins="$bins $i"
			rm $i
		fi
	done

	# now copy the missing binaries
	cp /sbin/mksquashfs tools/
	cp /sbin/unsquashfs tools/
	cp /usr/share/busybox/bin/busybox initrd/rootfs/bin/
	cp /usr/sbin/uniondbg initrd/rootfs/bin/
	cp /sbin/blkid initrd/rootfs/bin/
	cp /usr/sbin/unionctl initrd/rootfs/bin/
	cp /usr/bin/eject initrd/rootfs/bin/eject
	cp /lib/ld-$glibcver.so initrd/rootfs/lib/
	ln -sf ld-$glibcver.so initrd/rootfs/lib/ld-linux.so.2
	bins=${bins/ld-$liveglibcver.so/ld-$glibcver.so}
	cp /lib/libc-$glibcver.so initrd/rootfs/lib/
	ln -sf libc-$glibcver.so initrd/rootfs/lib/libc.so.6
	bins=${bins/libc-$liveglibcver.so/libc-$glibcver.so}
	cp /usr/lib/libz.so.1.2.3 initrd/rootfs/lib/
	cp /lib/libblkid.so.1.0 initrd/rootfs/lib/
	cp /lib/libuuid.so.1.2 initrd/rootfs/lib/

	# check if we have everything
	for i in $bins
	do
		if [ ! -e $i ]; then
			echo $i is missing
			return 1
		fi
	done

	# our splash
	cp $Fsrcdir/splash-$splashver.bmp cd-root/boot/splash.bmp
	# for incremental builds
	rm -f cd-root/boot/splash.bmp.gz
	gzip cd-root/boot/splash.bmp
	cp $Fsrcdir/splash-$splashver.lss cd-root/boot/splash.lss

	# finally install it
	Fmkdir /usr/share/linux-live
	cp -a * $Fdestdir/usr/share/linux-live/
}

sha1sums=('7933a82fbe6a278270fb5251960bae2dd37acccf' \
	  'ac9e7e33beff3fbd315262147aae1c52dc5be69a' \
	  '6575f4826c17a710eed5755f2db5b0eebc1d56b2' \
	  '38863a46e5cd53f7810e11a23f4960a7a592e4e3')

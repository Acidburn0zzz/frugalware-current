# Compiling Time: 0.33 SBU
# Maintainer: DeX77 <dex77@frugalware.org>

pkgname=docker
pkgver=17.05.0
_gitcommit="89658be"
pkgrel=1
pkgdesc="Docker - the Linux container runtime"
archs=('!i686' 'x86_64')
groups=('apps-extra')
depends=('bridge-utils' 'iproute2' 'libguestfs' 'sqlite3' 'lvm2' 'btrfs-progs>=4.10-2')
makedepends=('go>=1.7' 'git' 'mercurial' 'ca-certificates' 'sphinx-httpdomain' 'mkdocs' \
        'python-jinja' 'python-markupsafe' 'python-markdown' 'pyyaml' 'watchdog' 'pathtools')
rodepends=('containerd' 'runc' 'libnetwork' 'tini')
_F_github_name="moby"
_F_github_author="docker"
_F_github_tag_v="y"
_F_systemd_units=(docker=)
provides=('lxc-docker')
replaces=('lxc-docker')
conflicts=('lxc-docker')
_F_archive_grepv="rc[1-9]"
Finclude github systemd
_F_cd_path="moby-$pkgver-ce"
up2date="$up2date | sed 's/-ce//'"
source=(${source[@]//$pkgver/$pkgver-ce} \
	_docker \
	docker.conf)
sha1sums=('b1294decbd28eac9df59ecea1d4dc86dcd64346f' \
          '47027a4c415cb1aa556e54dd0dc1c80f4fbe076a' \
          '36269e4f788302439cd6bc672a83f594348660db')

build() {
	Fcd
	Fpatchall

        export GOPATH="$Fsrcdir/gopath:$Fsrcdir/gopath/src/github.com/docker/docker/vendor"

        Fexec mkdir -p $Fsrcdir/gopath/src/github.com/docker
	Fexec rm -rf $Fsrcdir/gopath/src/github.com/docker/docker
        Fexec mv $Fsrcdir/$_F_github_name-$pkgver-ce/ $Fsrcdir/gopath/src/github.com/docker/docker/

        Fcd gopath/src/github.com/docker/docker

        export DOCKER_GITCOMMIT=$_gitcommit
        Fexec ./hack/make.sh dynbinary

        Finstall 644 _docker usr/share/zsh/site-functions/_docker


        Fexe gopath/src/github.com/docker/docker/bundles/${pkgver}-ce/dynbinary-client/docker-${pkgver}-ce \
                        usr/bin/docker
	Fexe gopath/src/github.com/docker/docker/bundles/${pkgver}-ce/dynbinary-daemon/dockerd-${pkgver}-ce \
                        usr/bin/dockerd

        # install systemd service unit
        Finstall 644 gopath/src/github.com/docker/docker/contrib/init/systemd/docker.service lib/systemd/system/docker.service
	Finstall 644 gopath/src/github.com/docker/docker/contrib/init/systemd/docker.socket lib/systemd/system/docker.socket

        Finstall 644 gopath/src/github.com/docker/docker/contrib/completion/bash/docker \
                usr/share/bash-completion/completions/docker

        Fmkdir usr/share/doc/docker-${pkgver}-ce

        # Create group using sysuser.d
        Fmkdir usr/lib/sysusers.d/
        Ffile /usr/lib/sysusers.d/$pkgname.conf

}

# optimization OK

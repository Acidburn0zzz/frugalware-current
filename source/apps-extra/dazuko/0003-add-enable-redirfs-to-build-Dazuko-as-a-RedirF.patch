From b39f2f1f24f1a508c30356b0ee64aaa68f54e8a1 Mon Sep 17 00:00:00 2001
From: ogman <ogman>
Date: Wed, 12 Dec 2007 17:07:11 +0000
Subject: [PATCH] - add "--enable-redirfs" to build Dazuko as a RedirFS filter
 - change "--without-dep" to be the default

---
 configure |   41 +++++++++++++++++++++++++++++++++--------
 1 files changed, 33 insertions(+), 8 deletions(-)

diff --git a/configure b/configure
index 17168f1..d300fce 100755
--- a/configure
+++ b/configure
@@ -74,6 +74,7 @@ print_help()
 	echo "  --disable-compat1               disable 1.x compatibility (IO/Linux only)"
 	echo "  --enable-debug                  print extra debug information"
 	echo "  --enable-syscalls               hook syscalls, not LSM (Linux 2.6 only)"
+	echo "  --enable-redirfs                use RedirFS (Linux 2.6 only)"
 	echo ""
 	echo "optional packages"
 	echo "  --with-PACKAGE                  use PACKAGE"
@@ -81,7 +82,7 @@ print_help()
 	echo "  --without-module                do not build kernel module"
 	echo "  --without-library               do not build library"
 	echo "  --without-example-c             do not build C example"
-	echo "  --without-dep                   do not build dependencies (Linux only)"
+	echo "  --with-dep                      build dependencies (Linux only)"
 	echo "  --with-example-java             build Java example"
 	echo "  --with-example-perl             build Perl example"
 	echo "  --with-example-python           build Python example"
@@ -407,7 +408,18 @@ check_use_parent()
 
 do_linux26()
 {
-	if [ $LINUX26_USE_SYSCALLS -eq 0 ]
+	if [ $LINUX26_USE_SYSCALLS -eq 0 -a $LINUX26_USE_REDIRFS -eq 1 ]
+	then
+		echo -n "checking for RedirFS source code... "
+		if [ ! -f "../redirfs/redirfs.h" ]
+		then
+			echo "not found"
+			echo "error: please make sure the RedirFS code is available as ../redirfs/"
+			exit 1
+		fi
+		echo "found (../redirfs)"
+
+	elif [ $LINUX26_USE_SYSCALLS -eq 0 -a $LINUX26_USE_REDIRFS -eq 0 ]
 	then
 		echo -n "checking if security module support is enabled... "
 		if [ $CONFIG_SECURITY -eq 0 ]
@@ -690,25 +702,25 @@ do_linux26()
 
 	if [ $ON_CLOSE -ne 0 -a $LINUX26_USE_SYSCALLS -eq 0 ]
 	then
-		echo "disabling ON_CLOSE events (not available for Linux 2.6 LSM)"
+		echo "disabling ON_CLOSE events (not available for Linux 2.6 LSM/RedirFS)"
 		ON_CLOSE=0
 	fi
 
 	if [ ${ON_UNLINK} -ne 0 -a $LINUX26_USE_SYSCALLS -eq 0 ]
 	then
-		echo "disabling ON_UNLINK events (not available for Linux 2.6 LSM)"
+		echo "disabling ON_UNLINK events (not available for Linux 2.6 LSM/RedirFS)"
 		ON_UNLINK=0
 	fi
 
 	if [ ${ON_RMDIR} -ne 0 -a $LINUX26_USE_SYSCALLS -eq 0 ]
 	then
-		echo "disabling ON_RMDIR events (not available for Linux 2.6 LSM)"
+		echo "disabling ON_RMDIR events (not available for Linux 2.6 LSM/RedirFS)"
 		ON_RMDIR=0
 	fi
 
 	if [ ${ON_CLOSE_MODIFIED} -ne 0 -a $LINUX26_USE_SYSCALLS -eq 0 ]
 	then
-		echo "disabling ON_CLOSE_MODIFIED events (not available for Linux 2.6 LSM)"
+		echo "disabling ON_CLOSE_MODIFIED events (not available for Linux 2.6 LSM/RedirFS)"
 		ON_CLOSE_MODIFIED=0
 	fi
 
@@ -716,7 +728,12 @@ do_linux26()
 
 	if [ ${LINUX26_USE_SYSCALLS} -eq 0 ]
 	then
-		LINUX26_OBJS="dazuko_linux26.o"
+		if [ ${LINUX26_USE_REDIRFS} -eq 0 ]
+		then
+			LINUX26_OBJS="dazuko_linux26.o"
+		else
+			LINUX26_OBJS="dazuko_redirfs.o"
+		fi
 		echo "EXTRA_CFLAGS += -Wall -DLINUX26_SUPPORT" > Makefile
 	else
 		LINUX26_OBJS="dazuko_linux.o"
@@ -1460,12 +1477,13 @@ LINUX26_USE_SYSCALLS=0
 PERFORM_SCT_CHECK=1
 LINUX26_SYSCALLTABLE_READONLY=0
 LINUX26_SYSCALL_CFLAGS=""
-WITH_LINUX_DEP=1
+WITH_LINUX_DEP=0
 NO_CAPABILITIES=0
 SMP=0
 HIDDEN_SCT=0
 DUMMYOS=0
 LSM_STACKING=1
+LINUX26_USE_REDIRFS=0
 LOCAL_DPATH=2
 LINUX_SRC=""
 LINUX_OBJ=""
@@ -1549,6 +1567,13 @@ do
 		--disable-syscalls)
 			LINUX26_USE_SYSCALLS=0
 			;;
+		--enable-redirfs)
+			LINUX26_USE_REDIRFS=1
+			LSM_STACKING=0
+			;;
+		--disable-redirfs)
+			LINUX26_USE_REDIRFS=0
+			;;
 		--sct-nocheck)
 			PERFORM_SCT_CHECK=0
 			;;
-- 
1.5.4.rc4.25.g81cc-dirty


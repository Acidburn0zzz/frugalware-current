# Compiling Time: 0.26 SBU
# Maintainer: VMiklos <vmiklos@frugalware.org>

pkgname=squashfs
pkgver=3.2_r2
kver=2.6.22-1
kdir=/lib/modules/${kver/-/-fw}/kernel/fs/squashfs
pkgrel=5
pkgdesc="A highly compressed read-only filesystem for Linux."
depends=('zlib' "kernel-fwlive=$kver")
makedepends=("kernel-fwlive-source=$kver")
groups=('apps-extra')
archs=('i686' 'x86_64')
#_F_kernel_name="-fwlive"
Finclude sourceforge
up2date="lynx -dump http://sourceforge.net/project/showfiles.php?group_id=63835|grep squashfs[0-9]|sed 's/[^]]*][^]]*]squashfs\([^ ]*\) .*/\1/;s/-/_/g;q'"
source=(${source/squashfs-/squashfs} \
	http://$_F_sourceforge_mirror.dl.sourceforge.net/sevenzip/lzma443.tar.bz2 \
	ftp://ftp.slax.org/source/slax/kernel/2.6.21.5/src-core/patches/squashfs/sqlzma.tar.bz2 \
	mksquashfs.quiet.patch)
options=('scriptlet')

build()
{
	rm -rf lzma443
	mkdir -p lzma443 || Fdie
	tar -C lzma443 -xf lzma443.tar.bz2 || Fdie
	rm sqlzma2k-3.2-r2.patch
	patch -p0 <sqlzma2u-3.2-r2.patch || Fdie
	patch -p0 <mksquashfs.quiet.patch || Fdie
	if [ "$CARCH" == "x86_64" ]; then
		sed -i 's/-Werror//' sqlzma1-443.patch || Fdie
		sed -i 's/-Werror//' Makefile || Fdie
	fi
	patch -p0 <sqlzma1-443.patch || Fdie
#	cat *.patch | patch -p0 || return 1
	cp -a /usr/src/linux/ ./
	sed -i "s|KDir =.*|KDir = $Fsrcdir/linux|" Makefile || Fdie
	sed -i "s|SqFs =.*|SqFs = $Fsrcdir/linux/fs/squashfs|" Makefile || Fdie

	make || Fdie

	Fmkdir $kdir
	Ffilerel linux/fs/squashfs/squashfs.ko $kdir
	Ffilerel lzma443/C/7zip/Compress/LZMA_C/kmod/{un,sq}lzma.ko $kdir
	Fexerel squashfs${pkgver/_/-}/squashfs-tools/{mk,un}squashfs /usr/bin/
}

sha1sums=('e38c16c09435291b2c97aa0a321c29da442ff686' \
          '1667abfb40da82d53fa2690f3cd58a0e7e751e55' \
          '26e02ccaabd4b0c1bcf1452c6aa42644954959d6' \
          '910679b57a7b30f2969cc9e8fd622d0b6a237bcd')
# optimization OK

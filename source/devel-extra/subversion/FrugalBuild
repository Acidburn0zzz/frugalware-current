# Compiling Time: 1.20 SBU
# Maintainer: Christian Hamar alias krix <krics@linuxforum.hu>

pkgname=subversion
pkgver=1.4.0
pkgrel=5
pkgdesc="A version control system that is a compelling replacement for CVS."
url="http://subversion.tigris.org/"
depends=('neon>=0.26.1' 'apr-util>=1.2.7-2' 'apr')
makedepends=('apache>=2.2.3-2' 'swig' 'ruby')
groups=('devel-extra')
archs=('i686' 'x86_64')
up2date="lynx -dump http://subversion.tigris.org/project_packages.html|grep -m1 'The best available'|sed 's/.*]//'|tr -d [:blank:]"
source=(http://$pkgname.tigris.org/downloads/$pkgname-$pkgver.tar.bz2 rc.svnserve \
	mod_dav_svn.conf neon26.patch)
sha1sums=('92671bba140e9b9e300b5ffb526c4a7c59aeb5b1' \
          '97c1e3055ad1e25e96d21a38e9525ce2a8c45c10' \
          'b4012364a9fbd9e8c490a4819780c31c67940428' \
          '251947ca57ca5a35c84179c9d8ef927b17b58e15')

subpkgs=('mod_svn' 'subversion-svnserve' 'subversion-bindings')
subdescs=('SVN module for apache 2.X webservers to use SVN server via apache' \
		 'Standalone SVN server daemon' \
		 'Python,Ruby,Perl bindings for subversion')
subdepends=('apache subversion' 'subversion' 'subversion perl python ruby swig')
subgroups=('devel-extra' 'devel-extra' 'devel-extra')
subarchs=('i686 x86_64' 'i686 x86_64' 'i686 x86_64')
subbackup=('etc/httpd/conf/modules.d/mod_dav_svn.conf' '' '')

Finclude python

build() {
	## krix this need be here svn won't build on SMP systems without -- crazy --
	unset MAKEFLAGS
	
	Fpatchall
	Fautoreconf
	Fmake --disable-experimental-libtool --disable-debug \
		--disable-mod-activation --enable-dso --with-neon=/usr \
		--with-ssl --with-swig=/usr
	Fmakeinstall
	Fmv usr/share/man usr/man
	make swig-py || Fdie
	## bug 64634 Still need this ?!
	mkdir -p subversion/bindings/swig/perl/native/blib/arch/auto/SVN/{_Client,_Delta,_Fs,_Ra,_Repos,_Wc}
	make swig-pl || Fdie
	make swig-rb || Fdie

	# PYTHON bindings install
	make install-swig-py DESTDIR=$Fdestdir \
		DISTUTIL_PARAM==--prefix=$Fdestdir \
		LD_LIBRARY_PATH="-L$Fdestdir/usr/lib" || Fdie
	Fmkdir $_F_python_libdir
	Fmv usr/lib/svn-python/libsvn $_F_python_libdir
	Fmv usr/lib/svn-python/svn $_F_python_libdir
	Frm usr/lib/svn-python

	# PERL bindings install
	make DESTDIR=$Fdestdir install-swig-pl || Fdie
	Frm /usr/lib/perl5/`perl -e 'printf "%vd", $^V'`
	Fmv /usr/lib/perl5/site_perl/`perl -e 'printf "%vd", $^V'` /usr/lib/perl5/site_perl/current

	# RUBY bindings install
	make DESTDIR=$Fdestdir install-swig-rb || Fdie
	Frcd svnserve
	Ffile /etc/httpd/conf/modules.d/mod_dav_svn.conf

	# Install some example scripts and some tools
	Fmkdir /usr/share/subversion
	cp -r tools/hook-scripts $Fdestdir/usr/share/subversion || Fdie
	cp -r tools/dev $Fdestdir/usr/share/subversion || Fdie
	cp -r tools/backup/* $Fdestdir/usr/share/subversion/dev || Fdie
	Frm /usr/share/subversion/*.in
	Frm /usr/share/subversion/hook-scripts/*.in
	# For bash-completion
	Ffilerel tools/client-side/bash_completion etc/bash_completion.d/subversion
	Fmkdir /usr/share/doc/$pkgname-$pkgver
	cp -r doc $Fdestdir/usr/share/doc/$pkgname-$pkgver || Fdie
	# Split SVN svnserve daemon and releated files
	Fsplit subversion-svnserve etc/rc.d
	Fsplit subversion-svnserve usr/bin/svnserve
	Fsplit subversion-svnserve usr/man/man8/svnserve*
	Fsplit subversion-svnserve usr/man/man5/svnserve*
	# Split SVN apache libs and confs
	Fsplit mod_svn etc/httpd
	Fsplit mod_svn usr/lib/apache/
	# Split SVN bindings / bindings libs and mans
	Fsplit subversion-bindings usr/lib/perl5/
	Fsplit subversion-bindings $_F_python_libdir
	Fsplit subversion-bindings usr/lib/ruby/
	Fsplit subversion-bindings usr/lib/libsvn_swig*
	Fsplit subversion-bindings usr/man/man3/SVN*
}

# optimization OK

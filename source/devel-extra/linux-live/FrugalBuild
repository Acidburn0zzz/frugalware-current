# Compiling Time: 0.01 SBU
# Maintainer: CSÉCSY László <boobaa@frugalware.org>
# Contributor: VMiklos <vmiklos@frugalware.org>

pkgname=linux-live
pkgver=5.5.0
splashver=0.1
pkgrel=3
pkgdesc="A set of shell scripts which allows you to create own LiveCD."
url="http://www.linux-live.org/"
depends=('cdrtools')
makedepends=('squashfs' 'busybox' 'unionfs' 'eject' 'module-init-tools')
groups=('devel-extra')
archs=('i686')
up2date="lynx -dump $url |Flasttar"
source=(http://www.linux-live.org/dl/linux-live-$pkgver.tar.gz \
	http://ftp.frugalware.org/pub/other/sources/fwlive/splash-$splashver.lss \
	linux-live-5.5.0-fwlive.diff)
sha1sums=('7933a82fbe6a278270fb5251960bae2dd37acccf' \
	  '6575f4826c17a710eed5755f2db5b0eebc1d56b2' \
	  '47ac75c145e777362ce762498380d5bcaf9a0f8b')
# when the interal package versions are outdated, we need extra hacks
# the version of glibc we have
glibcver=2.5
# the version of the internal glibc
liveglibcver=2.3.6

build()
{
	Fpatchall
	Fmkdir /usr/share/linux-live
	Fcpr $pkgname-$pkgver/* usr/share/$pkgname/

	# a special version of make clean ;)
	unset bins
	for i in `find $Fdestdir/usr/share/$pkgname -perm -u+x ! -type d ! -type l`
	do
		if [[ "`file $i`" =~ "ELF" ]]; then
			bins="$bins $i"
			rm $i
		fi
	done

	# now copy the missing binaries
	cp /sbin/mksquashfs $Fdestdir/usr/share/$pkgname/tools/ || Fdie
	cp /sbin/unsquashfs $Fdestdir/usr/share/$pkgname/tools/ || Fdie
	cp /usr/share/busybox/bin/busybox $Fdestdir/usr/share/$pkgname/initrd/rootfs/bin/ || Fdie
	cp /usr/sbin/uniondbg $Fdestdir/usr/share/$pkgname/initrd/rootfs/bin/ || Fdie
	cp /sbin/blkid $Fdestdir/usr/share/$pkgname/initrd/rootfs/bin/ || Fdie
	cp /usr/sbin/unionctl $Fdestdir/usr/share/$pkgname/initrd/rootfs/bin/ || Fdie
	cp /usr/bin/eject $Fdestdir/usr/share/$pkgname/initrd/rootfs/bin/eject || Fdie
	cp /lib/ld-$glibcver.so $Fdestdir/usr/share/$pkgname/initrd/rootfs/lib/ || Fdie
	ln -sf ld-$glibcver.so $Fdestdir/usr/share/$pkgname/initrd/rootfs/lib/ld-linux.so.2 || Fdie
	bins=${bins/ld-$liveglibcver.so/ld-$glibcver.so}
	cp /lib/libc-$glibcver.so $Fdestdir/usr/share/$pkgname/initrd/rootfs/lib/ || Fdie
	ln -sf libc-$glibcver.so $Fdestdir/usr/share/$pkgname/initrd/rootfs/lib/libc.so.6 || Fdie
	bins=${bins/libc-$liveglibcver.so/libc-$glibcver.so}
	cp /usr/lib/libz.so.1.2.3 $Fdestdir/usr/share/$pkgname/initrd/rootfs/lib/ || Fdie
	cp /lib/libblkid.so.1.0 $Fdestdir/usr/share/$pkgname/initrd/rootfs/lib/ || Fdie
	cp /lib/libuuid.so.1.2 $Fdestdir/usr/share/$pkgname/initrd/rootfs/lib/ || Fdie
	cp /sbin/insmod $Fdestdir/usr/share/$pkgname/initrd/rootfs/bin/ || Fdie

	# check if we have everything
	for i in $bins
	do
		if [ ! -e $i ]; then
			echo $i is missing
			return 1
		fi
	done

	Ffile splash-$splashver.lss usr/share/$pkgname/cd-root/boot/splash.lss
	Fln /usr/share/$pkgname/DOC usr/share/doc/$pkgname-$pkgver/DOC
}

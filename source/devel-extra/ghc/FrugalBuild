# Compiling Time: 12.94 SBU
# Maintainer: VMiklos <vmiklos@frugalware.org>

pkgname=ghc
pkgver=6.8.3
pkgrel=1
pkgdesc="The Glasgow Haskell Compiler"
url="http://www.haskell.org/ghc/"
depends=('gmp' 'readline' 'gcc-3.3')
groups=('devel-extra')
archs=('i686' 'x86_64')
up2date="lynx -dump http://www.haskell.org/ghc/download.html|grep Current|sed 's/.*(\(.*\))/\1/'"
if [ "$CARCH" == "i686" ]; then
	_arch=i386
else
	_arch=$CARCH
fi
source=(http://www.haskell.org/ghc/dist/$pkgver/ghc-$pkgver-src.tar.bz2 \
	http://www.haskell.org/ghc/dist/$pkgver/ghc-$pkgver-src-extralibs.tar.bz2 \
	http://www.haskell.org/ghc/dist/$pkgver/ghc-$pkgver-$_arch-unknown-linux.tar.bz2)
# optimization OK
sha1sums=('f908b0e0293014dde587abd8c7912eb490f9b3d2' \
          '800258df7d86f5538fd2cc54829e29e90183b882')
if [ "$CARCH" == "i686" ]; then
	sha1sums=(${sha1sums[@]} '90ba23d68def98c8867973925c3362b7b5733797')
elif [ "$CARCH" == "x86_64" ]; then
	sha1sums=(${sha1sums[@]} 'e8869f7df7465f1db913ce070e95fb22cc9309e9')
fi
NOEXTRACT=1

build()
{
	# hack!
	mkdir lib
	cd lib
	ln -sf /usr/lib/libreadline.so libreadline.so.4
	export LD_LIBRARY_PATH=`pwd`
	cd ..

	if [ "$CARCH" == "x86_64" ]; then
		# gcc 3.3 doesn't support -march=k8
		export CFLAGS="-O2 -pipe"
	fi

	tar xf ghc-$pkgver-$_arch-unknown-linux.tar.bz2
	mv ghc-$pkgver ghc-$pkgver-binary
	cd ghc-$pkgver-binary
	./configure --prefix=$Fsrcdir/binary
	make install
	export PATH=$Fsrcdir/binary/bin:$PATH

	cd $Fsrcdir
	tar xf ghc-$pkgver-src.tar.bz2
	tar xf ghc-$pkgver-src-extralibs.tar.bz2
	Fbuild --with-gcc=gcc-3.3
}

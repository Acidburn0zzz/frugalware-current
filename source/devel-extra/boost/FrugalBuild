# Compiling Time: 2.33 SBU
# Maintainer: Marius Cirsta <mcirsta@frugalware.org>
# Contributor: Elentir <elentir@frugalware.org>
# Contributor: Christian Hamar alias krix <krics@linuxforum.hu>


pkgname=boost
pkgver=1.61.0
pkgrel=6
pkgdesc="Boost header files, examples and tools"
_F_sourceforge_ext=".tar.bz2"
Finclude sourceforge python
url="http://boost.org/"
depends=()
up2date="lynx -dump http://www.boost.org/users/download/|grep 'Current Release'|tail -n 1 | sed 's/.*]\(.*\) -.*/\1/'"
makedepends=('python3>=3.5.3-2' 'python>=2.7.13-2' 'icu4c>=58.2-3' 'bzip2>=1.0.6-14' 'zlib>=1.2.11-2' 'openssl>=1.0.2-15')
source=(${source/-$pkgver/_${pkgver//./_}})
groups=('devel-extra')
archs=('x86_64')
_F_cd_path="${pkgname}_`echo $pkgver|tr . _`"
sha1sums=('f84b1a1ce764108ec3c2b7bd7704cf8dfd3c9d01')

options+=('static') ## pong-static ?:)

subpkgs=("libboost")
subdescs=('Boost libraries.')
subdepends=('icu4c>=58.2-3 libstdc++>=6.3.1-4 bzip2>=1.0.6-14 zlib>=1.2.11-2')
subrodepends=('')
subgroups=('lib')
subarchs=('x86_64')

subpkgs+=("libboost-static")
subdescs+=('Boost libraries statically linked.')
subdepends+=('')
subrodepends+=('')
subgroups+=('devel-extra')
subarchs+=('x86_64')

subpkgs+=("libboost-mpi")
subdescs+=('Boost MPI Interface.')
subdepends+=('openmpi>=3.0 libstdc++>=6.3.1-4')
subrodepends+=("libboost>=$pkgver")
subgroups+=('lib-extra')
subarchs+=("x86_64")

build()
{

	CXXFLAGS+=" -fPIC -DPIC"

	local JOBS="$(sed -e 's/.*\(-j *[0-9]\+\).*/\1/' <<< ${MAKEFLAGS})"

	Fcd
	./bootstrap.sh --with-toolset=gcc --with-icu
	# Support for OpenMPI
	echo "using mpi ;" >> project-config.jam


   	# Add an extra python version. This does not replace anything and python 2.x
   	# need to be the default.

	## that never worked ...
	_F_python3_ver="`F_python3_getver`"
   	echo "using python : ${_F_python3_ver} : /usr/bin/python3 : /usr/include/python${_F_python3_ver}m : /usr/lib ;" \
		>> project-config.jam

	./b2 	variant=release \
		debug-symbols=off \
		threading=multi \
		runtime-link=shared \
		link=shared,static \
		toolset=gcc \
		optimization=speed \
		-sHAVE_ICU=1 -sICU_PATH=/usr \
		-sBOOST_ROOT="$Fsrcdir" \
		-sPYTHON_ROOT=/usr \
                -sPYTHON_VERSION="$_F_python_ver" \
		-sEXPAT_INCLUDE=/usr/include \
		-sEXPAT_LIBPATH=/usr/lib \
		--prefix="$Fdestdir/usr" \
		--exec-prefix="$Fdestdir/usr" \
		--includedir="$Fdestdir/usr/include" \
		--libdir="$Fdestdir/usr/lib" \
		--layout=system \
		cflags="${CXXFLAGS}" \
		linkflags="${LDFLAGS}" \
		${JOBS}  install || Fdie

	#for k3d
	cp libs/math/include_private/boost/math/tools/* $Fdestdir/usr/include/boost/math/tools/ || Fdie

	## this before mpi , we don't want static libs in mpi package
	Fsplit libboost-static usr/lib/libboost_*.a

	Fsplit libboost-mpi usr/lib/libboost_graph_parallel*
	Fsplit libboost-mpi usr/lib/libboost_mpi*
	Fsplit libboost-mpi usr/lib/mpi.so

	Fsplit libboost        usr/lib/libboost_*.so*

}

# optimization OK

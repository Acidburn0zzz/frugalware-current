# Compiling Time: 2.50 SBU
# Maintainer: Devil505 <devil505linux@gmail.com>

pkgname=chromium-browser
pkgver=5.0.342.8
pkgrel=2
pkgdesc='An open-source browser project that aims to build a safer, faster, and more stable way for all users to experience the web'
url='http://www.chromium.org/'
depends=('nss' 'gconf' 'alsa-lib' 'hicolor-icon-theme' 'libxslt' 'ffmpeg' \
	'libevent' 'libxscrnsaver' 'libpng>=1.4.1')
makedepends=('python' 'perl' 'gperf' 'yasm' 'libgl')
license=('BSD')
groups=('gnome-extra')
archs=('i686' 'x86_64')
_F_gnome_iconcache="y"
Finclude gnome-scriptlet
up2date="Flasttar http://ftp.frugalware.org/pub/other/people/devil505/snapshots/$pkgname/"
source=(http://ftp.frugalware.org/pub/other/people/devil505/snapshots/$pkgname/$pkgname-$pkgver.tar.bz2  \
        $pkgname.desktop $pkgname.sh  \
        drop_sse2.patch ffmpeg_branding_mime.patch libpng-1.4.patch chromium-gcc45.diff)
sha1sums=('d01c033727b43a12cf7345bbde6fbee992a5f760' \
          '78ed8913b8a598de6a9e45d206973a846dbe8a51' \
          'e06de4aee77b3deb77e3b08ebb175ec02da42ced' \
          'c47d35b1539bcc9fd80df253eb2ba43d3b76f6ff' \
          'dcf0bcd9da6e5e81787095d64ccfc8c1cb6ba02e' \
          '06eb55ef616525be7b6186e38231656e5af27255' \
          'ccaf1f5d9153923fc49e8b8918520e851ca39282')

build() {
        Fcd
	Fsed "-Werror" "" src/build/common.gypi
        export GYP_GENERATORS='make'
        export BUILDTYPE='Release'
        # we need to disable system_ssl until "next protocol negotiation" support
        # is available in our nss package
        # see https://bugzilla.mozilla.org/show_bug.cgi?id=547312
        export GYP_DEFINES="gcc_version=45 \
                no_strict_aliasing=1 \
                linux_sandbox_path=/usr/lib/chromium/chromium-sandbox \
                linux_strip_binary=1 \
                release_extra_cflags='${CFLAGS}' \
                ffmpeg_branding=Chrome \
                use_system_libjpeg=1 \
                use_system_libxslt=0 \
                use_system_libxml=0 \
                use_system_bzip2=1 \
                use_system_zlib=1 \
                use_system_libpng=1 \
                use_system_ffmpeg=0 \
                use_system_yasm=1 \
                use_system_libevent=1 \
                use_system_ssl=0"

        Fpatchall

        export PATH=./depot_tools/:$PATH
        gclient.py runhooks --force || Fdie

        cd src || Fdie
        make chrome chrome_sandbox || Fdie

	Fmkdir usr/lib/chromium
        Fexerel out/Release/chrome usr/lib/chromium/chromium
        Finstallrel 4555 out/Release/chrome_sandbox usr/lib/chromium/chromium-sandbox
	Ffileschown usr/lib/chromium/chromium-sandbox root root
        Finstallrel 644 out/Release/chrome.pak usr/lib/chromium/chrome.pak

        Fln /usr/lib/libavcodec.so.52 /usr/lib/chromium/libavcodec.so.52
        Fln /usr/lib/libavformat.so.52 /usr/lib/chromium/libavformat.so.52
        Fln /usr/lib/libavutil.so.50 /usr/lib/chromium/libavutil.so.50

        cp -a out/Release/locales out/Release/resources  \
	$Fdestdir/usr/lib/chromium/ || Fdie
        find $Fdestdir/usr/lib/chromium/ -name '*.d' -type f -delete
        Finstallrel 644 out/Release/chrome.1 usr/share/man/man1/chromium.1

        Finstall 644 $pkgname.desktop usr/share/applications/$pkgname.desktop
        for size in 16 32 48 256; do
                install -m 0644 -D \
                        chrome/app/theme/chromium/product_logo_${size}.png \
                        $Fdestdir/usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png
        done

        Fexe $pkgname.sh usr/bin/$pkgname

        Fdocrel LICENSE
	Fbuild_gnome_scriptlet
}


# Last Modified: Fri, 16 Sep 2005 13:07:42 +0200
# Compiling Time: 0.01 SBU
# Maintainer: VMiklos <vmiklos@frugalware.org>

pkgname=speech_tools
pkgver=1.2.3
festivalver=1.4.3
pkgrel=1
pkgdesc="Speech tools for Festival Text to Speech engine"
url="http://www.cstr.ed.ac.uk/"
pkgurl="http://fife.speech.cs.cmu.edu/festival/cstr/festival/"
depends=('libstdc++')
groups=('apps-extra')
archs=('i686')
up2date="lynx -dump $pkgurl/$festivalver/|grep speech_|sed -n 's/.*-\(.*\)-r.*/\1/;1 p'"
source=($pkgurl/$festivalver/speech_tools-$pkgver-release.tar.gz \
	$pkgname-$pkgver-gcc34.patch.bz2)
sha1sums=('8227d9820c6c25c9e5a0d02d7dcae00116e368df' \
	  'ce25ed29044fd69d285a15db5ec65f21fd945b7b')

# compiles only with gcc-3.4 :-/

build()
{
	unset MAKEFLAGS
	Fcd $pkgname
	Fpatchall
	Fsed 'head -1' 'head -n 1' config.guess
	Fsed '-O3' "$CXXFLAGS" base_class/Makefile
	Fconf
	
	make OPTIMISE_CXXFLAGS="${CXXFLAGS}" OPTIMISE_CCFLAGS="${CFLAGS}" \
		|| return 1

	Fmkdir /usr/lib
	Fexerel lib/libestbase.so.1.2.3.1 /usr/lib
	Fexerel lib/libeststring.so.1.2 /usr/lib
	Fln libestbase.so.1.2.3.1 /usr/lib/libestbase.so
	Fln libeststring.so.1.2 /usr/lib/libeststring.so
	Ffilerel lib/libestbase.a /usr/lib/
	Ffilerel lib/libestools.a /usr/lib/
	Ffilerel lib/libeststring.a /usr/lib/

	cd bin
	for i in *
	do
		[ $i = "Makefile" ] && continue
		Fexerel /usr/bin/$i
		Fsed "$Fsrcdir/$pkgname/testsuite/data" \
			"/usr/share/speech-tools/testsuite" $Fdestdir/usr/bin/$i
		Fsed "$Fsrcdir/$pkgname/bin" "/usr/libexec/speech-tools" \
			$Fdestdir/usr/bin/$i
		Fsed "$Fsrcdir/$pkgname/main" "/usr/libexec/speech-tools" \
			$Fdestdir/usr/bin/$i
		Fsed "$Fsrcdir/$pkgname/lib" "/usr/lib" $Fdestdir/usr/bin/$i
	done
	cd ..

	cd main
	for i in `find -perm +100 -type f`
	do
		Fexerel /usr/libexec/speech-tools/$i
	done
	cd ..

	Ffilerel lib/siod/* /usr/share/speech-tools/lib/siod

	Fdocrel lib/example_data/*

	find config -print |cpio -pmd $Fdestdir/usr/share/speech-tools \
		|| return 1

	cd include
	find . -print |cpio -pmd $Fdestdir/usr/include/speech-tools \
		|| return 1
	cd ..
	# compile fix for festival
	Fsed '\(^class EST_Chunk \)' 'class EST_ChunkPtr;\n\1/' \
		$Fdestdir/usr/include/speech-tools/EST_Chunk.h
	Fln /usr/include/speech-tools /usr/share/speech-tools/include
	chmod 755 $Fdestdir/usr/include/speech-tools

	chown -R root:0 $Fdestdir

	find $Fdestdir/usr/share/speech-tools/config -type f \
		|xargs sed -i 's/-ltermcap/-lncurses/g'

	Fdocrel lib/cstrutt.dtd
}

# optimalization OK

# vim: ft=sh

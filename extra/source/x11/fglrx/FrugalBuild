# Last modified: Mon, 20 Feb 2006 23:40:00 +0100
# Compiling time: ~0.08 SBU
# Contributor: Shrift <shrift@frugalware.org>
# Maintainer: voroskoi <voroskoi@frugalware.org>

pkgname=fglrx
pkgver=8.22.5
pkgrel=1
pkgdesc="Hardware Accelerated ATi driver for xorg"
url="http://www.ati.com/"
# libstdc++5: no hardware acceleration without it
depends=('xorg-server' 'libstdc++5')
rodepends=('fglrx_module>=8.22.5-1')
groups=('x11-extra')
archs=('i686')
Finclude kernel-module
install=$pkgname.install
up2date="8.22.5"
source=(https://a248.e.akamai.net/f/674/9206/0/www2.ati.com/drivers/linux/ati-driver-installer-$pkgver-i386.run)
[ "$CARCH" == "i686" ] && sha1sums=('e341bde3943bca1473bc411df1971a9e52fa5fbe')
options=('nodocs')

subpkgs=('fglrx_module')
subdescs=('fglrx kernel module')
subdepends=('kernel=2.6.15-2')
subgroups=('x11-extra')
subarchs=('i686')
subinstall=fglrx_module.install

build() {
	chmod a+x ati-driver-installer-$pkgver-i386.run
	./ati-driver-installer-$pkgver-i386.run --extract ATi

	cp -r $Fsrcdir/ATi/arch/x86/* $Fsrcdir/ || Fdie
	cp -r $Fsrcdir/ATi/common/* $Fsrcdir/ || Fdie
	cp -r $Fsrcdir/ATi/x690/* $Fsrcdir/ || Fdie

	# building kernel module
	Fcd /lib/modules/fglrx/build_mod
	cp 2.6.x/Makefile . || Fdie
	make -C /usr/src/linux-`uname -r` SUBDIRS="`pwd`" modules || Fdie
	Ffile lib/modules/fglrx/build_mod/fglrx.ko lib/modules/`uname -r`/video/fglrx.ko

	# moving the intresting part to the package
	mv $Fsrcdir/usr $Fdestdir || Fdie

	# Install into correct paths for Xorg7
	Fmkdir /usr/lib/xorg
	Fmkdir /usr/{include,lib,bin}
	mv $Fdestdir/usr/X11R6/include/* $Fdestdir/usr/include || Fdie
	mv $Fdestdir/usr/X11R6/lib/* $Fdestdir/usr/lib || Fdie
	mv $Fdestdir/usr/X11R6/bin/* $Fdestdir/usr/bin || Fdie
	Frm /usr/X11R6

	# No hardware support without it
	Fmv /usr/lib/modules /usr/lib/xorg/modules
	Fln /usr/lib/xorg/modules /usr/lib/modules

	Fcd /usr/lib
	ln -sf /usr/lib/libfglrx_pp.so.1.0 libfglrx_pp.1
	ln -sf /usr/lib/libfglrx_gamma.so.1.0 libfglrx_gamma.1

	# solving mesa config
	Fmv /usr/lib/libGL.so.1.2{,.ati}

	find $Fdestdir -type d |xargs chmod 755

	Fsplit fglrx_module /lib
}

# Last Modified: Tue, 22 Nov 2005 01:59:37 +0100
# Compiling Time: 7.26 SBU
# Maintainer: Zoltan Kiss <djsmiley@frugalware.org>

pkgname=kernel-grsec
pkgver=2.1.7
kver=2.6.14.2
kmin=`echo $kver|cut -d . -f 1,2,3`
cver=0.1.0
pkgrel=1
pkgdesc="The Linux Kernel and modules (Grsecurity version)"
url="http://www.grsecurity.net"
depends=('module-init-tools')
backup=('/etc/sysconfig/grsec')
groups=('base-extra')
archs=('i686')
provides=('kernel')
up2date="lynx -dump http://www.grsecurity.net/download.php|grep grsecurity-.*-2.6|sed -n 's/.*y-\([^-]*\)-.*/\1/;1 p'"
grtime=`lynx -dump http://www.grsecurity.net/download.php|grep grsecurity-.*-2.6|sed -n 's/.*-\(.*\)\.p.*/\1/;1 p'`
source=(http://www.grsecurity.net/grsecurity-$pkgver-$kver-$grtime.patch.gz \
	ftp://ftp.kernel.org/pub/linux/kernel/v2.6/linux-$kver.tar.gz \
	http://ftp.frugalware.org/pub/other/grsecconf/grsecconf-$cver.tar.gz \
	config config.patch grsec README.frugalware rc.grsec \
	rc.grsec-{de,hu}.po)
sha1sums=('5dbdaee9d0657827e445b51c16e44a0c3c6816a7' \
	  '5a390e2009f2e6928bed370a68f133c0d3cf2bee' \
	  'ff2bc3fc9c9a203dbeba81c4d1f4d67725776972' \
	  '5c21384228527c602ba53146177f5d509c184b59' \
	  'a345b3a6bf0c2971b3094a79cf5b57d30bd9d80b' \
	  'acc1412a2c2f267b150aea970ec4643810c25990' \
	  'e83987eb2ad234e56e1f47b406733bff79e82cf9' \
	  '39bf63a489895bd9ed7d107dbcc03867d4908b1c' \
	  'd92ba5c7321b63e16d56bea2bdafbbf9a90351ed' \
	  'a38cf9624b942b50182e9a8eee23e53ab093cec6')
						      
[ "$CARCH" == "x86_64" ] && MARCH=K8
echo "$CARCH" |grep -q 'i.86' && KARCH=i386

[ "$CARCH" == "x86_64" ] && \
	source=(${source[@]} linux-2.6.11-x86_64_config.patch0) && \
	sha1sums=(${sha1sums[@]} '191954a0edaee42cf72e139b34d428fe3df8a11c')

build()
{
	#build the mconf util
	Fcd grsecconf-$cver
	make || return 1

	#install mconf
	Fmkdir /usr/share/kernel-grsec
	Fmkdir /var/lib/frugalware/system
	Fmkdir /usr/sbin
	Fexerel /usr/sbin/grsecconf
	Ffilerel options /usr/share/kernel-grsec/mconf.opts
	Fexerel /var/lib/frugalware/system/mconf
	
	#build kernel
	cd $Fsrcdir/linux-$kver
	cp $Fsrcdir/config .config
	Fpatchall
	Fsed "486" "`echo ${MARCH:-$CARCH}|sed 's/^i//'`" .config
	yes "" | make config
	Fsed "EXTRAVERSION =.*" "EXTRAVERSION = -grsec-fw$pkgrel" Makefile
	
	make || return 1

	#install kernel
	Fmkdir /boot

	Ffilerel .config /boot/config-$kmin-grsec-fw$pkgrel
	Ffilerel arch/${KARCH:-$CARCH}/boot/bzImage \
		/boot/vmlinuz-$kmin-grsec-fw$pkgrel
	Fmkdir /lib/modules
	make INSTALL_MOD_PATH=$Fdestdir modules_install
	Ffilerel System.map /boot/System.map-$kmin-grsec-fw$pkgrel
	Frm /lib/modules/$kmin-grsec-fw$pkgrel/build
	Frm /lib/modules/$kmin-grsec-fw$pkgrel/source
	Fln /usr/src/linux-$kmin-grsec-fw$pkgrel /lib/modules/$kmin-grsec-fw$pkgrel/build
	Fln /usr/src/linux-$kmin-grsec-fw$pkgrel /lib/modules/$kmin-grsec-fw$pkgrel/source
	Fdoc README.frugalware
	Fmkdir /etc/sysconfig
	Ffile /etc/sysconfig/grsec
	Fmkdir /etc/rc.d/rc.messages
	Frcd2 grsec
}

# vim: ft=sh
